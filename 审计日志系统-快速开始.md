# EHS ç³»ç»Ÿå®¡è®¡æ—¥å¿— - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æ–°çš„å®¡è®¡æ—¥å¿—ç³»ç»Ÿæä¾›äº†ç»Ÿä¸€ã€ç±»å‹å®‰å…¨ã€åŠŸèƒ½å®Œå–„çš„æ—¥å¿—è®°å½•èƒ½åŠ›ï¼Œæ”¯æŒï¼š

- âœ… **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- âœ… **è‡ªåŠ¨åŒ–**ï¼šè‡ªåŠ¨ç”Ÿæˆå¿«ç…§ã€å·®å¼‚æ¯”å¯¹ã€å®¢æˆ·ç«¯ä¿¡æ¯æå–
- âœ… **ä¸å¯ç¯¡æ”¹**ï¼šAppend-only è®¾è®¡ï¼Œæ»¡è¶³å®¡è®¡åˆè§„è¦æ±‚
- âœ… **æ·±åº¦è¿½æº¯**ï¼šå®Œæ•´è®°å½•æ“ä½œå‰åçš„æ•°æ®çŠ¶æ€å’Œå·®å¼‚
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå¼‚æ­¥å†™å…¥ï¼Œé”™è¯¯éš”ç¦»ï¼Œä¸é˜»æ–­ä¸šåŠ¡æµç¨‹

---

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹

### 1. åŸºæœ¬ç”¨æ³•

```typescript
import AuditService from '@/services/audit.service';
import { LogModule, LogAction } from '@/types/audit';

// è®°å½•åˆ›å»ºæ“ä½œ
await AuditService.recordLog({
  module: LogModule.HAZARD,
  action: LogAction.CREATE,
  businessId: hazard.code,  // ä½¿ç”¨ä¸šåŠ¡ç¼–å·ï¼Œå¦‚ HZ-2024-001
  targetType: 'hazard',
  targetLabel: hazard.desc?.substring(0, 50),
  newData: hazard,
  operator: {
    id: user.id,
    name: user.name,
    role: user.role,
    departmentName: user.department?.name,
  },
  request,  // Next.js Request å¯¹è±¡
});
```

### 2. ä½¿ç”¨ä¾¿æ·æ–¹æ³•

```typescript
// åˆ›å»º
await AuditService.logCreate({
  module: LogModule.HAZARD,
  businessId: hazard.code,
  newData: hazard,
  operator: currentUser,
  request,
});

// æ›´æ–°ï¼ˆè‡ªåŠ¨è®¡ç®— Diffï¼‰
await AuditService.logUpdate({
  module: LogModule.HAZARD,
  businessId: hazard.code,
  oldData: oldHazard,
  newData: updatedHazard,
  operator: currentUser,
  request,
});

// åˆ é™¤
await AuditService.logDelete({
  module: LogModule.HAZARD,
  businessId: hazard.code,
  oldData: hazard,
  operator: currentUser,
  request,
});

// å®¡æ‰¹é€šè¿‡
await AuditService.logApprove({
  module: LogModule.WORK_PERMIT,
  businessId: permit.code,
  oldData: oldPermit,
  newData: approvedPermit,
  operator: currentUser,
  businessRole: BusinessRole.APPROVER,
  request,
});
```

---

## ğŸ“¦ å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šéšæ‚£ç®¡ç† - åˆ›å»ºéšæ‚£

```typescript
// src/actions/hazard.ts
import AuditService from '@/services/audit.service';
import { LogModule, BusinessRole } from '@/types/audit';

export async function createHazard(data: HazardFormData) {
  const user = await getCurrentUser();
  
  // 1. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
  const hazard = await prisma.hazardRecord.create({
    data: {
      code: generateHazardCode(), // å¦‚ï¼šHZ-2024-001
      type: data.type,
      location: data.location,
      desc: data.desc,
      reporterId: user.id,
      reporterName: user.name,
      // ... å…¶ä»–å­—æ®µ
    },
  });

  // 2. è®°å½•å®¡è®¡æ—¥å¿—
  await AuditService.logCreate({
    module: LogModule.HAZARD,
    businessId: hazard.code,  // âš ï¸ ä½¿ç”¨ä¸šåŠ¡ç¼–å·ï¼Œè€Œéæ•°æ®åº“ID
    targetType: 'hazard',
    targetLabel: hazard.desc?.substring(0, 50),
    targetLink: `/hazard/${hazard.id}`,  // è¯¦æƒ…é¡µé“¾æ¥
    newData: hazard,
    operator: {
      id: user.id,
      name: user.name,
      role: user.role,
      departmentName: user.department?.name,
    },
    businessRole: BusinessRole.REPORTER,
    request,
  });

  return { success: true, data: hazard };
}
```

### ç¤ºä¾‹ 2ï¼šéšæ‚£ç®¡ç† - åˆ†é…æ•´æ”¹è´£ä»»äºº

```typescript
export async function assignHazard(
  hazardId: string,
  responsibleId: string,
  request: Request
) {
  const user = await getCurrentUser();
  
  // 1. æŸ¥è¯¢æ—§æ•°æ®
  const oldHazard = await prisma.hazardRecord.findUnique({
    where: { id: hazardId },
  });

  if (!oldHazard) {
    return { success: false, error: 'éšæ‚£ä¸å­˜åœ¨' };
  }

  // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
  const responsible = await prisma.user.findUnique({
    where: { id: responsibleId },
  });

  const updatedHazard = await prisma.hazardRecord.update({
    where: { id: hazardId },
    data: {
      responsibleId,
      responsibleName: responsible?.name,
      responsibleDept: responsible?.department?.name,
      status: 'assigned',
    },
  });

  // 3. è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆè‡ªåŠ¨è®¡ç®— Diffï¼‰
  await AuditService.logAssign({
    module: LogModule.HAZARD,
    businessId: oldHazard.code,
    targetType: 'hazard',
    targetLabel: oldHazard.desc?.substring(0, 50),
    targetLink: `/hazard/${hazardId}`,
    oldData: oldHazard,
    newData: updatedHazard,
    operator: {
      id: user.id,
      name: user.name,
      role: user.role,
    },
    description: `${user.name} å°†éšæ‚£ [${oldHazard.code}] åˆ†é…ç»™ ${responsible?.name}`,
    request,
  });

  return { success: true, data: updatedHazard };
}
```

### ç¤ºä¾‹ 3ï¼šä½œä¸šè®¸å¯ - å®¡æ‰¹é€šè¿‡

```typescript
// src/actions/work-permit.ts
export async function approveWorkPermit(
  permitId: string,
  approvalComments: string,
  request: Request
) {
  const user = await getCurrentUser();
  
  // 1. æŸ¥è¯¢æ—§æ•°æ®
  const oldPermit = await prisma.workPermitRecord.findUnique({
    where: { id: permitId },
    include: { template: true, project: true },
  });

  if (!oldPermit) {
    return { success: false, error: 'ä½œä¸šç¥¨ä¸å­˜åœ¨' };
  }

  // 2. æ‰§è¡Œå®¡æ‰¹é€»è¾‘
  const updatedPermit = await prisma.workPermitRecord.update({
    where: { id: permitId },
    data: {
      status: 'approved',
      currentStep: oldPermit.currentStep + 1,
      approvalLogs: JSON.stringify([
        ...JSON.parse(oldPermit.approvalLogs || '[]'),
        {
          userId: user.id,
          userName: user.name,
          action: 'approve',
          comments: approvalComments,
          timestamp: new Date().toISOString(),
        },
      ]),
    },
  });

  // 3. è®°å½•å®¡è®¡æ—¥å¿—
  await AuditService.logApprove({
    module: LogModule.WORK_PERMIT,
    businessId: oldPermit.code || oldPermit.id,
    targetType: 'work_permit',
    targetLabel: oldPermit.template?.name,
    targetLink: `/work-permit/${permitId}`,
    oldData: oldPermit,
    newData: updatedPermit,
    operator: {
      id: user.id,
      name: user.name,
      role: user.role,
      departmentName: user.department?.name,
    },
    businessRole: BusinessRole.APPROVER,
    description: `${user.name} å®¡æ‰¹é€šè¿‡äº†ä½œä¸šç¥¨ [${oldPermit.code}]`,
    request,
  });

  return { success: true, data: updatedPermit };
}
```

### ç¤ºä¾‹ 4ï¼šç”¨æˆ·ç®¡ç† - ä¿®æ”¹å¯†ç 

```typescript
// src/actions/user.ts
export async function changePassword(
  userId: string,
  oldPassword: string,
  newPassword: string,
  request: Request
) {
  const user = await getCurrentUser();

  // 1. éªŒè¯æ—§å¯†ç 
  const existingUser = await prisma.user.findUnique({
    where: { id: userId },
  });

  if (!existingUser || !await verifyPassword(oldPassword, existingUser.password)) {
    return { success: false, error: 'åŸå¯†ç é”™è¯¯' };
  }

  // 2. æ›´æ–°å¯†ç 
  const hashedPassword = await hashPassword(newPassword);
  await prisma.user.update({
    where: { id: userId },
    data: { password: hashedPassword },
  });

  // 3. è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆä¸è®°å½•å¯†ç å†…å®¹ï¼‰
  await AuditService.recordLog({
    module: LogModule.USER,
    action: LogAction.UPDATE,
    businessId: existingUser.username,
    targetType: 'user',
    targetLabel: existingUser.name,
    operator: {
      id: user.id,
      name: user.name,
      role: user.role,
    },
    description: `${user.name} ä¿®æ”¹äº†å¯†ç `,
    request,
    // âš ï¸ ä¸ä¼ é€’ oldData å’Œ newDataï¼Œé¿å…è®°å½•å¯†ç 
  });

  return { success: true };
}
```

---

## ğŸ” æŸ¥è¯¢æ—¥å¿—

### è·å–ä¸šåŠ¡å¯¹è±¡çš„æ“ä½œæ—¶é—´çº¿

```typescript
// è·å–æŸä¸ªéšæ‚£çš„å®Œæ•´æ“ä½œå†å²
const timeline = await AuditService.getBusinessTimeline(
  LogModule.HAZARD,
  'HZ-2024-001'
);

// åœ¨å‰ç«¯å±•ç¤º
<Timeline>
  {timeline.map((log) => (
    <TimelineItem key={log.id}>
      <Badge>{log.actionLabel}</Badge>
      <span>{log.userName} - {formatDate(log.createdAt)}</span>
      <p>{log.details}</p>
      {log.diff && <DiffViewer diff={JSON.parse(log.diff)} />}
    </TimelineItem>
  ))}
</Timeline>
```

### è·å–ç”¨æˆ·çš„æ“ä½œå†å²

```typescript
const userHistory = await AuditService.getUserHistory(userId, 100);
```

### ç»Ÿè®¡æ“ä½œæ•°é‡

```typescript
const stats = await AuditService.countByAction(
  LogModule.HAZARD,
  new Date('2024-01-01'),
  new Date('2024-12-31')
);

// è¾“å‡ºï¼š{ CREATE: 150, UPDATE: 230, DELETE: 5, APPROVE: 120 }
```

---

## âš™ï¸ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰ä¸šåŠ¡ç¼–ç 

```typescript
await AuditService.recordLog({
  module: LogModule.HAZARD,
  action: LogAction.UPDATE,
  businessCode: 'HD_CUSTOM_001',  // è‡ªå®šä¹‰ç¼–ç 
  // ... å…¶ä»–å‚æ•°
});
```

### é™„åŠ é¢å¤–çš„å®¢æˆ·ç«¯ä¿¡æ¯

```typescript
await AuditService.recordLog({
  module: LogModule.HAZARD,
  action: LogAction.CREATE,
  clientInfo: {
    location: 'åŒ—äº¬å¸‚æœé˜³åŒº',  // å¯ä»¥é€šè¿‡ IP è§£æè·å–
  },
  // ... å…¶ä»–å‚æ•°
});
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ä¸šåŠ¡ç¼–å·è€Œéæ•°æ®åº“ ID

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¸šåŠ¡ç¼–å·
businessId: hazard.code,  // HZ-2024-001

// âŒ é”™è¯¯ï¼šä½¿ç”¨æ•°æ®åº“ ID
businessId: hazard.id,  // cljkxxx...
```

### 2. è®°å½•æœ‰æ„ä¹‰çš„å¯¹è±¡æè¿°

```typescript
// âœ… æ­£ç¡®
targetLabel: hazard.desc?.substring(0, 50),  // "è½¦é—´åŒ—ä¾§æ¶ˆé˜²è®¾æ–½æŸå"

// âŒ é”™è¯¯
targetLabel: hazard.id,  // "cljkxxx..."
```

### 3. æä¾›è¯¦æƒ…é¡µé“¾æ¥ä»¥ä¾¿è¿½æº¯

```typescript
targetLink: `/hazard/${hazard.id}`,  // å¯ç‚¹å‡»è·³è½¬
```

### 4. æ›´æ–°æ“ä½œåŠ¡å¿…ä¼ é€’ oldData å’Œ newData

```typescript
// âœ… æ­£ç¡®ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®— Diff
await AuditService.logUpdate({
  oldData: oldHazard,
  newData: updatedHazard,
  // ...
});
```

### 5. æŒ‡å®šä¸šåŠ¡è§’è‰²ä»¥ä¾¿åˆ†æ

```typescript
businessRole: BusinessRole.APPROVER,  // å®¡æ‰¹äºº
businessRole: BusinessRole.RECTIFIER,  // æ•´æ”¹äºº
```

---

## ğŸ› ï¸ è¿ç§»æ—§ä»£ç 

### æ—§ä»£ç ï¼ˆsystemLog.service.tsï¼‰

```typescript
import { SystemLogService } from '@/services/systemLog.service';

await SystemLogService.createLog({
  userId: user.id,
  userName: user.name,
  action: 'CREATE',
  module: 'hazard',
  targetId: hazard.id,
  details: 'åˆ›å»ºéšæ‚£',
});
```

### æ–°ä»£ç ï¼ˆaudit.service.tsï¼‰

```typescript
import AuditService from '@/services/audit.service';
import { LogModule, LogAction } from '@/types/audit';

await AuditService.logCreate({
  module: LogModule.HAZARD,
  businessId: hazard.code,  // âš ï¸ æ”¹ç”¨ä¸šåŠ¡ç¼–å·
  newData: hazard,
  operator: {
    id: user.id,
    name: user.name,
    role: user.role,
  },
  request,
});
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¸šåŠ¡ç¼–å·è§„èŒƒ](./æ“ä½œæ—¥å¿—-ä¸šåŠ¡ç¼–å·è§„èŒƒ.md)
- [ç±»å‹å®šä¹‰æ–‡æ¡£](../src/types/audit.ts)
- [å·¥å…·å‡½æ•°æ–‡æ¡£](../src/lib/audit-utils.ts)
- [å¸¸é‡å®šä¹‰æ–‡æ¡£](../src/constants/audit.ts)

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ—¥å¿—å†™å…¥å¤±è´¥ä¼šå½±å“ä¸šåŠ¡å—ï¼Ÿ

**A:** ä¸ä¼šã€‚`AuditService` å†…éƒ¨ä½¿ç”¨ `try-catch` åŒ…è£¹ï¼Œå†™å…¥å¤±è´¥åªä¼šåœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹ã€‚

### Q2: å¦‚ä½•æŸ¥çœ‹æŸä¸ªå¯¹è±¡çš„å®Œæ•´æ“ä½œå†å²ï¼Ÿ

**A:** ä½¿ç”¨ `AuditService.getBusinessTimeline(module, businessId)` æ–¹æ³•ã€‚

### Q3: å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ä¼šè¢«è®°å½•å—ï¼Ÿ

**A:** ä¸ä¼šã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è¿‡æ»¤ `password`ã€`apiKey`ã€`token` ç­‰æ•æ„Ÿå­—æ®µï¼ˆè¯¦è§ `SENSITIVE_FIELDS` å¸¸é‡ï¼‰ã€‚

### Q4: å¯ä»¥åˆ é™¤æˆ–ä¿®æ”¹æ—¥å¿—å—ï¼Ÿ

**A:** ä¸å¯ä»¥ã€‚æ—¥å¿—ç³»ç»Ÿè®¾è®¡ä¸º Append-onlyï¼Œæ•°æ®åº“å±‚é¢ä¼šæ‹¦æˆª `DELETE` å’Œ `UPDATE` æ“ä½œï¼ˆé˜¶æ®µäº”å®ç°ï¼‰ã€‚

---

## ğŸ‰ æ€»ç»“

æ–°çš„å®¡è®¡æ—¥å¿—ç³»ç»Ÿè®©æ—¥å¿—è®°å½•å˜å¾—ï¼š

- **æ›´ç®€å•**ï¼šä¸€è¡Œä»£ç æå®šï¼Œè‡ªåŠ¨å¤„ç†å¿«ç…§å’Œå·®å¼‚
- **æ›´å®‰å…¨**ï¼šç±»å‹å®‰å…¨ + æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
- **æ›´ä¸“ä¸š**ï¼šæ»¡è¶³ EHS åˆè§„å®¡è®¡è¦æ±‚
- **æ›´å¯é **ï¼šé”™è¯¯éš”ç¦»ï¼Œä¸å½±å“ä¸šåŠ¡

ç«‹å³å¼€å§‹ä½¿ç”¨å§ï¼ ğŸš€
