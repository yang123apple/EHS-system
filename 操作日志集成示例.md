# 操作日志集成示例 - 隐患管理模块

本文档展示如何在隐患管理模块中集成操作日志系统。

> **⚠️ 重要提示**：始终使用业务编号（如 `HZ-2024-001`）作为 `targetId`，而不是数据库ID。
> 
> 详见：[操作日志-业务编号规范.md](./操作日志-业务编号规范.md)

## 示例1：隐患上报

```typescript
// src/app/api/hazards/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { ActivityLogger, Modules } from '@/utils/activityLogger';
import { getServerSession } from 'next-auth';

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();

    // 创建隐患记录
    const hazard = await prisma.hazardRecord.create({
      data: {
        code: generateCode(), // 生成隐患编号
        desc: body.desc,
        level: body.level,
        location: body.location,
        reporterId: user.id,
        status: '待派发',
        images: body.images,
      },
    });

    // 记录操作日志
    await ActivityLogger.logCreate({
      userId: user.id,
      module: Modules.HAZARD,
      targetType: 'hazard',
      targetId: hazard.code,        // ✅ 使用隐患编号
      targetLabel: hazard.desc?.substring(0, 50),  // 隐患描述
      data: hazard,
      request,
    });

    return NextResponse.json({
      success: true,
      data: hazard,
    });
  } catch (error) {
    console.error('创建隐患失败:', error);
    return NextResponse.json(
      { error: '创建失败' },
      { status: 500 }
    );
  }
}
```

## 示例2：隐患派发

```typescript
// src/app/api/hazards/[id]/dispatch/route.ts
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();
    const hazardId = params.id;

    // 获取原始数据
    const beforeData = await prisma.hazardRecord.findUnique({
      where: { id: hazardId },
    });

    if (!beforeData) {
      return NextResponse.json({ error: '隐患记录不存在' }, { status: 404 });
    }

    // 更新隐患状态和责任人
    const afterData = await prisma.hazardRecord.update({
      where: { id: hazardId },
      data: {
        status: '待整改',
        responsibleId: body.responsibleId,
        deadline: body.deadline,
      },
    });

    // 记录操作日志（带变更对比）
    await ActivityLogger.logUpdate({
      userId: user.id,
      module: Modules.HAZARD,
      targetType: 'hazard',
      targetId: hazardId,
      targetLabel: `隐患 ${afterData.code}`,
      beforeData,
      afterData,
      fieldLabels: {
        status: '状态',
        responsibleId: '责任人',
        deadline: '整改期限',
      },
      request,
    });

    // 也可以记录为单独的派发操作
    await ActivityLogger.logAction({
      userId: user.id,
      action: 'DISPATCH',
      actionLabel: '派发隐患',
      module: Modules.HAZARD,
      targetType: 'hazard',
      targetId: hazardId,
      targetLabel: `隐患 ${afterData.code}`,
      details: `派发给 ${body.responsibleName}，要求在 ${body.deadline} 前完成整改`,
      afterData: {
        responsibleId: body.responsibleId,
        deadline: body.deadline,
      },
      request,
    });

    return NextResponse.json({
      success: true,
      data: afterData,
    });
  } catch (error) {
    console.error('派发隐患失败:', error);
    return NextResponse.json(
      { error: '派发失败' },
      { status: 500 }
    );
  }
}
```

## 示例3：隐患整改提交

```typescript
// src/app/api/hazards/[id]/rectify/route.ts
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();
    const hazardId = params.id;

    // 获取原始数据
    const beforeData = await prisma.hazardRecord.findUnique({
      where: { id: hazardId },
    });

    if (!beforeData) {
      return NextResponse.json({ error: '隐患记录不存在' }, { status: 404 });
    }

    // 检查权限（只有责任人可以提交整改）
    if (beforeData.responsibleId !== user.id) {
      return NextResponse.json({ error: '无权操作' }, { status: 403 });
    }

    // 更新隐患状态
    const afterData = await prisma.hazardRecord.update({
      where: { id: hazardId },
      data: {
        status: '待验收',
        rectifyDesc: body.rectifyDesc,
        rectifyImages: body.rectifyImages,
        rectifyTime: new Date(),
      },
    });

    // 记录操作日志
    await ActivityLogger.logAction({
      userId: user.id,
      action: 'RECTIFY',
      actionLabel: '提交整改',
      module: Modules.HAZARD,
      targetType: 'hazard',
      targetId: hazardId,
      targetLabel: `隐患 ${afterData.code}`,
      details: `提交了整改说明：${body.rectifyDesc}`,
      beforeData: {
        status: beforeData.status,
      },
      afterData: {
        status: afterData.status,
        rectifyDesc: afterData.rectifyDesc,
        rectifyTime: afterData.rectifyTime,
      },
      changes: [
        {
          field: 'status',
          fieldLabel: '状态',
          oldValue: beforeData.status,
          newValue: afterData.status,
          changeType: 'modified',
        },
        {
          field: 'rectifyDesc',
          fieldLabel: '整改说明',
          oldValue: null,
          newValue: afterData.rectifyDesc,
          changeType: 'added',
        },
      ],
      request,
    });

    return NextResponse.json({
      success: true,
      data: afterData,
    });
  } catch (error) {
    console.error('提交整改失败:', error);
    return NextResponse.json(
      { error: '提交失败' },
      { status: 500 }
    );
  }
}
```

## 示例4：隐患验收

```typescript
// src/app/api/hazards/[id]/verify/route.ts
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();
    const hazardId = params.id;
    const { approved, comment } = body;

    // 获取原始数据
    const beforeData = await prisma.hazardRecord.findUnique({
      where: { id: hazardId },
    });

    if (!beforeData) {
      return NextResponse.json({ error: '隐患记录不存在' }, { status: 404 });
    }

    // 更新隐患状态
    const newStatus = approved ? '已关闭' : '待整改';
    const afterData = await prisma.hazardRecord.update({
      where: { id: hazardId },
      data: {
        status: newStatus,
        verifyComment: comment,
        verifyTime: new Date(),
        verifierId: user.id,
      },
    });

    // 记录审批日志
    await ActivityLogger.logApproval({
      userId: user.id,
      module: Modules.HAZARD,
      targetType: 'hazard',
      targetId: hazardId,
      targetLabel: `隐患 ${afterData.code}`,
      action: approved ? 'APPROVE' : 'REJECT',
      comment,
      beforeStatus: beforeData.status,
      afterStatus: newStatus,
      request,
    });

    return NextResponse.json({
      success: true,
      data: afterData,
    });
  } catch (error) {
    console.error('验收失败:', error);
    return NextResponse.json(
      { error: '验收失败' },
      { status: 500 }
    );
  }
}
```

## 示例5：批量导入隐患

```typescript
// src/app/api/hazards/import/route.ts
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();
    const { hazards } = body; // 数组

    // 批量创建隐患
    const createdHazards = await prisma.$transaction(
      hazards.map((h: any) => 
        prisma.hazardRecord.create({
          data: {
            ...h,
            reporterId: user.id,
            status: '待派发',
          },
        })
      )
    );

    // 记录导入日志
    await ActivityLogger.logImport({
      userId: user.id,
      module: Modules.HAZARD,
      targetType: 'hazard',
      description: '隐患记录',
      count: createdHazards.length,
      request,
    });

    // 也可以为每条记录单独记录日志
    // 使用批量方法提高性能
    const logs = createdHazards.map(hazard => ({
      userId: user.id,
      userName: user.name,
      userRole: user.role,
      userDepartment: user.department?.name,
      action: 'CREATE',
      actionLabel: '批量导入',
      module: Modules.HAZARD,
      targetType: 'hazard' as const,
      targetId: hazard.id,
      targetLabel: `隐患 ${hazard.code}`,
      details: '通过批量导入创建',
      afterData: hazard,
    }));

    await SystemLogService.createBatchLogs(logs);

    return NextResponse.json({
      success: true,
      data: {
        imported: createdHazards.length,
        hazards: createdHazards,
      },
    });
  } catch (error) {
    console.error('导入失败:', error);
    return NextResponse.json(
      { error: '导入失败' },
      { status: 500 }
    );
  }
}
```

## 示例6：隐患导出

```typescript
// src/app/api/hazards/export/route.ts
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();
    const { filters } = body;

    // 查询要导出的数据
    const hazards = await prisma.hazardRecord.findMany({
      where: filters,
    });

    // 生成Excel文件
    const excelBuffer = await generateExcel(hazards);

    // 记录导出日志
    await ActivityLogger.logExport({
      userId: user.id,
      module: Modules.HAZARD,
      targetType: 'hazard',
      description: '隐患记录列表',
      count: hazards.length,
      request,
    });

    return new NextResponse(excelBuffer, {
      headers: {
        'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'Content-Disposition': `attachment; filename="hazards_${Date.now()}.xlsx"`,
      },
    });
  } catch (error) {
    console.error('导出失败:', error);
    return NextResponse.json(
      { error: '导出失败' },
      { status: 500 }
    );
  }
}
```

## 示例7：在组件中查看操作日志

```typescript
// src/app/hazards/[id]/page.tsx
import ActivityLogViewer from '@/components/ActivityLogViewer';

export default function HazardDetailPage({ params }: { params: { id: string } }) {
  return (
    <div className="container mx-auto p-6">
      {/* 隐患详情 */}
      <div className="mb-6">
        <h1>隐患详情</h1>
        {/* ... 隐患信息展示 ... */}
      </div>

      {/* 操作日志 */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-lg font-bold mb-4">操作日志</h2>
        <ActivityLogViewer 
          targetType="hazard"
          targetId={params.id}
          showFilters={false}
          pageSize={10}
        />
      </div>
    </div>
  );
}
```

## 示例8：系统日志管理页面

```typescript
// src/app/admin/logs/page.tsx
import ActivityLogViewer from '@/components/ActivityLogViewer';

export default function SystemLogsPage() {
  return (
    <div className="h-screen flex flex-col">
      <ActivityLogViewer showFilters={true} pageSize={50} />
    </div>
  );
}
```

## 字段标签映射

为了使变更记录更易读，建议维护一个统一的字段标签映射：

```typescript
// src/utils/fieldLabels.ts
export const HazardFieldLabels = {
  code: '隐患编号',
  desc: '隐患描述',
  level: '风险等级',
  status: '状态',
  location: '位置',
  reporterId: '上报人',
  responsibleId: '责任人',
  deadline: '整改期限',
  rectifyDesc: '整改说明',
  rectifyImages: '整改图片',
  rectifyTime: '整改时间',
  verifyComment: '验收意见',
  verifyTime: '验收时间',
  verifierId: '验收人',
  images: '现场图片',
  createdAt: '创建时间',
  updatedAt: '更新时间',
};

export const DocumentFieldLabels = {
  title: '标题',
  content: '内容',
  category: '分类',
  tags: '标签',
  // ...
};

export const UserFieldLabels = {
  username: '用户名',
  name: '姓名',
  role: '角色',
  departmentId: '部门',
  jobTitle: '职位',
  // ...
};
```

使用时：

```typescript
import { HazardFieldLabels } from '@/utils/fieldLabels';

await ActivityLogger.logUpdate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazardId,
  targetLabel: `隐患 ${afterData.code}`,
  beforeData,
  afterData,
  fieldLabels: HazardFieldLabels,
  request,
});
```

## 总结

通过以上示例，您可以：

1. ✅ 在创建、更新、删除操作时自动记录日志
2. ✅ 记录审批、派发等特殊业务操作
3. ✅ 自动对比并记录字段变更
4. ✅ 批量操作时高效记录日志
5. ✅ 在详情页面或管理页面查看操作历史
6. ✅ 导出操作日志用于审计

所有日志都包含完整的用户快照（姓名、角色、部门、职位）和操作详情，满足审计和追溯需求。
