# 局域网访问故障排查指南

## 问题诊断

您遇到的"响应时间过长"问题，根本原因是：**服务需要重启以应用新的网络配置**

### 当前状态检查结果

运行 `netstat -an | grep 3000` 显示：
```
tcp4       0      0  *.3000                 *.*                    LISTEN
```

虽然看起来在监听所有接口（`*`），但所有实际连接都是：
```
tcp4       0      0  127.0.0.1.3000         127.0.0.1.60217        ESTABLISHED
```

这说明服务仍在使用旧配置（只监听 localhost）。

## 解决方案

### 步骤 1: 停止当前服务

在运行服务的终端中按 `Ctrl + C` 停止服务，或者：

```bash
# 查找 Node 进程
lsof -i :3000

# 强制停止（如果需要）
kill -9 5487  # 替换为实际的 PID
```

### 步骤 2: 确认配置正确

检查 `package.json` 中的配置：
```json
"dev": "next dev -H 0.0.0.0"
```

检查 `.env.local` 中的配置：
```env
MINIO_ENDPOINT=10.1.65.48
MINIO_PRIMARY_ENDPOINT=http://10.1.65.48:9000
```

### 步骤 3: 重新启动服务

```bash
cd /Users/yangguang/Desktop/EHS/EHS-system
npm run dev
```

### 步骤 4: 验证服务正在监听正确的地址

启动后，在新终端中运行：

```bash
netstat -an | grep 3000
```

**正确的输出应该显示：**
```
tcp4       0      0  *.3000                 *.*                    LISTEN
tcp6       0      0  *.3000                 *.*                    LISTEN
```

或者使用 lsof 查看：
```bash
lsof -i :3000
```

应该看到类似：
```
node    XXXX yangguang   17u  IPv6 ...  TCP *:hbci (LISTEN)
node    XXXX yangguang   18u  IPv4 ...  TCP *:hbci (LISTEN)
```

### 步骤 5: 从本机测试局域网 IP 访问

```bash
curl http://10.1.65.48:3000
```

如果返回 HTML 内容，说明配置成功。

### 步骤 6: 从其他电脑测试

在局域网内的其他电脑上：

**Windows 上：**
```cmd
curl http://10.1.65.48:3000
```

或在浏览器中直接访问：`http://10.1.65.48:3000`

**macOS/Linux 上：**
```bash
curl http://10.1.65.48:3000
```

## 如果仍然无法访问

### 检查 1: macOS 防火墙设置

即使您关闭了防火墙，有时系统防火墙规则仍然存在。

```bash
# 检查防火墙状态
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 列出所有防火墙规则
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --listapps

# 完全禁用防火墙（需要管理员权限）
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off
```

### 检查 2: macOS 隐私设置

在"系统偏好设置" > "安全性与隐私" > "防火墙"中：
1. 点击左下角的锁图标解锁
2. 如果防火墙已开启，点击"防火墙选项"
3. 确保 Node.js 或您的开发工具不在阻止列表中
4. 或者临时关闭防火墙测试

### 检查 3: 网络连接测试

从其他电脑测试网络连通性：

```bash
# 测试是否可以 ping 通
ping 10.1.65.48

# 测试 3000 端口是否可达
telnet 10.1.65.48 3000

# 或使用 nc (netcat)
nc -zv 10.1.65.48 3000
```

### 检查 4: 路由器/交换机设置

某些企业网络可能有：
- **AP 隔离**：阻止同一网络中的设备互相通信
- **VLAN 隔离**：不同网段的设备无法通信
- **访问控制列表 (ACL)**：限制特定端口或协议

联系网络管理员确认这些设置。

### 检查 5: MinIO 服务

确保 MinIO 也在监听正确的地址：

```bash
# 检查 MinIO 进程
ps aux | grep minio

# 检查 MinIO 端口
lsof -i :9000
lsof -i :9001
```

## 快速重启脚本

创建 `restart-lan-server.sh` 脚本：

```bash
#!/bin/bash

echo "正在停止现有服务..."
pkill -f "next dev"

echo "等待端口释放..."
sleep 2

echo "检查当前 IP 地址..."
IP=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | head -1)
echo "本机 IP: $IP"

echo "启动服务（监听所有接口）..."
cd /Users/yangguang/Desktop/EHS/EHS-system
npm run dev &

echo "等待服务启动..."
sleep 5

echo "验证服务状态..."
lsof -i :3000

echo ""
echo "========================================="
echo "服务已启动！"
echo "本机访问: http://localhost:3000"
echo "局域网访问: http://$IP:3000"
echo "========================================="
```

使用方法：
```bash
chmod +x restart-lan-server.sh
./restart-lan-server.sh
```

## 完整检查清单

- [ ] 停止旧服务进程
- [ ] 确认 package.json 配置为 `next dev -H 0.0.0.0`
- [ ] 确认 .env.local 中 MINIO_ENDPOINT 为局域网 IP
- [ ] 重新启动服务
- [ ] 验证服务监听在 `*:3000` 而不是 `127.0.0.1:3000`
- [ ] 从本机测试 `curl http://10.1.65.48:3000`
- [ ] 关闭或配置防火墙
- [ ] 从其他电脑测试 ping 和端口连接
- [ ] 确认没有网络隔离（AP 隔离、VLAN 等）
- [ ] 检查 MinIO 服务状态

## 常见错误和解决方法

### 错误 1: "连接被拒绝"
**原因**: 防火墙阻止
**解决**: 关闭防火墙或添加规则

### 错误 2: "响应时间过长"
**原因**: 服务未监听正确地址或网络隔离
**解决**: 重启服务，确认监听 0.0.0.0

### 错误 3: "无法访问此网站"
**原因**: IP 地址错误或设备不在同一网络
**解决**: 确认 IP 地址和网络连接

### 错误 4: "ERR_CONNECTION_TIMED_OUT"
**原因**: 路由器 AP 隔离或防火墙
**解决**: 检查路由器设置

## 调试技巧

### 1. 实时查看服务日志
```bash
# 在服务运行的终端查看输出
# 应该看到类似：
# ▲ Next.js 16.0.10
# - Local:        http://localhost:3000
# - Network:      http://10.1.65.48:3000
```

### 2. 使用 tcpdump 捕获网络包
```bash
# 捕获 3000 端口的流量
sudo tcpdump -i any port 3000 -n
```

### 3. 检查系统日志
```bash
# macOS 系统日志
log show --predicate 'process == "socketfilterfw"' --last 1h
```

## 成功标志

当一切正常时，您应该看到：

1. **服务启动信息：**
   ```
   ▲ Next.js 16.0.10
   - Local:        http://localhost:3000
   - Network:      http://10.1.65.48:3000
   ```

2. **netstat 输出：**
   ```
   tcp4       0      0  *.3000                 *.*                    LISTEN
   ```

3. **从其他电脑访问成功：**
   浏览器中访问 `http://10.1.65.48:3000` 能看到登录页面

## 需要帮助？

如果按照以上步骤仍无法解决，请提供：
1. `lsof -i :3000` 的完整输出
2. `netstat -an | grep 3000` 的完整输出
3. 服务启动时的终端输出
4. 从其他电脑 ping 和 telnet 测试的结果
5. 防火墙状态和规则
