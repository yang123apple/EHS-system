# ğŸ” å¯†ç ä¿®æ”¹åŠŸèƒ½ - å¿«é€Ÿå¼€å§‹

## âœ… å·²å®Œæˆçš„å®ç°

### 1ï¸âƒ£ **æ ¸å¿ƒæ–‡ä»¶**
```
âœ… src/schemas/index.ts                    - Zod éªŒè¯æ¨¡å¼
âœ… src/actions/settings.ts                 - Server Actionï¼ˆå¯†ç ä¿®æ”¹é€»è¾‘ï¼‰
âœ… src/components/auth/change-password-form.tsx - UI è¡¨å•ç»„ä»¶
âœ… src/app/settings/password/page.tsx     - ç¤ºä¾‹é¡µé¢
âœ… scripts/migrate-passwords.ts            - å¯†ç è¿ç§»è„šæœ¬
```

### 2ï¸âƒ£ **ä¾èµ–åŒ…**
```json
âœ… bcryptjs - å¯†ç åŠ å¯†
âœ… @types/bcryptjs - TypeScript ç±»å‹
âœ… zod - æ•°æ®éªŒè¯
âœ… react-hook-form - è¡¨å•ç®¡ç†
âœ… @hookform/resolvers - Zod é›†æˆ
```

---

## ğŸš€ ç«‹å³ä½¿ç”¨

### æ–¹å¼ä¸€ï¼šè®¿é—®å¯†ç ä¿®æ”¹é¡µé¢

å¯åŠ¨å¼€å‘æœåŠ¡å™¨åï¼Œè®¿é—®ï¼š
```
http://localhost:3000/settings/password
```

### æ–¹å¼äºŒï¼šåœ¨ä»»æ„é¡µé¢ä½¿ç”¨ç»„ä»¶

```tsx
import { ChangePasswordForm } from '@/components/auth/change-password-form';

export default function MyPage() {
  return (
    <div>
      <h1>æˆ‘çš„è®¾ç½®</h1>
      <ChangePasswordForm />
    </div>
  );
}
```

---

## âš™ï¸ é‡è¦ï¼šæ•°æ®åº“è¿ç§»

**å¦‚æœæ‚¨çš„æ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯æ˜æ–‡å¯†ç ï¼Œå¿…é¡»å…ˆè¿è¡Œè¿ç§»è„šæœ¬ï¼**

### æ­¥éª¤ 1: æµ‹è¯•åŠ å¯†åŠŸèƒ½
```powershell
npx tsx scripts/migrate-passwords.ts --test
```

### æ­¥éª¤ 2: æŸ¥çœ‹å¸®åŠ©
```powershell
npx tsx scripts/migrate-passwords.ts --help
```

### æ­¥éª¤ 3: æ‰§è¡Œè¿ç§»
```powershell
npx tsx scripts/migrate-passwords.ts
```

è¿ç§»è„šæœ¬ä¼šï¼š
- âœ… è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼ˆ`backups/passwords-backup-*.json`ï¼‰
- âœ… å°†æ‰€æœ‰æ˜æ–‡å¯†ç è½¬æ¢ä¸º bcrypt å“ˆå¸Œ
- âœ… è·³è¿‡å·²åŠ å¯†çš„å¯†ç 
- âœ… æ˜¾ç¤ºè¯¦ç»†è¿›åº¦å’Œç»Ÿè®¡

---

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```powershell
npm run dev
```

### 2. è®¿é—®æµ‹è¯•é¡µé¢
```
http://localhost:3000/settings/password
```

### 3. æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æ“ä½œ | é¢„æœŸç»“æœ |
|------|------|----------|
| âœ… æ­£å¸¸ä¿®æ”¹ | è¾“å…¥æ­£ç¡®çš„å½“å‰å¯†ç å’Œæœ‰æ•ˆçš„æ–°å¯†ç  | æˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ |
| âŒ å½“å‰å¯†ç é”™è¯¯ | è¾“å…¥é”™è¯¯çš„å½“å‰å¯†ç  | å¤±è´¥ï¼Œæ˜¾ç¤º"å½“å‰å¯†ç ä¸æ­£ç¡®" |
| âŒ æ–°å¯†ç å¤ªçŸ­ | æ–°å¯†ç å°‘äº8å­—ç¬¦ | å¤±è´¥ï¼Œæ˜¾ç¤º"æ–°å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦" |
| âŒ å¯†ç ä¸ä¸€è‡´ | æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ | å¤±è´¥ï¼Œæ˜¾ç¤º"ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´" |
| âŒ æ–°æ—§ç›¸åŒ | æ–°å¯†ç ä¸å½“å‰å¯†ç ç›¸åŒ | å¤±è´¥ï¼Œæ˜¾ç¤º"æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ" |

---

## ğŸ“‹ é›†æˆåˆ°ç°æœ‰é¡µé¢

### åœ¨è®¾ç½®èœå•ä¸­æ·»åŠ å…¥å£

```tsx
// src/components/SettingsMenu.tsx
export function SettingsMenu() {
  return (
    <nav>
      <a href="/settings/profile">ä¸ªäººèµ„æ–™</a>
      <a href="/settings/password">ä¿®æ”¹å¯†ç </a>  {/* æ–°å¢ */}
      <a href="/settings/notifications">é€šçŸ¥è®¾ç½®</a>
    </nav>
  );
}
```

### åœ¨ç”¨æˆ·ä¸‹æ‹‰èœå•ä¸­æ·»åŠ 

```tsx
// src/components/UserDropdown.tsx
export function UserDropdown() {
  return (
    <div className="dropdown">
      <button>ç”¨æˆ·èœå•</button>
      <div className="menu">
        <a href="/profile">æˆ‘çš„èµ„æ–™</a>
        <a href="/settings/password">ä¿®æ”¹å¯†ç </a>  {/* æ–°å¢ */}
        <button onClick={logout}>é€€å‡ºç™»å½•</button>
      </div>
    </div>
  );
}
```

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### âœ… å·²å®ç°çš„å®‰å…¨æªæ–½

1. **æœåŠ¡ç«¯éªŒè¯**
   - ä»æœåŠ¡ç«¯ headers è·å–ç”¨æˆ·IDï¼ˆä¸ä¿¡ä»»å®¢æˆ·ç«¯ï¼‰
   - ä½¿ç”¨ bcrypt åŠ å¯†ï¼ˆå¼ºåº¦10ï¼‰
   - éªŒè¯å½“å‰å¯†ç æ­£ç¡®æ€§

2. **å®¢æˆ·ç«¯éªŒè¯**
   - æœ€å°é•¿åº¦ 8 å­—ç¬¦
   - å¯†ç å¿…é¡»ä¸€è‡´
   - æ–°æ—§å¯†ç ä¸èƒ½ç›¸åŒ

3. **é”™è¯¯å¤„ç†**
   - ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
   - å…·ä½“çš„é”™è¯¯æç¤º
   - æ—¥å¿—è®°å½•

### ğŸ”§ ç”Ÿäº§ç¯å¢ƒå»ºè®®

```typescript
// å»ºè®®æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆéœ€å®‰è£… @upstash/ratelimitï¼‰
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(5, "1 h"),
});

export async function changePassword(values: ChangePasswordInput) {
  const userId = await getCurrentUserId();
  
  const { success } = await ratelimit.limit(userId);
  if (!success) {
    return { success: false, error: 'æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·1å°æ—¶åå†è¯•' };
  }
  
  // ... å…¶ä½™ä»£ç 
}
```

---

## ğŸ¨ è‡ªå®šä¹‰æ ·å¼

### ä¿®æ”¹è¡¨å•æ ·å¼

```tsx
// ä¿®æ”¹ src/components/auth/change-password-form.tsx

<div className="max-w-md w-full mx-auto">
  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 shadow-xl rounded-2xl border-2 border-blue-200 p-8">
    {/* è¡¨å•å†…å®¹ */}
  </div>
</div>
```

### ä½¿ç”¨æ‚¨çš„ UI ç»„ä»¶åº“

```tsx
// ä½¿ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„ Button ç»„ä»¶
import { Button } from '@/components/ui/button';

<Button
  type="submit"
  disabled={isPending}
  variant="default"
  size="lg"
>
  {isPending ? 'æäº¤ä¸­...' : 'ä¿®æ”¹å¯†ç '}
</Button>
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: "æœªæˆæƒï¼šè¯·å…ˆç™»å½•"

**åŸå› **ï¼šServer Action æ— æ³•è·å–ç”¨æˆ·ID

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆlocalStorage ä¸­æœ‰ç”¨æˆ·ä¿¡æ¯ï¼‰
2. ç¡®è®¤è¯·æ±‚åŒ…å« `x-user-id` header
3. æŸ¥çœ‹ `src/lib/apiClient.ts` ä¸­çš„ `apiFetch` å®ç°

### Q2: "å½“å‰å¯†ç ä¸æ­£ç¡®"ï¼ˆä½†å¯†ç ç¡®å®æ­£ç¡®ï¼‰

**åŸå› **ï¼šæ•°æ®åº“å¯†ç æ ¼å¼é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# è¿è¡Œè¿ç§»è„šæœ¬
npx tsx scripts/migrate-passwords.ts
```

### Q3: è¡¨å•æäº¤åæ— ååº”

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯
2. ç¡®è®¤ `'use server'` æŒ‡ä»¤åœ¨ Server Action æ–‡ä»¶é¡¶éƒ¨
3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦å‘é€

### Q4: ç±»å‹é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# é‡æ–°ç”Ÿæˆ Prisma Client
npm run postinstall
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´å®ç°æ–‡æ¡£](./å¯†ç ä¿®æ”¹åŠŸèƒ½å®ç°æ–‡æ¡£.md) - è¯¦ç»†çš„æŠ€æœ¯è¯´æ˜
- [Next.js Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations)
- [Zod æ–‡æ¡£](https://zod.dev/)
- [bcryptjs GitHub](https://github.com/dcodeIO/bcrypt.js)

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå‰ï¼š

- [ ] è¿è¡Œå¯†ç è¿ç§»è„šæœ¬
- [ ] æµ‹è¯•æ‰€æœ‰åŠŸèƒ½åœºæ™¯
- [ ] æ·»åŠ é€Ÿç‡é™åˆ¶
- [ ] å¯ç”¨ HTTPS
- [ ] é…ç½®ç¯å¢ƒå˜é‡
- [ ] è®¾ç½®æ—¥å¿—ç›‘æ§
- [ ] å¤‡ä»½æ•°æ®åº“

---

## ğŸ’¡ ä¸‹ä¸€æ­¥

1. **å¼ºåˆ¶å¯†ç å¤æ‚åº¦**ï¼šæ·»åŠ æ›´ä¸¥æ ¼çš„å¯†ç è§„åˆ™
2. **å¯†ç å†å²**ï¼šé˜²æ­¢é‡å¤ä½¿ç”¨æœ€è¿‘çš„å¯†ç 
3. **é‚®ä»¶é€šçŸ¥**ï¼šå¯†ç ä¿®æ”¹åå‘é€é€šçŸ¥é‚®ä»¶
4. **ä¸¤æ­¥éªŒè¯**ï¼šå¢å¼ºè´¦æˆ·å®‰å…¨æ€§
5. **å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨**ï¼šå®æ—¶æ˜¾ç¤ºå¯†ç å¼ºåº¦

---

## ğŸ‰ å®Œæˆï¼

å¯†ç ä¿®æ”¹åŠŸèƒ½å·²ç»å¯ä»¥ä½¿ç”¨äº†ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- [å®Œæ•´æ–‡æ¡£](./å¯†ç ä¿®æ”¹åŠŸèƒ½å®ç°æ–‡æ¡£.md)
- ä»£ç æ³¨é‡Š
- æ§åˆ¶å°æ—¥å¿—

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸš€
