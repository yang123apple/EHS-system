# æ“ä½œæ—¥å¿—ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿé›†æˆ

> **âš ï¸ é‡è¦**ï¼šä½¿ç”¨ä¸šåŠ¡ç¼–å·è€Œéæ•°æ®åº“ID
> 
> `targetId` å¿…é¡»ä½¿ç”¨ä¸šåŠ¡ç³»ç»Ÿçš„ç¼–å·ï¼ˆå¦‚ `HZ-2024-001`ï¼‰ï¼Œä¸è¦ä½¿ç”¨æ•°æ®åº“IDï¼
> 
> è¯¦è§ï¼š[æ“ä½œæ—¥å¿—-ä¸šåŠ¡ç¼–å·è§„èŒƒ.md](./æ“ä½œæ—¥å¿—-ä¸šåŠ¡ç¼–å·è§„èŒƒ.md)

### 1. æ•°æ®åº“å·²æ›´æ–° âœ…

æ•°æ®åº“è¿ç§»å·²è‡ªåŠ¨æ‰§è¡Œï¼ŒSystemLogè¡¨å·²åŒ…å«æ‰€æœ‰æ–°å­—æ®µã€‚

### 2. åŸºç¡€ä½¿ç”¨ - è®°å½•æ“ä½œæ—¥å¿—

#### æ–¹å¼1ï¼šä½¿ç”¨ ActivityLoggerï¼ˆæ¨èï¼‰

```typescript
import { ActivityLogger, Modules } from '@/utils/activityLogger';

// åœ¨APIè·¯ç”±ä¸­è®°å½•æ—¥å¿—
export async function POST(request: NextRequest) {
  const user = await getUser(request); // è·å–å½“å‰ç”¨æˆ·
  
  // åˆ›å»ºè®°å½•
  const newRecord = await prisma.hazardRecord.create({ data: ... });
  
  // è®°å½•æ—¥å¿—ï¼ˆè‡ªåŠ¨è·å–ç”¨æˆ·å¿«ç…§ï¼‰
  await ActivityLogger.logCreate({
    userId: user.id,
    module: Modules.HAZARD,      // æ¨¡å—å
    targetType: 'hazard',         // å¯¹è±¡ç±»å‹
    targetId: newRecord.code,     // âš ï¸ ä½¿ç”¨ä¸šåŠ¡ç¼–å·ï¼ˆéšæ‚£ç¼–å·ï¼‰ï¼Œä¸æ˜¯æ•°æ®åº“ID
    targetLabel: newRecord.desc?.substring(0, 50),  // éšæ‚£æè¿°ï¼ˆå¯é€‰ï¼‰
    data: newRecord,              // æ•°æ®å¿«ç…§
    roleInAction: 'ä¸ŠæŠ¥äºº',       // â­ æ–°å¢:ç”¨æˆ·åœ¨æœ¬æ¬¡æ“ä½œä¸­çš„ä¸šåŠ¡è§’è‰²
    request,                      // NextRequestå¯¹è±¡
  });
  
  return NextResponse.json({ success: true, data: newRecord });
}
```

#### æ–¹å¼2ï¼šè®°å½•æ›´æ–°æ“ä½œï¼ˆè‡ªåŠ¨å¯¹æ¯”å˜æ›´ï¼‰

```typescript
// è·å–æ›´æ–°å‰çš„æ•°æ®
const beforeData = await prisma.hazardRecord.findUnique({ 
  where: { id } 
});

// æ‰§è¡Œæ›´æ–°
const afterData = await prisma.hazardRecord.update({ 
  where: { id }, 
  data: updateData 
});

// è®°å½•æ—¥å¿—ï¼ˆè‡ªåŠ¨å¯¹æ¯”å˜æ›´ï¼‰
await ActivityLogger.logUpdate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: afterData.code,       // âš ï¸ ä½¿ç”¨ä¸šåŠ¡ç¼–å·
  targetLabel: afterData.desc?.substring(0, 50),
  beforeData,
  afterData,
  fieldLabels: {          // å­—æ®µä¸­æ–‡åæ˜ å°„ï¼ˆå¯é€‰ï¼‰
    status: 'çŠ¶æ€',
    desc: 'æè¿°',
    level: 'ç­‰çº§',
  },
  request,
});
```

### 3. æŸ¥çœ‹æ“ä½œæ—¥å¿—

#### åœ¨é¡µé¢ä¸­é›†æˆæ—¥å¿—æŸ¥çœ‹å™¨

```typescript
import ActivityLogViewer from '@/components/ActivityLogViewer';

export default function MyPage() {
  return (
    <div>
      {/* æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿— */}
      <ActivityLogViewer />
      
      {/* æˆ–è€…åªæ˜¾ç¤ºç‰¹å®šå¯¹è±¡çš„æ—¥å¿— */}
      <ActivityLogViewer 
        targetType="hazard"
        targetId="xxx"
      />
    </div>
  );
}
```

## ğŸ“ å¸¸ç”¨æ“ä½œç±»å‹

```typescript
// åˆ›å»º
await ActivityLogger.logCreate({ ... });

// æ›´æ–°
await ActivityLogger.logUpdate({ ... });

// åˆ é™¤
await ActivityLogger.logDelete({ ... });

// å®¡æ‰¹
await ActivityLogger.logApproval({ 
  action: 'APPROVE', // æˆ– 'REJECT'
  ... 
});

// å¯¼å‡º
await ActivityLogger.logExport({ ... });

// å¯¼å…¥
await ActivityLogger.logImport({ ... });
```

## ğŸ¯ æ—¥å¿—ä¼šè‡ªåŠ¨è®°å½•

- âœ… ç”¨æˆ·èº«ä»½ï¼ˆå§“åã€è§’è‰²ã€éƒ¨é—¨ã€èŒä½ï¼‰ - **è‡ªåŠ¨è·å–**
- âœ… æ“ä½œæ—¶é—´ - **è‡ªåŠ¨è®°å½•**
- âœ… IPåœ°å€ - **ä»requestè‡ªåŠ¨æå–**
- âœ… å­—æ®µå˜æ›´ - **è‡ªåŠ¨å¯¹æ¯”**ï¼ˆè°ƒç”¨logUpdateæ—¶ï¼‰

## ğŸ” æŸ¥è¯¢æ—¥å¿—

```typescript
// APIæŸ¥è¯¢
GET /api/logs?module=hazard&action=CREATE&page=1&limit=20

// æ”¯æŒçš„ç­›é€‰å‚æ•°ï¼š
// - module: æ¨¡å—ï¼ˆhazard, document, permitç­‰ï¼‰
// - targetType: å¯¹è±¡ç±»å‹
// - action: æ“ä½œç±»å‹
// - userId: ç”¨æˆ·ID
// - startDate: å¼€å§‹æ—¥æœŸ
// - endDate: ç»“æŸæ—¥æœŸ
```

## ğŸ“š å®Œæ•´æ–‡æ¡£

æŸ¥çœ‹ä»¥ä¸‹æ–‡æ¡£äº†è§£æ›´å¤šï¼š

- **æ“ä½œæ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md** - å®Œæ•´APIæ–‡æ¡£
- **æ“ä½œæ—¥å¿—é›†æˆç¤ºä¾‹.md** - è¯¦ç»†é›†æˆç¤ºä¾‹
- **æ“ä½œæ—¥å¿—ç³»ç»Ÿä¼˜åŒ–æ€»ç»“.md** - ç³»ç»ŸåŠŸèƒ½æ€»ç»“

## âš¡ æœ€ä½³å®è·µ

1. **å§‹ç»ˆè®°å½•ç”¨æˆ·æ“ä½œ**ï¼šåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ã€å®¡æ‰¹ç­‰
2. **æä¾›å­—æ®µæ ‡ç­¾æ˜ å°„**ï¼šä½¿å˜æ›´è®°å½•æ›´æ˜“è¯»
3. **ä½¿ç”¨æ¨¡å—å¸¸é‡**ï¼š`Modules.HAZARD`, `Modules.DOCUMENT`ç­‰
4. **æ‰¹é‡æ“ä½œä½¿ç”¨æ‰¹é‡æ–¹æ³•**ï¼š`SystemLogService.createBatchLogs()`
5. **å®šæœŸæ¸…ç†æ—§æ—¥å¿—**ï¼š`SystemLogService.cleanOldLogs(90)`

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨å¯ä»¥åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨å®Œæ•´çš„æ“ä½œæ—¥å¿—åŠŸèƒ½äº†ï¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---
æ›´æ–°æ—¶é—´ï¼š2026-01-02
