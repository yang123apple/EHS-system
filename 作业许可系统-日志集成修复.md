# ä½œä¸šè®¸å¯ç³»ç»Ÿæ—¥å¿—é›†æˆ - ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜æè¿°
ç”¨æˆ·åœ¨ä½œä¸šè®¸å¯ç³»ç»Ÿä¸­æ–°å»ºäº†å·¥ç¨‹ï¼Œä½†è¿™ä¸ªè®°å½•å¹¶æ²¡æœ‰è¢«æ—¥å¿—ç³»ç»Ÿè®°å½•ä¸‹æ¥ã€‚

## ğŸ› æ ¹æœ¬åŸå› 
ä½œä¸šè®¸å¯ç›¸å…³APIä½¿ç”¨çš„æ˜¯æ—§çš„ `createLog` å‡½æ•°ï¼Œä½†è°ƒç”¨æ—¶**ç¼ºå°‘å…³é”®å‚æ•°**ï¼š
- ç¼ºå°‘ `targetType` å‚æ•°
- ç¼ºå°‘ `module` å‚æ•°ï¼ˆé»˜è®¤ä½¿ç”¨'SYSTEM'ï¼‰

è¿™å¯¼è‡´æ—¥å¿—è®°å½•åˆ°æ•°æ®åº“æ—¶ï¼Œ`module` å­—æ®µä¸º `'SYSTEM'`ï¼Œè€Œå‰ç«¯æŸ¥è¯¢æ—¶ä½¿ç”¨ `targetType: 'permit'` æˆ– `module: 'WORK_PERMIT'`ï¼Œæ— æ³•åŒ¹é…åˆ°æ•°æ®ã€‚

## âœ… å·²ä¿®å¤çš„æ–‡ä»¶

### 1. å·¥ç¨‹é¡¹ç›®ç®¡ç† (`src/app/api/projects/route.ts`)
ä¿®å¤äº†é¡¹ç›®çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ“ä½œçš„æ—¥å¿—è®°å½•ï¼š

```typescript
// åˆ›å»ºé¡¹ç›®
createLog(
  userId,
  userName,
  'CREATE',
  newProject.id,
  `åˆ›å»ºå·¥ç¨‹é¡¹ç›®: ${name}`,
  'project',        // âœ… æ·»åŠ  targetType
  'WORK_PERMIT'     // âœ… æ·»åŠ  module
);

// æ›´æ–°é¡¹ç›®
createLog(
  userId,
  userName,
  'UPDATE',
  id,
  'æ›´æ–°å·¥ç¨‹é¡¹ç›®ä¿¡æ¯',
  'project',
  'WORK_PERMIT'
);

// åˆ é™¤é¡¹ç›®
createLog(
  userId,
  userName,
  'DELETE',
  id,
  'åˆ é™¤å·¥ç¨‹é¡¹ç›®',
  'project',
  'WORK_PERMIT'
);
```

### 2. ä½œä¸šè®¸å¯è®°å½• (`src/app/api/permits/route.ts`)
ä¿®å¤äº†ä½œä¸šç¥¨çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼š

```typescript
// åˆ›å»ºä½œä¸šç¥¨
createLog(
  userId,
  userName,
  'CREATE',
  newRecord.id,
  `åˆ›å»ºä½œä¸šç¥¨è®°å½• - é¡¹ç›®ID: ${projectId}`,
  'permit',         // âœ… æ·»åŠ  targetType
  'WORK_PERMIT'     // âœ… æ·»åŠ  module
);

// æ›´æ–°ä½œä¸šç¥¨
createLog(
  userId,
  userName,
  'UPDATE',
  id,
  'æ›´æ–°ä½œä¸šç¥¨è®°å½•',
  'permit',
  'WORK_PERMIT'
);

// åˆ é™¤ä½œä¸šç¥¨
createLog(
  userId,
  userName,
  'DELETE',
  id,
  'åˆ é™¤ä½œä¸šç¥¨è®°å½•',
  'permit',
  'WORK_PERMIT'
);
```

### 3. ä½œä¸šç¥¨å®¡æ‰¹ (`src/app/api/permits/approve/route.ts`)
ä¿®å¤äº†å®¡æ‰¹æ“ä½œçš„æ—¥å¿—è®°å½•ï¼š

```typescript
// å®¡æ‰¹æ“ä½œ
const actionType = action === 'pass' ? 'APPROVE' : 'REJECT';
createLog(
  userId, 
  userName, 
  actionType, 
  recordId, 
  `å®¡æ‰¹æ„è§: ${opinion}`,
  'permit',         // âœ… æ·»åŠ  targetType
  'WORK_PERMIT'     // âœ… æ·»åŠ  module
);
```

### 4. ä½œä¸šç¥¨æ¨¡æ¿ (`src/app/api/templates/route.ts`)
ä¿®å¤äº†æ¨¡æ¿çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼š

```typescript
// åˆ›å»ºæ¨¡æ¿
createLog(
  userId,
  userName,
  'CREATE',
  newTemplate.id,
  `åˆ›å»ºä½œä¸šç¥¨æ¨¡æ¿: ${name}`,
  'template',       // âœ… æ·»åŠ  targetType
  'WORK_PERMIT'     // âœ… æ·»åŠ  module
);

// æ›´æ–°æ¨¡æ¿
createLog(
  userId,
  userName,
  'UPDATE',
  id,
  'æ›´æ–°ä½œä¸šç¥¨æ¨¡æ¿',
  'template',
  'WORK_PERMIT'
);

// åˆ é™¤æ¨¡æ¿
createLog(
  userId,
  userName,
  'DELETE',
  id,
  'åˆ é™¤ä½œä¸šç¥¨æ¨¡æ¿',
  'template',
  'WORK_PERMIT'
);
```

## ğŸ“Š æ—¥å¿—è®°å½•è§„èŒƒ

### createLog å‡½æ•°ç­¾å
```typescript
createLog(
  userId: string | undefined,      // ç”¨æˆ·ID
  userName: string | undefined,    // ç”¨æˆ·å
  action: string,                   // æ“ä½œç±»å‹ (CREATE/UPDATE/DELETE/APPROVE/REJECT)
  targetId?: string,                // ç›®æ ‡å¯¹è±¡ID
  details?: string,                 // æ“ä½œè¯¦æƒ…
  targetType?: string,              // ç›®æ ‡å¯¹è±¡ç±»å‹ (project/permit/template)
  module: string = 'SYSTEM'         // æ¨¡å—æ ‡è¯† (WORK_PERMIT)
)
```

### æ ‡å‡†è°ƒç”¨ç¤ºä¾‹
```typescript
createLog(
  userId,
  userName,
  'CREATE',              // æ ‡å‡†æ“ä½œï¼šCREATE/UPDATE/DELETE/APPROVE/REJECT
  objectId,
  'æ“ä½œæè¿°',
  'permit',              // targetType: project/permit/template
  'WORK_PERMIT'          // module: ç»Ÿä¸€ä½¿ç”¨ WORK_PERMIT
);
```

## ğŸ¯ ä¿®å¤åçš„æ•ˆæœ

### 1. æ•°æ®åº“æ—¥å¿—è®°å½•
æ–°æ“ä½œä¼šåœ¨æ•°æ®åº“ä¸­è®°å½•å¦‚ä¸‹å­—æ®µï¼š
- `module`: 'WORK_PERMIT'
- `targetType`: 'project' / 'permit' / 'template'
- `action`: 'CREATE' / 'UPDATE' / 'DELETE' / 'APPROVE' / 'REJECT'
- `userId`, `userName`: æ“ä½œäººä¿¡æ¯
- `targetId`: æ“ä½œå¯¹è±¡ID
- `details`: æ“ä½œè¯¦æƒ…

### 2. å‰ç«¯æ—¥å¿—æŸ¥è¯¢
å‰ç«¯æŸ¥è¯¢æ—¶ä½¿ç”¨ `targetType: 'permit'`ï¼Œå¯ä»¥åŒ¹é…åˆ°ï¼š
- é¡¹ç›®æ“ä½œï¼š`targetType='project'`
- ä½œä¸šç¥¨æ“ä½œï¼š`targetType='permit'`
- æ¨¡æ¿æ“ä½œï¼š`targetType='template'`

æ‰€æœ‰è¿™äº›éƒ½å±äº `module='WORK_PERMIT'`ï¼Œéƒ½ä¼šåœ¨ä½œä¸šè®¸å¯ç³»ç»Ÿçš„æ—¥å¿—é¡µé¢æ˜¾ç¤ºã€‚

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. åˆ›å»ºæ–°å·¥ç¨‹é¡¹ç›®
2. åˆ›å»ºä½œä¸šç¥¨
3. å®¡æ‰¹ä½œä¸šç¥¨
4. æ‰“å¼€ä½œä¸šè®¸å¯ç³»ç»Ÿçš„"ç³»ç»Ÿæ—¥å¿—"é¡µé¢
5. æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰æ“ä½œè®°å½•

### é¢„æœŸç»“æœ
- âœ… åˆ›å»ºé¡¹ç›®çš„æ—¥å¿—ä¼šè¢«è®°å½•
- âœ… åˆ›å»ºä½œä¸šç¥¨çš„æ—¥å¿—ä¼šè¢«è®°å½•
- âœ… å®¡æ‰¹æ“ä½œçš„æ—¥å¿—ä¼šè¢«è®°å½•
- âœ… æ‰€æœ‰æ—¥å¿—éƒ½ä¼šåœ¨ç³»ç»Ÿæ—¥å¿—é¡µé¢æ˜¾ç¤º

### éªŒè¯æŸ¥è¯¢
è¿è¡Œæµ‹è¯•è„šæœ¬æŸ¥çœ‹æ•°æ®åº“ä¸­çš„æ—¥å¿—ï¼š
```bash
node scripts/test-log-queries.js
```

åº”è¯¥èƒ½çœ‹åˆ° `targetType='permit'` æˆ– `targetType='project'` çš„æ—¥å¿—è®°å½•ã€‚

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å†å²æ•°æ®**ï¼šä¿®å¤åªå¯¹æ–°æ“ä½œç”Ÿæ•ˆï¼Œå†å²æ—¥å¿—ï¼ˆå¦‚æœæœ‰ï¼‰å¯èƒ½ä»ç„¶ä½¿ç”¨æ—§çš„æ ¼å¼
2. **ç»Ÿä¸€æ ‡å‡†**ï¼šæ‰€æœ‰ä½œä¸šè®¸å¯ç›¸å…³æ“ä½œéƒ½ä½¿ç”¨ `module='WORK_PERMIT'`
3. **targetTypeåŒºåˆ†**ï¼š
   - `'project'` - å·¥ç¨‹é¡¹ç›®
   - `'permit'` - ä½œä¸šè®¸å¯è®°å½•
   - `'template'` - ä½œä¸šç¥¨æ¨¡æ¿

## ğŸ”„ ç›¸å…³ä¿®æ”¹

æœ¬æ¬¡ä¿®å¤ä¸ä¹‹å‰çš„æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–ä¸€è‡´ï¼š
- ä½¿ç”¨ç»Ÿä¸€çš„ `targetType` æŸ¥è¯¢å‚æ•°
- æ‰€æœ‰æ¨¡å—ä½¿ç”¨æ ‡å‡†çš„æ—¥å¿—è®°å½•æ–¹å¼
- å‰ç«¯æŸ¥è¯¢ä¸åç«¯è®°å½•ä¿æŒä¸€è‡´

**ä¿®å¤æ—¥æœŸ**: 2026å¹´1æœˆ5æ—¥
