# 或签功能测试指南

## 测试准备

### 前置条件
1. ✅ 数据库已更新（candidateHandlers字段已添加）
2. ✅ API代码已修复（序列化/反序列化）
3. ✅ 前端代码已更新（权限检查逻辑）
4. ✅ 系统已重启（确保所有修改生效）

### 测试环境
- Next.js 开发服务器已启动
- 数据库连接正常
- 至少3个测试用户账号（用于模拟多人场景）

## 测试用户准备

建议创建以下测试用户：
- **张三**：安全员A（userId: user1）
- **李四**：安全员B（userId: user2）
- **王五**：安全员C（userId: user3）

## 测试场景

### 场景1：作业管理系统 - OR模式审批

#### 1.1 配置工作流
1. 以管理员身份登录
2. 进入作业管理系统 → 模板管理
3. 选择一个模板，点击"编辑工作流"
4. 配置某个审批步骤：
   - 审批模式：选择"或签"
   - 审批人策略：固定人员
   - 添加审批人：张三、李四、王五
5. 保存工作流配置

#### 1.2 创建作业票
1. 创建新作业票
2. 填写必要信息
3. 提交作业票

#### 1.3 测试或签逻辑
**步骤1：张三审批**
- 以张三身份登录
- 打开待审批的作业票
- 应该能看到"审批"按钮
- 点击审批通过
- ✅ **预期结果**：审批成功，流程进入下一步

**步骤2：李四尝试审批**
- 以李四身份登录
- 打开同一张作业票
- ✅ **预期结果**：
  - 看不到审批按钮（或按钮为禁用状态）
  - 如果尝试审批，应显示错误："当前步骤已有其他人审批通过，无需重复审批"

**步骤3：王五尝试审批**
- 以王五身份登录
- 打开同一张作业票
- ✅ **预期结果**：同李四，无法审批

#### 1.4 检查审批日志
- 打开作业票详情
- 查看审批日志
- ✅ **预期结果**：
  - 清晰记录张三为实际审批人
  - 显示审批时间
  - 不应出现李四或王五的审批记录

### 场景2：隐患系统 - OR模式验收

#### 2.1 配置工作流
1. 以管理员身份登录
2. 进入隐患管理系统 → 工作流配置
3. 配置"验收"步骤：
   - 处理人策略：固定人员
   - 审批模式：OR（或签）
   - 添加验收人：张三、李四、王五
4. 保存配置

#### 2.2 创建并流转隐患
1. 创建新隐患（上报）
2. 指派整改责任人
3. 整改责任人提交整改
4. 隐患流转到验收步骤

#### 2.3 测试或签逻辑
**步骤1：检查候选人列表**
- 查看数据库或后台日志
- ✅ **预期结果**：
  ```json
  candidateHandlers: [
    {"userId":"user1","userName":"张三","hasOperated":false},
    {"userId":"user2","userName":"李四","hasOperated":false},
    {"userId":"user3","userName":"王五","hasOperated":false}
  ]
  ```

**步骤2：张三验收**
- 以张三身份登录
- 打开待验收的隐患
- 应该能看到"验收"按钮
- 点击验收通过
- ✅ **预期结果**：
  - 验收成功
  - 隐患状态变为"已验收"或"已闭环"
  - candidateHandlers中张三的hasOperated变为true

**步骤3：李四尝试验收**
- 以李四身份登录
- 打开同一隐患
- ✅ **预期结果**：
  - 看不到验收按钮（或按钮为禁用状态）
  - 权限检查应返回false
  - 如果尝试验收，应被阻止

**步骤4：王五尝试验收**
- 以王五身份登录
- 打开同一隐患
- ✅ **预期结果**：同李四，无法验收

#### 2.4 检查操作日志
- 打开隐患详情
- 查看操作日志
- ✅ **预期结果**：
  - 清晰记录张三为实际验收人
  - 显示验收时间和验收结果
  - 可选：显示"或签模式，候选人：张三、李四、王五"

### 场景3：边界情况测试

#### 3.1 并发操作测试
**模拟两人同时操作**
1. 张三和李四同时打开待处理的隐患/作业票
2. 两人几乎同时点击"验收/审批"按钮
3. ✅ **预期结果**：
   - 只有一个人的操作成功
   - 另一个人收到错误提示
   - 数据库中只记录一次操作

#### 3.2 权限回收测试
**验证其他候选人权限失效**
1. 张三完成操作后
2. 系统应自动更新candidateHandlers
3. ✅ **预期结果**：
   - 李四和王五的权限立即失效
   - 即使他们已经打开了页面，刷新后也无法操作

#### 3.3 流程继续测试
**验证流程正常推进**
1. 或签步骤完成后
2. 隐患/作业票应流转到下一步
3. ✅ **预期结果**：
   - candidateHandlers被清除（设为null或undefined）
   - 下一步的处理人正确设置
   - 流程状态正确更新

### 场景4：兼容性测试

#### 4.1 单人模式兼容
**配置单人处理步骤**
1. 配置某步骤只有一个处理人
2. ✅ **预期结果**：
   - 不设置candidateHandlers
   - 只使用dopersonal_ID
   - 功能正常工作

#### 4.2 AND模式兼容
**配置会签模式**
1. 配置某步骤为AND（会签）模式
2. 添加多个审批人
3. ✅ **预期结果**：
   - 所有人都必须审批
   - 使用现有的会签逻辑
   - 不使用candidateHandlers

## 测试检查点

### 前端检查
- [ ] 或签步骤显示所有候选处理人
- [ ] 第一人操作后，其他人看不到操作按钮
- [ ] 操作按钮状态正确（启用/禁用）
- [ ] 错误提示清晰明确
- [ ] 日志显示完整准确

### 后端检查
- [ ] candidateHandlers正确保存到数据库
- [ ] hasOperated正确标记
- [ ] API返回正确的数据结构
- [ ] 权限检查逻辑正确
- [ ] 并发控制有效

### 数据库检查
```sql
-- 检查candidateHandlers字段
SELECT 
  id, 
  code, 
  status,
  dopersonal_ID,
  candidateHandlers 
FROM HazardRecord 
WHERE candidateHandlers IS NOT NULL;

-- 检查操作日志
SELECT 
  logs 
FROM HazardRecord 
WHERE id = 'your_hazard_id';
```

### 日志检查
查看浏览器控制台和服务器日志：
- [ ] 🎯 标记或签模式操作人的日志
- [ ] 🔍 检查候选处理人数据的日志
- [ ] ✅ 派发成功的日志
- [ ] 📦 准备更新的数据的日志

## 常见问题排查

### 问题1：无法保存candidateHandlers
**症状**：保存时报错"服务器内部错误"
**检查**：
- 数据库schema是否已更新
- API是否正确序列化数组
- Prisma Client是否已重新生成

**解决**：
```bash
npx prisma generate
npx prisma migrate dev
```

### 问题2：权限检查不生效
**症状**：其他人仍然可以操作
**检查**：
- permissions.ts中的逻辑是否正确
- candidateHandlers是否正确传递到前端
- hasOperated标记是否正确更新

**解决**：
- 检查权限检查函数的返回值
- 在浏览器控制台打印hazard.candidateHandlers
- 确认后端正确更新了hasOperated

### 问题3：candidateHandlers为null
**症状**：查询时candidateHandlers字段为null
**检查**：
- 是否正确设置了candidateHandlers
- 是否在OR模式且有多个处理人
- useHazardWorkflow中的逻辑是否正确执行

**解决**：
- 检查派发引擎日志
- 确认审批模式配置
- 验证处理人数量

## 回归测试

### 测试现有功能不受影响
- [ ] 单人审批/验收正常
- [ ] AND模式（会签）正常
- [ ] 条件签模式正常
- [ ] 隐患流程完整流转
- [ ] 作业票流程完整流转
- [ ] 通知功能正常
- [ ] 权限控制正常

## 性能测试

### 大量候选人测试
1. 配置10个以上候选人
2. 测试性能和响应时间
3. ✅ **预期结果**：性能不受明显影响

### 历史数据兼容
1. 测试旧的隐患/作业票
2. 没有candidateHandlers字段
3. ✅ **预期结果**：功能正常，无报错

## 测试报告模板

### 测试结果记录
```
测试日期：____
测试人员：____
测试环境：开发/测试/生产

场景1：作业管理系统OR模式
- 配置工作流：✅ / ❌
- 张三审批：✅ / ❌
- 李四被阻止：✅ / ❌
- 日志记录：✅ / ❌

场景2：隐患系统OR模式
- 配置工作流：✅ / ❌
- 候选人列表：✅ / ❌
- 张三验收：✅ / ❌
- 李四被阻止：✅ / ❌
- 数据库记录：✅ / ❌

场景3：边界情况
- 并发操作：✅ / ❌
- 权限回收：✅ / ❌
- 流程继续：✅ / ❌

场景4：兼容性
- 单人模式：✅ / ❌
- AND模式：✅ / ❌

问题记录：
1. __________
2. __________

总体评价：通过 / 需要修复 / 重大问题
```

## 上线前检查清单

### 代码检查
- [ ] 所有修改已提交
- [ ] 代码已经过审查
- [ ] 无TypeScript错误
- [ ] 无ESLint警告

### 数据库检查
- [ ] Schema已更新
- [ ] Migration文件已创建
- [ ] 测试环境数据库已迁移
- [ ] 生产环境迁移脚本已准备

### 文档检查
- [ ] 用户手册已更新
- [ ] API文档已更新
- [ ] 技术文档已完善
- [ ] 操作指南已提供

### 测试检查
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 用户验收测试通过
- [ ] 性能测试通过

## 相关文档
- `或签功能修复总结.md` - 完整实现说明
- `或签功能错误修复说明.md` - 错误修复记录
- `操作日志-或签模式处理指南.md` - 或签模式指南
