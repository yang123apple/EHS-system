# 操作日志系统 - 部署检查清单

## ✅ 已完成的工作

### 1. 数据库层
- [x] 更新 SystemLog 数据模型
- [x] 添加用户快照字段
- [x] 添加操作详情字段
- [x] 添加数据库索引
- [x] 执行数据库迁移
- [x] 重新生成 Prisma Client

### 2. 服务层
- [x] 优化 SystemLogService
- [x] 添加 getUserSnapshot 方法
- [x] 添加 compareObjects 方法
- [x] 支持批量日志记录
- [x] 添加日志清理功能

### 3. 工具层
- [x] 创建 ActivityLogger 工具类
- [x] 提供便捷的日志记录方法
- [x] 定义操作类型常量
- [x] 定义模块常量
- [x] 创建日志中间件

### 4. API层
- [x] 更新日志查询API
- [x] 支持新字段查询
- [x] 支持module筛选
- [x] 自动解析JSON字段

### 5. UI层
- [x] 创建 ActivityLogViewer 组件
- [x] 支持字段变更展示
- [x] 支持数据快照查看
- [x] 支持筛选和分页
- [x] 支持导出功能

### 6. 文档
- [x] 快速开始文档
- [x] 完整使用指南
- [x] 集成示例文档
- [x] 文件索引
- [x] 项目总结
- [x] README文档

## 🚀 部署前检查

### 必须完成
- [x] 数据库迁移已执行
- [x] Prisma Client已重新生成
- [x] TypeScript编译通过（除了原有的错误）
- [ ] **需要集成到具体业务模块**（见下方）

### 可选优化
- [ ] 创建字段标签映射文件
- [ ] 添加定时清理任务
- [ ] 更新现有日志记录代码
- [ ] 在系统菜单中添加日志查看入口

## 📋 业务模块集成清单

以下模块需要集成操作日志系统：

### 隐患管理模块
- [ ] 隐患上报 - 使用 `ActivityLogger.logCreate()`
- [ ] 隐患派发 - 使用 `ActivityLogger.logUpdate()` 或 `logAction()`
- [ ] 隐患整改 - 使用 `ActivityLogger.logAction()`
- [ ] 隐患验收 - 使用 `ActivityLogger.logApproval()`
- [ ] 隐患关闭 - 使用 `ActivityLogger.logAction()`
- [ ] 隐患导出 - 使用 `ActivityLogger.logExport()`
- [ ] 批量导入 - 使用 `ActivityLogger.logImport()`

### 文档管理模块
- [ ] 文档创建 - 使用 `ActivityLogger.logCreate()`
- [ ] 文档修改 - 使用 `ActivityLogger.logUpdate()`
- [ ] 文档删除 - 使用 `ActivityLogger.logDelete()`
- [ ] 文档下载 - 使用 `ActivityLogger.logAction()`
- [ ] 文档导出 - 使用 `ActivityLogger.logExport()`

### 作业许可模块
- [ ] 许可证创建 - 使用 `ActivityLogger.logCreate()`
- [ ] 许可证审批 - 使用 `ActivityLogger.logApproval()`
- [ ] 许可证更新 - 使用 `ActivityLogger.logUpdate()`
- [ ] 许可证导出 - 使用 `ActivityLogger.logExport()`

### 培训管理模块
- [ ] 培训任务创建 - 使用 `ActivityLogger.logCreate()`
- [ ] 培训材料上传 - 使用 `ActivityLogger.logAction()`
- [ ] 培训完成 - 使用 `ActivityLogger.logAction()`
- [ ] 培训记录导出 - 使用 `ActivityLogger.logExport()`

### 用户管理模块
- [ ] 用户登录 - 使用 `ActivityLogger.logLogin()`
- [ ] 用户注销 - 使用 `ActivityLogger.logAction()`
- [ ] 用户创建 - 使用 `ActivityLogger.logCreate()`
- [ ] 用户修改 - 使用 `ActivityLogger.logUpdate()`
- [ ] 用户删除 - 使用 `ActivityLogger.logDelete()`
- [ ] 密码修改 - 使用 `ActivityLogger.logAction()`

### 组织架构模块
- [ ] 部门创建 - 使用 `ActivityLogger.logCreate()`
- [ ] 部门修改 - 使用 `ActivityLogger.logUpdate()`
- [ ] 部门删除 - 使用 `ActivityLogger.logDelete()`
- [ ] 批量导入 - 使用 `ActivityLogger.logImport()`

## 🔧 集成步骤（以隐患上报为例）

### 1. 在API路由中添加日志记录

```typescript
// src/app/api/hazards/route.ts
import { ActivityLogger, Modules } from '@/utils/activityLogger';

export async function POST(request: NextRequest) {
  const user = await getUser(request);
  
  // 创建隐患记录
  const hazard = await prisma.hazardRecord.create({ data: ... });
  
  // 记录操作日志
  await ActivityLogger.logCreate({
    userId: user.id,
    module: Modules.HAZARD,
    targetType: 'hazard',
    targetId: hazard.id,
    targetLabel: `隐患 ${hazard.code}`,
    data: hazard,
    request,
  });
  
  return NextResponse.json({ success: true, data: hazard });
}
```

### 2. 在详情页添加日志查看

```typescript
// src/app/hazards/[id]/page.tsx
import ActivityLogViewer from '@/components/ActivityLogViewer';

export default function HazardDetailPage({ params }) {
  return (
    <div>
      {/* 隐患详情 */}
      <div>...</div>
      
      {/* 操作日志 */}
      <div className="mt-6">
        <h2 className="text-lg font-bold mb-4">操作日志</h2>
        <ActivityLogViewer 
          targetType="hazard"
          targetId={params.id}
          showFilters={false}
        />
      </div>
    </div>
  );
}
```

### 3. 测试验证

- [ ] 创建一条测试记录，检查日志是否生成
- [ ] 修改记录，检查变更对比是否正确
- [ ] 删除记录，检查日志是否记录
- [ ] 在详情页查看日志，检查UI显示

## 📊 系统管理页面

建议创建一个系统日志管理页面：

```typescript
// src/app/admin/logs/page.tsx
import ActivityLogViewer from '@/components/ActivityLogViewer';

export default function SystemLogsPage() {
  return (
    <div className="h-screen flex flex-col p-6">
      <h1 className="text-2xl font-bold mb-6">系统操作日志</h1>
      <ActivityLogViewer showFilters={true} pageSize={50} />
    </div>
  );
}
```

并在系统菜单中添加入口：

```typescript
// 在导航菜单中添加
{
  name: '系统日志',
  path: '/admin/logs',
  icon: Activity,
  permission: 'admin',
}
```

## 🎯 字段标签映射

建议创建字段标签映射文件：

```typescript
// src/utils/fieldLabels.ts
export const HazardFieldLabels = {
  code: '隐患编号',
  desc: '隐患描述',
  level: '风险等级',
  status: '状态',
  location: '位置',
  reporterId: '上报人',
  responsibleId: '责任人',
  deadline: '整改期限',
  // ...
};

export const DocumentFieldLabels = {
  title: '标题',
  content: '内容',
  category: '分类',
  // ...
};

// ... 其他模块的字段标签
```

## ⏰ 定时任务

建议添加定时清理任务：

```typescript
// scripts/cleanup-logs.ts
import { SystemLogService } from '@/services/systemLog.service';

async function cleanupLogs() {
  console.log('开始清理90天前的日志...');
  const result = await SystemLogService.cleanOldLogs(90);
  console.log(`清理完成，删除了 ${result.count} 条日志`);
}

cleanupLogs();
```

可以通过cron或任务调度器定期执行。

## ✨ 验证测试

### 基础功能测试
- [ ] 创建操作日志记录
- [ ] 更新操作日志记录（带变更对比）
- [ ] 删除操作日志记录
- [ ] 查询日志列表
- [ ] 按模块筛选
- [ ] 按时间筛选
- [ ] 按用户筛选
- [ ] 导出日志CSV

### UI测试
- [ ] 日志列表正常展示
- [ ] 字段变更对比正确显示
- [ ] 数据快照可以查看
- [ ] 筛选功能正常
- [ ] 分页功能正常
- [ ] 导出功能正常

### 性能测试
- [ ] 批量操作性能正常
- [ ] 日志查询速度正常
- [ ] 不影响主业务性能

## 📞 问题排查

如遇到问题，请检查：

1. **日志未记录**
   - 检查用户ID是否正确
   - 查看控制台是否有错误
   - 确认数据库连接正常

2. **变更对比不准确**
   - 确保 beforeData 和 afterData 格式一致
   - 检查字段标签映射是否正确

3. **UI显示异常**
   - 检查API返回的数据格式
   - 确认JSON字段正确解析

## 🎉 部署完成标志

当以下条件都满足时，表示部署完成：

- [x] 数据库迁移成功
- [x] 代码编译通过
- [ ] 至少一个业务模块已集成
- [ ] 日志可以正常记录和查看
- [ ] 测试验证通过

## 📚 参考资料

- [操作日志快速开始.md](./操作日志快速开始.md)
- [操作日志系统使用指南.md](./操作日志系统使用指南.md)
- [操作日志集成示例.md](./操作日志集成示例.md)
- [操作日志系统-文件索引.md](./操作日志系统-文件索引.md)

---

**检查日期**: 2026-01-02  
**检查人**: ___________  
**状态**: 🟡 待集成业务模块
