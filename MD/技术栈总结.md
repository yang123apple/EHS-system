# EHS 系统技术栈总结

## 项目概述
**项目名称**: Hytzer EHS System (环境、健康与安全管理系统)  
**版本**: 1.0  
**开发语言**: TypeScript  
**架构模式**: 存算分离、策略分级

---

## 核心技术栈

### 前端框架
- **Next.js**: `^16.0.10` - React 全栈框架，支持 SSR/SSG
- **React**: `19.2.1` - UI 库
- **React DOM**: `19.2.1` - React DOM 渲染
- **React Compiler**: `babel-plugin-react-compiler@1.0.0` - React 编译器优化

### 编程语言
- **TypeScript**: `^5` - 类型安全的 JavaScript 超集
- **Node.js**: 运行时环境（通过 Next.js）

---

## 样式与 UI

### CSS 框架
- **Tailwind CSS**: `^4.1.17` - 实用优先的 CSS 框架
- **PostCSS**: `^8.5.6` - CSS 后处理器
- **Autoprefixer**: `^10.4.23` - 自动添加 CSS 浏览器前缀
- **@tailwindcss/postcss**: `^4.1.17` - Tailwind CSS PostCSS 插件

### UI 组件库
- **Lucide React**: `^0.556.0` - 图标库
- **class-variance-authority**: `^0.7.1` - 组件变体管理
- **clsx**: `^2.1.1` - 条件类名工具
- **tailwind-merge**: `^3.4.0` - Tailwind 类名合并工具
- **@radix-ui/react-dialog**: `^1.1.15` - 对话框组件
- **@radix-ui/react-scroll-area**: `^1.2.10` - 滚动区域组件

### 字体
- **Inter** (Google Fonts) - 通过 Next.js 字体优化加载

---

## 数据库与 ORM

### ORM
- **Prisma**: `^5.22.0` - 现代数据库 ORM
- **@prisma/client**: `^5.22.0` - Prisma 客户端

### 数据库
- **SQLite**: 开发环境数据库（`dev.db`），支持 WAL 模式增量备份
- **PostgreSQL**: 生产环境支持（通过 `@prisma/adapter-pg@^7.1.0` 和 `pg@^8.16.3`）

### 数据库模型
项目包含以下主要数据模型：
- **用户与组织**: User（用户）、Department（部门）
- **作业许可**: Project（项目）、WorkPermitTemplate（模板）、WorkPermitRecord（记录）、SubPermit（子表单）
- **隐患管理**: HazardRecord（隐患记录）、HazardConfig（配置）、HazardExtension（延期记录）
- **事故事件**: Incident（事故事件）
- **培训系统**: TrainingMaterial（培训材料）、TrainingTask（培训任务）、TrainingAssignment（任务分配）、ExamQuestion（考试题目）、AutoAssignRule（自动派发规则）
- **文档管理**: Document（文档）、DocumentHistory（版本历史）、Tag（标签）
- **系统功能**: SystemLog（系统日志）、Notification（通知）、NotificationTemplate（通知模板）
- **AI 功能**: AIApiConfig（AI API 配置）、AIApiLog（调用日志）、AIApiRateLimit（限流策略）
- **备份系统**: FileMetadata（文件元数据，用于增量备份）
- **电子签名**: SignatureRecord（电子签名记录，支持作业许可、隐患、事故）
- **档案库系统**: Equipment（设备档案）、ArchiveFile（档案文件）、ArchiveConfig（档案配置）

---

## 文件处理库

### 文档处理
- **mammoth**: `^1.11.0` - Word (.docx) 文档转 HTML
- **xlsx**: `^0.18.5` - Excel 文件读写
- **pdf-lib**: `^1.17.1` - PDF 文件生成和操作

### 数据导入导出
- **papaparse**: `^5.5.3` - CSV 文件解析
- **jschardet**: `^3.1.4` - 字符编码检测

### 文件压缩与归档
- **archiver**: `^7.0.1` - 文件压缩（tar.gz）
- **unzipper**: `^0.12.3` - ZIP 文件解压

---

## 工具库

### 搜索与匹配
- **fuse.js**: `^7.1.0` - 模糊搜索库

### 环境配置
- **dotenv**: `^17.2.3` - 环境变量管理

### 表单处理
- **react-hook-form**: `^7.69.0` - React 表单管理
- **@hookform/resolvers**: `^5.2.2` - 表单验证解析器
- **zod**: `^4.3.4` - 模式验证库

### 安全与加密
- **bcryptjs**: `^3.0.3` - 密码加密

### 任务队列
- **bullmq**: `^5.66.4` - Redis 任务队列
- **ioredis**: `^5.8.2` - Redis 客户端

### 其他工具
- **caniuse-lite**: `^1.0.30001762` - 浏览器兼容性数据

---

## 开发工具

### 代码质量
- **ESLint**: `^9.39.2` - JavaScript/TypeScript 代码检查
- **eslint-config-next**: `^16.0.8` - Next.js ESLint 配置

### 类型定义
- **@types/node**: `^20` - Node.js 类型定义
- **@types/react**: `^19` - React 类型定义
- **@types/react-dom**: `^19` - React DOM 类型定义
- **@types/papaparse**: `^5.5.2` - papaparse 类型定义

---

## 项目配置

### 构建配置
- **Next.js Config**: 启用 React Compiler 和 Turbopack
- **TypeScript Config**: 严格模式，ES2017 目标，路径别名 `@/*` → `./src/*`
- **PostCSS Config**: Tailwind CSS 和 Autoprefixer 插件

### 项目结构
```
src/
├── app/              # Next.js App Router 页面和路由
├── components/       # React 组件
│   ├── common/      # 公共组件
│   ├── ui/          # 基础 UI 组件
│   └── workflow/    # 工作流组件
├── lib/             # 工具库和 API 客户端
├── services/        # 业务服务层
├── types/           # TypeScript 类型定义
├── hooks/           # React Hooks
├── context/         # React Context
├── middleware/      # Next.js 中间件
└── utils/           # 工具函数

prisma/
├── schema.prisma    # 数据库模型定义
└── migrations/      # 数据库迁移文件
```

---

## 主要功能模块

1. **用户认证与权限管理**
   - 基于 Context API 的认证系统
   - 角色和权限控制（admin/user/manager）
   - 密码修改功能（bcrypt 加密）
   - OAuth 用户支持

2. **隐患管理系统（隐患排查治理）**
   - 隐患上报、整改、验收工作流
   - 风险等级评估（低/中/高/重大）
   - 工作流引擎（或签/会签模式）
   - 自动指派规则
   - 抄送机制
   - 延期申请（HazardExtension）
   - 应急预案管理

3. **作业许可管理**
   - 动态表单模板（Excel 模板）
   - 多级审批流程
   - 手写签名管理（电子签名记录）
   - 移动端表单支持
   - A4 打印优化
   - 子表单系统（SubPermit）
   - 动态记录型模板（追加记录）

4. **培训管理系统**
   - 培训材料管理（视频、PDF、Word）
   - 培训任务发布与分配
   - 在线考试（标准/随机模式）
   - 学习记录追踪
   - 自动派发规则（事件触发/条件规则）
   - 公共知识库

5. **文档管理系统（EHS 文档管理）**
   - 文档上传与版本管理
   - 文档搜索（全文检索）
   - 水印功能
   - 文档层级管理（1-4 级体系文件）
   - DOCX/PDF 格式支持
   - 文档标签系统（Tag）

6. **组织架构管理**
   - 部门层级管理（树形结构）
   - 用户管理（批量导入/权限分配）
   - 职位管理

7. **备份系统（存算分离架构）**
   - 数据库备份（全量 + WAL 增量）
   - 文件备份（全量 + MD5 增量）
   - 日志归档（压缩存储）
   - 自动调度（每日/每小时任务）
   - 备份统计与验证

8. **审计日志系统**
   - 操作日志记录（模块隔离）
   - 快照与差异对比
   - 业务编号规范
   - 日志归档与查询

9. **通知系统**
   - 实时通知推送
   - 通知模板管理
   - 变量占位符支持
   - 触发事件配置

10. **AI API 管理**
    - 多提供商支持（OpenAI/Azure/Custom）
    - API 调用日志
    - 限流策略（用户/部门级别）
    - 调用统计

11. **数据保护服务**
    - 数据导出/导入
    - 数据验证
    - 备份恢复
    - 核心数据恢复（从JSON文件）

12. **事故事件管理**
    - 事故上报（伤害/未遂/财产损失/环境事故）
    - 5Why分析法（直接原因/间接原因/管理原因/根本原因）
    - CAPA整改措施（纠正措施/预防措施）
    - 工作流集成（上报→调查→审批→结案）
    - 电子签名支持
    - 附件管理（照片、调查报告）

13. **EHS档案库系统**
    - 企业档案管理（基础资质、三同时、双重预防等）
    - 设备档案管理（特种设备、定检提醒）
    - 人员档案管理（一人一档、三级培训、资质证书）
    - MSDS档案管理（化学品安全技术说明书）
    - 档案配置管理（文件类型、水印设置）
    - 档案日志系统
    - 档案统计（培训覆盖率、资质证书、定检预警）

---

## 开发脚本

```json
{
  "dev": "next dev",              // 开发服务器
  "build": "next build",          // 生产构建
  "start": "next start",          // 生产服务器
  "lint": "eslint",               // 代码检查
  "postinstall": "prisma generate", // 安装后生成 Prisma 客户端
  "db:export": "node scripts/export-to-json.js",    // 导出数据库
  "db:import": "node scripts/import-from-json.js",  // 导入数据库
  "db:backup": "node scripts/export-to-json.js",    // 备份数据库
  "db:restore": "node scripts/restore-from-git.js", // 恢复数据库
  "backup:full": "node scripts/auto-backup.js",      // 完整备份
  "restore:full": "node scripts/restore-backup.js", // 完整恢复
  "backup:auto": "node scripts/auto-backup.js",     // 自动备份
  "backup:test": "node scripts/test-backup-service.js", // 测试备份服务
  "backup:test-new": "node scripts/test-new-backup-system.js", // 测试新备份系统
  "restore": "node scripts/restore-from-zip.js",    // 从 ZIP 恢复
  "test:backup-api": "node scripts/test-backup-api.js" // 测试备份 API
}
```

---

## 技术特点

1. **全栈 TypeScript**: 前后端统一使用 TypeScript，类型安全
2. **App Router**: 使用 Next.js 16 的 App Router 架构
3. **服务端渲染**: 支持 SSR 和 SSG，优化 SEO 和首屏加载
4. **组件化开发**: 高度模块化的组件架构
5. **类型安全**: Prisma ORM 提供端到端类型安全
6. **现代化 UI**: Tailwind CSS 4 + 自定义组件系统
7. **工作流引擎**: 自定义工作流引擎支持复杂业务流程（或签/会签模式）
8. **文件处理**: 支持多种文件格式（Word、Excel、PDF、CSV）
9. **存算分离**: 备份系统采用存算分离架构，结构化数据与非结构化数据分离
10. **增量备份**: 基于 WAL 和 MD5 的增量备份策略，大幅提升效率
11. **审计日志**: 完整的操作日志系统，支持快照和差异对比
12. **任务队列**: 支持 Redis 任务队列（BullMQ），处理异步任务
13. **AI 集成**: 支持多提供商 AI API，带限流和日志功能
14. **对象存储**: MinIO 对象存储集成，支持私有/公有存储桶、预签名上传
15. **电子签名**: 防篡改电子签名系统，支持数据快照和审计追踪
16. **子表单系统**: 动态记录型模板，支持追加记录和独立审批流程
17. **档案库系统**: 分类档案管理（企业/设备/人员/MSDS），支持定检提醒和一人一档
18. **事故事件管理**: 5Why分析法、CAPA整改措施、完整工作流支持

---

## 部署环境

- **开发环境**: SQLite 数据库
- **生产环境**: PostgreSQL 数据库（通过 Prisma 适配器）
- **构建工具**: Next.js 内置构建系统（支持 Turbopack）

---

## 版本信息

- **Next.js**: 16.0.10
- **React**: 19.2.1
- **TypeScript**: 5.x
- **Prisma**: 5.22.0
- **Tailwind CSS**: 4.1.17
- **Zod**: 4.3.4
- **bcryptjs**: 3.0.3
- **BullMQ**: 5.66.4
- **ioredis**: 5.8.2

---

## 备份系统架构

### 存算分离设计
- **结构化数据**（数据库）：SQLite WAL 模式，支持增量备份
- **非结构化数据**（文件）：基于 MD5 哈希的增量备份
- **日志数据**：压缩归档，体积减少 90%

### 备份策略
- **数据库全量备份**: 每日凌晨 2:00，保留 30 天
- **数据库增量备份**: 每小时，保留 7 天
- **文件全量备份**: 首次运行或手动触发，保留 30 天
- **文件增量备份**: 每日凌晨 2:30，保留 30 天
- **日志归档**: 每日凌晨 0:00，保留 180 天

---

## 新增依赖

### 对象存储
- **minio**: `^8.0.6` - MinIO 对象存储客户端

---

*最后更新: 2025年1月*

