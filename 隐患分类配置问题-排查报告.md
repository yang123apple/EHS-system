# éšæ‚£åˆ†ç±»é…ç½®é—®é¢˜ - æ’æŸ¥æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

ä¿®æ”¹äº†éšæ‚£åˆ†ç±»åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¢å¤ä¸ºé»˜è®¤å€¼ï¼ˆç«ç¾ã€çˆ†ç‚¸ã€ä¸­æ¯’ã€çª’æ¯ã€è§¦ç”µã€æœºæ¢°ä¼¤å®³ï¼‰ã€‚

## ğŸ” é—®é¢˜æ ¹å› 

### 1. æ•°æ®æœªæŒä¹…åŒ–
éšæ‚£åˆ†ç±»é…ç½®**æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“**ï¼Œå¯¼è‡´æ¯æ¬¡é‡å¯æœåŠ¡æˆ–åˆ·æ–°é¡µé¢æ—¶ï¼ŒAPI ä»æ•°æ®åº“æŸ¥è¯¢ä¸åˆ°é…ç½®ï¼Œå°±è¿”å›ç¡¬ç¼–ç çš„é»˜è®¤å€¼ã€‚

### 2. ä»£ç é€»è¾‘åˆ†æ

**API å®ç°** (`src/app/api/hazards/config/route.ts`):
```typescript
// é»˜è®¤é…ç½®ï¼ˆç¡¬ç¼–ç ï¼‰
const DEFAULT_TYPES = ['ç«ç¾', 'çˆ†ç‚¸', 'ä¸­æ¯’', 'çª’æ¯', 'è§¦ç”µ', 'æœºæ¢°ä¼¤å®³'];

export const GET = withAuth(async (req: NextRequest, context, user) => {
  // ä»æ•°æ®åº“è·å–é…ç½®
  const typesConfig = await prisma.hazardConfig.findUnique({
    where: { key: 'hazard_types' }
  });
  
  const data = {
    types: typesConfig ? JSON.parse(typesConfig.value) : DEFAULT_TYPES,
    //     â†‘ æ•°æ®åº“ä¸­æ²¡æœ‰ â†’ è¿”å›é»˜è®¤å€¼
  };
  
  return NextResponse.json(data);
});
```

### 3. æ•°æ®åº“çŠ¶æ€

**é—®é¢˜å‘ç°å‰**:
```sql
SELECT * FROM HazardConfig WHERE key = 'hazard_types';
-- ç»“æœ: 0 æ¡è®°å½•ï¼ˆé…ç½®ä¸å­˜åœ¨ï¼‰
```

**ä¿®å¤å**:
```json
{
  "id": "cmjzxr2z60000h2yg6g3nanut",
  "key": "hazard_types",
  "value": "[\"ç«ç¾\",\"çˆ†ç‚¸\",\"ä¸­æ¯’\",\"çª’æ¯\",\"è§¦ç”µ\",\"æœºæ¢°ä¼¤å®³\"]",
  "description": "éšæ‚£åˆ†ç±»é…ç½®",
  "createdAt": "2026-01-04T16:18:01.554Z",
  "updatedAt": "2026-01-04T16:18:01.554Z"
}
```

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼ˆå·²å®Œæˆï¼‰

```bash
node init-hazard-config.js
```

æ­¤è„šæœ¬ä¼šåœ¨æ•°æ®åº“ä¸­åˆ›å»ºé»˜è®¤çš„éšæ‚£åˆ†ç±»é…ç½®ã€‚

### æ–¹æ¡ˆ 2: é€šè¿‡ç®¡ç†é¡µé¢ä¿®æ”¹

1. ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥ **éšæ‚£ç®¡ç† â†’ å·¥ä½œæµé…ç½®** é¡µé¢
3. ä¿®æ”¹éšæ‚£åˆ†ç±»
4. ç‚¹å‡» **ä¿å­˜é…ç½®** æŒ‰é’®
5. ç¡®è®¤ä¿å­˜æˆåŠŸæç¤º

**é‡è¦**: å¿…é¡»ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ï¼Œé…ç½®æ‰ä¼šé€šè¿‡ POST è¯·æ±‚ä¿å­˜åˆ°æ•°æ®åº“ï¼

### æ–¹æ¡ˆ 3: æ‰‹åŠ¨æ’å…¥æ•°æ®åº“

```javascript
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

await prisma.hazardConfig.upsert({
  where: { key: 'hazard_types' },
  update: {
    value: JSON.stringify(['è‡ªå®šä¹‰ç±»å‹1', 'è‡ªå®šä¹‰ç±»å‹2']),
    updatedAt: new Date()
  },
  create: {
    key: 'hazard_types',
    value: JSON.stringify(['è‡ªå®šä¹‰ç±»å‹1', 'è‡ªå®šä¹‰ç±»å‹2']),
    description: 'éšæ‚£åˆ†ç±»é…ç½®'
  }
});
```

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. åœ¨ seed.ts ä¸­æ·»åŠ åˆå§‹åŒ–

ç¼–è¾‘ `prisma/seed.ts`ï¼Œåœ¨æœ«å°¾æ·»åŠ ï¼š

```typescript
// åˆå§‹åŒ–éšæ‚£é…ç½®
await prisma.hazardConfig.upsert({
  where: { key: 'hazard_types' },
  update: {},
  create: {
    key: 'hazard_types',
    value: JSON.stringify(['ç«ç¾', 'çˆ†ç‚¸', 'ä¸­æ¯’', 'çª’æ¯', 'è§¦ç”µ', 'æœºæ¢°ä¼¤å®³']),
    description: 'éšæ‚£åˆ†ç±»é…ç½®'
  }
});

await prisma.hazardConfig.upsert({
  where: { key: 'hazard_areas' },
  update: {},
  create: {
    key: 'hazard_areas',
    value: JSON.stringify(['æ–½å·¥ç°åœº', 'ä»“åº“', 'åŠå…¬å®¤', 'è½¦é—´', 'å…¶ä»–']),
    description: 'å‘ç°åŒºåŸŸé…ç½®'
  }
});
```

è¿è¡Œ seed:
```bash
npx prisma db seed
```

### 2. æ·»åŠ é…ç½®æ£€æŸ¥ä¸­é—´ä»¶

å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥å¿…è¦çš„é…ç½®æ˜¯å¦å­˜åœ¨ï¼š

```typescript
// src/lib/config-check.ts
export async function checkRequiredConfigs() {
  const required = ['hazard_types', 'hazard_areas'];
  
  for (const key of required) {
    const config = await prisma.hazardConfig.findUnique({ where: { key } });
    if (!config) {
      console.warn(`âš ï¸  é…ç½® ${key} ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼`);
      // è‡ªåŠ¨åˆ›å»ºé»˜è®¤é…ç½®
    }
  }
}
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **API è·¯ç”±**: `src/app/api/hazards/config/route.ts`
- **æ•°æ®åº“æ¨¡å‹**: `prisma/schema.prisma` (HazardConfig è¡¨)
- **åˆå§‹åŒ–è„šæœ¬**: `init-hazard-config.js`
- **æ£€æŸ¥è„šæœ¬**: `check-hazard-config.js`
- **å‰ç«¯é…ç½®é¡µé¢**: `src/app/hidden-danger/_components/views/WorkflowConfig.tsx`

## ğŸ§ª éªŒè¯æ­¥éª¤

1. **æ£€æŸ¥æ•°æ®åº“é…ç½®**:
   ```bash
   node check-hazard-config.js
   ```

2. **æµ‹è¯• API**:
   è®¿é—® `/api/hazards/config` æŸ¥çœ‹è¿”å›çš„é…ç½®

3. **å‰ç«¯éªŒè¯**:
   - æ‰“å¼€éšæ‚£å¡«æŠ¥é¡µé¢
   - æŸ¥çœ‹éšæ‚£ç±»å‹ä¸‹æ‹‰åˆ—è¡¨
   - åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤é…ç½®æœªå˜

4. **ä¿å­˜æµ‹è¯•**:
   - ä¿®æ”¹éšæ‚£åˆ†ç±»
   - ç‚¹å‡»ä¿å­˜
   - åˆ·æ–°é¡µé¢éªŒè¯æ˜¯å¦ä¿æŒ

## ğŸ“Š æ€»ç»“

| é¡¹ç›® | é—®é¢˜çŠ¶æ€ | ä¿®å¤çŠ¶æ€ |
|------|---------|---------|
| æ•°æ®åº“é…ç½®ç¼ºå¤± | âŒ ç¼ºå¤± | âœ… å·²ä¿®å¤ |
| é…ç½®æŒä¹…åŒ– | âŒ æœªä¿å­˜ | âœ… å·²ä¿å­˜ |
| Seed è„šæœ¬ | âš ï¸  æœªåŒ…å« | ğŸ“ å¾…æ·»åŠ  |
| å¯åŠ¨æ£€æŸ¥ | âš ï¸  æœªå®ç° | ğŸ“ å¯é€‰æ”¹è¿› |

---

**ä¿®å¤æ—¶é—´**: 2026-01-04  
**ä¿®å¤æ–¹å¼**: æ•°æ®åº“åˆå§‹åŒ–  
**é¢„é˜²æªæ–½**: å»ºè®®åœ¨ seed.ts ä¸­æ·»åŠ é…ç½®åˆå§‹åŒ–
