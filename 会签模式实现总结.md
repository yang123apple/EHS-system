# 会签（AND）模式实现总结

## 📋 概述

会签模式（AND Mode）要求所有指定的审批人都必须完成签核，才能流转到下一步骤。这与或签模式（OR Mode）不同，或签模式只需任意一人完成即可流转。

## 🎯 实现目标

1. **权限控制**：所有会签人都能看到操作按钮，但每人只能操作一次
2. **流转控制**：只有所有人都完成签核时，才流转到下一步
3. **显示优化**：UI上清晰显示所有会签人的名字，并标注"会签"标识
4. **通知功能**：当有人完成签核时，自动通知其他待签核人员

## 📊 涉及系统

### 1. 作业管理系统（Work Permit）
- ✅ workflowEngine.ts 已实现AND模式流转逻辑
- ✅ RecordDetailModal.tsx 权限检查正确（每人只能审批一次）
- ✅ 流程图显示优化（显示所有已审批人，未审批显示全部会签人）
- ✅ 审批API添加会签进度通知

### 2. 隐患管理系统（Hazard）
- ✅ 扩展类型定义，添加 `approvalMode` 字段
- ✅ 数据库迁移，添加 `approvalMode` 列
- ✅ useHazardWorkflow.ts 添加会签流转检查逻辑
- ✅ permissions.ts 权限检查支持AND模式
- ✅ HazardDetailModal 显示优化（区分会签/或签）
- ✅ 通知服务添加会签进度通知

## 🔧 技术实现

### 数据结构

#### HazardRecord 类型扩展
```typescript
interface HazardRecord {
  // ... 其他字段
  candidateHandlers?: Array<{
    userId: string;
    userName: string;
    hasOperated?: boolean; // 是否已操作
  }>;
  approvalMode?: 'OR' | 'AND' | 'CONDITIONAL'; // 审批模式
}
```

#### 数据库变更
- **迁移文件**: `20260102160003_add_approval_mode`
- **新增字段**: `HazardRecord.approvalMode` (String?, nullable)

### 核心逻辑

#### 1. 作业系统 - workflowEngine.ts
```typescript
if (approvalMode === 'AND') {
  // 获取所有应审批人
  const requiredApprovers = await resolveApprovers(...);
  
  // 构建已批准用户集合
  const approvedUserIds = new Set<string>();
  existingLogs.forEach(log => approvedUserIds.add(log.operatorId));
  approvedUserIds.add(operator.id);
  
  // 检查是否所有人都已批准
  const allApproved = requiredApprovers.every(user => 
    approvedUserIds.has(user.id)
  );
  
  if (!allApproved) {
    // 会签未完成：停留在当前步骤
    newStatus = WorkflowStatus.PENDING;
    newStepIndex = record.currentStep;
  } else {
    // 会签完成：进入下一步
    newStepIndex = record.currentStep + 1;
  }
}
```

#### 2. 隐患系统 - useHazardWorkflow.ts
```typescript
// 会签模式检查
if (hazard.candidateHandlers && hazard.approvalMode === 'AND') {
  const updatedCandidates = hazard.candidateHandlers.map(c => ({
    ...c,
    hasOperated: c.userId === user?.id ? true : c.hasOperated
  }));
  
  const allOperated = updatedCandidates.every(c => c.hasOperated);
  
  if (!allOperated) {
    shouldStayAtCurrentStep = true;
    // 停留在当前步骤，不更新状态
  }
}
```

#### 3. 权限检查 - permissions.ts
```typescript
if (hazard.candidateHandlers && hazard.approvalMode === 'AND') {
  // AND模式：每个人都可以操作，但只能操作一次
  const currentUserHandler = hazard.candidateHandlers.find(
    h => h.userId === user.id
  );
  if (currentUserHandler && currentUserHandler.hasOperated) {
    return false; // 已操作过，不能再操作
  }
}
```

### UI显示

#### 作业系统 - RecordDetailModal.tsx
```tsx
// 流程图中显示所有已审批人
const completedLogs = logs.filter(log => 
  log.stepIndex === stepNum && log.action === 'pass'
);
if (completedLogs.length > 0) {
  approverName = completedLogs
    .map(log => log.approver || '未知')
    .join('、');
} else {
  const names = potentialApprovers
    .map(u => u.userName)
    .join('、');
  approverName = approvalMode === 'AND' 
    ? `${names}（会签）` 
    : names;
}
```

#### 隐患系统 - HazardDetailModal/index.tsx
```tsx
{(hazard.candidateHandlers && hazard.candidateHandlers.length > 0) ? (
  <p className="text-slate-500">
    当前处理人（{hazard.approvalMode === 'AND' ? '会签' : '或签'}）：
    <span className="text-blue-600 font-bold ml-1">
      {hazard.candidateHandlers.map(h => h.userName).join('、')}
    </span>
  </p>
) : ...}
```

## 📬 通知功能

### 通知模板
创建了两个新的通知模板：

1. **作业系统会签进度通知** (`permit_approval_progress`)
   - 标题: `{{permit.approvalMode}}进度提醒`
   - 内容: `{{user.name}}已完成【{{permit.templateName}}】{{permit.projectName}}的签核（{{permit.stepName}}），{{permit.approvalMode}}进度：{{permit.operatedCount}}/{{permit.totalCount}}人已处理`

2. **隐患系统会签进度通知** (`hazard_approval_progress`)
   - 标题: `{{hazard.approvalMode}}进度提醒`
   - 内容: `{{user.name}}已完成隐患{{hazard.code}}的签核，{{hazard.approvalMode}}进度：{{hazard.operatedCount}}/{{hazard.totalCount}}人已处理`

### 通知服务

#### HazardNotificationService.generateApprovalProgressNotifications()
```typescript
static generateApprovalProgressNotifications(params: {
  hazard: HazardRecord;
  candidateHandlers: Array<{...}>;
  operatorId: string;
  operatorName: string;
  approvalMode: 'OR' | 'AND';
}): NotificationData[] {
  // 找出还未操作的候选人（排除当前操作人）
  const pendingUsers = candidateHandlers.filter(
    c => c.userId !== operatorId && !c.hasOperated
  );
  
  // 计算进度
  const operatedCount = candidateHandlers.filter(
    c => c.hasOperated || c.userId === operatorId
  ).length;
  const totalCount = candidateHandlers.length;
  
  // 生成通知
  return pendingUsers.map(user => ({
    userId: user.userId,
    type: 'hazard_approval_progress',
    title: `${approvalMode === 'AND' ? '会签' : '或签'}进度提醒`,
    content: `...（${operatedCount}/${totalCount}人已处理）`,
    ...
  }));
}
```

#### 作业系统审批API
在 `src/app/api/permits/approve/route.ts` 中添加：
```typescript
// 会签/或签进度通知
if (action === 'pass' && currentStepConfig) {
  const approvalMode = currentStepConfig.approvalMode || 'OR';
  
  if (approvalMode === 'OR' || approvalMode === 'AND') {
    // 获取所有审批人
    const allApprovers = await resolveApprovers(...);
    
    // 找出还未审批的人
    const pendingApprovers = allApprovers.filter(u => 
      !approvedUserIds.has(u.id)
    );
    
    if (pendingApprovers.length > 0) {
      await createPermitNotification(
        'permit_approval_progress',
        pendingIds,
        { ...context, approvalMode, operatedCount, totalCount },
        userName
      );
    }
  }
}
```

## 📁 修改文件列表

### 类型定义
- ✅ `src/types/hidden-danger.d.ts` - 添加 `approvalMode` 字段

### 数据库
- ✅ `prisma/schema.prisma` - 添加 `approvalMode` 字段
- ✅ `prisma/migrations/20260102160003_add_approval_mode/` - 数据库迁移

### 作业系统
- ✅ `src/components/work-permit/moduls/RecordDetailModal.tsx` - 显示优化
- ✅ `src/services/workflowEngine.ts` - 已有AND模式逻辑（无需修改）
- ✅ `src/app/api/permits/approve/route.ts` - 添加会签进度通知

### 隐患系统
- ✅ `src/app/hidden-danger/_hooks/useHazardWorkflow.ts` - 会签流转检查和通知
- ✅ `src/app/hidden-danger/_utils/permissions.ts` - 权限检查支持AND模式
- ✅ `src/app/hidden-danger/_components/modals/HazardDetailModal/index.tsx` - 显示优化
- ✅ `src/app/api/hazards/route.ts` - API序列化支持

### 通知系统
- ✅ `src/services/hazardNotification.service.ts` - 添加会签进度通知方法
- ✅ `scripts/init-notification-templates.ts` - 添加通知模板

## ✅ 测试场景

### 会签模式测试
1. **配置会签步骤**
   - 设置步骤的 `approvalMode` 为 `'AND'`
   - 配置多个审批人（如：张三、李四、王五）

2. **第一人审批**
   - 张三登录，能看到审批按钮
   - 张三点击"通过"
   - ✅ 验证：流程停留在当前步骤（不流转）
   - ✅ 验证：candidateHandlers 中张三的 hasOperated 标记为 true
   - ✅ 验证：李四和王五收到会签进度通知（1/3已处理）

3. **第二人审批**
   - 李四登录，能看到审批按钮
   - 李四点击"通过"
   - ✅ 验证：流程仍停留在当前步骤
   - ✅ 验证：李四的 hasOperated 标记为 true
   - ✅ 验证：王五收到通知（2/3已处理）

4. **最后一人审批**
   - 王五登录，能看到审批按钮
   - 王五点击"通过"
   - ✅ 验证：流程流转到下一步骤
   - ✅ 验证：状态更新
   - ✅ 验证：下一步审批人收到待审批通知

5. **权限验证**
   - 张三再次尝试审批
   - ✅ 验证：看不到审批按钮（已操作过）

6. **显示验证**
   - ✅ 流程图显示"张三、李四、王五（会签）"
   - ✅ 当前处理人区域显示"当前处理人（会签）：张三、李四、王五"

### 或签模式对比测试
1. 配置或签步骤（`approvalMode: 'OR'`）
2. 张三审批通过
3. ✅ 验证：立即流转到下一步（与会签不同）
4. ✅ 验证：李四收到或签进度通知（提示已有人处理）
5. ✅ 验证：李四不能再审批（或签已完成）

## 🎉 完成状态

| 任务 | 状态 |
|------|------|
| 作业系统会签权限检查 | ✅ 已完成 |
| 作业系统会签显示优化 | ✅ 已完成 |
| 作业系统会签流转逻辑 | ✅ 已完成 |
| 隐患系统会签支持 | ✅ 已完成 |
| 隐患系统会签显示优化 | ✅ 已完成 |
| 数据库迁移 | ✅ 已完成 |
| 通知模板创建 | ✅ 已完成 |
| 会签进度通知（作业） | ✅ 已完成 |
| 会签进度通知（隐患） | ✅ 已完成 |
| 文档编写 | ✅ 已完成 |

## 📝 注意事项

1. **数据库迁移**：已执行迁移 `20260102160003_add_approval_mode`，添加了 `approvalMode` 字段

2. **向后兼容**：
   - `approvalMode` 字段为可选（nullable）
   - 默认值为 `'OR'` 模式
   - 现有数据不受影响

3. **通知模板**：已通过脚本初始化，无需手动创建

4. **性能考虑**：
   - 会签检查在内存中进行，不额外查询数据库
   - 通知异步创建，不阻塞主流程

## 🚀 后续优化建议

1. **批量审批**：允许管理员代表所有会签人一次性批准
2. **审批进度可视化**：在详情页显示进度条
3. **超时提醒**：会签超过一定时间未完成，发送催办通知
4. **审批顺序**：支持顺序会签（必须按顺序审批）
5. **部分会签**：支持"N人中至少M人同意"的灵活模式

---

**文档生成时间**: 2026-01-03  
**实现版本**: v1.0  
**维护人员**: EHS System Development Team
