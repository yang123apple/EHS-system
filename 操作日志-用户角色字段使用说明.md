# 操作日志系统 - 用户角色字段使用说明

## 📋 概述

系统操作日志现已强制要求记录以下完整信息:

- ✅ **用户部门** (`userDepartment`) - 自动获取
- ✅ **用户职务** (`userJobTitle`) - 自动获取
- ✅ **用户在本次操作中的角色** (`userRoleInAction`) - **需要手动指定**
- ✅ **操作前状态 → 操作后状态** (`beforeData`, `afterData`, `changes`) - 自动对比

## 🎯 关键字段说明

### 1. `userRole` - 系统角色
- **含义**: 用户在系统中的角色(admin/user/manager等)
- **来源**: 自动从用户表获取
- **示例**: `"admin"`, `"user"`, `"manager"`

### 2. `userRoleInAction` - 业务角色 ⭐ **新增必填**
- **含义**: 用户在本次具体操作中扮演的业务角色
- **来源**: **需要在记录日志时手动指定**
- **示例**: 
  - 隐患管理: `"上报人"`, `"整改责任人"`, `"验收人"`, `"审批人"`
  - 作业票: `"申请人"`, `"审批人"`, `"监护人"`, `"作业负责人"`
  - 培训: `"培训发布人"`, `"学员"`, `"考核人"`

### 3. 状态变更
- `beforeData`: 操作前的完整数据快照
- `afterData`: 操作后的完整数据快照
- `changes`: 自动对比生成的字段变更列表

## 💡 使用示例

### 示例 1: 隐患上报

```typescript
import { ActivityLogger, Modules } from '@/utils/activityLogger';

// 用户上报隐患
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: newHazard.code,  // 使用业务编号,如 HZ-2024-001
  targetLabel: `隐患 ${newHazard.code}`,
  data: newHazard,
  roleInAction: '上报人',  // ⭐ 指定业务角色
  request,
});
```

生成的日志将包含:
```json
{
  "userName": "张三",
  "userRole": "user",           // 系统角色
  "userDepartment": "生产部",
  "userJobTitle": "班组长",
  "userRoleInAction": "上报人", // ⭐ 业务角色
  "action": "CREATE",
  "details": "上报了新隐患",
  "afterData": { ... }
}
```

### 示例 2: 隐患整改

```typescript
// 整改责任人提交整改
const beforeData = await prisma.hazardRecord.findUnique({ where: { id } });
const afterData = await prisma.hazardRecord.update({
  where: { id },
  data: {
    status: 'RECTIFIED',
    rectifiedAt: new Date(),
    rectifyDescription: '已完成整改',
    rectifyAttachments: files,
  },
});

await ActivityLogger.logUpdate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: afterData.code,
  targetLabel: `隐患 ${afterData.code}`,
  beforeData,
  afterData,
  fieldLabels: {
    status: '状态',
    rectifiedAt: '整改时间',
    rectifyDescription: '整改说明',
  },
  roleInAction: '整改责任人',  // ⭐ 指定业务角色
  request,
});
```

系统会自动:
- 对比 beforeData 和 afterData 的差异
- 生成字段变更列表(status: "待整改" → "已整改")
- 记录完整的操作前后状态

### 示例 3: 隐患验收

```typescript
// 验收人验收隐患
await ActivityLogger.logApproval({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  targetLabel: `隐患 ${hazard.code}`,
  action: 'APPROVE',  // 或 'REJECT'
  comment: '整改措施到位,验收通过',
  beforeStatus: 'RECTIFIED',
  afterStatus: 'VERIFIED',
  roleInAction: '验收人',  // ⭐ 指定业务角色
  request,
});
```

### 示例 4: 作业票审批

```typescript
// 安全管理员审批作业票
await ActivityLogger.logApproval({
  userId: user.id,
  module: Modules.PERMIT,
  targetType: 'permit',
  targetId: permit.code,
  targetLabel: `作业票 ${permit.code}`,
  action: 'APPROVE',
  comment: '符合安全要求,批准作业',
  beforeStatus: 'PENDING',
  afterStatus: 'APPROVED',
  roleInAction: '安全审批人',  // ⭐ 指定业务角色
  request,
});
```

### 示例 5: 培训任务发布

```typescript
// 培训管理员发布培训任务
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.TRAINING,
  targetType: 'training',
  targetId: task.id,
  targetLabel: `培训任务: ${task.title}`,
  data: task,
  roleInAction: '培训发布人',  // ⭐ 指定业务角色
  request,
});
```

## 📊 常见业务角色列表

### 隐患管理模块
| 操作 | roleInAction 值 |
|------|----------------|
| 上报隐患 | `"上报人"` |
| 派发隐患 | `"派发人"` |
| 接收隐患 | `"整改责任人"` |
| 提交整改 | `"整改责任人"` |
| 验收隐患 | `"验收人"` |
| 复核 | `"复核人"` |
| 关闭 | `"关闭操作人"` |

### 作业票模块
| 操作 | roleInAction 值 |
|------|----------------|
| 申请作业票 | `"申请人"` |
| 审批作业票 | `"审批人"` 或 `"安全审批人"` |
| 签发作业票 | `"签发人"` |
| 监护作业 | `"监护人"` |
| 作业负责 | `"作业负责人"` |
| 验收作业 | `"验收人"` |

### 培训模块
| 操作 | roleInAction 值 |
|------|----------------|
| 发布培训 | `"培训发布人"` |
| 参加培训 | `"学员"` |
| 完成培训 | `"学员"` |
| 考核评分 | `"考核人"` |

### 文档管理模块
| 操作 | roleInAction 值 |
|------|----------------|
| 上传文档 | `"上传人"` |
| 审核文档 | `"审核人"` |
| 归档文档 | `"归档人"` |
| 下载文档 | `"下载人"` |

## 🔍 日志查看

在 `ActivityLogViewer` 组件中,业务角色会突出显示:

```tsx
<ActivityLogViewer 
  targetType="hazard" 
  targetId="HZ-2024-001" 
/>
```

显示效果:
- 业务角色以彩色徽章形式显示: 🏷️ **上报人**
- 系统角色显示为文本: 系统角色: user
- 部门和职位也会一并显示

## ⚠️ 重要提醒

### 必须指定 roleInAction 的场景

在以下场景中,**必须**指定 `roleInAction`:

1. ✅ 所有涉及业务流程的操作(上报、派发、整改、验收等)
2. ✅ 所有审批类操作
3. ✅ 涉及多角色协作的操作

### 可选的场景

以下场景可以不指定(但建议指定):

1. 纯粹的数据导出、导入
2. 系统配置修改
3. 批量删除等管理操作

### 最佳实践

```typescript
// ❌ 不好的做法 - 缺少业务角色
await ActivityLogger.logApproval({
  userId: user.id,
  action: 'APPROVE',
  // 缺少 roleInAction
});

// ✅ 好的做法 - 明确指定业务角色
await ActivityLogger.logApproval({
  userId: user.id,
  action: 'APPROVE',
  roleInAction: '验收人',  // 明确指定
});
```

## 🎯 完整的日志记录清单

每条操作日志应包含:

- [x] **用户部门** - 自动获取
- [x] **用户职务** - 自动获取  
- [x] **系统角色** - 自动获取
- [x] **业务角色** - **手动指定** (roleInAction)
- [x] **操作类型** - 必填 (CREATE/UPDATE/DELETE等)
- [x] **操作对象** - 建议填写 (targetType, targetId, targetLabel)
- [x] **操作前状态** - 更新操作时必填 (beforeData)
- [x] **操作后状态** - 创建/更新操作时必填 (afterData)
- [x] **字段变更** - 自动生成 (changes)
- [x] **操作说明** - 建议填写 (details)
- [x] **IP地址** - 自动获取
- [x] **操作时间** - 自动记录

## 📝 迁移现有代码

如果您的代码已经在使用 ActivityLogger,只需添加 `roleInAction` 参数:

```typescript
// 原代码
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  data: hazard,
  request,
});

// 更新后 - 添加 roleInAction
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  data: hazard,
  roleInAction: '上报人',  // ⭐ 新增
  request,
});
```

所有 ActivityLogger 的方法都已支持 `roleInAction` 参数:
- `logCreate()`
- `logUpdate()`
- `logDelete()`
- `logApproval()`
- `logExport()`
- `logImport()`
- `logAction()`

## 🔗 相关文档

- [操作日志快速开始](./操作日志快速开始.md)
- [操作日志系统使用指南](./操作日志系统使用指南.md)
- [操作日志集成示例](./操作日志集成示例.md)
- [操作日志-业务编号规范](./操作日志-业务编号规范.md)

## 💬 常见问题

### Q: roleInAction 和 userRole 有什么区别?

**A:** 
- `userRole`: 用户的**系统角色**(admin/user/manager),来自用户表,表示用户在系统中的权限级别
- `roleInAction`: 用户在**本次具体操作中的业务角色**(上报人/整改人/验收人),表示用户在业务流程中的职责

例如: 一个系统角色为 `"user"` 的普通用户,可以在不同操作中担任 `"上报人"`, `"整改责任人"` 等不同的业务角色。

### Q: 如果不指定 roleInAction 会怎样?

**A:** 系统仍然可以正常记录日志,但缺少业务角色信息,不利于审计和追溯。强烈建议在所有业务操作中指定。

### Q: roleInAction 的值有固定列表吗?

**A:** 没有强制限制,但建议使用本文档中列出的标准值,保持一致性。您也可以根据业务需要自定义。

### Q: 如何批量更新现有日志?

**A:** 历史日志的 `roleInAction` 字段为空是正常的(新增字段),不影响系统运行。新的操作会自动记录该字段。

---

**最后更新**: 2026-01-03  
**版本**: v2.0
