# 操作日志 - 模块隔离实现总结

## 📋 需求
- 不同模块的操作日志应只会显示本模块的操作日志
- 系统管理 > logs 会显示所有子模块的日志

## ✅ 已完成修改

### 1. 隐患管理模块
**文件**: `src/app/hidden-danger/_components/views/SystemLogView.tsx`

```typescript
// 修改前
const params = new URLSearchParams({
  targetType: 'hazard',
  page: page.toString(),
  pageSize: pageSize.toString(),
});

// 修改后
const params = new URLSearchParams({
  module: 'HAZARD',  // 只显示隐患模块的日志
  page: page.toString(),
  pageSize: pageSize.toString(),
});
```

### 2. 文档管理模块
**文件**: `src/app/docs/_components/SystemLogModal.tsx`

```typescript
// 修改前
const params = new URLSearchParams({
  page: page.toString(),
  pageSize: pageSize.toString(),
  targetType: 'document'
});

// 修改后
const params = new URLSearchParams({
  page: page.toString(),
  pageSize: pageSize.toString(),
  module: 'DOCUMENT'  // 只显示文档模块的日志
});
```

### 3. 作业许可模块
**文件**: `src/components/work-permit/views/SystemLogView.tsx`

```typescript
// 修改前
const params = new URLSearchParams({
  page: pageNum.toString(),
  limit: limit.toString(),
});

// 修改后
const params = new URLSearchParams({
  page: pageNum.toString(),
  limit: limit.toString(),
  module: 'WORK_PERMIT'  // 只显示作业许可模块的日志
});
```

### 4. 培训管理模块
**文件**: `src/app/training/_components/SystemLogModal.tsx`

```typescript
// 修改前
const params = new URLSearchParams({
  page: page.toString(),
  pageSize: pageSize.toString(),
  targetType: 'training'
});

// 修改后
const params = new URLSearchParams({
  page: page.toString(),
  pageSize: pageSize.toString(),
  module: 'TRAINING'  // 只显示培训模块的日志
});
```

### 5. 系统管理模块
**文件**: `src/app/admin/logs/page.tsx`

**状态**: ✅ 无需修改

系统管理页面使用专门的 `/api/admin/logs` API，该API：
- 通过 `type` 参数区分登录日志（`login`）和操作日志（`operation`）
- 操作日志会显示所有非登录的日志，包含所有模块
- 不限制 `module` 参数，确保能看到所有子模块的日志

## 📊 模块与日志关系

| 模块 | 日志查询参数 | API | 说明 |
|------|------------|-----|------|
| 隐患管理 | `module=HAZARD` | `/api/logs` | 只显示隐患相关日志 |
| 文档管理 | `module=DOCUMENT` | `/api/logs` | 只显示文档相关日志 |
| 作业许可 | `module=WORK_PERMIT` | `/api/logs` | 只显示作业许可相关日志 |
| 培训管理 | `module=TRAINING` | `/api/logs` | 只显示培训相关日志 |
| 系统管理 | `type=operation` | `/api/admin/logs` | 显示所有模块的操作日志 |

## 🎯 实现原理

### 模块日志隔离
各业务模块在查询日志时，通过 `module` 参数过滤：

```typescript
// 隐患模块只查询 HAZARD 模块的日志
GET /api/logs?module=HAZARD&page=1&pageSize=20

// 文档模块只查询 DOCUMENT 模块的日志
GET /api/logs?module=DOCUMENT&page=1&pageSize=20
```

### 系统管理查看全部
系统管理使用专门的 `/api/admin/logs` API，它通过 `type` 参数区分日志类型：

```typescript
// 查看所有操作日志（排除登录日志）
GET /api/admin/logs?type=operation&page=1&limit=20

// 查看所有登录日志
GET /api/admin/logs?type=login&page=1&limit=20
```

操作日志查询逻辑（`src/app/api/admin/logs/route.ts`）：
```typescript
if (type === 'operation') {
  // 操作日志：既不是 AUTH 模块，也不包含登录相关动作
  where.AND = [
    { module: { not: LogModule.AUTH } },
    { action: { notIn: LOGIN_ACTIONS } },
  ];
}
// 不限制 module，所以会包含所有模块的操作日志
```

## 🔍 可用的日志模块

根据 `src/types/audit.ts` 的定义：

```typescript
export enum LogModule {
  /** 隐患管理系统 */
  HAZARD = 'HAZARD',
  /** 作业许可证系统 */
  WORK_PERMIT = 'WORK_PERMIT',
  /** 培训管理系统 */
  TRAINING = 'TRAINING',
  /** 文档管理系统 */
  DOCUMENT = 'DOCUMENT',
  /** 用户管理 */
  USER = 'USER',
  /** 认证授权（登录/登出） */
  AUTH = 'AUTH',
  /** 组织架构管理 */
  ORGANIZATION = 'ORGANIZATION',
  /** 系统设置 */
  SYSTEM = 'SYSTEM',
  /** 通知中心 */
  NOTIFICATION = 'NOTIFICATION',
}
```

## 🧪 测试验证

### 测试步骤
1. **隐患模块测试**
   - 打开隐患管理页面
   - 查看"系统日志"标签
   - 验证只显示隐患相关操作（上报、整改、验收等）

2. **文档模块测试**
   - 打开文档管理页面
   - 点击"查看操作日志"按钮
   - 验证只显示文档相关操作（上传、删除、下载等）

3. **作业票模块测试**
   - 打开作业许可页面
   - 切换到"系统日志"视图
   - 验证只显示作业票相关操作（创建、审批、完工等）

4. **培训模块测试**
   - 打开培训管理页面
   - 点击"操作日志"按钮
   - 验证只显示培训相关操作（创建课程、学习记录等）

5. **系统管理测试**
   - 以管理员身份登录
   - 打开"系统管理 > 日志管理"
   - 切换到"操作日志"标签
   - 验证显示所有模块的操作日志（隐患、文档、作业票、培训等）

### 预期结果
- ✅ 各模块的日志页面只显示本模块的日志
- ✅ 系统管理的操作日志标签显示所有模块的日志
- ✅ 登录日志和操作日志正确区分
- ✅ 筛选功能正常工作

## 📝 相关文件

### 修改的文件
- `src/app/hidden-danger/_components/views/SystemLogView.tsx`
- `src/app/docs/_components/SystemLogModal.tsx`
- `src/components/work-permit/views/SystemLogView.tsx`
- `src/app/training/_components/SystemLogModal.tsx`

### 相关API
- `src/app/api/logs/route.ts` - 通用日志查询API
- `src/app/api/admin/logs/route.ts` - 系统管理日志查询API
- `src/services/systemLog.service.ts` - 日志服务层

### 类型定义
- `src/types/audit.ts` - 日志模块和操作类型定义

## 🎉 完成状态

所有模块的日志查询已经正确配置：
- ✅ 隐患管理：只显示 HAZARD 模块日志
- ✅ 文档管理：只显示 DOCUMENT 模块日志
- ✅ 作业许可：只显示 WORK_PERMIT 模块日志
- ✅ 培训管理：只显示 TRAINING 模块日志
- ✅ 系统管理：显示所有模块的操作日志

**实现日期**: 2026年1月5日
