# 批量权限管理功能实现说明

## 功能概述

在账户管理页面新增了批量权限管理功能，允许管理员对全体员工、指定部门或指定人员（多选）进行权限的批量管理。

## 实现的功能

### 1. 用户选择
- ✅ **复选框选择**：每个用户行前增加复选框，支持单个选择
- ✅ **全选/取消全选**：表头提供全选复选框，一键选择/取消当前页所有用户
- ✅ **部门筛选**：在批量管理弹窗中可按部门筛选用户
- ✅ **选择状态显示**：实时显示已选择的用户数量

### 2. 批量管理按钮
- ✅ 位置：用户列表上方，选择用户后自动显示
- ✅ 显示条件：至少选择1个用户时显示
- ✅ 按钮样式：蓝色主题，带Shield图标，显示"批量管理权限"

### 3. 批量权限管理弹窗

#### 3.1 操作模式（三种）
1. **添加权限（merge）**
   - 保留用户原有权限
   - 将选中的权限添加到原有权限中
   - 适用场景：给用户增加新权限

2. **覆盖权限（overwrite）**
   - 完全替换用户原有权限
   - 用户将只拥有选中的权限
   - 适用场景：统一设置某类用户的权限

3. **移除权限（remove）**
   - 从用户原有权限中删除选中的权限
   - 保留其他未选中的权限
   - 适用场景：批量取消某些权限

#### 3.2 用户选择区域（左侧）
- ✅ 显示所有用户列表（排除admin）
- ✅ 部门筛选下拉框
- ✅ 全选/清空按钮
- ✅ 复选框选择用户
- ✅ 显示用户姓名和部门
- ✅ 支持在弹窗内调整选择

#### 3.3 权限选择区域（右侧）
- ✅ 按系统模块分组显示
- ✅ 模块级别全选功能
- ✅ 显示已选/总数（如：3/10）
- ✅ 支持的系统模块：
  - 作业许可系统（10项权限）
  - 隐患排查治理系统（7项权限）
  - EHS文档管理系统（7项权限）
  - 培训管理系统（8项权限）

#### 3.4 确认与反馈
- ✅ 操作前确认对话框，显示：
  - 影响的用户列表（最多显示5个，超出显示总数）
  - 操作模式
  - 将要修改的权限汇总
- ✅ 操作后详细反馈：
  - 成功数量
  - 失败数量及原因
  - 具体的失败用户信息

## 技术实现

### 1. 后端API
**路径**: `src/app/api/users/batch-permissions/route.ts`

```typescript
POST /api/users/batch-permissions
{
  userIds: string[],        // 用户ID数组
  permissions: {            // 权限对象
    [moduleKey]: string[]   // 模块权限数组
  },
  mode: 'merge' | 'overwrite' | 'remove'  // 操作模式
}
```

**响应**:
```typescript
{
  success: true,
  results: {
    success: string[],      // 成功的用户ID
    failed: Array<{        // 失败的用户
      userId: string,
      reason: string
    }>
  },
  message: string
}
```

**安全措施**:
- ❌ 不允许修改超级管理员（admin）权限
- ✅ 详细的错误处理和反馈
- ✅ 事务性处理，记录成功和失败

### 2. 前端组件
**路径**: `src/app/admin/account/_components/BatchPermissionModal.tsx`

**主要功能**:
- 用户选择与过滤
- 权限多选界面
- 操作模式切换
- 确认与提交
- 结果反馈

**状态管理**:
```typescript
const [mode, setMode] = useState<'overwrite' | 'merge' | 'remove'>('merge');
const [selectedPermissions, setSelectedPermissions] = useState<Record<string, string[]>>({});
const [localSelectedUsers, setLocalSelectedUsers] = useState<string[]>([]);
const [filterDepartment, setFilterDepartment] = useState('');
```

### 3. 页面集成
**路径**: `src/app/admin/account/page.tsx`

**新增功能**:
- 用户选择状态管理
- 批量管理按钮显示逻辑
- 弹窗打开/关闭控制
- 选择后刷新数据

## 使用流程

### 场景1：给EHS部门全员添加隐患上报权限

1. 在部门筛选中选择"EHS与消防部"
2. 点击"全选"按钮
3. 点击"批量管理权限"按钮
4. 选择操作模式：**添加权限**
5. 在权限区域勾选：
   - 隐患排查治理系统 → 隐患上报
   - 隐患排查治理系统 → 整改/验收隐患
6. 点击"确认执行"
7. 确认提示信息
8. 查看执行结果

### 场景2：统一设置所有操作员的基础权限

1. 在用户列表中勾选所有操作员
2. 点击"批量管理权限"
3. 选择操作模式：**覆盖权限**
4. 勾选需要的基础权限（如：作业许可系统 → 新建关联表单）
5. 确认并执行
6. 所有操作员将只拥有选中的权限，其他权限被清除

### 场景3：批量移除某个已废弃的权限

1. 选择需要修改的用户
2. 点击"批量管理权限"
3. 选择操作模式：**移除权限**
4. 勾选要移除的权限
5. 确认并执行
6. 被选中的权限将从所有用户中移除

## UI/UX 特性

### 视觉设计
- ✅ 操作模式：三色卡片（绿色-添加、橙色-覆盖、红色-移除）
- ✅ 模块分组：卡片式布局，清晰的层级结构
- ✅ 选择状态：实时显示已选数量（如：3/10）
- ✅ 提示信息：底部显示当前操作模式的说明

### 交互优化
- ✅ 智能全选：点击模块标题可全选/取消该模块所有权限
- ✅ 部门筛选：快速定位特定部门用户
- ✅ 响应式设计：适配不同屏幕尺寸
- ✅ 加载状态：提交时显示"处理中..."状态
- ✅ 禁用逻辑：未选用户或权限时禁用提交按钮

### 用户反馈
- ✅ 操作前：详细的确认对话框
- ✅ 操作中：加载动画和状态提示
- ✅ 操作后：成功/失败统计和详细错误信息
- ✅ 自动刷新：成功后自动刷新用户列表

## 权限系统结构

### 权限数据格式
```typescript
{
  permissions: {
    "work_permit": ["create_project", "approve_permit"],
    "hidden_danger": ["report", "handle"],
    "doc_sys": ["upload", "delete"],
    "training": ["create_material", "assign_task"]
  }
}
```

### 支持的系统模块
- `work_permit`: 作业许可系统
- `hidden_danger`: 隐患排查治理系统
- `doc_sys`: EHS文档管理系统
- `training`: 培训管理系统

## 注意事项

1. **超级管理员保护**：admin账户不能被批量修改
2. **操作不可撤销**：覆盖模式会永久删除原有权限
3. **部分失败处理**：即使部分用户失败，成功的修改仍会保存
4. **权限验证**：只有admin角色可以访问批量管理功能

## 未来优化建议

1. **权限模板**：预设常用权限组合，快速应用
2. **批量导入**：支持从Excel导入权限配置
3. **变更历史**：记录权限变更日志
4. **角色管理**：引入角色概念，简化权限分配
5. **权限预览**：在提交前预览每个用户的最终权限状态

## 版本信息

- 实现日期：2025-12-29
- 版本：1.0.0
- 开发者：Cline AI Assistant
