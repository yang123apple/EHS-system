# EHS系统数据恢复说明文档

## 概述

本文档说明如何从自动备份数据中恢复整个EHS系统的数据。系统提供了多种备份和恢复方式，本文档重点说明从自动备份ZIP文件中恢复所有数据的方法。

## 备份类型

系统支持以下备份类型：

1. **自动全量备份（ZIP格式）** - 推荐使用
   - 备份文件：`data/backups/full_backup_YYYY-MM-DD_HH-MM-SS.zip`
   - 包含内容：数据库文件、上传文件、配置文件、JSON数据文件
   - 创建方式：运行 `npm run backup:full` 或 `node scripts/auto-backup.js`

2. **JSON格式数据库备份**
   - 备份文件：`data/core_data/database_full.json`
   - 包含内容：所有数据库表的数据（JSON格式）
   - 创建方式：运行 `npm run backup:core` 或 `node data/core_data/backup-database-full.js`

3. **增量备份**
   - 数据库WAL文件：`data/backups/database/incremental/wal_*.wal`
   - 文件备份：`data/backups/files/full/*.tar.gz`
   - 日志备份：`data/backups/logs/archives/*.json.gz`

## 恢复方法

### 方法一：从ZIP备份文件恢复（推荐）

**适用场景：** 需要恢复完整的系统数据，包括数据库、上传文件、配置文件等。

**恢复脚本：** `data/restore-from-backup.js`

#### 使用步骤

1. **列出可用的备份文件**
   ```bash
   cd data
   node restore-from-backup.js --list
   ```
   或从项目根目录：
   ```bash
   node data/restore-from-backup.js --list
   ```

2. **选择要恢复的备份文件**
   从列表中选择一个备份文件，或直接指定备份文件路径。

3. **执行恢复**
   ```bash
   cd data
   node restore-from-backup.js backups/full_backup_2026-01-13_12-00-00.zip
   ```
   或从项目根目录：
   ```bash
   node data/restore-from-backup.js data/backups/full_backup_2026-01-13_12-00-00.zip
   ```

4. **重启应用程序**
   恢复完成后，需要重启应用程序使数据库变更生效。

#### 恢复内容

脚本会恢复以下内容：
- ✅ 数据库文件（`prisma/dev.db`）
- ✅ WAL文件（如果存在）
- ✅ 上传文件目录（`public/uploads/`）
- ✅ JSON数据文件（`data/*.json`）
- ✅ Prisma Schema（`prisma/schema.prisma`）
- ✅ 环境配置示例（`.env.sample`，注意这是脱敏版本）

#### 安全措施

- 恢复前会自动备份当前数据库到 `data/backups/pre_restore/`
- 恢复上传文件前会备份现有目录
- 如果恢复失败，可以从备份目录恢复原始数据

#### 注意事项

1. **数据覆盖警告**：恢复会覆盖现有的数据库和文件，请确保已备份重要数据
2. **应用程序停止**：恢复数据库时建议先停止应用程序
3. **配置文件**：`.env.sample` 是脱敏版本，不能直接使用，需要手动配置 `.env` 文件
4. **权限问题**：确保有足够的文件系统权限

---

### 方法二：从JSON备份恢复数据库

**适用场景：** 只需要恢复数据库数据，不需要恢复文件。

**恢复脚本：** `data/core_data/restore-database-full.js`

#### 使用步骤

1. **执行恢复**
   ```bash
   cd data/core_data
   node restore-database-full.js
   ```
   或从项目根目录：
   ```bash
   node data/core_data/restore-database-full.js
   ```

2. **选择恢复模式**
   - 输入 `y` - 清空现有数据后恢复（完全覆盖）
   - 输入 `N`（或直接回车）- 合并模式（保留现有数据，更新重复记录）

3. **重启应用程序**
   恢复完成后，需要重启应用程序。

#### 恢复内容

- ✅ 所有数据库表的数据
- ✅ 按照表的依赖关系顺序恢复
- ✅ 自动处理日期类型转换
- ✅ 智能匹配（存在则更新，不存在则创建）

详细说明请参考：`data/core_data/数据库备份说明.txt`

---

## 备份文件结构

### ZIP备份文件结构

```
full_backup_YYYY-MM-DD_HH-MM-SS.zip
├── backup_metadata.json          # 备份元数据
├── database/
│   ├── dev.db                    # 数据库主文件
│   ├── dev.db-wal                # WAL文件（如果存在）
│   └── dev.db-shm                # SHM文件（如果存在）
├── uploads/                      # 上传文件目录
│   └── ...
├── data/                         # JSON数据文件
│   ├── org.json
│   ├── users.json
│   ├── docs.json
│   └── hazard-workflow.json
└── config/
    ├── schema.prisma             # Prisma Schema
    └── .env.sample               # 环境配置示例（脱敏）
```

### JSON备份文件结构

```
database_full.json
├── metadata                      # 备份元数据
│   ├── version
│   ├── backupTime
│   ├── backupTimestamp
│   └── summary
└── data                          # 所有表的数据
    ├── user
    ├── department
    ├── project
    └── ...
```

---

## 故障排除

### 常见问题

1. **备份文件不存在**
   - 检查文件路径是否正确
   - 使用 `--list` 选项查看可用备份
   - 确认备份文件没有被移动或删除

2. **权限错误**
   - 确保有读取备份文件的权限
   - 确保有写入目标目录的权限
   - Windows系统可能需要管理员权限

3. **数据库锁定**
   - 停止应用程序后再恢复
   - 关闭所有数据库连接
   - 删除数据库锁定文件（如果存在）

4. **恢复失败**
   - 检查备份文件是否完整
   - 查看错误日志了解详细错误
   - 尝试从 `data/backups/pre_restore/` 恢复原始数据库

5. **文件冲突**
   - 恢复前手动备份重要文件
   - 使用恢复脚本的自动备份功能
   - 检查磁盘空间是否充足

### 手动恢复步骤

如果自动恢复脚本失败，可以手动恢复：

1. **恢复数据库文件**
   ```bash
   # 停止应用程序
   # 备份当前数据库
   cp prisma/dev.db prisma/dev.db.backup
   
   # 解压ZIP文件
   unzip data/backups/full_backup_*.zip -d temp_restore
   
   # 复制数据库文件
   cp temp_restore/database/dev.db prisma/dev.db
   
   # 清理临时文件
   rm -rf temp_restore
   ```

2. **恢复上传文件**
   ```bash
   # 备份现有文件
   mv public/uploads public/uploads.backup
   
   # 解压并复制
   unzip data/backups/full_backup_*.zip -d temp_restore
   cp -r temp_restore/uploads public/uploads
   
   # 清理
   rm -rf temp_restore
   ```

---

## 最佳实践

1. **定期备份**
   - 建议每天自动备份
   - 重要操作前手动备份
   - 保留多个历史备份

2. **备份验证**
   - 定期测试恢复流程
   - 验证备份文件完整性
   - 检查备份文件大小是否正常

3. **备份存储**
   - 备份到外部存储设备
   - 使用云存储服务
   - 保留离线备份

4. **恢复测试**
   - 定期进行恢复演练
   - 记录恢复时间
   - 验证数据完整性

5. **文档记录**
   - 记录备份策略
   - 记录恢复步骤
   - 保留操作日志

---

## 相关文件

- **备份脚本**
  - `scripts/auto-backup.js` - 创建ZIP格式全量备份
  - `data/core_data/backup-database-full.js` - 创建JSON格式数据库备份

- **恢复脚本**
  - `data/restore-from-backup.js` - 从ZIP备份恢复（本文档主要说明）
  - `data/core_data/restore-database-full.js` - 从JSON备份恢复数据库
  - `data/数据恢复.py` - Python恢复工具（多种恢复方式）

- **说明文档**
  - `data/数据恢复说明.md` - 本文档
  - `data/core_data/数据库备份说明.txt` - JSON备份详细说明
  - `data/README_数据恢复.txt` - Python恢复工具说明

---

## 技术支持

如遇到问题，请：
1. 查看本文档的故障排除部分
2. 检查错误日志
3. 查看备份文件元数据
4. 联系系统管理员或技术支持

---

**最后更新：** 2026-01-13  
**版本：** 1.0.0

