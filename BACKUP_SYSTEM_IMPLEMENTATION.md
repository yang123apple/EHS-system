# æ•°æ®å¤‡ä»½ä¸æ¢å¤ç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è¿°](#ç³»ç»Ÿæ¶æ„æ¦‚è¿°)
2. [å¤‡ä»½ç­–ç•¥è®¾è®¡](#å¤‡ä»½ç­–ç•¥è®¾è®¡)
3. [æ ¸å¿ƒæ¨¡å—å®ç°](#æ ¸å¿ƒæ¨¡å—å®ç°)
4. [æŠ€æœ¯åŸç†](#æŠ€æœ¯åŸç†)
5. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
6. [æ¢å¤æœºåˆ¶](#æ¢å¤æœºåˆ¶)
7. [ä»£ç ç»“æ„](#ä»£ç ç»“æ„)
8. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
9. [æ•…éšœå¤„ç†](#æ•…éšœå¤„ç†)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### è®¾è®¡ç†å¿µ

æœ¬ç³»ç»Ÿé‡‡ç”¨**å­˜ç®—åˆ†ç¦»æ¶æ„**ï¼Œå°†å¤‡ä»½è°ƒåº¦ã€æ•°æ®å¤‡ä»½ã€æ–‡ä»¶å¤‡ä»½å’Œæ—¥å¿—å½’æ¡£åˆ†ç¦»ä¸ºç‹¬ç«‹æœåŠ¡ï¼Œå®ç°ï¼š

- âœ… **æ¨¡å—åŒ–è®¾è®¡**: å„æœåŠ¡èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤
- âœ… **è‡ªåŠ¨åŒ–è°ƒåº¦**: åŸºäºæ—¶é—´è§¦å‘çš„è‡ªåŠ¨å¤‡ä»½ä»»åŠ¡
- âœ… **å¢é‡å¤‡ä»½**: å‡å°‘å­˜å‚¨ç©ºé—´å’Œå¤‡ä»½æ—¶é—´
- âœ… **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«æ•°æ®å˜åŒ–ï¼Œé¿å…æ— æ•ˆå¤‡ä»½
- âœ… **å®¹é”™æœºåˆ¶**: å¤‡ä»½å¤±è´¥ä¸å½±å“ä¸»åº”ç”¨è¿è¡Œ

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Next.js åº”ç”¨å¯åŠ¨                      â”‚
â”‚                  (instrumentation.ts)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åº”ç”¨åˆå§‹åŒ– (startup.ts)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ å¤‡ä»½è°ƒåº¦æœåŠ¡      â”‚      â”‚  MinIO æœåŠ¡      â”‚        â”‚
â”‚  â”‚ BackupScheduler  â”‚      â”‚  (å¯é€‰)          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤‡ä»½è°ƒåº¦æœåŠ¡ (BackupSchedulerService)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ•°æ®åº“å¤‡ä»½   â”‚  â”‚  æ–‡ä»¶å¤‡ä»½    â”‚  â”‚  æ—¥å¿—å½’æ¡£    â”‚  â”‚
â”‚  â”‚ Database    â”‚  â”‚  File        â”‚  â”‚  Log         â”‚  â”‚
â”‚  â”‚ Backup      â”‚  â”‚  Backup      â”‚  â”‚  Archive     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤‡ä»½å­˜å‚¨ (data/backups/)                    â”‚
â”‚  â”œâ”€â”€ database/  (æ•°æ®åº“å¤‡ä»½)                            â”‚
â”‚  â”œâ”€â”€ files/     (æ–‡ä»¶å¤‡ä»½)                              â”‚
â”‚  â””â”€â”€ logs/      (æ—¥å¿—å½’æ¡£)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¤‡ä»½ç­–ç•¥è®¾è®¡

### 1. æ•°æ®åº“å¤‡ä»½ç­–ç•¥

#### å…¨é‡å¤‡ä»½
- **é¢‘ç‡**: æ¯æ—¥å‡Œæ™¨ 02:00
- **æ–¹æ³•**: SQLite `.backup` å‘½ä»¤
- **ä¿ç•™æœŸ**: 30 å¤©
- **ä½ç½®**: `data/backups/database/full/*.db`

#### å¢é‡å¤‡ä»½
- **é¢‘ç‡**: æ¯å°æ—¶
- **æ–¹æ³•**: å¤‡ä»½ WAL (Write-Ahead Log) æ–‡ä»¶
- **ä¿ç•™æœŸ**: 7 å¤©
- **ä½ç½®**: `data/backups/database/incremental/*.db-wal`
- **åŸç†**: SQLite WAL æ¨¡å¼è®°å½•æ‰€æœ‰å†™æ“ä½œï¼Œå¤‡ä»½ WAL æ–‡ä»¶å³å¯æ¢å¤å¢é‡æ•°æ®

### 2. æ–‡ä»¶å¤‡ä»½ç­–ç•¥

#### å…¨é‡å¤‡ä»½
- **é¢‘ç‡**: é¦–æ¬¡è¿è¡Œæˆ–æ‰‹åŠ¨è§¦å‘
- **æ–¹æ³•**: æ‰«ææ‰€æœ‰æ–‡ä»¶ï¼Œè®¡ç®— MD5 å“ˆå¸Œï¼Œå»ºç«‹ç´¢å¼•
- **ä½ç½®**: `data/backups/files/full/*.zip`

#### å¢é‡å¤‡ä»½
- **é¢‘ç‡**: æ¯æ—¥å‡Œæ™¨ 02:30
- **æ–¹æ³•**: 
  1. æ‰«ææ–‡ä»¶ç›®å½•
  2. è®¡ç®—æ–‡ä»¶ MD5 å“ˆå¸Œ
  3. ä¸ç´¢å¼•å¯¹æ¯”ï¼Œè¯†åˆ«æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶
  4. åªå¤‡ä»½å˜åŒ–çš„æ–‡ä»¶
- **ä½ç½®**: `data/backups/files/incremental/*.zip`
- **ä¿ç•™æœŸ**: 30 å¤©

### 3. æ—¥å¿—å½’æ¡£ç­–ç•¥

- **é¢‘ç‡**: æ¯ 15 å¤©
- **æ–¹æ³•**: 
  1. å¯¼å‡ºè¿‡å» 15 å¤©çš„ SystemLog è®°å½•
  2. å‹ç¼©ä¸º `.gz` æ ¼å¼ï¼ˆä½“ç§¯å‡å°‘ 90%ï¼‰
  3. ä»æ•°æ®åº“åˆ é™¤å·²å½’æ¡£è®°å½•ï¼ˆä¿ç•™æœ€è¿‘ 90 å¤©ï¼‰
- **ä½ç½®**: `data/backups/logs/archives/*.json.gz`
- **ä¿ç•™æœŸ**: 10 å¹´ï¼ˆ3650 å¤©ï¼‰

---

## æ ¸å¿ƒæ¨¡å—å®ç°

### 1. å¤‡ä»½è°ƒåº¦æœåŠ¡ (BackupSchedulerService)

**æ–‡ä»¶**: `src/services/backup/backupScheduler.service.ts`

#### æ ¸å¿ƒåŠŸèƒ½

```typescript
export class BackupSchedulerService {
  private databaseBackup: DatabaseBackupService;
  private fileBackup: FileBackupService;
  private logArchive: LogArchiveService;
  private intervals: Map<string, NodeJS.Timeout>;
  private isRunning: boolean;
}
```

#### è°ƒåº¦æœºåˆ¶

1. **æ¯æ—¥ä»»åŠ¡è°ƒåº¦** (`scheduleDailyTask`)
   - è®¡ç®—åˆ°æŒ‡å®šæ—¶é—´çš„å»¶è¿Ÿ
   - ä½¿ç”¨ `setTimeout` è®¾ç½®é¦–æ¬¡æ‰§è¡Œ
   - ä½¿ç”¨ `setInterval` è®¾ç½®å‘¨æœŸæ€§æ‰§è¡Œï¼ˆ24 å°æ—¶ï¼‰

2. **å‘¨æœŸæ€§ä»»åŠ¡è°ƒåº¦** (`schedulePeriodicTask`)
   - æ”¯æŒæ¯ N å¤©æ‰§è¡Œä¸€æ¬¡
   - ç”¨äºæ—¥å¿—å½’æ¡£ï¼ˆæ¯ 15 å¤©ï¼‰

3. **æ¯å°æ—¶ä»»åŠ¡**
   - æ•°æ®åº“å¢é‡å¤‡ä»½
   - è®¡ç®—åˆ°ä¸‹ä¸€ä¸ªæ•´ç‚¹çš„å»¶è¿Ÿï¼Œç„¶åæ¯å°æ—¶æ‰§è¡Œ

#### å…³é”®ä»£ç 

```typescript
// æ¯æ—¥ä»»åŠ¡è°ƒåº¦
private scheduleDailyTask(
  name: string,
  hour: number,
  minute: number,
  handler: () => Promise<void>
): void {
  const now = new Date();
  const scheduledTime = new Date();
  scheduledTime.setHours(hour, minute, 0, 0);
  
  // å¦‚æœä»Šå¤©çš„æ‰§è¡Œæ—¶é—´å·²è¿‡ï¼Œè®¾ç½®ä¸ºæ˜å¤©
  if (scheduledTime <= now) {
    scheduledTime.setDate(scheduledTime.getDate() + 1);
  }
  
  const msUntilScheduled = scheduledTime.getTime() - now.getTime();
  
  // è®¾ç½®é¦–æ¬¡æ‰§è¡Œ
  setTimeout(async () => {
    await handler();
    // ä¹‹åæ¯å¤©æ‰§è¡Œä¸€æ¬¡
    const interval = setInterval(async () => {
      await handler();
    }, 24 * 60 * 60 * 1000);
    this.intervals.set(name, interval);
  }, msUntilScheduled);
}
```

---

### 2. æ•°æ®åº“å¤‡ä»½æœåŠ¡ (DatabaseBackupService)

**æ–‡ä»¶**: `src/services/backup/databaseBackup.service.ts`

#### å…¨é‡å¤‡ä»½å®ç°

```typescript
async performFullBackup(): Promise<BackupResult> {
  // 1. æ‰§è¡Œ WAL checkpointï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®å†™å…¥ä¸»æ•°æ®åº“
  await this.checkpointDatabase();
  
  // 2. ä½¿ç”¨ SQLite çš„ .backup å‘½ä»¤
  const backupCommand = `sqlite3 "${dbPath}" ".backup '${backupFilePath}'"`;
  await execAsync(backupCommand);
  
  // 3. è¿”å›å¤‡ä»½ç»“æœ
  return { success: true, filePath, sizeBytes, ... };
}
```

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨ SQLite åŸç”Ÿçš„ `.backup` å‘½ä»¤ï¼Œç¡®ä¿å¤‡ä»½ä¸€è‡´æ€§
- æ‰§è¡Œ `PRAGMA wal_checkpoint(TRUNCATE)` å°† WAL åˆå¹¶åˆ°ä¸»æ•°æ®åº“
- å¤‡ä»½æ–‡ä»¶åŒ…å«å®Œæ•´çš„æ•°æ®åº“çŠ¶æ€

#### å¢é‡å¤‡ä»½å®ç°

```typescript
async performIncrementalBackup(): Promise<BackupResult> {
  // 1. æ£€æŸ¥ WAL æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  const walPath = path.join(process.cwd(), 'prisma', 'dev.db-wal');
  
  if (!fs.existsSync(walPath)) {
    return { message: 'æ•°æ®åº“æœªå¯ç”¨ WAL æ¨¡å¼ï¼Œè·³è¿‡å¢é‡å¤‡ä»½' };
  }
  
  // 2. å¤åˆ¶ WAL æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•
  fs.copyFileSync(walPath, backupFilePath);
  
  return { success: true, filePath, sizeBytes, ... };
}
```

**æŠ€æœ¯è¦ç‚¹**:
- SQLite WAL æ¨¡å¼å°†æ‰€æœ‰å†™æ“ä½œè®°å½•åœ¨ `-wal` æ–‡ä»¶ä¸­
- å¤‡ä»½ WAL æ–‡ä»¶å³å¯æ•è·æ‰€æœ‰å¢é‡æ•°æ®
- æ¢å¤æ—¶ï¼ŒSQLite ä¼šè‡ªåŠ¨åº”ç”¨ WAL æ–‡ä»¶

#### WAL Checkpoint æœºåˆ¶

```typescript
private async checkpointDatabase(): Promise<void> {
  // TRUNCATE æ¨¡å¼ä¼šå°† WAL æ–‡ä»¶æˆªæ–­ä¸º 0
  // ç¡®ä¿å¤‡ä»½æ—¶ä¸éœ€è¦åŒ…å« .wal æ–‡ä»¶
  await this.prisma.$queryRaw`PRAGMA wal_checkpoint(TRUNCATE)`;
}
```

**ä½œç”¨**:
- å°† WAL æ–‡ä»¶ä¸­çš„æ›´æ”¹åˆå¹¶åˆ°ä¸»æ•°æ®åº“
- æ¸…ç©º WAL æ–‡ä»¶ï¼Œä¸ºä¸‹æ¬¡å¢é‡å¤‡ä»½åšå‡†å¤‡
- ç¡®ä¿å…¨é‡å¤‡ä»½åŒ…å«æœ€æ–°æ•°æ®

---

### 3. æ–‡ä»¶å¤‡ä»½æœåŠ¡ (FileBackupService)

**æ–‡ä»¶**: `src/services/backup/fileBackup.service.ts`

#### æ–‡ä»¶ç´¢å¼•æœºåˆ¶

```typescript
interface FileIndex {
  [filePath: string]: {
    md5: string;      // æ–‡ä»¶ MD5 å“ˆå¸Œ
    size: number;     // æ–‡ä»¶å¤§å°
    mtime: number;    // ä¿®æ”¹æ—¶é—´
  };
}
```

**ç´¢å¼•æ–‡ä»¶**: `data/file-index/index.json`

**ä½œç”¨**:
- è®°å½•æ‰€æœ‰æ–‡ä»¶çš„ MD5 å“ˆå¸Œå€¼
- ç”¨äºå¿«é€Ÿæ£€æµ‹æ–‡ä»¶å˜åŒ–
- é¿å…é‡å¤å¤‡ä»½æœªä¿®æ”¹çš„æ–‡ä»¶

#### MD5 å“ˆå¸Œè®¡ç®—

```typescript
private async calculateMD5(filePath: string): Promise<string> {
  return new Promise((resolve, reject) => {
    const hash = crypto.createHash('md5');
    const stream = fs.createReadStream(filePath);
    
    stream.on('data', (data) => hash.update(data));
    stream.on('end', () => resolve(hash.digest('hex')));
    stream.on('error', reject);
  });
}
```

**ä¼˜åŠ¿**:
- æµå¼å¤„ç†ï¼Œå†…å­˜å ç”¨å°
- MD5 å“ˆå¸Œå”¯ä¸€æ ‡è¯†æ–‡ä»¶å†…å®¹
- å³ä½¿æ–‡ä»¶åç›¸åŒï¼Œå†…å®¹å˜åŒ–ä¹Ÿèƒ½æ£€æµ‹

#### å¢é‡å¤‡ä»½æµç¨‹

```typescript
async performIncrementalBackup(): Promise<BackupResult> {
  // 1. æ‰«æç›®å½•ï¼Œè®¡ç®—å½“å‰æ–‡ä»¶å“ˆå¸Œ
  const currentIndex = await this.scanDirectory(this.uploadsDir);
  
  // 2. å¯¹æ¯”ç´¢å¼•ï¼Œæ‰¾å‡ºå˜åŒ–çš„æ–‡ä»¶
  const changedFiles = this.findChangedFiles(currentIndex);
  
  if (changedFiles.length === 0) {
    return { message: 'æ²¡æœ‰æ–‡ä»¶å˜åŒ–' };
  }
  
  // 3. åˆ›å»º ZIP å‹ç¼©åŒ…ï¼ŒåªåŒ…å«å˜åŒ–çš„æ–‡ä»¶
  const archive = archiver('zip', { zlib: { level: 9 } });
  changedFiles.forEach(file => {
    archive.file(file.path, { name: file.relativePath });
  });
  
  // 4. æ›´æ–°ç´¢å¼•
  this.fileIndex = currentIndex;
  this.saveIndex();
  
  return { success: true, filesCount: changedFiles.length, ... };
}
```

**æ™ºèƒ½æ£€æµ‹**:
- æ–°å¢æ–‡ä»¶: ç´¢å¼•ä¸­ä¸å­˜åœ¨
- ä¿®æ”¹æ–‡ä»¶: MD5 å“ˆå¸Œä¸åŒ¹é…
- åˆ é™¤æ–‡ä»¶: ç´¢å¼•ä¸­å­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨ï¼ˆä¸å¤‡ä»½ï¼Œä»…æ›´æ–°ç´¢å¼•ï¼‰

---

### 4. æ—¥å¿—å½’æ¡£æœåŠ¡ (LogArchiveService)

**æ–‡ä»¶**: `src/services/backup/logArchive.service.ts`

#### å½’æ¡£æµç¨‹

```typescript
async archiveLogsByDate(targetDate: Date): Promise<ArchiveResult> {
  // 1. æŸ¥è¯¢æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰æ—¥å¿—
  const logs = await this.prisma.systemLog.findMany({
    where: {
      createdAt: {
        gte: startOfDay,
        lte: endOfDay,
      },
    },
  });
  
  // 2. å¯¼å‡ºä¸º JSON
  const jsonContent = JSON.stringify(logs, null, 2);
  fs.writeFileSync(jsonFilePath, jsonContent, 'utf-8');
  
  // 3. å‹ç¼©ä¸º .gz
  const input = fs.createReadStream(jsonFilePath);
  const output = fs.createWriteStream(gzFilePath);
  const gzip = createGzip();
  await pipeline(input, gzip, output);
  
  // 4. åˆ é™¤ JSON æ–‡ä»¶ï¼Œä¿ç•™å‹ç¼©æ–‡ä»¶
  fs.unlinkSync(jsonFilePath);
  
  // 5. ä»æ•°æ®åº“åˆ é™¤å·²å½’æ¡£çš„è®°å½•
  await this.prisma.systemLog.deleteMany({
    where: { createdAt: { gte: startOfDay, lte: endOfDay } },
  });
  
  return { success: true, ... };
}
```

**å‹ç¼©æ•ˆæœ**:
- JSON æ ¼å¼: åŸå§‹å¤§å°
- GZIP å‹ç¼©: ä½“ç§¯å‡å°‘çº¦ 90%
- èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œæé«˜ä¼ è¾“æ•ˆç‡

---

## æŠ€æœ¯åŸç†

### 1. SQLite WAL æ¨¡å¼

#### å·¥ä½œåŸç†

SQLite çš„ Write-Ahead Logging (WAL) æ¨¡å¼æ˜¯ä¸€ç§æ—¥å¿—è®°å½•æœºåˆ¶ï¼š

1. **å†™æ“ä½œ**: æ‰€æœ‰å†™æ“ä½œå…ˆå†™å…¥ `-wal` æ–‡ä»¶
2. **è¯»æ“ä½œ**: åŒæ—¶è¯»å–ä¸»æ•°æ®åº“å’Œ WAL æ–‡ä»¶
3. **Checkpoint**: å®šæœŸå°† WAL åˆå¹¶åˆ°ä¸»æ•°æ®åº“

#### å¤‡ä»½ä¼˜åŠ¿

- **å¢é‡å¤‡ä»½**: åªéœ€å¤‡ä»½ WAL æ–‡ä»¶å³å¯æ•è·æ‰€æœ‰å¢é‡æ•°æ®
- **åœ¨çº¿å¤‡ä»½**: å¤‡ä»½æ—¶æ•°æ®åº“å¯ä»¥ç»§ç»­è¿è¡Œ
- **ä¸€è‡´æ€§**: WAL æ–‡ä»¶ä¿è¯æ•°æ®ä¸€è‡´æ€§

#### æ¢å¤æœºåˆ¶

```typescript
// æ¢å¤æ­¥éª¤
1. æ¢å¤å…¨é‡å¤‡ä»½: cp backup.db prisma/dev.db
2. åº”ç”¨å¢é‡å¤‡ä»½: cp backup.db-wal prisma/dev.db-wal
3. å¯åŠ¨åº”ç”¨: SQLite è‡ªåŠ¨åº”ç”¨ WAL æ–‡ä»¶
4. æ‰§è¡Œ checkpoint: PRAGMA wal_checkpoint(TRUNCATE)
```

### 2. MD5 å“ˆå¸Œæ–‡ä»¶æ£€æµ‹

#### ä¸ºä»€ä¹ˆä½¿ç”¨ MD5ï¼Ÿ

- **å”¯ä¸€æ€§**: ç›¸åŒå†…å®¹äº§ç”Ÿç›¸åŒå“ˆå¸Œ
- **å¿«é€Ÿ**: è®¡ç®—é€Ÿåº¦å¿«ï¼Œé€‚åˆå¤§é‡æ–‡ä»¶
- **å¯é æ€§**: å†…å®¹å˜åŒ–å¿…ç„¶å¯¼è‡´å“ˆå¸Œå˜åŒ–

#### æ£€æµ‹ç®—æ³•

```typescript
// ä¼ªä»£ç 
for each file in directory:
  currentMD5 = calculateMD5(file)
  if file not in index:
    // æ–°æ–‡ä»¶
    add to backup
  else if currentMD5 != index[file].md5:
    // æ–‡ä»¶è¢«ä¿®æ”¹
    add to backup
  else:
    // æ–‡ä»¶æœªå˜åŒ–
    skip
```

### 3. æ—¶é—´è°ƒåº¦ç®—æ³•

#### è®¡ç®—å»¶è¿Ÿ

```typescript
// è®¡ç®—åˆ°ä¸‹ä¸€ä¸ªæ‰§è¡Œæ—¶é—´çš„å»¶è¿Ÿ
const now = new Date();
const scheduledTime = new Date();
scheduledTime.setHours(hour, minute, 0, 0);

// å¦‚æœä»Šå¤©çš„æ—¶é—´å·²è¿‡ï¼Œè®¾ç½®ä¸ºæ˜å¤©
if (scheduledTime <= now) {
  scheduledTime.setDate(scheduledTime.getDate() + 1);
}

const msUntilScheduled = scheduledTime.getTime() - now.getTime();
```

#### å‘¨æœŸæ€§æ‰§è¡Œ

```typescript
// é¦–æ¬¡æ‰§è¡Œ
setTimeout(() => {
  handler();
  // ä¹‹åæ¯ N å¤©æ‰§è¡Œä¸€æ¬¡
  setInterval(handler, days * 24 * 60 * 60 * 1000);
}, msUntilScheduled);
```

---

## å·¥ä½œæµç¨‹

### 1. åº”ç”¨å¯åŠ¨æµç¨‹

```
1. Next.js å¯åŠ¨
   â†“
2. instrumentation.ts æ‰§è¡Œ
   â†“
3. è°ƒç”¨ initializeApp()
   â†“
4. åˆ›å»º BackupSchedulerService
   â†“
5. è°ƒç”¨ scheduler.start()
   â†“
6. è°ƒåº¦æ‰€æœ‰å¤‡ä»½ä»»åŠ¡
   â”œâ”€â”€ æ—¥å¿—å½’æ¡£ï¼ˆæ¯15å¤©ï¼‰
   â”œâ”€â”€ æ•°æ®åº“å…¨é‡å¤‡ä»½ï¼ˆæ¯æ—¥02:00ï¼‰
   â”œâ”€â”€ æ–‡ä»¶å¢é‡å¤‡ä»½ï¼ˆæ¯æ—¥02:30ï¼‰
   â””â”€â”€ æ•°æ®åº“å¢é‡å¤‡ä»½ï¼ˆæ¯å°æ—¶ï¼‰
```

### 2. æ•°æ®åº“å…¨é‡å¤‡ä»½æµç¨‹

```
1. è°ƒåº¦å™¨è§¦å‘ï¼ˆæ¯æ—¥02:00ï¼‰
   â†“
2. æ‰§è¡Œ WAL checkpoint
   â†“
3. ä½¿ç”¨ sqlite3 .backup å‘½ä»¤å¤‡ä»½
   â†“
4. ä¿å­˜åˆ° data/backups/database/full/
   â†“
5. æ¸…ç†è¿‡æœŸå¤‡ä»½ï¼ˆ>30å¤©ï¼‰
```

### 3. æ•°æ®åº“å¢é‡å¤‡ä»½æµç¨‹

```
1. è°ƒåº¦å™¨è§¦å‘ï¼ˆæ¯å°æ—¶ï¼‰
   â†“
2. æ£€æŸ¥ WAL æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   â†“
3. å¦‚æœå­˜åœ¨ï¼Œå¤åˆ¶ WAL æ–‡ä»¶
   â†“
4. ä¿å­˜åˆ° data/backups/database/incremental/
   â†“
5. æ¸…ç†è¿‡æœŸå¤‡ä»½ï¼ˆ>7å¤©ï¼‰
```

### 4. æ–‡ä»¶å¢é‡å¤‡ä»½æµç¨‹

```
1. è°ƒåº¦å™¨è§¦å‘ï¼ˆæ¯æ—¥02:30ï¼‰
   â†“
2. æ‰«æä¸Šä¼ ç›®å½•
   â†“
3. è®¡ç®—æ–‡ä»¶ MD5 å“ˆå¸Œ
   â†“
4. ä¸ç´¢å¼•å¯¹æ¯”ï¼Œæ‰¾å‡ºå˜åŒ–æ–‡ä»¶
   â†“
5. å¦‚æœæ— å˜åŒ–ï¼Œè¿”å›"æ— éœ€æ›´æ–°"
   â†“
6. å¦‚æœæœ‰å˜åŒ–ï¼Œåˆ›å»º ZIP å‹ç¼©åŒ…
   â†“
7. æ›´æ–°æ–‡ä»¶ç´¢å¼•
   â†“
8. æ¸…ç†è¿‡æœŸå¤‡ä»½ï¼ˆ>30å¤©ï¼‰
```

### 5. æ—¥å¿—å½’æ¡£æµç¨‹

```
1. è°ƒåº¦å™¨è§¦å‘ï¼ˆæ¯15å¤©ï¼‰
   â†“
2. æŸ¥è¯¢è¿‡å»15å¤©çš„æ—¥å¿—
   â†“
3. å¯¼å‡ºä¸º JSON æ–‡ä»¶
   â†“
4. å‹ç¼©ä¸º .gz æ ¼å¼
   â†“
5. ä»æ•°æ®åº“åˆ é™¤å·²å½’æ¡£è®°å½•
   â†“
6. æ¸…ç†è¿‡æœŸå½’æ¡£ï¼ˆ>10å¹´ï¼‰
```

---

## æ¢å¤æœºåˆ¶

### 1. å…¨é‡æ¢å¤

**è„šæœ¬**: `scripts/restore-backup.js`

**æµç¨‹**:
```
1. åˆ—å‡ºå¯ç”¨å¤‡ä»½
   â†“
2. ç”¨æˆ·é€‰æ‹©å¤‡ä»½æ–‡ä»¶
   â†“
3. è§£å‹ ZIP æ–‡ä»¶
   â†“
4. æ¢å¤æ•°æ®åº“æ–‡ä»¶
   â”œâ”€â”€ å¤‡ä»½å½“å‰æ•°æ®åº“
   â”œâ”€â”€ å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ° prisma/dev.db
   â””â”€â”€ åˆ é™¤ WAL/SHM æ–‡ä»¶
   â†“
5. æ¢å¤ä¸Šä¼ æ–‡ä»¶
   â”œâ”€â”€ å¤‡ä»½å½“å‰ä¸Šä¼ ç›®å½•
   â””â”€â”€ å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ° public/uploads/
   â†“
6. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

### 2. æ•°æ®åº“å¢é‡æ¢å¤

**è„šæœ¬**: `scripts/restore-database-incremental.js`

**æµç¨‹**:
```
1. æ¢å¤å…¨é‡å¤‡ä»½
   â†“
2. æŒ‰æ—¶é—´é¡ºåºåº”ç”¨å¢é‡å¤‡ä»½
   â”œâ”€â”€ å¤åˆ¶ WAL æ–‡ä»¶åˆ° prisma/dev.db-wal
   â””â”€â”€ SQLite è‡ªåŠ¨åº”ç”¨
   â†“
3. æ‰§è¡Œ checkpoint
   â””â”€â”€ PRAGMA wal_checkpoint(TRUNCATE)
```

### 3. æ–‡ä»¶å¢é‡æ¢å¤

**æµç¨‹**:
```
1. æ¢å¤å…¨é‡å¤‡ä»½
   unzip full_backup.zip -d public/uploads/
   â†“
2. æŒ‰æ—¶é—´é¡ºåºåº”ç”¨å¢é‡å¤‡ä»½
   for each incremental_backup.zip:
     unzip -d temp/
     cp -r temp/* public/uploads/
   â†“
3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

---

## ä»£ç ç»“æ„

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ backup/
â”‚       â”œâ”€â”€ backupScheduler.service.ts    # å¤‡ä»½è°ƒåº¦æœåŠ¡
â”‚       â”œâ”€â”€ databaseBackup.service.ts      # æ•°æ®åº“å¤‡ä»½æœåŠ¡
â”‚       â”œâ”€â”€ fileBackup.service.ts         # æ–‡ä»¶å¤‡ä»½æœåŠ¡
â”‚       â””â”€â”€ logArchive.service.ts         # æ—¥å¿—å½’æ¡£æœåŠ¡
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ startup.ts                         # åº”ç”¨åˆå§‹åŒ–
â””â”€â”€ instrumentation.ts                     # Next.js å¯åŠ¨é’©å­

scripts/
â”œâ”€â”€ restore-backup.js                      # å…¨é‡æ¢å¤è„šæœ¬
â”œâ”€â”€ restore-database-incremental.js       # æ•°æ®åº“å¢é‡æ¢å¤è„šæœ¬
â””â”€â”€ test-backup-system.js                 # å¤‡ä»½ç³»ç»Ÿæµ‹è¯•è„šæœ¬

data/
â”œâ”€â”€ backups/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ full/                          # æ•°æ®åº“å…¨é‡å¤‡ä»½
â”‚   â”‚   â””â”€â”€ incremental/                   # æ•°æ®åº“å¢é‡å¤‡ä»½
â”‚   â”œâ”€â”€ files/
â”‚   â”‚   â”œâ”€â”€ full/                          # æ–‡ä»¶å…¨é‡å¤‡ä»½
â”‚   â”‚   â””â”€â”€ incremental/                   # æ–‡ä»¶å¢é‡å¤‡ä»½
â”‚   â””â”€â”€ logs/
â”‚       â””â”€â”€ archives/                       # æ—¥å¿—å½’æ¡£
â””â”€â”€ file-index/
    â””â”€â”€ index.json                         # æ–‡ä»¶ç´¢å¼•
```

### å…³é”®æ¥å£

#### BackupResult

```typescript
interface BackupResult {
  success: boolean;
  type: 'full' | 'incremental';
  filePath: string;
  sizeBytes: number;
  timestamp: Date;
  message?: string;
}
```

#### FileIndex

```typescript
interface FileIndex {
  [filePath: string]: {
    md5: string;
    size: number;
    mtime: number;
  };
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å¢é‡å¤‡ä»½ä¼˜åŒ–

- **æ–‡ä»¶ç´¢å¼•**: é¿å…é‡å¤è®¡ç®— MD5
- **æ™ºèƒ½æ£€æµ‹**: åªå¤‡ä»½å˜åŒ–çš„æ–‡ä»¶
- **å‹ç¼©å­˜å‚¨**: ZIP/GZIP å‹ç¼©å‡å°‘å­˜å‚¨ç©ºé—´

### 2. æ•°æ®åº“å¤‡ä»½ä¼˜åŒ–

- **WAL æ¨¡å¼**: åœ¨çº¿å¤‡ä»½ï¼Œä¸é˜»å¡è¯»å†™
- **Checkpoint ä¼˜åŒ–**: å…¨é‡å¤‡ä»½å‰æ‰§è¡Œï¼Œå‡å°‘ WAL æ–‡ä»¶å¤§å°
- **å¼‚æ­¥æ‰§è¡Œ**: æ‰€æœ‰å¤‡ä»½ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»è¿›ç¨‹

### 3. å­˜å‚¨ä¼˜åŒ–

- **è‡ªåŠ¨æ¸…ç†**: å®šæœŸåˆ é™¤è¿‡æœŸå¤‡ä»½
- **å‹ç¼©å½’æ¡£**: æ—¥å¿—å‹ç¼©å‡å°‘ 90% å­˜å‚¨ç©ºé—´
- **ç´¢å¼•ç¼“å­˜**: æ–‡ä»¶ç´¢å¼•æŒä¹…åŒ–ï¼Œé¿å…é‡å¤æ‰«æ

---

## æ•…éšœå¤„ç†

### 1. å¤‡ä»½å¤±è´¥å¤„ç†

```typescript
try {
  await backup();
} catch (error) {
  console.error('âŒ å¤‡ä»½å¤±è´¥:', error);
  // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸å…¶ä»–å¤‡ä»½ç»§ç»­æ‰§è¡Œ
}
```

**ç­–ç•¥**:
- å•ä¸ªå¤‡ä»½å¤±è´¥ä¸å½±å“å…¶ä»–å¤‡ä»½
- è®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥
- ä¸‹æ¬¡è°ƒåº¦æ—¶è‡ªåŠ¨é‡è¯•

### 2. æ¢å¤å¤±è´¥å¤„ç†

**é¢„é˜²æªæ–½**:
- æ¢å¤å‰è‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®
- éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
- æä¾›å›æ»šæœºåˆ¶

### 3. æœåŠ¡åˆå§‹åŒ–å¤±è´¥

```typescript
try {
  await initializeApp();
} catch (error) {
  console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
  // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸æœåŠ¡å™¨ç»§ç»­å¯åŠ¨
}
```

**ç­–ç•¥**:
- å¤‡ä»½æœåŠ¡å¤±è´¥ä¸å½±å“åº”ç”¨å¯åŠ¨
- æä¾›æ‰‹åŠ¨åˆå§‹åŒ–æ¥å£
- è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

## æ€»ç»“

### ç³»ç»Ÿç‰¹ç‚¹

1. **è‡ªåŠ¨åŒ–**: æ— éœ€äººå·¥å¹²é¢„ï¼Œè‡ªåŠ¨æ‰§è¡Œå¤‡ä»½ä»»åŠ¡
2. **é«˜æ•ˆ**: å¢é‡å¤‡ä»½å‡å°‘å­˜å‚¨å’Œä¼ è¾“æˆæœ¬
3. **å¯é **: å¤šé‡å®¹é”™æœºåˆ¶ï¼Œç¡®ä¿å¤‡ä»½æˆåŠŸ
4. **çµæ´»**: æ”¯æŒæ‰‹åŠ¨è§¦å‘å’Œè‡ªåŠ¨è°ƒåº¦
5. **å¯æ¢å¤**: æä¾›å®Œæ•´çš„æ¢å¤å·¥å…·å’Œæµç¨‹

### æŠ€æœ¯äº®ç‚¹

- âœ… SQLite WAL æ¨¡å¼å®ç°çœŸæ­£çš„å¢é‡å¤‡ä»½
- âœ… MD5 å“ˆå¸Œå®ç°æ™ºèƒ½æ–‡ä»¶å˜åŒ–æ£€æµ‹
- âœ… æ—¶é—´è°ƒåº¦ç®—æ³•ç²¾ç¡®æ§åˆ¶å¤‡ä»½æ—¶æœº
- âœ… å‹ç¼©æŠ€æœ¯å¤§å¹…å‡å°‘å­˜å‚¨ç©ºé—´
- âœ… æ¨¡å—åŒ–è®¾è®¡ä¾¿äºç»´æŠ¤å’Œæ‰©å±•

### é€‚ç”¨åœºæ™¯

- ä¸­å°å‹åº”ç”¨çš„æ•°æ®ä¿æŠ¤
- éœ€è¦å®šæœŸå¤‡ä»½çš„ä¸šåŠ¡ç³»ç»Ÿ
- å¯¹æ¢å¤æ—¶é—´æœ‰è¦æ±‚çš„åœºæ™¯
- å­˜å‚¨ç©ºé—´æœ‰é™çš„ç¯å¢ƒ

---

## ç›¸å…³æ–‡æ¡£

- [å¤‡ä»½æ¢å¤æ“ä½œæŒ‡å—](./BACKUP_RESTORE_GUIDE.md)
- [å¤‡ä»½æµ‹è¯•ç»“æœ](./BACKUP_TEST_RESULTS.md)
- [MinIO é…ç½®æŒ‡å—](./MINIO_SETUP_INSTRUCTIONS.md)

