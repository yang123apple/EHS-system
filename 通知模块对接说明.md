# 通知模块对接说明

## 概述

已将消息通知模块与 `/admin/notifications` 页面完成对接，实现了基于模板的消息通知系统。

## 实现内容

### 1. 统一通知服务 (`src/lib/notificationService.ts`)

创建了基于模板的通知服务，支持：
- 模板驱动的消息创建
- 变量占位符替换（如 `{{user.name}}`）
- 触发条件判断
- 快捷函数（培训、作业票、隐患）

主要函数：
```typescript
// 通用函数
createNotificationsFromTemplate(params)

// 快捷函数
createTrainingNotification(event, recipientIds, taskData, assignerName)
createPermitNotification(event, recipientIds, permitData, operatorName)
createHazardNotification(event, recipientIds, hazardData, operatorName)
```

### 2. 管理页面增强 (`/admin/notifications`)

增加了两个标签页：

#### 通知模板管理
- 创建/编辑/删除模板
- 配置触发事件和条件
- 变量占位符支持

#### 消息记录查看
- 统计卡片（总数、未读、阅读率）
- 筛选器（类型、状态、关键词）
- 消息列表展示（支持查看接收人、时间等）

### 3. API 接口

**管理端 API**: `/api/admin/notifications`
- `GET`: 获取所有消息记录及统计数据
- 支持按类型、阅读状态、关键词筛选

**模板管理 API**: `/api/admin/notification-templates`
- `GET`: 获取模板列表
- `POST`: 创建模板
- `PUT`: 更新模板
- `DELETE`: 删除模板

### 4. 各模块集成

已重构以下模块使用统一通知服务：

#### 培训模块
- `training_assigned`: 培训任务分配
- `training_updated`: 培训任务更新

#### 作业票模块
- `permit_pending_approval`: 待审批
- `permit_approved`: 审批通过
- `permit_rejected`: 审批驳回

## 初始化通知模板

### 方法一：通过管理页面手动创建

访问 `/admin/notifications` 页面，点击"新建模板"创建以下预设模板：

#### 培训模块模板

**1. 培训任务分配**
- 名称: `training_assigned_default`
- 标题: `新培训任务`
- 内容: `{{user.name}}分配给您一个新的培训任务：{{training.title}}，请及时完成。`
- 类型: `training`
- 触发事件: `training_assigned`
- 状态: 启用

**2. 培训任务更新**
- 名称: `training_updated_default`
- 标题: `培训任务已更新`
- 内容: `培训任务"{{training.title}}"已更新，请及时查看。`
- 类型: `training`
- 触发事件: `training_updated`
- 状态: 启用

**3. 培训任务即将到期**
- 名称: `training_completed_reminder`
- 标题: `培训任务即将到期`
- 内容: `您的培训任务"{{training.title}}"即将到期，请尽快完成。`
- 类型: `training`
- 触发事件: `training_deadline_reminder`
- 状态: 启用

#### 作业票模块模板

**4. 待审批作业票**
- 名称: `permit_pending_approval_default`
- 标题: `待审批作业票`
- 内容: `【{{permit.templateName}}】{{permit.projectName}} - 等待您审批（第{{permit.stepNumber}}步：{{permit.stepName}}）`
- 类型: `work_permit`
- 触发事件: `permit_pending_approval`
- 状态: 启用

**5. 作业票审批通过**
- 名称: `permit_approved_default`
- 标题: `作业票审批通过`
- 内容: `【已完成】【{{permit.templateName}}】{{permit.projectName}} - {{user.name}}通过了您的申请`
- 类型: `work_permit`
- 触发事件: `permit_approved`
- 状态: 启用

**6. 作业票被驳回**
- 名称: `permit_rejected_default`
- 标题: `作业票被驳回`
- 内容: `【已驳回】【{{permit.templateName}}】{{permit.projectName}} - {{user.name}}驳回了您的申请`
- 类型: `work_permit`
- 触发事件: `permit_rejected`
- 状态: 启用

**7. 作业票已提交**
- 名称: `permit_submitted_default`
- 标题: `作业票已提交`
- 内容: `您提交的作业票【{{permit.templateName}}】{{permit.projectName}}已进入审批流程。`
- 类型: `work_permit`
- 触发事件: `permit_submitted`
- 状态: 启用

#### 隐患模块模板

**8. 新隐患已创建**
- 名称: `hazard_created_default`
- 标题: `新隐患已创建`
- 内容: `隐患编号：{{hazard.code}}，位置：{{hazard.location}}，请及时处理。`
- 类型: `hazard`
- 触发事件: `hazard_created`
- 状态: 启用

**9. 隐患已分配**
- 名称: `hazard_assigned_default`
- 标题: `隐患已分配`
- 内容: `{{user.name}}分配给您一个隐患（编号：{{hazard.code}}，位置：{{hazard.location}}），请及时处理。`
- 类型: `hazard`
- 触发事件: `hazard_assigned`
- 状态: 启用

**10. 高风险隐患（带条件）**
- 名称: `hazard_high_risk`
- 标题: `高风险隐患需关注`
- 内容: `⚠️ 高风险隐患（编号：{{hazard.code}}，位置：{{hazard.location}}）需要您立即处理！`
- 类型: `hazard`
- 触发事件: `hazard_assigned`
- 触发条件: `{"hazard.riskLevel": "high"}`
- 状态: 启用

**11. 隐患已完成**
- 名称: `hazard_completed_default`
- 标题: `隐患已完成`
- 内容: `隐患（编号：{{hazard.code}}）已完成处理。`
- 类型: `hazard`
- 触发事件: `hazard_completed`
- 状态: 启用

### 方法二：通过 SQL 直接插入（如果需要批量初始化）

可以使用 SQLite 客户端连接数据库并执行 SQL 插入语句。

## 可用变量说明

### 培训模块
- `{{user.name}}`: 操作用户名称
- `{{user.department}}`: 用户部门
- `{{training.id}}`: 培训任务 ID
- `{{training.title}}`: 培训任务标题
- `{{training.endDate}}`: 培训结束日期

### 作业票模块
- `{{user.name}}`: 操作用户名称
- `{{permit.id}}`: 作业票 ID
- `{{permit.code}}`: 作业票编号
- `{{permit.templateName}}`: 作业票模板名称
- `{{permit.projectName}}`: 项目名称
- `{{permit.stepName}}`: 当前审批步骤名称
- `{{permit.stepNumber}}`: 当前审批步骤编号

### 隐患模块
- `{{user.name}}`: 操作用户名称
- `{{hazard.id}}`: 隐患 ID
- `{{hazard.code}}`: 隐患编号
- `{{hazard.location}}`: 隐患位置
- `{{hazard.status}}`: 隐患状态
- `{{hazard.riskLevel}}`: 风险等级
- `{{hazard.description}}`: 隐患描述

## 测试建议

1. 访问 `/admin/notifications` 创建上述模板
2. 在培训模块创建新任务，检查是否发送通知
3. 在作业票模块提交审批，检查流程中的通知
4. 在消息记录标签页查看所有已发送的消息
5. 测试筛选和搜索功能

## 注意事项

- 模板名称（name）必须唯一
- 触发事件（triggerEvent）需要与代码中的事件名称匹配
- 变量占位符使用 `{{变量名}}` 格式
- 触发条件使用 JSON 格式配置
- 如果没有找到匹配的模板，系统会跳过通知创建（不会报错）

## 后续扩展

可以根据需要添加更多模板和触发事件：
1. 在 `/admin/notifications` 页面创建新模板
2. 在相应模块调用通知服务函数
3. 传入正确的触发事件名称和上下文数据
