# A4 åˆ—å®½è®¡ç®—å·¥å…· - é›†æˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä¸“ä¸º EHS ç³»ç»Ÿè®¾è®¡çš„ A4 çº¸å¼ åˆ—å®½è®¡ç®—å·¥å…·,èƒ½å¤Ÿæ™ºèƒ½è®¡ç®— Excel è¡¨æ ¼çš„åˆ—å®½,ç¡®ä¿æ‰“å°æ—¶å®Œç¾é€‚é… A4 çº¸å¼ ã€‚

### æ ¸å¿ƒç‰¹æ€§

âœ… **ç¯å¢ƒæ— å…³**: çº¯è®¡ç®—é€»è¾‘,æ— éœ€ DOM/Canvas,æ”¯æŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯  
âœ… **CJK å­—ç¬¦æ”¯æŒ**: æ­£ç¡®å¤„ç†ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡å­—ç¬¦(æŒ‰ 2 å€å®½åº¦è®¡ç®—)  
âœ… **æ™ºèƒ½åˆ†é…**: åŸºäºå†…å®¹é•¿åº¦çš„åŠ æƒåˆ†é…ç®—æ³•  
âœ… **çº¦æŸä¿æŠ¤**: è‡ªåŠ¨åº”ç”¨æœ€å°/æœ€å¤§å®½åº¦é™åˆ¶  
âœ… **A4 é€‚é…**: ä¸¥æ ¼ç¬¦åˆ A4 çº¸å¼ å¯æ‰“å°åŒºåŸŸ(700px)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ç”¨æ³•

```typescript
import { calculateA4ColumnWidths } from '@/utils/a4-column-width';

// å‡†å¤‡æ•°æ®(2D æ•°ç»„)
const data = [
  ['å§“å', 'éƒ¨é—¨', 'Email', 'çŠ¶æ€'],
  ['å¼ ä¸‰', 'æŠ€æœ¯éƒ¨é—¨', 'zhangsan@example.com', 'åœ¨èŒ'],
  ['æå››', 'è¡Œæ”¿éƒ¨', 'lisi@example.com', 'ç¦»èŒ']
];

// è®¡ç®—åˆ—å®½
const widths = calculateA4ColumnWidths(data);
// è¿”å›: [80, 120, 280, 80] (ç¤ºä¾‹å€¼,å®é™…æ ¹æ®å†…å®¹è®¡ç®—)

console.log('åˆ—å®½:', widths);
// åº”ç”¨åˆ°è¡¨æ ¼ç»„ä»¶...
```

### 2. ä¸ LuckySheet é›†æˆ

```typescript
import { calculateA4ColumnWidths } from '@/utils/a4-column-width';

// åˆå§‹åŒ– LuckySheet æ—¶åº”ç”¨åˆ—å®½
const columnWidths = calculateA4ColumnWidths(data);

window.luckysheet.create({
  container: 'luckysheet',
  data: [{
    name: 'Sheet1',
    config: {
      columnlen: Object.fromEntries(
        columnWidths.map((width, index) => [String(index), width])
      )
    },
    // ...å…¶ä»–é…ç½®
  }]
});
```

### 3. React ç»„ä»¶ç¤ºä¾‹

```tsx
import { useMemo } from 'react';
import { calculateA4ColumnWidths, validateA4Fit } from '@/utils/a4-column-width';

export function ExcelPrintView({ data }: { data: any[][] }) {
  const columnWidths = useMemo(() => 
    calculateA4ColumnWidths(data), 
    [data]
  );

  const validation = validateA4Fit(columnWidths);

  return (
    <div className="w-[794px] mx-auto"> {/* A4 å®½åº¦ */}
      {!validation.fits && (
        <div className="bg-yellow-100 p-2 mb-4">
          âš ï¸ è¡¨æ ¼è¶…å‡º A4 å®½åº¦ {validation.overflow}px
        </div>
      )}
      
      <table>
        <thead>
          <tr>
            {data[0].map((header, i) => (
              <th key={i} style={{ width: `${columnWidths[i]}px` }}>
                {header}
              </th>
            ))}
          </tr>
        </thead>
        {/* æ¸²æŸ“æ•°æ®è¡Œ... */}
      </table>
    </div>
  );
}
```

---

## ğŸ“ ç®—æ³•è¯¦è§£

### åŠ æƒåˆ†é…ç®—æ³•å·¥ä½œåŸç†

#### ç¬¬ 1 æ­¥: è®¡ç®—åˆ—æƒé‡

å¯¹äºæ¯ä¸€åˆ—,æ‰¾å‡ºè¯¥åˆ—ä¸­**æœ€é•¿çš„å†…å®¹**(åŒ…æ‹¬è¡¨å¤´):

```typescript
// ç¤ºä¾‹æ•°æ®
const column1 = ['å§“å', 'å¼ ä¸‰', 'æå››'];  // æœ€é•¿: 'å§“å'(4å­—ç¬¦ Ã— CJK)
const column2 = ['Email', 'zhangsan@example.com', 'lisi@example.com'];  // æœ€é•¿: email
```

è®¡ç®—å­—ç¬¦ä¸²å®½åº¦æ—¶:
- **CJK å­—ç¬¦**: æ¯å­—ç¬¦ â‰ˆ 14px (æƒé‡ 2)
- **ASCII/æ•°å­—**: æ¯å­—ç¬¦ â‰ˆ 7px (æƒé‡ 1)

```typescript
// 'å§“å' â†’ 2ä¸ªCJKå­—ç¬¦ â†’ 2 Ã— 14px = 28px + 16px padding = 44px
// 'zhangsan@example.com' â†’ 21ä¸ªASCII â†’ 21 Ã— 7px = 147px + 16px = 163px
```

#### ç¬¬ 2 æ­¥: æ€»æƒé‡æ±‚å’Œ

```typescript
const weights = [44, 163, 120, 50];  // 4åˆ—çš„æƒé‡
const totalWeight = 377;
```

#### ç¬¬ 3 æ­¥: æŒ‰æ¯”ä¾‹åˆ†é… 700px

æ¯åˆ—è·å¾—çš„å®½åº¦ = (åˆ—æƒé‡ / æ€»æƒé‡) Ã— 700px

```typescript
åˆ—1: (44 / 377) Ã— 700 = 82px
åˆ—2: (163 / 377) Ã— 700 = 303px  â†’ é™åˆ¶ä¸º 300px (è§¦åŠä¸Šé™)
åˆ—3: (120 / 377) Ã— 700 = 223px
åˆ—4: (50 / 377) Ã— 700 = 93px
```

#### ç¬¬ 4 æ­¥: åº”ç”¨çº¦æŸ

- **æœ€å°å®½åº¦**: 40px (é˜²æ­¢åˆ—å´©æºƒ)
- **æœ€å¤§å®½åº¦**: 300px (é˜²æ­¢å•åˆ—ç‹¬å )

#### ç¬¬ 5 æ­¥: é‡æ–°åˆ†é…å‰©ä½™ç©ºé—´

å¦‚æœæŸäº›åˆ—è§¦åŠä¸Šé™/ä¸‹é™,å°†å¤šä½™/ç¼ºå°‘çš„ç©ºé—´é‡æ–°åˆ†é…ç»™å…¶ä»–åˆ—:

```typescript
// åˆ—2è¶…å‡º3px,é‡æ–°åˆ†é…ç»™åˆ—1ã€3ã€4
const remainingCols = [1, 3, 4];
// æŒ‰æƒé‡é‡æ–°åˆ†é…è¿™3px...
```

---

## ğŸ”§ API å‚è€ƒ

### `calculateA4ColumnWidths(data: any[][]): number[]`

è®¡ç®—ç¬¦åˆ A4 çº¸å¼ çš„åˆ—å®½æ•°ç»„ã€‚

**å‚æ•°:**
- `data`: äºŒç»´æ•°ç»„,æ¯è¡ŒåŒ…å«å•å…ƒæ ¼å€¼

**è¿”å›:**
- `number[]`: æ¯åˆ—çš„åƒç´ å®½åº¦

**ç¤ºä¾‹:**
```typescript
const widths = calculateA4ColumnWidths([
  ['å§“å', 'å¹´é¾„'],
  ['å¼ ä¸‰', '25']
]);
// => [150, 100]
```

---

### `calculateStringWidth(text: string): number`

è®¡ç®—å­—ç¬¦ä¸²çš„æ˜¾ç¤ºå®½åº¦(è€ƒè™‘ CJK å­—ç¬¦)ã€‚

**å‚æ•°:**
- `text`: è¦æµ‹é‡çš„å­—ç¬¦ä¸²

**è¿”å›:**
- `number`: ä¼°ç®—çš„åƒç´ å®½åº¦

**ç¤ºä¾‹:**
```typescript
calculateStringWidth('Hello');    // => 51px
calculateStringWidth('ä½ å¥½');      // => 44px
calculateStringWidth('Helloä¸–ç•Œ'); // => 79px
```

---

### `validateA4Fit(widths: number[]): ValidationResult`

éªŒè¯è¡¨æ ¼æ˜¯å¦é€‚é… A4 çº¸å¼ ã€‚

**è¿”å›:**
```typescript
{
  fits: boolean;        // æ˜¯å¦é€‚é…
  totalWidth: number;   // æ€»å®½åº¦
  maxWidth: number;     // æœ€å¤§å…è®¸å®½åº¦(744px)
  overflow: number;     // æº¢å‡ºåƒç´ (0è¡¨ç¤ºé€‚é…)
}
```

**ç¤ºä¾‹:**
```typescript
const result = validateA4Fit([100, 200, 300, 200]);
// => { fits: false, totalWidth: 800, maxWidth: 744, overflow: 56 }
```

---

### `formatWidthsForCSS(widths: number[]): string[]`

è½¬æ¢ä¸º CSS å®½åº¦å­—ç¬¦ä¸²ã€‚

**ç¤ºä¾‹:**
```typescript
formatWidthsForCSS([100, 200, 150]);
// => ['100px', '200px', '150px']
```

---

### `getTotalTableWidth(widths: number[]): number`

è®¡ç®—è¡¨æ ¼æ€»å®½åº¦ã€‚

**ç¤ºä¾‹:**
```typescript
getTotalTableWidth([100, 200, 150]);
// => 450
```

---

## ğŸ“Š å¸¸é‡é…ç½®

å¯æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ä»¥ä¸‹å¸¸é‡(ä½äº `a4-column-width.ts`):

```typescript
const A4_WIDTH_PX = 794;           // A4çº¸å¼ å®½åº¦
const A4_MARGINS_PX = 50;          // å·¦å³è¾¹è·æ€»å’Œ
const TARGET_USABLE_WIDTH = 700;   // ç›®æ ‡å¯ç”¨å®½åº¦
const MIN_COLUMN_WIDTH = 40;       // æœ€å°åˆ—å®½
const MAX_COLUMN_WIDTH = 300;      // æœ€å¤§åˆ—å®½
const ASCII_CHAR_WIDTH = 7;        // ASCIIå­—ç¬¦å®½åº¦
const CJK_CHAR_WIDTH = 14;         // CJKå­—ç¬¦å®½åº¦
const CELL_PADDING = 16;           // å•å…ƒæ ¼å†…è¾¹è·
const MAX_CHARS_FOR_WIDTH = 50;    // è¶…è¿‡æ­¤é•¿åº¦å‡è®¾æ¢è¡Œ
```

---

## ğŸ¨ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1: éšæ‚£æŠ¥å‘Šæ‰“å°

```typescript
// ä»åç«¯è·å–éšæ‚£æ•°æ®
const hazardData = await fetchHazardReport();

// è½¬æ¢ä¸º2Dæ•°ç»„
const tableData = [
  ['éšæ‚£ç¼–å·', 'éšæ‚£æè¿°', 'è´£ä»»äºº', 'æ•´æ”¹æœŸé™', 'çŠ¶æ€'],
  ...hazardData.map(item => [
    item.id,
    item.description,
    item.responsible,
    item.deadline,
    item.status
  ])
];

// è®¡ç®—åˆ—å®½
const columnWidths = calculateA4ColumnWidths(tableData);

// åº”ç”¨åˆ°æ‰“å°é¢„è§ˆ
<PrintPreview data={tableData} columnWidths={columnWidths} />
```

### åœºæ™¯ 2: ç»„ç»‡æ¶æ„å¯¼å‡º

```typescript
// ç»„ç»‡æ¶æ„æ•°æ®
const orgData = [
  ['éƒ¨é—¨', 'è´Ÿè´£äºº', 'äººå‘˜æ•°é‡', 'è”ç³»ç”µè¯'],
  ['æŠ€æœ¯éƒ¨', 'å¼ ç»ç†', '15', '010-12345678'],
  ['è¡Œæ”¿éƒ¨', 'æä¸»ç®¡', '8', '010-87654321']
];

const widths = calculateA4ColumnWidths(orgData);

// é…ç½®LuckySheet
luckysheet.create({
  data: [{
    config: {
      columnlen: Object.fromEntries(
        widths.map((w, i) => [i, w])
      )
    }
  }]
});
```

### åœºæ™¯ 3: æ£€æŸ¥è®°å½•æ‰¹é‡æ‰“å°

```typescript
// å¤šé¡µæ•°æ®
const inspectionRecords = [
  // ç¬¬1é¡µ
  generateTableData(inspectionData.slice(0, 50)),
  // ç¬¬2é¡µ
  generateTableData(inspectionData.slice(50, 100)),
];

inspectionRecords.forEach((pageData, index) => {
  const widths = calculateA4ColumnWidths(pageData);
  renderPage(pageData, widths, index + 1);
});
```

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: è¡¨æ ¼ä»ç„¶æº¢å‡º A4 çº¸å¼ 

**åŸå› :** åˆ—æ•°è¿‡å¤šæˆ–å†…å®¹è¿‡é•¿

**è§£å†³æ–¹æ¡ˆ:**
```typescript
// æ–¹æ¡ˆ A: å‡å°ç›®æ ‡å®½åº¦
const TARGET_USABLE_WIDTH = 680; // æ›´ä¿å®ˆçš„å®½åº¦

// æ–¹æ¡ˆ B: åˆ†é¡µæ˜¾ç¤º
const maxColumnsPerPage = 8;
const pages = chunkColumns(data, maxColumnsPerPage);

// æ–¹æ¡ˆ C: ä½¿ç”¨æ¨ªå‘æ‰“å°
<style>
  @page { size: A4 landscape; }
</style>
```

### é—®é¢˜ 2: CJK å­—ç¬¦å®½åº¦ä¸å‡†ç¡®

**åŸå› :** å­—ä½“ä¸åŒå¯¼è‡´å®½åº¦å·®å¼‚

**è§£å†³æ–¹æ¡ˆ:**
```typescript
// è°ƒæ•´ CJK å­—ç¬¦å®½åº¦å¸¸é‡
const CJK_CHAR_WIDTH = 16; // å¦‚æœå­—ä½“è¾ƒå®½,å¢åŠ æ­¤å€¼
```

### é—®é¢˜ 3: æŸäº›åˆ—å¤ªçª„/å¤ªå®½

**åŸå› :** çº¦æŸé…ç½®ä¸é€‚åˆå½“å‰æ•°æ®

**è§£å†³æ–¹æ¡ˆ:**
```typescript
// è°ƒæ•´çº¦æŸ
const MIN_COLUMN_WIDTH = 50;  // å¢åŠ æœ€å°å®½åº¦
const MAX_COLUMN_WIDTH = 250; // å‡å°æœ€å¤§å®½åº¦
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ•°æ®é¢„å¤„ç†

```typescript
// âœ… å¥½çš„åšæ³•: æ¸…ç†ç©ºå€¼
const cleanData = rawData.map(row => 
  row.map(cell => cell ?? '')
);

// âŒ é¿å…: ç›´æ¥ä¼ å…¥æœªå¤„ç†çš„æ•°æ®(å¯èƒ½åŒ…å«null/undefined)
```

### 2. æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const columnWidths = useMemo(() => 
  calculateA4ColumnWidths(data),
  [data]
);

// âŒ é¿å…: æ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–°è®¡ç®—
const columnWidths = calculateA4ColumnWidths(data); // åœ¨renderä¸­
```

### 3. å“åº”å¼å¤„ç†

```typescript
// âœ… æ ¹æ®è®¾å¤‡è°ƒæ•´ç›®æ ‡å®½åº¦
const isMobile = window.innerWidth < 768;
const targetWidth = isMobile ? 350 : 700;

// éœ€è¦ä¿®æ”¹æºç æˆ–ä¼ å…¥å‚æ•°
```

### 4. æ‰“å°æ ·å¼

```css
@media print {
  @page {
    size: A4;
    margin: 10mm;
  }
  
  table {
    page-break-inside: avoid;
    font-size: 10pt; /* ç¡®ä¿æ–‡å­—å¤§å°é€‚åˆæ‰“å° */
  }
  
  th, td {
    padding: 4px;
    border: 1px solid #ccc;
  }
}
```

---

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•å¥—ä»¶:

```bash
# ä½¿ç”¨ ts-node è¿è¡Œæµ‹è¯•
npx ts-node src/utils/a4-column-width.test.ts

# æˆ–ä½¿ç”¨ Node.js (éœ€è¦å…ˆç¼–è¯‘)
npm run build
node dist/utils/a4-column-width.test.js
```

æµ‹è¯•è¦†ç›–:
- âœ… CJK vs ASCII å­—ç¬¦å®½åº¦è®¡ç®—
- âœ… ç©ºæ•°æ®/å•å…ƒæ ¼å¤„ç†
- âœ… A4 å®½åº¦çº¦æŸ
- âœ… æœ€å°/æœ€å¤§å®½åº¦çº¦æŸ
- âœ… æ¯”ä¾‹åˆ†é…é€»è¾‘
- âœ… å¤šåˆ—åœºæ™¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ“ä½œæ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—](./æ“ä½œæ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md)
- [é€šçŸ¥æ¨¡å—å¿«é€Ÿå¼€å§‹](./å¿«é€Ÿå¼€å§‹-é€šçŸ¥æ¨¡å—.md)
- [éšæ‚£ç³»ç»ŸæŠ€æœ¯æ ˆ](./æŠ€æœ¯æ ˆæ€»ç»“.md)

---

## ğŸ¤ è´¡çŒ®

å¦‚éœ€è°ƒæ•´ç®—æ³•æˆ–æ·»åŠ æ–°ç‰¹æ€§,è¯·ä¿®æ”¹:
- æ ¸å¿ƒé€»è¾‘: `src/utils/a4-column-width.ts`
- æµ‹è¯•ç”¨ä¾‹: `src/utils/a4-column-width.test.ts`
- æ–‡æ¡£: æœ¬æ–‡ä»¶

---

## ğŸ“„ è®¸å¯

è¯¥å·¥å…·ä¸º EHS ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨,éµå¾ªé¡¹ç›®æ•´ä½“è®¸å¯åè®®ã€‚
