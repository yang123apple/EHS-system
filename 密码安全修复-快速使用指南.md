# 密码安全修复 - 快速使用指南

## ✅ 已完成的修复

所有密码相关的代码已修复，现在系统使用 **bcrypt** 进行密码加密存储和验证。

## 🚀 如何应用修复

### 方案一：全新系统（推荐）
如果是全新的系统或可以重置数据库：

```bash
# 1. 重置数据库（会删除所有数据）
npx prisma migrate reset

# 2. 运行种子脚本（创建管理员账号，密码已加密）
npx prisma db seed
```

管理员账号：
- 用户名：`admin`
- 密码：`admin`（已使用 bcrypt 加密存储）

### 方案二：现有系统（保留用户数据）
如果系统已经有用户数据，需要迁移现有密码：

```bash
# 运行密码迁移脚本
node scripts/migrate-passwords-to-hash.js
```

#### 迁移脚本会：
1. ✅ 自动检测所有用户
2. ✅ 识别哪些密码是明文（未加密）
3. ✅ 将明文密码转换为 bcrypt 哈希
4. ✅ 跳过已经加密的密码（幂等性）
5. ✅ 生成详细的迁移报告

#### 迁移输出示例：
```
🔐 开始密码迁移...

📊 共找到 5 个用户

✅ 已加密: admin (超级管理员)
🔄 已迁移: zhangsan (张三) - 原密码: 123456
🔄 已迁移: lisi (李四) - 原密码: 123456
⏭️  跳过: oauth_user (OAuth用户) - 无密码 (OAuth用户)
✅ 已加密: wangwu (王五)

============================================================
📋 迁移报告
============================================================
总用户数:        5
已迁移:          2
已加密(跳过):    2
无密码(跳过):    1
错误数:          0
============================================================

✅ 密码迁移完成！

⚠️  重要: 迁移了 2 个明文密码，这些用户的原密码已在上面显示。
建议通知用户或为其重置密码。
```

## 🔍 验证修复

### 1. 测试登录
```bash
# 启动开发服务器
npm run dev
```

访问登录页面，使用以下账号测试：
- 用户名：`admin`
- 密码：`admin`

### 2. 检查数据库
查看数据库中的密码字段，应该看到类似这样的哈希值：
```
$2a$10$abcdefghijklmnopqrstuvwxyz1234567890ABCDEFGHIJKLMNOPQRS
```

**注意**：如果看到明文密码（如 `123456`、`admin`），请运行迁移脚本。

### 3. 测试密码功能
- ✅ 用户登录
- ✅ 创建新用户
- ✅ 重置密码
- ✅ 修改密码

## 📋 修复清单

| 功能 | 文件 | 状态 |
|------|------|------|
| 登录验证 | `src/app/api/auth/login/route.ts` | ✅ 已修复 |
| 用户创建 | `src/app/api/users/route.ts` | ✅ 已修复 |
| 密码重置 | `src/app/api/users/[id]/reset-password/route.ts` | ✅ 已修复 |
| 用户保存 | `src/lib/db.ts` | ✅ 已修复 |
| 数据库种子 | `prisma/seed.ts` | ✅ 已修复 |
| 密码修改 | `src/actions/settings.ts` | ✅ 已支持 |
| 密码迁移脚本 | `scripts/migrate-passwords-to-hash.js` | ✅ 已创建 |

## ⚠️ 重要提示

### 默认密码
修复后，系统中的默认密码：
- **新用户默认密码**：`123456`（创建时自动加密）
- **重置后的密码**：`123`（重置时自动加密）
- **管理员初始密码**：`admin`（种子脚本中已加密）

**建议**：提醒用户首次登录后修改默认密码。

### 备份建议
在运行迁移脚本之前，强烈建议备份数据库：

**SQLite：**
```bash
# 复制数据库文件
cp prisma/dev.db prisma/dev.db.backup
```

**PostgreSQL：**
```bash
pg_dump -U username -d database_name > backup.sql
```

### 安全性
- ✅ 密码使用 bcrypt 加密（10轮 salt）
- ✅ 每个密码有唯一的 salt
- ✅ 单向哈希，无法反向解密
- ✅ 抗暴力破解（计算成本高）

## 🆘 常见问题

### Q: 迁移脚本会影响现有用户登录吗？
A: 不会。迁移脚本只是将明文密码转换为加密格式，用户使用相同的密码仍然可以登录。

### Q: 可以多次运行迁移脚本吗？
A: 可以。脚本具有幂等性，会自动跳过已加密的密码，不会重复加密。

### Q: 如果用户忘记密码怎么办？
A: 管理员可以通过系统的"重置密码"功能将密码重置为 `123`（会自动加密）。

### Q: 需要通知用户密码已加密吗？
A: 不需要。从用户角度来看，登录过程没有任何变化，密码还是相同的。

### Q: 是否需要修改前端代码？
A: 不需要。前端仍然发送明文密码，加密和验证都在后端完成。

## 📚 详细文档

查看完整的技术文档：
- 📄 `docs/密码安全修复文档.md` - 详细的技术说明和修复记录

## 💡 后续建议

1. **密码复杂度**：考虑添加密码强度要求（长度、大小写、数字、特殊字符）
2. **密码过期**：实施定期密码修改策略
3. **账户锁定**：添加登录失败次数限制，防止暴力破解
4. **多因素认证**：考虑添加 2FA/MFA 支持
5. **密码历史**：防止用户重复使用最近的密码

## ✨ 总结

密码安全问题已完全修复！系统现在使用行业标准的 bcrypt 加密算法保护用户密码。

**下一步**：运行迁移脚本（如果有现有用户数据），或重置数据库开始全新系统。
