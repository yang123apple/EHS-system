# ğŸ¯ EHS ç³»ç»Ÿæ—¥å¿—åŠŸèƒ½ç»Ÿä¸€è¯´æ˜

## âœ… ç»Ÿä¸€å®ŒæˆçŠ¶æ€

**ç°åœ¨æ•´ä¸ªç³»ç»Ÿçš„æ—¥å¿—åŠŸèƒ½å·²ç»å®Œå…¨ç»Ÿä¸€ï¼**

æ‰€æœ‰çš„æ—¥å¿—è®°å½•ç°åœ¨éƒ½é€šè¿‡**æ–°çš„ AuditService** ä½œä¸ºåº•å±‚å®ç°ï¼ŒåŒæ—¶ä¿ç•™äº†æ—§APIçš„å…¼å®¹æ€§ã€‚

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ—§ APIï¼ˆå…¼å®¹å±‚ï¼Œä¿æŒå‘ä¸‹å…¼å®¹ï¼‰          â”‚
â”‚  Â· ActivityLogger.logCreate()               â”‚
â”‚  Â· SystemLogService.createLog()             â”‚
â”‚  Â· logUserLogin() / logUserLogout()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ç»Ÿä¸€è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å…¼å®¹é€‚é…å±‚ï¼ˆaudit-compat.serviceï¼‰    â”‚
â”‚  Â· æ˜ å°„æ—§æ¨¡å—ååˆ°æ–°æšä¸¾                       â”‚
â”‚  Â· æ˜ å°„æ—§æ“ä½œç±»å‹åˆ°æ–°æšä¸¾                     â”‚
â”‚  Â· è‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ–°ç»Ÿä¸€æœåŠ¡ï¼ˆAuditServiceï¼‰            â”‚
â”‚  Â· ç±»å‹å®‰å…¨                                  â”‚
â”‚  Â· è‡ªåŠ¨ Diff                                â”‚
â”‚  Â· è‡ªåŠ¨å¿«ç…§                                  â”‚
â”‚  Â· ä¸å¯ç¯¡æ”¹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®åº“ï¼ˆSystemLog è¡¨ï¼‰               â”‚
â”‚  Â· Prisma + SQLite/PostgreSQL               â”‚
â”‚  Â· ä¸­é—´ä»¶ä¿æŠ¤ï¼ˆAppend-onlyï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å…¼å®¹æ€§è¯´æ˜

### âœ… æ—§ä»£ç æ— éœ€ä¿®æ”¹

æ‰€æœ‰ç°æœ‰çš„æ—¥å¿—è®°å½•ä»£ç **éƒ½å¯ä»¥ç»§ç»­ä½¿ç”¨**ï¼Œä¸ä¼šæŠ¥é”™ï¼š

```typescript
// âœ… è¿™äº›æ—§ä»£ç éƒ½èƒ½æ­£å¸¸å·¥ä½œ
import { ActivityLogger, Modules } from '@/utils/activityLogger';

await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  data: hazard,
});
```

```typescript
// âœ… è¿™äº›ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
import { logUserLogin, logUserLogout } from '@/services/systemLogService';

await logUserLogin(user.id, user.name, ip);
await logUserLogout(user.id, user.name, ip);
```

### âš¡ æ¨èæ–°ä»£ç ä½¿ç”¨æ–° API

å¯¹äºæ–°å¼€å‘çš„åŠŸèƒ½ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨æ–°çš„ `AuditService`ï¼š

```typescript
// â­ æ¨èï¼šä½¿ç”¨æ–° API
import AuditService from '@/services/audit.service';
import { LogModule, LogAction } from '@/types/audit';

await AuditService.logCreate({
  module: LogModule.HAZARD,
  businessId: hazard.code,
  newData: hazard,
  operator: currentUser,
  request,
});
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ–°å¢çš„ç»Ÿä¸€ç³»ç»Ÿæ–‡ä»¶
```
src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ audit.ts                    # âœ… ç±»å‹å®šä¹‰
â”œâ”€â”€ constants/
â”‚   â””â”€â”€ audit.ts                    # âœ… å¸¸é‡ä¸æ˜ å°„
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ audit-utils.ts              # âœ… å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ audit-middleware.ts         # âœ… æ•°æ®åº“ä¿æŠ¤ä¸­é—´ä»¶
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ audit.service.ts            # âœ… æ–°ç»Ÿä¸€æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ audit-compat.service.ts     # âœ… å…¼å®¹é€‚é…å±‚
â””â”€â”€ components/audit/
    â”œâ”€â”€ LogDiffViewer.tsx           # âœ… å·®å¼‚æŸ¥çœ‹å™¨
    â”œâ”€â”€ LogSnapshotViewer.tsx       # âœ… å¿«ç…§æŸ¥çœ‹å™¨
    â””â”€â”€ LogTimeline.tsx             # âœ… æ—¶é—´çº¿ç»„ä»¶
```

### å·²æ›´æ–°çš„å…¼å®¹å±‚æ–‡ä»¶
```
src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ systemLogService.ts         # âœ… å·²æ›´æ–°ï¼šè°ƒç”¨æ–°æœåŠ¡
â”‚   â””â”€â”€ systemLog.service.ts        # âš ï¸ ä¿ç•™æ—§å®ç°ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
â””â”€â”€ utils/
    â””â”€â”€ activityLogger.ts           # âœ… å·²æ›´æ–°ï¼šè°ƒç”¨å…¼å®¹å±‚
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### æ–¹æ¡ˆ 1ï¼šç»§ç»­ä½¿ç”¨æ—§ APIï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

å¦‚æœä½ ä¸æƒ³æ”¹åŠ¨ç°æœ‰ä»£ç ï¼Œä»€ä¹ˆéƒ½ä¸ç”¨åšï¼ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨æ–°çš„åº•å±‚å®ç°ã€‚

### æ–¹æ¡ˆ 2ï¼šé€æ­¥è¿ç§»åˆ°æ–° APIï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šåœ¨æ–°åŠŸèƒ½ä¸­ä½¿ç”¨æ–° API
```typescript
// æ–°åŠŸèƒ½ç›´æ¥ä½¿ç”¨
import AuditService from '@/services/audit.service';
import { LogModule, LogAction, BusinessRole } from '@/types/audit';

// åˆ›å»ºæ“ä½œ
await AuditService.logCreate({
  module: LogModule.HAZARD,
  businessId: hazard.code,
  targetType: 'hazard',
  targetLabel: hazard.desc?.substring(0, 50),
  newData: hazard,
  operator: {
    id: user.id,
    name: user.name,
    role: user.role,
    departmentName: user.department?.name,
  },
  businessRole: BusinessRole.REPORTER,
  request,
});
```

#### æ­¥éª¤ 2ï¼šé€æ­¥æ›¿æ¢æ—§ä»£ç ï¼ˆå¯é€‰ï¼‰
```typescript
// æ—§ä»£ç 
import { ActivityLogger, Modules } from '@/utils/activityLogger';
await ActivityLogger.logUpdate({
  userId: user.id,
  module: Modules.HAZARD,
  targetId: hazard.code,
  beforeData: oldHazard,
  afterData: newHazard,
});

// æ›¿æ¢ä¸ºæ–°ä»£ç 
import AuditService from '@/services/audit.service';
import { LogModule } from '@/types/audit';
await AuditService.logUpdate({
  module: LogModule.HAZARD,
  businessId: hazard.code,
  oldData: oldHazard,
  newData: newHazard,
  operator: currentUser,
  request,
});
```

---

## ğŸ” ä¸»è¦æ”¹è¿›ç‚¹

### 1. **ç±»å‹å®‰å…¨**
```typescript
// âŒ æ—§æ–¹å¼ï¼šå­—ç¬¦ä¸²å®¹æ˜“æ‹¼é”™
module: 'hazard'  // æ‹¼å†™é”™è¯¯ä¸ä¼šæŠ¥é”™

// âœ… æ–°æ–¹å¼ï¼šTypeScript æšä¸¾
module: LogModule.HAZARD  // IDE è‡ªåŠ¨è¡¥å…¨ï¼Œç±»å‹æ£€æŸ¥
```

### 2. **è‡ªåŠ¨åŒ–å¤„ç†**
```typescript
// âœ… è‡ªåŠ¨è®¡ç®—å·®å¼‚ï¼ˆDiffï¼‰
// âœ… è‡ªåŠ¨ç”Ÿæˆå¿«ç…§ï¼ˆSnapshotï¼‰
// âœ… è‡ªåŠ¨æå–å®¢æˆ·ç«¯ä¿¡æ¯ï¼ˆIPã€UAã€è®¾å¤‡ï¼‰
// âœ… è‡ªåŠ¨ç”Ÿæˆæ“ä½œæè¿°

await AuditService.logUpdate({
  oldData: oldHazard,
  newData: updatedHazard,
  // å…¶ä»–å‚æ•°...
});
// ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
// 1. æ¯”å¯¹ä¸¤ä¸ªå¯¹è±¡çš„å·®å¼‚
// 2. ç”Ÿæˆå¿«ç…§
// 3. æå–å®¢æˆ·ç«¯ä¿¡æ¯
// 4. ç”Ÿæˆæè¿°ï¼š"å¼ ä¸‰ æ›´æ–°äº† éšæ‚£ [HZ-2024-001]"
```

### 3. **ä¸å¯ç¯¡æ”¹**
```typescript
// å¯ç”¨æ•°æ®åº“ä¿æŠ¤ï¼ˆåœ¨ lib/prisma.ts ä¸­ï¼‰
import { registerAuditProtection } from '@/lib/audit-middleware';
registerAuditProtection(prisma);

// ç°åœ¨ä»»ä½•å°è¯•åˆ é™¤æˆ–ä¿®æ”¹æ—¥å¿—çš„æ“ä½œéƒ½ä¼šè¢«æ‹¦æˆª
// âŒ è¿™ä¼šæŠ›å‡ºé”™è¯¯ï¼š
// await prisma.systemLog.delete({ where: { id: '...' } });
// await prisma.systemLog.update({ where: { id: '...' }, data: {...} });
```

### 4. **ä¸šåŠ¡ç¼–ç è§„èŒƒ**
```typescript
// æ¯ä¸ªæ“ä½œéƒ½æœ‰æ ‡å‡†ç¼–ç 
BusinessActionRegistry.HAZARD.CREATE    // HD_CRT_001
BusinessActionRegistry.HAZARD.UPDATE    // HD_UPD_002
BusinessActionRegistry.HAZARD.ASSIGN    // HD_ASG_004

// ç”¨äºå¿«é€Ÿæ£€ç´¢å’Œç»Ÿè®¡
```

### 5. **å¯è§†åŒ–ç»„ä»¶**
```tsx
// å·®å¼‚æŸ¥çœ‹å™¨
<LogDiffViewer diff={log.diff} mode="inline" />

// å¿«ç…§æŸ¥çœ‹å™¨
<LogSnapshotViewer snapshot={log.snapshot} />

// æ—¶é—´çº¿
<LogTimeline logs={logs} />
```

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

### å¿«é€Ÿå…¥é—¨
- **å¿«é€Ÿå¼€å§‹**: `å®¡è®¡æ—¥å¿—ç³»ç»Ÿ-å¿«é€Ÿå¼€å§‹.md`
- **é›†æˆç¤ºä¾‹**: `å®¡è®¡æ—¥å¿—ç³»ç»Ÿ-é›†æˆç¤ºä¾‹.ts`

### æ—§æ–‡æ¡£ï¼ˆä»ç„¶é€‚ç”¨ï¼Œä½†æ¨èçœ‹æ–°æ–‡æ¡£ï¼‰
- `æ“ä½œæ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`
- `æ“ä½œæ—¥å¿—é›†æˆç¤ºä¾‹.md`
- `æ“ä½œæ—¥å¿—å¿«é€Ÿå¼€å§‹.md`

### æŠ€æœ¯æ–‡æ¡£
- **ç±»å‹å®šä¹‰**: `src/types/audit.ts`
- **å¸¸é‡å®šä¹‰**: `src/constants/audit.ts`
- **å·¥å…·å‡½æ•°**: `src/lib/audit-utils.ts`
- **æ ¸å¿ƒæœåŠ¡**: `src/services/audit.service.ts`
- **å…¼å®¹å±‚**: `src/services/audit-compat.service.ts`

---

## âš™ï¸ å½“å‰çŠ¶æ€æ€»ç»“

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **æ•°æ®åº“ç»“æ„** | âœ… å·²å‡çº§ | æ”¯æŒå¿«ç…§ã€å·®å¼‚ã€å®¢æˆ·ç«¯ä¿¡æ¯ |
| **æ ¸å¿ƒæœåŠ¡** | âœ… å·²å®Œæˆ | AuditService å…¨åŠŸèƒ½ |
| **å…¼å®¹å±‚** | âœ… å·²å®Œæˆ | æ—§ API æ— ç¼åˆ‡æ¢åˆ°æ–°å®ç° |
| **ç±»å‹ç³»ç»Ÿ** | âœ… å·²å®Œæˆ | å®Œæ•´ TypeScript ç±»å‹å®šä¹‰ |
| **å‰ç«¯ç»„ä»¶** | âœ… å·²å®Œæˆ | Diffã€å¿«ç…§ã€æ—¶é—´çº¿æŸ¥çœ‹å™¨ |
| **æ•°æ®åº“ä¿æŠ¤** | âœ… å·²å®Œæˆ | Prisma ä¸­é—´ä»¶ä¿æŠ¤ |
| **æ—§ä»£ç å…¼å®¹** | âœ… 100% | æ‰€æœ‰æ—§ä»£ç éƒ½èƒ½æ­£å¸¸å·¥ä½œ |

---

## ğŸ‰ æ€»ç»“

**ç°åœ¨æ•´ä¸ª EHS ç³»ç»Ÿçš„æ—¥å¿—åŠŸèƒ½å·²ç»å®Œå…¨ç»Ÿä¸€ï¼**

- âœ… **æ—§ä»£ç æ— éœ€ä¿®æ”¹**ï¼Œè‡ªåŠ¨ä½¿ç”¨æ–°åº•å±‚
- âœ… **æ–°ä»£ç å»ºè®®ä½¿ç”¨æ–° API**ï¼Œæ›´å¼ºå¤§ã€æ›´å®‰å…¨
- âœ… **æ¸è¿›å¼è¿ç§»**ï¼Œå¯ä»¥é€æ­¥æ›¿æ¢æ—§ä»£ç 
- âœ… **å‘ä¸‹å…¼å®¹**ï¼Œä¸ä¼šç ´åç°æœ‰åŠŸèƒ½
- âœ… **é¢å‘æœªæ¥**ï¼Œæ»¡è¶³å®¡è®¡åˆè§„è¦æ±‚

**ç«‹å³å¼€å§‹ä½¿ç”¨ï¼** ğŸš€
