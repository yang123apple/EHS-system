# 隐患上报拖拽上传功能实现说明

## 功能概述

在桌面端（屏幕宽度 ≥ 1024px）的隐患上报弹窗中，用户现在可以直接将图片文件拖放到页面任意位置来完成照片上传，无需点击上传按钮。

## 实现细节

### 1. 技术实现

**文件位置**: `EHS-system/src/app/hidden-danger/_components/modals/HazardReportModal.tsx`

#### 核心功能

1. **桌面端检测**
   - 使用 `window.innerWidth >= 1024` 检测是否为桌面端
   - 响应式监听窗口大小变化
   - 仅在桌面端启用拖拽功能

2. **拖拽状态管理**
   ```typescript
   const [isDragging, setIsDragging] = useState(false);
   const dragCounterRef = useRef(0); // 跟踪拖拽进入/离开次数
   ```

3. **拖拽事件处理**
   - `handleDragEnter`: 检测文件拖入，显示提示 overlay
   - `handleDragLeave`: 检测文件离开，隐藏提示
   - `handleDragOver`: 阻止默认行为，允许拖放
   - `handleDrop`: 处理文件放置，执行上传

4. **文件处理**
   - 支持批量上传多张图片
   - 验证文件格式（JPG、PNG、JPEG）
   - 自动转换为 Base64 预览

### 2. 用户体验

#### 拖拽提示 Overlay
当用户将图片拖到弹窗区域时，会显示：
- 蓝色半透明背景（bg-blue-600/90）
- 模糊效果（backdrop-blur-md）
- 动画上传图标（Upload icon with animate-bounce）
- 提示文字："松开鼠标上传图片" + "支持 JPG、PNG、JPEG 格式"

#### 视觉效果
```tsx
{isDesktop && isDragging && (
  <div className="absolute inset-0 z-[60] bg-blue-600/90 backdrop-blur-md flex items-center justify-center pointer-events-none">
    <div className="text-center">
      <Upload size={64} className="text-white mx-auto mb-4 animate-bounce" />
      <h3 className="text-2xl font-bold text-white mb-2">松开鼠标上传图片</h3>
      <p className="text-blue-100">支持 JPG、PNG、JPEG 格式</p>
    </div>
  </div>
)}
```

### 3. 文件格式验证

支持的格式：
- MIME 类型：`image/jpeg`, `image/jpg`, `image/png`
- 文件扩展名：`.jpg`, `.jpeg`, `.png`

不支持的文件会显示警告提示。

### 4. 兼容性

- **桌面端**（≥ 1024px）：完整支持拖拽上传
- **移动端**（< 1024px）：保持原有点击上传方式
- **渐进增强**：拖拽功能作为额外特性，不影响原有功能

### 5. 技术细节

#### dragCounter 机制
使用 `dragCounterRef` 解决拖拽事件冒泡问题：
- 拖入时计数 +1
- 拖出时计数 -1
- 仅当计数归零时才隐藏提示
- 避免在子元素间移动时闪烁

#### 事件绑定位置
```tsx
<div 
  className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-2 lg:p-4 backdrop-blur-sm"
  onDragEnter={isDesktop ? handleDragEnter : undefined}
  onDragLeave={isDesktop ? handleDragLeave : undefined}
  onDragOver={isDesktop ? handleDragOver : undefined}
  onDrop={isDesktop ? handleDrop : undefined}
>
```

## 使用方式

### 桌面端用户

1. 打开隐患上报弹窗
2. 从文件管理器选择一张或多张图片
3. 将图片拖到弹窗任意位置
4. 看到蓝色提示 overlay 后松开鼠标
5. 图片自动上传并显示预览

### 移动端用户

继续使用原有的点击上传方式：
1. 点击"上传照片"按钮
2. 从相册或相机选择图片
3. 确认上传

## 优势

1. **提升效率**：桌面端用户无需点击，直接拖放即可
2. **直观友好**：视觉反馈清晰，操作流畅
3. **向下兼容**：不影响移动端和原有功能
4. **批量支持**：可同时拖放多张图片
5. **安全验证**：保持文件格式验证机制

## 后续优化建议

1. 添加拖拽区域高亮边框
2. 支持更多图片格式（WebP、AVIF）
3. 添加拖拽进度指示器
4. 实现图片压缩功能
5. 支持粘贴上传（Ctrl+V）

## 测试建议

### 桌面端测试
- [ ] 拖拽单张图片到弹窗
- [ ] 拖拽多张图片到弹窗
- [ ] 拖拽非图片文件（应显示错误提示）
- [ ] 拖拽过程中移到子元素（不应闪烁）
- [ ] 拖拽后取消（不上传）
- [ ] 窗口大小调整时的行为

### 移动端测试
- [ ] 确认拖拽功能不启用
- [ ] 原有点击上传功能正常
- [ ] 界面无异常显示

### 兼容性测试
- [ ] Chrome/Edge（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] 不同分辨率（1024px临界点）

## 更新日期

2026年1月19日
