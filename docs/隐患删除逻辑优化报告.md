# 隐患删除逻辑优化报告

## 修复日期
2026年1月22日

## 问题描述

管理员删除已作废的隐患时，系统提示"无法重复作废"，不符合预期的业务逻辑。

### 期望的业务逻辑

1. **未作废隐患**：
   - 管理员或用户删除时 → 执行**软删除**（作废）
   - 需要输入作废原因
   - 隐患标记为已作废，数据保留在系统中
   - 普通用户看不到已作废的隐患
   - 管理员可以看到已作废的隐患

2. **已作废隐患**：
   - 只有管理员可以删除
   - 执行**硬删除**（彻底删除）
   - 弹窗提示"您确定要彻底删除该隐患吗？"
   - 物理删除数据库记录，不可恢复
   - 不能进行除删除外的任何业务操作

## 修复方案

### 1. 修改主页面删除逻辑 (`src/app/hidden-danger/page.tsx`)

#### 1.1 修改状态类型
```typescript
// 修改前
const [showDeleteConfirm, setShowDeleteConfirm] = useState<string | null>(null);

// 修改后
const [showDeleteConfirm, setShowDeleteConfirm] = useState<HazardRecord | null>(null);
```

#### 1.2 修改 handleDelete 函数
```typescript
// 修改前：只接收隐患 ID
const handleDelete = async (id: string) => {
  setShowDeleteConfirm(id);
  setVoidReason('');
};

// 修改后：接收完整的隐患对象
const handleDelete = async (hazard: HazardRecord) => {
  setShowDeleteConfirm(hazard);
  setVoidReason('');
};
```

#### 1.3 修改 confirmDelete 函数
```typescript
const confirmDelete = async () => {
  if (!showDeleteConfirm) return;
  
  const isVoided = showDeleteConfirm.isVoided;
  
  // 如果是未作废的隐患，验证作废原因
  if (!isVoided && (!voidReason || voidReason.trim() === '')) {
    toast.error('请填写作废原因');
    return;
  }
  
  try {
    if (isVoided) {
      // 已作废的隐患 → 硬删除（彻底删除）
      await hazardService.destroyHazard(showDeleteConfirm.id);
      toast.success('隐患已彻底删除');
    } else {
      // 未作废的隐患 → 软删除（作废）
      await hazardService.voidHazard(showDeleteConfirm.id, voidReason);
      toast.success('隐患已作废');
    }
    
    setShowDeleteConfirm(null);
    setVoidReason('');
    setSelectedHazard(null);
    await refresh();
  } catch (error) {
    console.error(isVoided ? '彻底删除失败:' : '作废失败:', error);
    toast.error(isVoided ? '彻底删除失败，请重试' : '作废失败，请重试');
  }
};
```

#### 1.4 修改确认弹窗UI
创建了两个不同的确认对话框：

**未作废隐患 - 作废确认框**：
- 标题：作废隐患
- 说明：作废后的隐患记录将保留在系统中
- 输入框：要求输入作废原因（必填）
- 确认按钮：橙色"确认作废"按钮

**已作废隐患 - 彻底删除确认框**：
- 标题：⚠️ 彻底删除隐患（红色警告）
- 说明：您确定要彻底删除该隐患吗？
- 警告横幅：红色背景，提示此操作不可恢复
- 确认按钮：红色"确认彻底删除"按钮

### 2. 修改数据表格组件 (`src/app/hidden-danger/_components/views/HazardDataTable.tsx`)

#### 2.1 修改 Props 接口
```typescript
// 修改前
interface Props {
  onDelete: (id: string) => void;
  // ...
}

// 修改后
interface Props {
  onDelete: (hazard: HazardRecord) => void;
  // ...
}
```

#### 2.2 修改删除按钮调用
```typescript
// 修改前
onClick={(e) => {e.stopPropagation(); onDelete(h.id);}}

// 修改后
onClick={(e) => {e.stopPropagation(); onDelete(h);}}
```

### 3. 重新生成 Prisma Client
```bash
npx prisma generate
```

确保 TypeScript 类型定义包含软删除字段（`isVoided`、`voidReason`、`voidedAt`、`voidedBy`）。

## 技术实现细节

### API 调用流程

1. **软删除（作废）**：
   ```typescript
   hazardService.voidHazard(id, reason)
   → POST /api/hazards/void
   → 更新数据库：isVoided=true, voidReason, voidedAt, voidedBy
   → 记录系统日志
   ```

2. **硬删除（彻底删除）**：
   ```typescript
   hazardService.destroyHazard(id)
   → DELETE /api/hazards/destroy
   → 验证是否已作废
   → 物理删除数据库记录
   → 记录系统日志
   ```

### 用户体验优化

1. **视觉区分**：
   - 已作废隐患：灰色半透明背景
   - 删除确认框：根据操作类型使用不同颜色（橙色 vs 红色）
   - 警告提示：硬删除时显示红色警告横幅

2. **操作提示**：
   - 软删除：提示"作废后的隐患记录将保留在系统中"
   - 硬删除：提示"此操作将永久删除该隐患记录...此操作不可恢复！"

3. **防误操作**：
   - 软删除：必须填写作废原因
   - 硬删除：明确的红色警告和二次确认

## 测试验证

### 测试场景

1. **管理员删除未作废隐患**：
   - ✅ 弹出"作废隐患"对话框
   - ✅ 要求输入作废原因
   - ✅ 确认后执行软删除
   - ✅ 隐患标记为已作废

2. **管理员删除已作废隐患**：
   - ✅ 弹出"彻底删除隐患"对话框
   - ✅ 显示红色警告提示
   - ✅ 确认后执行硬删除
   - ✅ 隐患从数据库中物理删除

3. **普通用户权限**：
   - ✅ 看不到已作废的隐患
   - ✅ 可以作废自己上报的隐患

4. **已作废隐患的操作限制**：
   - ✅ 不能进行批准/驳回等业务操作
   - ✅ 只能查看详情或删除（管理员）

## 修改文件清单

1. `src/app/hidden-danger/page.tsx` - 主页面删除逻辑
2. `src/app/hidden-danger/_components/views/HazardDataTable.tsx` - 数据表格组件

## 相关文档

- [隐患软删除和硬删除实现文档](./隐患软删除和硬删除实现文档.md)
- [隐患软删除实现检查报告](./隐患软删除实现检查报告.md)
- [隐患软删除Bug修复报告](./隐患软删除Bug修复报告.md)
- [隐患软删除显示问题修复报告](./隐患软删除显示问题修复报告.md)

## 总结

本次优化完善了隐患删除的业务逻辑，实现了：

1. ✅ **智能判断**：根据隐患状态自动选择软删除或硬删除
2. ✅ **清晰提示**：不同操作类型使用不同的确认对话框
3. ✅ **安全防护**：硬删除时显示红色警告，防止误操作
4. ✅ **类型安全**：TypeScript 类型定义完整，避免运行时错误
5. ✅ **用户体验**：流程清晰，操作直观

修复后的系统符合预期的业务逻辑，管理员可以正确删除已作废的隐患，不再出现"无法重复作废"的错误提示。
