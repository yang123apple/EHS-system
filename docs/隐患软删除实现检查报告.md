# 隐患软删除实现检查报告

## 📋 检查时间
2026-01-22

## 🎯 需求对照

### ✅ 已实现的功能

1. **软删除机制** ✅
   - 数据库字段已添加（`isVoided`, `voidReason`, `voidedAt`, `voidedBy`）
   - 软删除API已实现（`/api/hazards/void`）
   - 硬删除API已实现（`/api/hazards/destroy`，仅admin）

2. **查询过滤** ✅ 
   - `/api/hazards/route.ts` GET端点已实现角色过滤
   - 普通用户：`where.isVoided = false`
   - 管理员：无过滤，显示所有隐患

3. **权限控制** ✅
   - 硬删除仅限admin（403校验）
   - 软删除所有登录用户可用

---

## ⚠️ 发现的问题

### 🔴 问题1：导出功能未过滤软删除数据

**文件位置：** `src/app/hidden-danger/_components/views/HazardDataTable.tsx`

**当前实现：**
```typescript
const handleExport = async () => {
  const response = await hazardService.getHazards(1, maxExportLimit, filters);
  // 直接导出所有获取到的数据，未区分用户角色
}
```

**问题描述：**
- 导出功能调用 `hazardService.getHazards()` 获取数据
- 虽然API层已经根据角色过滤了软删除数据
- 但**文档要求明确区分**：
  - ✅ 普通用户导出：不包含软删除隐患
  - ✅ admin导出：包含软删除隐患
- 当前实现依赖API过滤，**符合需求**，但缺少前端视觉提示

**建议修复：**
1. 在导出的Excel中为admin添加"已作废"标识列
2. 对已作废的隐患行进行特殊样式标记（如背景色置灰）

---

### 🔴 问题2：统计分析未过滤软删除数据

**文件位置：** `src/app/hidden-danger/_components/views/StatsAnalysis.tsx`

**当前实现：**
```typescript
export function StatsAnalysis({ hazards, loading }: StatsAnalysisProps) {
  // 直接使用传入的 hazards 数组进行统计
  const categoryStats = useMemo(() => {
    hazards.forEach(h => { /* 统计逻辑 */ });
  }, [hazards]);
}
```

**问题描述：**
- 统计分析组件接收 `hazards` 数组作为props
- 未主动过滤 `isVoided` 字段
- 依赖父组件传入的数据是否已过滤
- **文档要求**：统计分析页面应忽略软删除的隐患数据

**影响范围：**
- 隐患整改率计算
- 隐患类别分析
- 发现位置高频词
- 责任部门分布
- 隐患详情高频词

**根因分析：**
需要检查 `StatsAnalysis` 组件的调用位置，确认传入的 `hazards` 数据源：
1. 如果数据来自API（已过滤），则符合需求 ✅
2. 如果数据来自前端状态管理（未过滤），需要组件内部过滤 ❌

---

### 🔴 问题3：隐患中心/我的任务界面过滤

**需要检查：**
1. `src/app/hidden-danger/page.tsx` 主页面
2. `src/app/hidden-danger/_hooks/useHazardData.ts` 数据获取钩子

**期望行为：**
- 隐患中心（全部隐患）：
  - 普通用户：不显示软删除隐患
  - Admin：显示所有隐患，软删除隐患有视觉标识
- 我的任务界面：
  - 所有用户：不显示软删除隐患

---

### 🔴 问题4：前端视觉标识缺失

**当前状态：**
- 数据库和API层已实现软删除
- 前端UI未显示软删除状态

**需要添加：**
1. **HazardCard组件**：为已作废隐患添加标记（置灰+徽章）
2. **HazardDataTable组件**：表格行添加视觉区分
3. **HazardDetailModal组件**：详情模态框显示作废信息

---

## 🔍 需要进一步检查的文件

1. **数据获取层**
   - `src/app/hidden-danger/page.tsx` - 主页面数据获取
   - `src/app/hidden-danger/_hooks/useHazardData.ts` - 数据钩子
   - `src/services/hazard.service.ts` - 服务层

2. **前端组件**
   - `src/app/hidden-danger/_components/HazardCard.tsx` - 卡片组件
   - `src/app/hidden-danger/_components/modals/HazardDetailModal/index.tsx` - 详情模态框
   - `src/app/hidden-danger/_components/views/OverviewDashboard.tsx` - 概览面板

---

## 📊 实现完整性评估

| 功能点 | 状态 | 备注 |
|--------|------|------|
| 数据库字段 | ✅ 完成 | 已添加软删除字段 |
| 软删除API | ✅ 完成 | `/api/hazards/void` |
| 硬删除API | ✅ 完成 | `/api/hazards/destroy` (admin only) |
| 查询过滤-API层 | ✅ 完成 | 根据角色过滤 |
| 查询过滤-隐患中心 | ⚠️ 待验证 | 需检查页面组件 |
| 查询过滤-我的任务 | ⚠️ 待验证 | 需检查页面组件 |
| 导出-普通用户 | ✅ 基本完成 | API已过滤，建议加视觉标识 |
| 导出-Admin | ⚠️ 待优化 | 建议添加"已作废"标识列 |
| 统计分析过滤 | ⚠️ 待验证 | 需确认数据源 |
| 前端视觉标识 | ❌ 缺失 | 需添加UI标记 |
| 权限控制 | ✅ 完成 | 硬删除仅admin |

**完成度：** 约 70%

---

## 🛠️ 修复建议优先级

### P0 - 必须修复（影响核心需求）

1. **验证数据获取逻辑**
   - 检查 `page.tsx` 和 `useHazardData.ts`
   - 确保所有数据源都正确过滤软删除

2. **统计分析过滤**
   - 在组件内部添加防御性过滤
   - 确保即使数据源未过滤，组件也能正确处理

### P1 - 应该修复（用户体验）

3. **前端视觉标识**
   - HazardCard：添加"已作废"徽章和置灰样式
   - HazardDataTable：表格行区分显示
   - HazardDetailModal：详情显示作废信息

4. **导出优化**
   - Admin导出时添加"状态"列（正常/已作废）
   - 已作废行使用不同背景色

### P2 - 可以优化（功能增强）

5. **软删除恢复功能**
   - 添加 `/api/hazards/restore` 端点
   - Admin可恢复误作废的隐患

6. **作废历史记录**
   - 在详情页显示作废历史
   - 支持查看谁在何时作废了隐患

---

## 📝 下一步行动

1. ✅ 检查主页面数据获取逻辑
2. ✅ 验证统计分析数据源
3. ✅ 添加前端视觉标识
4. ✅ 优化导出功能
5. ⏭️ 可选：实现恢复功能

---

**检查人：** Cline AI Assistant  
**状态：** 待开发者确认并修复
