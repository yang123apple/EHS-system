# 档案库日志接口使用说明

## 一、接口概述

档案库模块提供了专用的日志查询接口，用于查看档案库相关的操作日志。

## 二、接口信息

### 2.1 档案库专用日志接口

**接口地址**: `/api/archives/logs`

**请求方式**: `GET`

**权限要求**: 需要登录认证（使用 `withAuth` 中间件）

**功能**: 查询档案库模块（`module=ARCHIVE`）的所有操作日志

### 2.2 系统日志接口（查看所有模块）

**接口地址**: `/api/logs`

**请求方式**: `GET`

**查询参数**: `module=ARCHIVE` 可筛选档案库日志

**功能**: 查询所有模块的日志，包括档案库日志

## 三、查询参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| page | number | 否 | 页码，默认1 | `1` |
| limit | number | 否 | 每页数量，默认50 | `50` |
| targetType | string | 否 | 目标类型筛选 | `archive_file`, `equipment`, `archive_config` |
| targetId | string | 否 | 目标ID筛选 | `file_id` |
| action | string | 否 | 操作类型筛选 | `UPLOAD`, `DELETE`, `CREATE`, `UPDATE`, `CONFIG` |
| userId | string | 否 | 用户ID筛选 | `user_id` |
| startDate | string | 否 | 开始日期（YYYY-MM-DD） | `2024-01-01` |
| endDate | string | 否 | 结束日期（YYYY-MM-DD） | `2024-01-31` |

## 四、返回格式

### 4.1 成功响应

```json
{
  "success": true,
  "data": {
    "logs": [
      {
        "id": "log_id",
        "userId": "user_id",
        "userName": "用户名",
        "userRole": "admin",
        "userDepartment": "部门名称",
        "action": "UPLOAD",
        "actionLabel": "上传档案",
        "module": "ARCHIVE",
        "targetId": "file_id",
        "targetType": "archive_file",
        "targetLabel": "文件名.pdf",
        "details": "{\"fileName\":\"文件名.pdf\",\"fileType\":\"基础资质与证照\",\"category\":\"enterprise\"}",
        "createdAt": "2024-01-01T10:00:00.000Z",
        ...
      }
    ],
    "total": 100
  },
  "meta": {
    "page": 1,
    "limit": 50,
    "totalPages": 2,
    "total": 100
  }
}
```

### 4.2 错误响应

```json
{
  "success": false,
  "error": "获取日志失败",
  "data": {
    "logs": [],
    "total": 0
  },
  "meta": {
    "page": 1,
    "limit": 50,
    "totalPages": 0,
    "total": 0
  }
}
```

## 五、使用示例

### 5.1 JavaScript/TypeScript

```typescript
// 查询所有档案库日志
async function getArchiveLogs(page = 1, limit = 50) {
  const res = await fetch(`/api/archives/logs?page=${page}&limit=${limit}`, {
    headers: {
      'x-user-id': 'current_user_id', // 需要传递用户ID进行认证
    },
  });
  const data = await res.json();
  return data;
}

// 查询上传操作日志
async function getUploadLogs() {
  const res = await fetch('/api/archives/logs?action=UPLOAD');
  const data = await res.json();
  return data;
}

// 查询特定设备的日志
async function getEquipmentLogs(equipmentId: string) {
  const res = await fetch(`/api/archives/logs?targetType=equipment&targetId=${equipmentId}`);
  const data = await res.json();
  return data;
}

// 查询日期范围日志
async function getLogsByDateRange(startDate: string, endDate: string) {
  const res = await fetch(`/api/archives/logs?startDate=${startDate}&endDate=${endDate}`);
  const data = await res.json();
  return data;
}
```

### 5.2 使用系统日志接口查询档案库日志

```typescript
// 通过系统日志接口查询档案库日志
async function getArchiveLogsFromSystem() {
  const res = await fetch('/api/logs?module=ARCHIVE');
  const data = await res.json();
  return data;
}
```

## 六、日志类型说明

### 6.1 操作类型（action）

- `UPLOAD`: 上传文件
- `DELETE`: 删除文件
- `CREATE`: 创建（如创建设备）
- `UPDATE`: 更新（如更新设备信息）
- `CONFIG`: 配置（如更新档案配置）

### 6.2 目标类型（targetType）

- `archive_file`: 档案文件
- `equipment`: 设备
- `archive_config`: 档案配置

## 七、注意事项

1. **权限要求**: 所有查询都需要登录认证
2. **数据范围**: 档案库专用接口只返回 `module=ARCHIVE` 的日志
3. **系统日志**: 档案库日志也会出现在系统操作日志中（`/api/logs?module=ARCHIVE`）
4. **日期格式**: 日期参数必须使用 `YYYY-MM-DD` 格式
5. **分页**: 默认每页50条，可通过 `limit` 参数调整

## 八、前端集成示例

```tsx
// React组件示例
import { useState, useEffect } from 'react';

function ArchiveLogView() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);

  const fetchLogs = async (pageNum = 1) => {
    setLoading(true);
    try {
      const res = await fetch(`/api/archives/logs?page=${pageNum}&limit=50`, {
        headers: {
          'x-user-id': 'current_user_id',
        },
      });
      const data = await res.json();
      if (data.success) {
        setLogs(data.data.logs);
        setTotalPages(data.meta.totalPages);
        setPage(pageNum);
      }
    } catch (error) {
      console.error('获取日志失败:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchLogs(1);
  }, []);

  return (
    <div>
      <h2>档案库操作日志</h2>
      {loading ? (
        <div>加载中...</div>
      ) : (
        <>
          <table>
            <thead>
              <tr>
                <th>时间</th>
                <th>操作人</th>
                <th>操作</th>
                <th>目标</th>
                <th>详情</th>
              </tr>
            </thead>
            <tbody>
              {logs.map((log) => (
                <tr key={log.id}>
                  <td>{new Date(log.createdAt).toLocaleString()}</td>
                  <td>{log.userName}</td>
                  <td>{log.actionLabel}</td>
                  <td>{log.targetLabel}</td>
                  <td>{log.details}</td>
                </tr>
              ))}
            </tbody>
          </table>
          <div>
            <button onClick={() => fetchLogs(page - 1)} disabled={page === 1}>
              上一页
            </button>
            <span>第 {page} 页 / 共 {totalPages} 页</span>
            <button onClick={() => fetchLogs(page + 1)} disabled={page === totalPages}>
              下一页
            </button>
          </div>
        </>
      )}
    </div>
  );
}
```

