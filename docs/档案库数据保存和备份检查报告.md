# EHS档案库模块数据保存和备份检查报告

## 一、当前数据保存方式

### 1.1 文件存储
- **存储位置**: MinIO对象存储（private bucket）
- **存储路径格式**: `bucket:key`（如：`private:archives/enterprise/xxx.pdf`）
- **文件类型**: 支持 pdf/docx/xlsx/png/jpg/jpeg

### 1.2 数据库存储
- **ArchiveFile表**: 存储文件元数据（名称、类型、路径、大小等）
- **ArchiveConfig表**: 存储配置（水印、文件类型库等）
- **Equipment表**: 存储设备信息
- **User表**: 存储人员信息（一人一档）

### 1.3 备份机制
- **数据库备份**: 
  - 全量备份：每日02:00
  - 增量备份：每小时（WAL文件）
- **MinIO备份**: 
  - 增量同步：每日02:30（使用mc mirror）
  - 备份到本地目录：`./data/minio-backup`

## 二、发现的问题

### 2.1 数据一致性问题 ⚠️ 严重

**问题描述**：
1. 上传文件时，先上传到MinIO，然后保存到数据库
2. 如果MinIO上传成功但数据库保存失败，会导致：
   - 文件在MinIO中存在，但数据库没有记录
   - 文件无法通过系统访问（因为数据库没有记录）
   - 文件成为"孤儿文件"，占用存储空间但无法管理

3. 如果数据库保存成功但MinIO上传失败，会导致：
   - 数据库有记录，但文件不存在
   - 用户看到文件记录，但无法下载/预览

**影响**：
- 数据不一致
- 存储空间浪费
- 用户体验差

### 2.2 备份索引缺失 ⚠️ 中等

**问题描述**：
- `ArchiveFile`表的数据没有同步到`FileMetadata`表
- `FileMetadata`表用于文件索引和增量备份
- 档案库的文件不会被备份系统正确索引

**影响**：
- 备份系统可能无法完整备份档案库文件
- 增量备份可能遗漏档案库文件

### 2.3 错误处理不完善 ⚠️ 中等

**问题描述**：
- 如果MinIO上传失败，没有回滚机制
- 如果数据库保存失败，MinIO中的文件不会被清理
- 没有事务处理保证原子性

**影响**：
- 可能导致数据不一致
- 需要手动清理孤儿文件

## 三、修复建议

### 3.1 添加事务处理
- 使用数据库事务确保原子性
- 如果数据库保存失败，删除MinIO中的文件
- 如果MinIO上传失败，不保存数据库记录

### 3.2 同步到FileMetadata表
- 上传文件时，同时写入`ArchiveFile`和`FileMetadata`表
- 确保备份系统能正确索引档案库文件

### 3.3 改进错误处理
- 添加详细的错误日志
- 实现自动清理机制
- 添加数据一致性检查工具

## 四、修复状态

### ✅ 已修复

#### 4.1 数据一致性问题（2.1）✅
- **修复内容**:
  - 创建了统一的`uploadArchiveFile`辅助函数
  - 实现了事务处理：先上传MinIO，再保存数据库
  - 如果数据库保存失败，自动清理MinIO中的文件
  - 如果MinIO上传失败，不保存数据库记录
- **修复文件**:
  - `src/lib/archiveUploadHelper.ts`（新增）
  - `src/app/api/archives/enterprise/route.ts`
  - `src/app/api/archives/equipment/[id]/files/route.ts`
  - `src/app/api/archives/personnel/[id]/files/route.ts`

#### 4.2 备份索引缺失（2.2）✅
- **修复内容**:
  - 上传文件时，同时写入`ArchiveFile`和`FileMetadata`表
  - 使用`upsert`确保不重复
  - 计算MD5哈希值用于备份去重
  - 设置`category='archives'`标识档案库文件
- **修复文件**:
  - `src/lib/archiveUploadHelper.ts`

### ⚠️ 待改进

#### 4.3 错误处理改进（2.3）
- **建议**:
  - 添加数据一致性检查工具（定期检查ArchiveFile和MinIO文件的一致性）
  - 添加孤儿文件清理工具
  - 添加详细的错误日志和监控

## 五、备份机制说明

### 5.1 数据库备份
- **全量备份**: 每日02:00（SQLite dump）
- **增量备份**: 每小时（WAL文件）
- **保留策略**: 全量备份保留30天，增量备份保留7天
- **备份位置**: `./data/backups/database/`

### 5.2 MinIO备份
- **增量同步**: 每日02:30（使用mc mirror）
- **备份位置**: `./data/minio-backup/`
- **备份范围**: `ehs-private`和`ehs-public`两个bucket
- **同步方式**: 增量同步，只传输变化文件

### 5.3 文件索引
- **FileMetadata表**: 用于文件索引和增量备份
- **MD5哈希**: 用于去重和变化检测
- **档案库文件**: 现在已同步到FileMetadata表，会被备份系统正确索引

## 六、全项目修复状态

### ✅ 已修复的文件上传接口

1. **档案库模块**（3个接口）
   - `src/app/api/archives/enterprise/route.ts`
   - `src/app/api/archives/equipment/[id]/files/route.ts`
   - `src/app/api/archives/personnel/[id]/files/route.ts`

2. **文档管理系统**（1个接口）
   - `src/app/api/docs/route.ts`

3. **用户管理**（2个接口）
   - `src/app/api/users/[id]/route.ts`
   - `src/app/api/users/batch-avatar/route.ts`

4. **培训系统**（1个接口）
   - `src/app/api/training/materials/[id]/thumbnail/route.ts`

5. **通用上传**（1个接口）
   - `src/app/api/upload/route.ts`

**总计**: 8个文件上传接口已全部修复

### 修复内容

- ✅ 数据一致性：添加事务处理和错误回滚
- ✅ 备份索引：所有文件同步到FileMetadata表
- ✅ 错误处理：统一的错误处理和清理机制

详细修复报告请参考：`docs/全项目文件上传修复报告.md`

## 七、使用建议

1. **定期检查**: 建议每月检查一次数据一致性
2. **备份验证**: 建议每周验证一次备份完整性
3. **监控告警**: 建议添加备份失败的告警机制
4. **灾难恢复**: 建议定期测试备份恢复流程
5. **数据一致性检查**: 建议定期运行数据一致性检查工具（待开发）

