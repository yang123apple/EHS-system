# 事故事件管理模块前端实现总结

## 一、已完成的实现

### 1.1 列表页 (`src/app/incident/page.tsx`)

**功能**：
- ✅ 事故列表展示（表格形式）
- ✅ 分页功能
- ✅ 筛选功能（状态、类型、严重程度、时间范围）
- ✅ 查看详情功能
- ✅ 上报事故入口

**技术特点**：
- 使用 Server Actions (`getIncidents`) 获取数据
- 支持多种筛选条件
- 响应式设计

### 1.2 上报模态框 (`src/components/incident/IncidentReportModal.tsx`)

**功能**：
- ✅ 事故基本信息录入
- ✅ 文件上传（照片、附件）
- ✅ 表单验证
- ✅ 调用 Server Action 上报

**表单字段**：
- 事故类型（必填）
- 严重程度（必填）
- 发生时间（必填）
- 发生地点（必填）
- 事故描述（必填）
- 责任部门（可选）
- 现场照片（可选）
- 其他附件（可选）

### 1.3 详情模态框 (`src/components/incident/IncidentDetailModal.tsx`)

**功能**：
- ✅ 基本信息展示
- ✅ 调查详情展示（5Why分析）
- ✅ 整改措施展示
- ✅ 附件和照片展示
- ✅ 调查报告表单（状态为"已上报"或"调查中"时）
- ✅ 审批操作（状态为"待审批"且为管理员时）

**标签页**：
1. **基本信息**：显示所有事故信息
2. **调查报告**：显示调查表单（如果状态允许）
3. **审批操作**：显示审批按钮（如果状态和权限允许）

**调查报告表单**：
- 直接原因（必填）
- 间接原因（必填）
- 管理原因（必填）
- 根本原因（必填）
- 纠正措施（必填，支持多条）
- 预防措施（可选，支持多条）
- 整改期限（必填）
- 负责人ID（必填）
- 调查报告文件（可选）
- 调查照片（可选）

## 二、文件上传集成

### 2.1 FileUploader 组件使用

使用现有的 `FileUploader` 组件，配置：
- `bucket="private"`: 使用私有存储桶
- `prefix`: 设置文件路径前缀（如 `incidents/photos`）
- `accept`: 限制文件类型
- `multiple={true}`: 支持多文件上传
- `onUploadSuccess`: 上传成功回调，接收 `(objectName: string, url?: string)`

### 2.2 文件路径格式

上传成功后，文件路径格式为：
```
private:incidents/photos/xxx.jpg
```

存储在数据库中的格式：
```json
["private:incidents/photos/photo1.jpg", "private:incidents/photos/photo2.jpg"]
```

## 三、工作流配置

### 3.1 工作流定义 (`src/app/incident/_utils/workflow-config.ts`)

定义了事故处理流程的四个步骤：
1. **已上报** (reported): 初始状态
2. **调查中** (investigating): 调查人员填写调查报告
3. **待审批** (reviewed): 等待管理员审批
4. **已结案** (closed): 审批通过，事故结案

**注意**：当前工作流配置是简化版本，实际使用时需要：
- 集成到 IncidentService 中的状态流转逻辑
- 处理人匹配逻辑（参考隐患模块的 `handler-matcher.ts`）
- 或签/会签逻辑处理

## 四、待完善的功能

### 4.1 工作流引擎集成

当前状态流转是通过直接更新数据库状态实现的，需要：
1. 集成工作流引擎（参考 `WorkflowEngine` 或 `HazardDispatchEngine`）
2. 实现自动处理人匹配
3. 支持审批、驳回操作

### 4.2 数字签名集成

如果需要调查报告签字功能：
1. 在提交调查报告时调用签名组件
2. 记录签名到 SignatureRecord 表
3. 在详情页显示签名记录

### 4.3 用户选择器

当前负责人ID是文本输入，应该：
1. 使用现有的用户选择器组件（如 `PeopleSelector`）
2. 支持按部门、角色筛选
3. 支持搜索

### 4.4 部门选择器

当前部门ID是文本输入，应该：
1. 使用现有的部门选择器
2. 支持树形结构选择

### 4.5 数据验证增强

- 日期验证（发生时间不能晚于当前时间）
- 整改期限验证（不能早于当前时间）
- 负责人存在性验证

## 五、API 路由（可选）

如果需要 RESTful API（而不是 Server Actions），可以创建：
- `src/app/api/incident/route.ts`: GET（列表）、POST（创建）
- `src/app/api/incident/[id]/route.ts`: GET（详情）、PUT（更新）、DELETE（删除）
- `src/app/api/incident/[id]/investigation/route.ts`: POST（提交调查报告）
- `src/app/api/incident/[id]/close/route.ts`: POST（结案）

**注意**：当前实现使用 Server Actions，这是推荐的 Next.js 14+ 方式。

## 六、页面路由

### 6.1 当前路由

- `/incident`: 列表页（已完成）

### 6.2 可选路由

- `/incident/report`: 独立的上报页（可选）
- `/incident/[id]`: 独立的详情页（可选）

当前实现使用模态框，但也可以改为独立页面。

## 七、样式和UI

### 7.1 设计风格

- 遵循现有的 Tailwind CSS 样式规范
- 使用相同的颜色方案（蓝色主色调）
- 响应式设计

### 7.2 图标

使用 `lucide-react` 图标库，与其他模块保持一致。

## 八、测试建议

1. **功能测试**
   - 测试上报流程
   - 测试调查表单提交
   - 测试审批和结案
   - 测试文件上传

2. **权限测试**
   - 测试不同角色的权限
   - 测试只有管理员可以结案

3. **数据验证测试**
   - 测试必填字段验证
   - 测试文件格式验证
   - 测试日期格式验证

4. **UI测试**
   - 测试响应式布局
   - 测试模态框交互
   - 测试分页和筛选

