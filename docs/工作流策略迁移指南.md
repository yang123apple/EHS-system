# 工作流策略数据迁移指南

## 概述

本指南说明如何将现有的隐患管理和作业票管理系统的工作流策略配置迁移到新的统一格式。

## 迁移内容

### 1. 隐患管理系统

**数据位置**: `HazardConfig` 表
- `workflow_steps` - 工作流步骤配置
- `handler_strategy` - 处理人策略配置
- `workflow_config` - 完整工作流配置

**迁移变更**:
```typescript
// 旧格式
{
  handlerStrategy: {
    type: 'fixed',
    userIds: ['user1', 'user2']
  }
}

// 新格式
{
  strategies: [{
    id: 'generated-id',
    type: 'fixed',
    config: {
      userIds: ['user1', 'user2']
    }
  }]
}
```

### 2. 作业票管理系统

**数据位置**: `WorkPermitTemplate.workflowConfig`

**迁移变更**:
```typescript
// 旧格式
{
  steps: [{
    approverStrategy: {
      type: 'form_condition',
      field: 'amount',
      condition: { operator: '>', value: '5000' },
      userIds: ['approver1']
    }
  }]
}

// 新格式
{
  steps: [{
    strategies: [{
      id: 'generated-id',
      type: 'form_condition',
      config: {
        field: 'amount',
        condition: { operator: '>', value: '5000' },
        userIds: ['approver1']
      }
    }]
  }]
}
```

## 迁移步骤

### 步骤 1: 模拟运行（推荐）

首先执行模拟运行，检查迁移过程是否正常：

```bash
cd EHS-system
npx tsx scripts/migrate-workflow-strategies.ts --dry-run
```

这将：
- ✅ 不修改任何数据
- ✅ 显示将要进行的迁移操作
- ✅ 检测可能存在的问题
- ✅ 生成预览报告

### 步骤 2: 备份数据

执行实际迁移前，确保数据已备份：

```bash
# 自动备份（推荐）
npx tsx scripts/migrate-workflow-strategies.ts --backup

# 或手动备份数据库
cp prisma/dev.db prisma/dev.db.backup-$(date +%Y%m%d-%H%M%S)
```

### 步骤 3: 执行迁移

确认模拟运行无误后，执行实际迁移：

```bash
npx tsx scripts/migrate-workflow-strategies.ts
```

迁移脚本将：
1. 自动备份原始数据到 `backups/workflow-migration/`
2. 转换隐患管理配置
3. 转换作业票模板配置
4. 验证迁移结果
5. 生成详细报告

### 步骤 4: 验证结果

迁移完成后，检查生成的报告：

```bash
# 查看最新的迁移报告
cat backups/workflow-migration/report-*.json
```

报告内容示例：
```json
{
  "startTime": "2026-01-20T11:45:00.000Z",
  "endTime": "2026-01-20T11:45:05.000Z",
  "mode": "production",
  "hazardConfig": {
    "total": 3,
    "migrated": 3,
    "failed": 0,
    "errors": []
  },
  "workPermitTemplates": {
    "total": 5,
    "migrated": 5,
    "failed": 0,
    "errors": []
  },
  "backupPath": "backups/workflow-migration/backup-2026-01-20T11-45-00-000Z.json"
}
```

## 回滚方案

如果迁移后发现问题，可以从备份恢复：

### 方案 1: 使用备份文件恢复

```bash
# 查看备份文件
ls -lh backups/workflow-migration/

# 使用 Node.js 脚本恢复
node scripts/restore-workflow-backup.js backups/workflow-migration/backup-xxx.json
```

### 方案 2: 手动恢复数据库

```bash
# 停止应用
pm2 stop ehs-system

# 恢复数据库备份
cp prisma/dev.db.backup-xxx prisma/dev.db

# 重启应用
pm2 start ehs-system
```

## 迁移后任务

### 1. 更新旧组件引用

迁移后，需要更新使用旧组件的代码：

**隐患管理**:
```tsx
// 旧代码
import { HandlerStrategySelector } from '@/app/hidden-danger/_components/workflow/HandlerStrategySelector';

// 新代码
import { WorkflowStrategySelector } from '@/components/workflow';
```

**作业票管理**:
```tsx
// 旧代码
import { ApproverStrategyConfig } from '@/components/work-permit/moduls/ApproverStrategyConfig';

// 新代码
import { WorkflowStrategySelector } from '@/components/workflow';
```

### 2. 更新配置读取逻辑

确保读取配置的代码使用新的字段名：

```typescript
// 旧代码
const strategy = step.handlerStrategy || step.approverStrategy;

// 新代码
const strategies = step.strategies || [];
```

### 3. 测试关键功能

迁移后测试以下功能：

- [ ] 隐患上报后的处理人分配
- [ ] 作业票审批流程
- [ ] 区域/类型匹配规则
- [ ] 表单字段条件判断
- [ ] 或签/会签模式

## 常见问题

### Q1: 迁移失败如何处理？

**A**: 检查错误报告：
```bash
cat backups/workflow-migration/report-*.json | grep -A 5 "errors"
```

常见错误原因：
- 数据格式不符合预期
- 缺少必需字段
- JSON 解析错误

### Q2: 可以分步骤迁移吗？

**A**: 可以。迁移脚本支持只迁移特定类型：

```typescript
// 只迁移隐患配置
await migrateHazardConfigs(false);

// 只迁移作业票配置
await migrateWorkPermitTemplates(false);
```

### Q3: 迁移会影响现有业务吗？

**A**: 
- 迁移过程中建议暂停业务操作
- 迁移时间通常 < 1分钟
- 建议在业务低峰期执行
- 数据格式兼容，不影响历史记录

### Q4: 如何验证迁移是否成功？

**A**: 迁移脚本包含自动验证功能：

1. 检查所有配置已移除旧字段
2. 检查所有配置包含新字段
3. 验证数据格式正确性
4. 生成详细验证报告

### Q5: 迁移后旧组件还能用吗？

**A**: 
- 旧组件代码保留，但建议迁移到新组件
- 数据格式已变更，旧组件读取新数据可能有问题
- 建议在迁移后统一使用新组件

## 迁移检查清单

在执行迁移前，请确认：

- [ ] 已阅读并理解本迁移指南
- [ ] 已执行模拟运行 (`--dry-run`)
- [ ] 已备份数据库文件
- [ ] 已通知相关人员暂停业务操作
- [ ] 准备好回滚方案
- [ ] 了解迁移后的验证步骤

在迁移完成后，请确认：

- [ ] 查看迁移报告，确认无错误
- [ ] 执行功能测试
- [ ] 更新相关代码引用
- [ ] 通知用户恢复业务操作
- [ ] 保存备份文件至少 30 天

## 技术支持

如遇到问题：

1. 查看迁移报告中的错误详情
2. 检查 `backups/workflow-migration/` 目录中的备份文件
3. 参考 `src/components/workflow/README.md` 了解新组件使用方法
4. 联系技术团队

## 附录：手动迁移示例

如果需要手动迁移特定配置：

```typescript
import { convertHazardConfigToUnified } from '@/components/workflow/converter';

// 读取旧配置
const oldConfig = await prisma.hazardConfig.findUnique({
  where: { key: 'workflow_steps' }
});

// 转换格式
const oldValue = JSON.parse(oldConfig.value);
const newSteps = oldValue.map(step => ({
  ...step,
  strategies: step.handlerStrategy 
    ? [convertHazardConfigToUnified(step.handlerStrategy)]
    : []
}));

// 保存新配置
await prisma.hazardConfig.update({
  where: { key: 'workflow_steps' },
  data: { value: JSON.stringify(newSteps) }
});
```

## 版本历史

- **v1.0.0** (2026-01-20) - 初始版本
  - 支持隐患管理配置迁移
  - 支持作业票模板配置迁移
  - 自动备份和验证功能
  - 详细的迁移报告
