# 档案库模块日志系统实现文档

## 一、概述

为档案库模块添加了完整的日志记录功能，参考其他模块的日志系统实现，并接入系统总日志。

## 二、日志系统配置

### 2.1 类型定义更新

**文件**: `src/types/audit.ts`

- ✅ 添加了 `ARCHIVE` 模块到 `LogModule` 枚举
- ✅ 添加了档案库相关的业务编码：
  - `ARC_UPE_001`: 上传企业档案
  - `ARC_UPD_002`: 上传设备档案
  - `ARC_UPP_003`: 上传人员档案
  - `ARC_DEL_004`: 删除档案文件
  - `ARC_CRT_005`: 创建设备
  - `ARC_UPD_006`: 更新设备信息
  - `ARC_CFG_007`: 更新档案配置
  - `ARC_VEW_008`: 查看档案文件
  - `ARC_DWN_009`: 下载档案文件

### 2.2 常量定义更新

**文件**: `src/constants/audit.ts`

- ✅ 添加了 `ARCHIVE` 模块的中文标签：`档案库管理`
- ✅ 添加了档案库相关的目标类型映射：
  - `archive_file`: 档案文件
  - `equipment`: 设备
  - `archive_config`: 档案配置

### 2.3 中间件更新

**文件**: `src/middleware/auth.ts`

- ✅ 在 `logApiOperation` 函数中添加了档案库模块的映射
- ✅ 添加了 `archive` 模块到 `moduleToTargetType` 和 `moduleToLogModule` 映射
- ✅ 添加了档案库操作标签的中文显示

## 三、日志记录实现

### 3.1 文件上传日志

#### 企业档案上传
**文件**: `src/app/api/archives/enterprise/route.ts`
- ✅ 记录上传操作
- 日志内容：文件名、文件类型、文件大小、分类

#### 设备档案上传
**文件**: `src/app/api/archives/equipment/[id]/files/route.ts`
- ✅ 记录上传操作
- 日志内容：文件名、文件类型、文件大小、设备ID、设备名称

#### 人员档案上传
**文件**: `src/app/api/archives/personnel/[id]/files/route.ts`
- ✅ 记录上传操作
- 日志内容：文件名、文件类型、文件大小、用户ID、用户名称

### 3.2 文件删除日志

**文件**: `src/app/api/archives/files/[id]/route.ts`
- ✅ 记录删除操作
- 日志内容：文件ID、文件名、文件类型、分类、文件大小

### 3.3 设备管理日志

**文件**: `src/app/api/archives/equipment/route.ts`
- ✅ 记录创建设备操作
- 日志内容：设备ID、设备名称、设备编号、是否特种设备、定检周期

### 3.4 配置管理日志

**文件**: `src/app/api/archives/config/route.ts`
- ✅ 记录更新配置操作
- 日志内容：配置键、旧值、新值、是否新建配置

## 四、日志记录方式

### 4.1 使用 `logApiOperation` 函数

所有档案库操作都使用统一的 `logApiOperation` 函数记录日志，该函数：
- 自动提取用户信息（ID、姓名、角色、部门等）
- 自动生成操作标签（中文）
- 自动映射模块和操作类型
- 支持自定义详细信息

### 4.2 日志格式

日志记录到 `SystemLog` 表，包含以下信息：
- **用户信息**: userId, userName, userRole, userDepartment, userDepartmentId, userJobTitle
- **操作信息**: action, actionLabel, module, businessCode
- **操作对象**: targetId, targetType, targetLabel
- **详细信息**: details (JSON格式，包含操作的具体信息)

## 五、日志查询

### 5.1 档案库专用日志接口

**接口地址**: `/api/archives/logs`

**请求方式**: `GET`

**权限要求**: 需要登录认证

**查询参数**:
- `page`: 页码（默认1）
- `limit`: 每页数量（默认50）
- `targetType`: 目标类型筛选（可选：`archive_file`, `equipment`, `archive_config`）
- `targetId`: 目标ID筛选（可选）
- `action`: 操作类型筛选（可选：`UPLOAD`, `DELETE`, `CREATE`, `UPDATE`, `CONFIG`等）
- `userId`: 用户ID筛选（可选）
- `startDate`: 开始日期（可选，格式：YYYY-MM-DD）
- `endDate`: 结束日期（可选，格式：YYYY-MM-DD）

**返回格式**:
```json
{
  "success": true,
  "data": {
    "logs": [...],
    "total": 100
  },
  "meta": {
    "page": 1,
    "limit": 50,
    "totalPages": 2,
    "total": 100
  }
}
```

**使用示例**:
```typescript
// 查询所有档案库日志
const res = await fetch('/api/archives/logs?page=1&limit=50');

// 查询上传操作日志
const res = await fetch('/api/archives/logs?action=UPLOAD');

// 查询特定设备的日志
const res = await fetch('/api/archives/logs?targetType=equipment&targetId=equipment_id');

// 查询日期范围日志
const res = await fetch('/api/archives/logs?startDate=2024-01-01&endDate=2024-01-31');
```

### 5.2 通过系统日志接口查询

档案库日志也会出现在系统操作日志中，可以通过系统日志查询接口查询：
- **接口地址**: `/api/logs`
- **模块筛选**: `module=ARCHIVE`
- **操作类型筛选**: `action=UPLOAD`, `action=DELETE`, `action=CREATE`, `action=CONFIG`
- **目标类型筛选**: `targetType=archive_file`, `targetType=equipment`, `targetType=archive_config`

**说明**: 
- 档案库日志同时记录在系统总日志中，可以在系统操作日志模块查看
- 档案库专用接口只返回 `module=ARCHIVE` 的日志，方便在档案库模块内查看

### 5.3 日志内容示例

#### 上传企业档案日志
```json
{
  "module": "ARCHIVE",
  "action": "UPLOAD",
  "actionLabel": "上传档案",
  "targetType": "archive_file",
  "targetId": "file_id",
  "targetLabel": "文件名.pdf",
  "details": {
    "fileName": "文件名.pdf",
    "fileType": "基础资质与证照",
    "category": "enterprise",
    "fileSize": 1024000
  }
}
```

#### 创建设备日志
```json
{
  "module": "ARCHIVE",
  "action": "CREATE",
  "actionLabel": "创建档案",
  "targetType": "equipment",
  "targetId": "equipment_id",
  "targetLabel": "设备名称",
  "details": {
    "equipmentName": "设备名称",
    "equipmentCode": "EQ-001",
    "isSpecialEquip": true,
    "inspectionCycle": 12
  }
}
```

## 六、后续扩展建议

1. **查看和下载日志**
   - 可以在文件查看和下载时添加日志记录
   - 用于审计文件访问记录

2. **设备更新日志**
   - 如果后续添加设备更新功能，需要添加更新日志

3. **批量操作日志**
   - 如果添加批量上传或批量删除功能，需要添加批量操作日志

4. **日志统计**
   - 可以添加档案库操作统计功能
   - 例如：每日上传文件数、各分类文件数量等

## 七、日志查看位置

### 7.1 档案库模块内查看
- 使用档案库专用日志接口：`/api/archives/logs`
- 只显示档案库相关的操作日志
- 支持按操作类型、目标类型、日期范围等筛选

### 7.2 系统操作日志中查看
- 使用系统日志接口：`/api/logs?module=ARCHIVE`
- 在系统操作日志模块中可以看到所有模块的日志
- 档案库日志会显示在系统总日志中

### 7.3 日志数据存储
- 所有日志统一存储在 `SystemLog` 表中
- 通过 `module` 字段区分不同模块
- 档案库日志的 `module` 字段值为 `ARCHIVE`

## 八、测试建议

1. **功能测试**
   - 测试所有操作是否正常记录日志
   - 验证日志内容是否完整准确
   - 测试档案库专用日志接口是否正常工作
   - 验证日志能在系统操作日志中看到

2. **性能测试**
   - 日志记录不应影响主业务流程性能
   - 日志失败不应影响主业务功能
   - 日志查询接口响应速度

3. **查询测试**
   - 测试通过档案库专用接口查询日志
   - 测试通过系统日志接口查询档案库日志
   - 验证筛选和分页功能
   - 验证日期范围查询

