# 工作流策略组件集成说明

## 当前状态

### 现有组件（正在使用）

**隐患管理**：
- `src/app/hidden-danger/_components/workflow/HandlerStrategySelector.tsx`
- `src/app/hidden-danger/_components/workflow/AdvancedHandlerConfig.tsx`
- `src/app/hidden-danger/_components/workflow/WorkflowStepEditor.tsx`

**作业票管理**：
- `src/components/work-permit/moduls/ApproverStrategyConfig.tsx`

### 新统一组件（已创建，待集成）

- `src/components/workflow/WorkflowStrategySelector.tsx`
- `src/components/workflow/StrategyConfigPanel.tsx`
- `src/components/workflow/types.ts`
- `src/components/workflow/utils.ts`
- `src/components/workflow/converter.ts`

## 集成方案

### 方案A：渐进式迁移（推荐）

逐步替换旧组件，保持系统稳定：

#### 阶段1：新功能使用新组件
```tsx
// 在新的配置页面或新模块中直接使用
import { WorkflowStrategySelector } from '@/components/workflow';
```

#### 阶段2：并行运行
- 保留旧组件
- 新功能使用新组件
- 数据层同时支持两种格式

#### 阶段3：逐步替换
1. 替换隐患管理的 `HandlerStrategySelector`
2. 替换作业票管理的 `ApproverStrategyConfig`
3. 统一所有工作流配置UI

#### 阶段4：清理
- 删除旧组件代码
- 更新相关文档

### 方案B：一次性替换（风险较高）

适用于：
- 测试环境验证
- 全新部署
- 大版本升级

## 具体集成步骤

### 1. 替换隐患管理的策略选择器

#### 当前代码（WorkflowStepEditor.tsx）

```tsx
import { HandlerStrategySelector } from './HandlerStrategySelector';
import { AdvancedHandlerConfig } from './AdvancedHandlerConfig';

// ...在渲染中使用
<HandlerStrategySelector
  strategy={step.handlerStrategy.type}
  config={step.handlerStrategy}
  allUsers={allUsers}
  departments={departments}
  onChange={config => updateHandlerStrategy(index, { ...config, approvalMode: 'OR' })}
  onSelectDepartment={(field, ruleIndex) => openDeptSelector(index, field, ruleIndex)}
  onSelectUser={() => openUserSelector(index)}
/>
```

#### 替换为新组件

```tsx
import { WorkflowStrategySelector } from '@/components/workflow';
import { convertHazardConfigToUnified, convertUnifiedToHazardConfig } from '@/components/workflow/converter';

// 1. 在组件中转换数据格式
const unifiedStrategies = useMemo(() => {
  if (!step.handlerStrategy) return [];
  return [convertHazardConfigToUnified(step.handlerStrategy)];
}, [step.handlerStrategy]);

// 2. 使用新组件
<WorkflowStrategySelector
  value={unifiedStrategies}
  onChange={(strategies) => {
    if (strategies.length > 0) {
      const oldFormat = convertUnifiedToHazardConfig(strategies[0]);
      updateHandlerStrategy(index, oldFormat);
    }
  }}
  mode="simple"
  supportedStrategies={[
    'fixed',
    'reporter_manager',
    'responsible_manager',
    'dept_manager',
    'role',
    'location_match',
    'type_match',
    'risk_match'
  ]}
/>
```

### 2. 替换作业票管理的审批配置

#### 查找作业票配置组件

```bash
# 查找作业票审批配置的使用位置
grep -r "ApproverStrategyConfig" src/app/work-permit/
```

#### 替换示例

```tsx
import { WorkflowStrategySelector } from '@/components/workflow';
import { convertWorkPermitConfigToUnified } from '@/components/workflow/converter';

<WorkflowStrategySelector
  value={strategies}
  onChange={setStrategies}
  mode="advanced"
  showApprovalMode={true}
  showConditions={true}
  supportedStrategies={[
    'fixed',
    'role',
    'dept_manager',
    'form_field_dept_manager',
    'form_condition'
  ]}
/>
```

## 数据兼容性处理

### 读取配置时

```typescript
// 从数据库读取配置
const dbConfig = await prisma.hazardConfig.findUnique({
  where: { key: 'workflow_steps' }
});

const config = JSON.parse(dbConfig.value);

// 检查是否是旧格式
if (config.handlerStrategy && !config.strategies) {
  // 转换为新格式
  const newStrategies = [convertHazardConfigToUnified(config.handlerStrategy)];
  config.strategies = newStrategies;
  delete config.handlerStrategy;
}
```

### 保存配置时

```typescript
// 如果需要向后兼容
const saveConfig = {
  strategies: newStrategies,
  // 同时保存旧格式以兼容旧版本
  handlerStrategy: convertUnifiedToHazardConfig(newStrategies[0])
};
```

## 测试清单

在集成新组件前，确保测试以下场景：

### 功能测试
- [ ] 固定人员选择
- [ ] 主管类策略（上报人主管、部门主管等）
- [ ] 匹配规则（区域、类型、风险）
- [ ] 表单条件判断
- [ ] 审批模式（或签、会签、条件签）
- [ ] 策略添加/删除/编辑
- [ ] 数据保存和加载

### 兼容性测试
- [ ] 旧数据格式读取
- [ ] 新数据格式保存
- [ ] 双向转换正确性
- [ ] 边界情况处理

### UI测试
- [ ] 简单模式显示
- [ ] 高级模式显示
- [ ] 响应式布局
- [ ] 交互流畅性
- [ ] 错误提示

## 回退方案

如果新组件出现问题：

1. **立即回退**
```bash
git revert <commit-hash>
```

2. **临时禁用**
```tsx
// 使用特性开关
const USE_NEW_WORKFLOW_COMPONENT = false;

{USE_NEW_WORKFLOW_COMPONENT ? (
  <WorkflowStrategySelector />
) : (
  <HandlerStrategySelector />
)}
```

3. **数据回退**
```bash
# 恢复数据库备份
npx tsx scripts/restore-workflow-backup.js backups/workflow-migration/backup-xxx.json
```

## 注意事项

1. **不要一次性删除旧组件**
   - 保留旧组件代码至少一个版本周期
   - 确保新组件稳定后再清理

2. **数据迁移需谨慎**
   - 先在测试环境验证
   - 生产环境迁移前做好备份
   - 使用 --dry-run 模拟运行

3. **用户培训**
   - 如果UI有显著变化，需要培训用户
   - 准备新旧对比文档

4. **监控和日志**
   - 记录组件切换时间
   - 监控错误率
   - 收集用户反馈

## 时间表建议

| 阶段 | 时长 | 里程碑 |
|-----|------|--------|
| 准备 | 1周 | 完成测试环境部署 |
| 测试 | 1-2周 | 完成所有功能测试 |
| 试点 | 1周 | 在小范围用户中测试 |
| 推广 | 2-4周 | 逐步推广到所有用户 |
| 清理 | 1周 | 删除旧代码，更新文档 |

**总计**：6-9周

## 当前推荐做法

**现阶段（v1.0.0）**：
- ✅ 保持现有组件不变
- ✅ 新统一组件已完成，作为备选方案
- ✅ 迁移工具已准备就绪
- ⏳ 等待合适的时机进行集成

**适合集成的时机**：
- 系统大版本升级时
- 需要添加新的审批策略时
- 用户反馈现有UI需要改进时
- 有充足的测试时间时

**不建议集成的时机**：
- ❌ 生产环境紧急修复时
- ❌ 用户使用高峰期
- ❌ 缺少完整测试时间
- ❌ 团队人手不足时

## 相关文档

- [组件使用文档](../src/components/workflow/README.md)
- [数据迁移指南](./工作流策略迁移指南.md)
- [迁移脚本](../scripts/migrate-workflow-strategies.ts)

## 联系方式

如有问题，请联系开发团队或查阅以上文档。
