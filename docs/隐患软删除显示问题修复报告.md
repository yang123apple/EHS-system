# 隐患软删除显示问题修复报告

## 问题描述

用户使用管理员账户删除了两条隐患，但在隐患查询中没有看到"已作废"的隐患记录。

## 根本原因分析

虽然软删除功能的后端逻辑已经实现（数据库字段存在，软删除 API 已创建），但存在一个关键问题：

**API 的 `mapHazard` 函数没有映射软删除字段到前端**

在 `src/app/api/hazards/route.ts` 中的 `mapHazard` 函数负责将 Prisma 查询结果转换为前端类型，但该函数缺少以下字段的映射：
- `isVoided` (是否已作废)
- `voidReason` (作废原因)
- `voidedAt` (作废时间)
- `voidedBy` (作废操作人)

因此，即使数据库中存储了这些信息，前端也无法获取和显示。

## 修复方案

### 1. 修改 `mapHazard` 函数（API 返回软删除字段）

**文件**: `src/app/api/hazards/route.ts`

**位置**: 第 195-202 行

**修改内容**:
```typescript
createdAt: normalizeDate(pHazard.createdAt) ?? new Date().toISOString(),
updatedAt: normalizeDate(pHazard.updatedAt) ?? new Date().toISOString(),
// 🟢 软删除字段
isVoided: pHazard.isVoided ?? false,
voidReason: pHazard.voidReason ?? undefined,
voidedAt: normalizeDate(pHazard.voidedAt) ?? undefined,
voidedBy: pHazard.voidedBy ?? undefined,
// 延期记录通过独立的 API 获取，这里不包含
extensions: undefined,
```

### 2. 禁用已作废隐患的业务操作

**文件**: `src/app/hidden-danger/_components/modals/HazardDetailModal/index.tsx`

**修改内容**: 在隐患详情模态框中，当隐患已作废时，禁用所有业务操作按钮（批准、驳回、整改、验收等），只保留查看和删除功能。

```typescript
{/* 🟢 已作废隐患：禁用所有业务操作 */}
{hazard.isVoided ? (
  <div className="bg-gray-100 border-2 border-gray-300 rounded-xl p-6 text-center">
    <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-500 mb-4">
      <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
      </svg>
    </div>
    <p className="text-gray-800 font-bold text-lg mb-2">此隐患已作废</p>
    <p className="text-gray-600 text-sm">已作废的隐患无法进行任何业务操作</p>
  </div>
) : (
  // 正常业务操作流程
)}
```

### 3. 重新生成 Prisma Client

执行以下命令以更新 TypeScript 类型定义：

```bash
npx prisma generate
```

## 修复效果

### 已作废隐患的限制
1. **禁用所有业务操作**：批准、驳回、整改、验收等操作全部禁用
2. **只允许查看**：可以查看隐患详情、流程记录、作废信息
3. **只允许删除**：管理员可以彻底删除已作废的隐患（硬删除）

### 用户界面改进
1. **列表视图**：已作废隐患显示灰色背景、删除线和"已作废"标记
2. **详情页顶部**：显示醒目的作废信息横幅（原因、时间、操作人）
3. **操作区域**：显示"此隐患已作废，无法进行任何业务操作"提示

## 验证现有实现

### ✅ 数据库字段（已存在）
- `isVoided` Boolean @default(false)
- `voidReason` String?
- `voidedAt` DateTime?
- `voidedBy` String?

### ✅ 后端 API（已实现）
- **软删除 API**: `/api/hazards/void` (POST)
- **硬删除 API**: `/api/hazards/destroy` (POST)
- **查询过滤**: 管理员可查看所有（包括已作废），普通用户只看未作废

### ✅ 前端服务层（已修复）
- `hazardService.voidHazard()` - 软删除
- `hazardService.destroyHazard()` - 硬删除
- `hazardService.deleteHazard()` - 默认调用软删除

### ✅ 前端 UI（已支持）
- `HazardDataTable.tsx` 已包含已作废标记显示逻辑
- 已作废隐患显示灰色背景和删除线样式
- 导出 Excel 时包含"状态标记"和"作废原因"列

## 测试步骤

1. **清理并重启开发服务器**
   ```bash
   # 清理 node_modules 中的 Prisma Client 缓存（如果遇到类型错误）
   rm -rf node_modules/.prisma
   npx prisma generate
   
   # 重启开发服务器
   ```bash
   npm run dev
   ```

2. **使用管理员账户登录**

3. **测试软删除功能**
   - 选择一条隐患，点击"删除"按钮
   - 验证是否弹出输入作废原因的对话框
   - 输入作废原因后确认删除

4. **验证已作废隐患显示和操作限制**
   - 在隐患列表中查看是否显示灰色背景的已作废隐患
   - 检查是否显示"已作废"标记
   - 点击查看详情，确认：
     * 顶部显示作废信息横幅（原因、时间、操作人）
     * 隐患描述显示删除线和灰色样式
     * 操作区域显示"此隐患已作废，无法进行任何业务操作"
     * 所有业务操作按钮（批准、驳回、整改、验收）全部禁用
     * 只保留"删除"按钮（管理员可见）

5. **验证权限控制**
   - 使用普通用户账户登录
   - 验证只能看到未作废的隐患（已作废的隐患应该被过滤掉）

## 技术细节

### API 查询逻辑
```typescript
// 管理员：显示所有数据（包括已作废的）
if (isAdmin) {
  console.log('[Hazard GET] 管理员模式：显示所有隐患（包括已作废）');
} else {
  // 普通用户：只显示未作废的数据
  where.isVoided = false;
  console.log('[Hazard GET] 普通用户模式：只显示未作废的隐患');
}
```

### 前端显示逻辑
```typescript
// 检测是否已作废
const isVoided = h.isVoided || false;

// 应用样式
className={cn(
  "group transition-colors cursor-pointer hover:bg-blue-50/30",
  index % 2 === 0 ? "bg-white" : "bg-slate-50/30",
  isVoided && "opacity-50 bg-gray-50/50" // 已作废样式
)}

// 显示标记
{isVoided && (
  <div className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold bg-gray-500 text-white w-fit">
    <svg>...</svg>
    <span>已作废</span>
  </div>
)}
```

## 注意事项

1. **之前被硬删除的隐患无法恢复**：在修复前被物理删除的两条隐患记录已从数据库中永久删除，无法恢复。

2. **权限说明**：
   - 管理员：可以查看和删除（软删除/硬删除）所有隐患
   - 普通用户：只能查看未作废的隐患，无删除权限

3. **软删除 vs 硬删除**：
   - 软删除（作废）：保留记录在数据库中，标记为已作废，可查询和审计
   - 硬删除（彻底删除）：从数据库物理删除，无法恢复

## 修复时间线

- **2026/1/22 21:20** - 发现问题：`mapHazard` 函数缺少软删除字段映射
- **2026/1/22 21:21** - 修复字段映射并重新生成 Prisma Client
- **2026/1/22 21:26** - 新增需求：禁用已作废隐患的业务操作
- **2026/1/22 21:27** - 修复完成：在详情模态框中添加已作废隐患的操作限制

## 相关文档

- [隐患软删除和硬删除实现文档.md](./隐患软删除和硬删除实现文档.md)
- [隐患软删除实现检查报告.md](./隐患软删除实现检查报告.md)
- [隐患软删除Bug修复报告.md](./隐患软删除Bug修复报告.md)

## 总结

此次修复解决了软删除隐患无法在前端显示的问题。问题根源在于 API 返回数据时未包含软删除字段。修复后，管理员可以正常查看已作废的隐患记录，包括作废原因、作废时间等详细信息。
