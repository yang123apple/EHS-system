# 隐患系统压力测试任务状态报告

## 📋 任务概述

**任务目标**：生成100万条不同人员可见的隐患数据，并自动化测试访问隐患系统不同页面的前后端响应情况

**当前状态**：✅ 脚本已改进，支持断点续传

---

## ✅ 已完成的工作

### 1. 脚本改进（已完成）

**文件**：`scripts/stress-test-generate-data.ts`

**改进内容**：
1. ✅ **断点续传功能**：自动检测已生成的数据，从中断处继续
2. ✅ **进度保存机制**：每100批次保存一次进度到 `.stress-test-progress.json`
3. ✅ **错误恢复机制**：批次失败时自动重试，最多3次
4. ✅ **进度显示优化**：显示已完成数量、剩余数量、预计剩余时间

**关键改进点**：

```typescript
// 1. 断点续传检测
async function getLastBatch(): Promise<number> {
  // 优先从进度文件读取
  const progress = await loadProgress();
  if (progress) {
    return progress.batch;
  }
  // 从数据库查询最后批次
  // ...
}

// 2. 进度保存
if ((batch + 1) % 100 === 0) {
  await saveProgress(batch + 1, totalInserted);
}

// 3. 错误重试
let retries = 0;
while (retries < CONFIG.MAX_RETRIES && !success) {
  try {
    // 执行插入
  } catch (error) {
    retries++;
    // 指数退避重试
  }
}
```

### 2. 数据生成配置

**目标数据量**：
- 隐患记录：1,000,000 条
- 可见性记录：约 4,000,000 ~ 8,000,000 条（每条隐患3-8个可见用户）
- 测试用户：110 个（100个普通用户 + 10个管理员）

**批量策略**：
- 批量大小：1,000 条/批
- 总批次数：1,000 批
- 预计耗时：20-40分钟（取决于硬件性能）

---

## 📊 当前进度检查

### 检查命令

```bash
# 检查已生成的隐患数量
sqlite3 prisma/dev.db "SELECT COUNT(*) FROM HazardRecord WHERE id LIKE 'stress_test_%';"

# 检查已生成的可见性记录数量
sqlite3 prisma/dev.db "SELECT COUNT(*) FROM HazardVisibility WHERE hazardId LIKE 'stress_test_%';"

# 检查测试用户数量
sqlite3 prisma/dev.db "SELECT COUNT(*) FROM User WHERE username LIKE 'test_%';"

# 检查进度文件
cat .stress-test-progress.json
```

### 当前状态

根据检查结果：
- ✅ 隐患记录：0 条（任务尚未开始或已中断）
- ✅ 可见性记录：0 条
- ✅ 测试用户：0 个

**结论**：任务尚未开始或已完全中断，需要重新启动。

---

## 🚀 继续执行任务

### 方法1：直接运行脚本（推荐）

```bash
cd /Users/yangguang/Desktop/EHS/EHS-system
npm run stress-test:generate
```

或使用 tsx 直接运行：

```bash
npx tsx scripts/stress-test-generate-data.ts
```

### 方法2：后台运行（适合长时间任务）

```bash
# 后台运行并保存输出
nohup npx tsx scripts/stress-test-generate-data.ts > stress-test.log 2>&1 &

# 查看进度
tail -f stress-test.log

# 查看进程
ps aux | grep stress-test
```

### 方法3：使用 screen/tmux（推荐用于长时间任务）

```bash
# 使用 screen
screen -S stress-test
npm run stress-test:generate
# 按 Ctrl+A 然后 D 分离会话

# 重新连接
screen -r stress-test
```

---

## 📈 进度监控

### 实时监控

脚本运行时会输出以下格式的进度信息：

```
✅ 批次 500/1000 (50.00%) | 插入 1,000 条 | 耗时 2.35s | 均速 2.35ms/条 | 已完成 500,000 条 | 预计剩余 19.6分钟
💾 进度检查点：已保存 500 批次的数据
```

### 进度文件

进度保存在 `.stress-test-progress.json`：

```json
{
  "batch": 500,
  "totalInserted": 500000,
  "timestamp": "2026-01-23T12:00:00.000Z"
}
```

### 数据库查询

```sql
-- 查询已生成的隐患数量
SELECT COUNT(*) FROM HazardRecord WHERE id LIKE 'stress_test_%';

-- 查询最后一批的批次号
SELECT MAX(CAST(SUBSTR(id, 13, INSTR(SUBSTR(id, 13), '_') - 1) AS INTEGER)) + 1) as last_batch
FROM HazardRecord 
WHERE id LIKE 'stress_test_%';

-- 查询可见性记录数量
SELECT COUNT(*) FROM HazardVisibility WHERE hazardId LIKE 'stress_test_%';
```

---

## 🔧 故障排查

### 问题1：脚本卡住或中断

**症状**：脚本运行一段时间后停止，无输出

**解决方案**：
1. 检查进度文件：`cat .stress-test-progress.json`
2. 检查数据库中的最后批次
3. 重新运行脚本（会自动从断点继续）

### 问题2：数据库连接失败

**症状**：`PrismaClientInitializationError`

**解决方案**：
```bash
# 检查数据库文件是否存在
ls -lh prisma/dev.db

# 检查数据库是否锁定
sqlite3 prisma/dev.db "PRAGMA busy_timeout = 30000;"

# 重新生成 Prisma Client
npx prisma generate
```

### 问题3：内存不足

**症状**：进程崩溃，OOM错误

**解决方案**：
- 减小 `BATCH_SIZE`（从1000改为500）
- 增加系统内存
- 关闭其他占用内存的程序

### 问题4：插入速度慢

**症状**：每批次耗时 > 10秒

**解决方案**：
```typescript
// 在脚本中调整配置
const CONFIG = {
  BATCH_SIZE: 500,  // 减小批量大小
  // ...
};
```

---

## 📝 下一步操作

### 1. 启动数据生成

```bash
# 在终端中运行（建议使用 screen 或 tmux）
cd /Users/yangguang/Desktop/EHS/EHS-system
npm run stress-test:generate
```

### 2. 监控进度

```bash
# 实时查看进度（新开终端）
watch -n 5 'sqlite3 prisma/dev.db "SELECT COUNT(*) FROM HazardRecord WHERE id LIKE \"stress_test_%\";"'
```

### 3. 数据生成完成后执行性能测试

```bash
npm run stress-test:performance
```

---

## 🎯 预期结果

### 数据生成完成后

- ✅ 隐患记录：1,000,000 条
- ✅ 可见性记录：约 5,000,000 条（平均每条隐患5个可见用户）
- ✅ 测试用户：110 个

### 性能测试报告

性能测试脚本会生成以下报告：

```
📊 压力测试性能报告
============================================================

| 场景                   | 平均(ms) | P50(ms) | P95(ms) | P99(ms) | QPS | 成功率 |
|------------------------|----------|---------|---------|---------|-----|--------|
| 普通用户-我的任务       |    45.23 |   42.00 |   89.00 |  105.00 | 221 |  100.0% |
| 管理员-我的任务(优化后) |    12.56 |   11.00 |   18.00 |   25.00 | 796 |  100.0% |
| 分页查询               |    67.89 |   65.00 |  112.00 |  156.00 | 147 |  100.0% |
| 详情查询               |    23.45 |   21.00 |   45.00 |   67.00 | 426 |  100.0% |
| 搜索查询               |    78.34 |   75.00 |  134.00 |  189.00 | 128 |  100.0% |
| 并发访问               |   156.78 |  145.00 |  298.00 |  456.00 | 319 |  100.0% |
```

---

## 📌 重要提示

1. **数据生成时间**：预计需要 20-40 分钟，请确保有足够时间
2. **磁盘空间**：100万条数据约占用 500MB-1GB 磁盘空间
3. **数据库性能**：建议在SSD上运行，提升插入速度
4. **断点续传**：脚本支持断点续传，可以安全中断和恢复
5. **进度保存**：每100批次自动保存进度，防止数据丢失

---

## 🔗 相关文件

- **数据生成脚本**：`scripts/stress-test-generate-data.ts`
- **性能测试脚本**：`scripts/stress-test-performance.ts`
- **使用指南**：`docs/隐患可见性表压力测试使用指南.md`
- **进度文件**：`.stress-test-progress.json`（运行时生成）

---

**报告生成时间**：2026-01-23  
**状态**：✅ 脚本已改进，准备执行  
**下一步**：运行 `npm run stress-test:generate` 开始数据生成
