# 隐患可见性表数据初始化说明

## 📋 概述

本文档说明如何为现有隐患数据初始化可见性表记录。

## 🎯 使用场景

1. **首次部署**：新上线可见性表功能时，需要为历史数据生成可见性记录
2. **数据修复**：当可见性数据不一致时，需要重建可见性表
3. **系统维护**：定期检查和修复可见性数据完整性

## ⚙️ 执行步骤

### 1. 确认数据库迁移已完成

在运行初始化脚本前，确保已执行数据库迁移：

```bash
npx prisma migrate deploy
```

或者如果是开发环境：

```bash
npx prisma migrate dev
```

### 2. 运行初始化脚本

执行以下命令开始数据初始化：

```bash
npm run init:visibility
```

### 3. 查看执行过程

脚本会显示详细的执行进度：

```
========================================
🚀 隐患可见性数据初始化
========================================

📊 发现 1250 条隐患记录

⚠️  即将为所有隐患重建可见性数据
   这可能需要一些时间，具体取决于数据量
   批量大小: 100条/批次

⏳ 进度: [████████████████████] 100% (1250/1250)

========================================
✅ 初始化完成！
========================================
📈 统计信息:
   - 总计: 1250 条
   - 成功: 1248 条
   - 失败: 2 条
   - 耗时: 15.32秒

🔌 数据库连接已关闭
```

## 📊 性能参考

| 数据量 | 预计耗时 | 内存占用 |
|--------|---------|---------|
| 1,000条 | ~10秒 | ~100MB |
| 10,000条 | ~1.5分钟 | ~150MB |
| 100,000条 | ~15分钟 | ~200MB |
| 1,000,000条 | ~2.5小时 | ~300MB |

> 注：实际性能取决于服务器配置和数据库性能

## 🔍 技术细节

### 处理流程

1. **统计隐患数量**：查询未删除的隐患总数
2. **分批处理**：每批100条，避免内存溢出
3. **并发同步**：每批内并发处理，提升效率
4. **进度反馈**：实时显示处理进度
5. **错误记录**：记录失败的隐患ID

### 可见性计算逻辑

对每条隐患，系统会计算以下角色的可见权限：

- **creator**：创建人（始终可见）
- **executor**：当前执行人
- **cc**：抄送人
- **responsible**：责任人
- **verifier**：验收人
- **candidate**：候选处理人

### 数据库操作

每条隐患的同步过程：

```sql
-- 1. 删除旧记录
DELETE FROM HazardVisibility WHERE hazardId = ?

-- 2. 插入新记录（批量）
INSERT INTO HazardVisibility (hazardId, userId, role)
VALUES 
  (?, ?, 'creator'),
  (?, ?, 'executor'),
  ...
```

## ⚠️ 注意事项

### 执行前检查

1. **数据库备份**：建议先备份数据库
2. **系统负载**：选择在低峰期执行
3. **磁盘空间**：确保有足够的磁盘空间存储可见性记录

### 执行期间

1. **避免中断**：不要强制终止进程
2. **监控性能**：留意数据库CPU和内存使用
3. **日志记录**：保存执行日志以便排查问题

### 执行后验证

1. **数据完整性检查**：

```sql
-- 检查可见性记录总数
SELECT COUNT(*) FROM HazardVisibility;

-- 检查是否有隐患缺少可见性记录
SELECT h.id, h.code 
FROM HazardRecord h
LEFT JOIN HazardVisibility v ON h.id = v.hazardId
WHERE h.deletedAt IS NULL 
  AND v.id IS NULL;
```

2. **功能验证**：
   - 登录不同用户账号
   - 检查"我的隐患"列表是否正确
   - 验证权限控制是否生效

## 🛠️ 故障排查

### 问题1：脚本执行失败

**错误信息**：`Error: Connection timeout`

**解决方案**：
```bash
# 增加数据库连接超时时间
DATABASE_URL="postgresql://...?connect_timeout=30"
npm run init:visibility
```

### 问题2：部分隐患失败

**错误信息**：`Failed: 5`

**解决方案**：
1. 检查失败隐患的完整性（是否缺少必要字段）
2. 手动修复数据后重新运行脚本
3. 脚本会自动跳过已处理的记录

### 问题3：内存不足

**错误信息**：`JavaScript heap out of memory`

**解决方案**：
```bash
# 增加Node.js内存限制
NODE_OPTIONS=--max-old-space-size=4096 npm run init:visibility
```

## 🔄 重新初始化

如果需要重新初始化所有数据：

```bash
# 1. 清空可见性表
npx prisma studio
# 在Prisma Studio中删除HazardVisibility表的所有记录

# 2. 重新运行初始化
npm run init:visibility
```

或使用SQL直接清空：

```sql
DELETE FROM HazardVisibility;
```

## 📝 相关文档

- [隐患可见性表性能优化实现报告](./隐患可见性表性能优化实现报告.md)
- [隐患可见性表API集成实现报告](./隐患可见性表API集成实现报告.md)
- [Prisma Schema定义](../prisma/schema.prisma)

## 🆘 支持

如遇到问题，请：

1. 检查日志文件获取详细错误信息
2. 查看相关技术文档
3. 联系技术支持团队
