# 隐患表格完整信息展示实现说明

## 📋 实施日期
2026年1月22日

## 🎯 需求描述
在隐患系统的"我的任务"和"隐患查询"模块中，需要以表格形式展示完整的隐患信息，并支持导出包含所有关键字段的Excel报表。

## 📊 展示字段清单

### 表格显示字段（12个核心字段）

1. **隐患编号**（code）- 唯一标识符
2. **状态**（status）- 当前处理状态 + 作废标记
3. **风险等级**（riskLevel）- 风险分级
4. **隐患类型**（type）- 隐患分类
5. **发现位置**（location）- 现场位置
6. **隐患描述**（desc）- 详细描述
7. **责任部门**（responsibleDeptName）- 整改责任部门
8. **责任人**（responsibleName）- 整改责任人
9. **整改期限**（deadline）- 要求完成时间
10. **整改描述**（rectifyDesc）- 整改情况说明
11. **整改时间**（rectifyTime）- 实际完成时间
12. **整改措施要求**（rectifyRequirement）- 具体整改要求

### Excel导出字段（19个基础字段 + 4个管理员字段）

#### 基础字段（所有用户）
1. **隐患编号**（code）
2. **状态**（status）
3. **风险等级**（riskLevel）
4. **检查类型**（checkType）- 日常检查/专项检查/月度检查等
5. **整改方式**（rectificationType）- 立即整改/限期整改
6. **隐患类型**（type）
7. **发现位置**（location）
8. **隐患描述**（desc）
9. **上报人**（reporterName）
10. **上报时间**（reportTime）
11. **责任部门**（responsibleDeptName）
12. **责任人**（responsibleName）
13. **整改期限**（deadline）
14. **整改描述**（rectifyDesc）
15. **整改时间**（rectifyTime）
16. **整改措施要求**（rectifyRequirement）
17. **验收人**（verifierName）
18. **验收时间**（verifyTime）
19. **验收描述**（verifyDesc）

#### 管理员专属字段（仅admin/super_admin角色）
20. **是否已作废**（isVoided）- 是/否
21. **作废原因**（voidReason）
22. **作废时间**（voidedAt）
23. **作废操作人**（voidedBy解析后的名称）

## 🔧 技术实现

### 修改文件
`src/app/hidden-danger/_components/views/HazardDataTable.tsx`

### 主要变更

#### 1. 表格结构优化
```tsx
// 设置表格最小宽度以容纳所有列
<table className="w-full text-sm text-left border-collapse min-w-[1800px]">
```

#### 2. 表头定义（13列）
- 12个数据列 + 1个操作列
- 每列设置合理的宽度约束
- 使用语义化的中文标题

#### 3. 数据行实现
每个字段都有独立的单元格，包含：
- **视觉区分**：已作废记录显示灰色样式
- **数据格式化**：日期字段统一格式（YYYY-MM-DD）
- **空值处理**：使用 `-` 表示无数据
- **文本截断**：长文本使用 `line-clamp-2` 限制显示行数
- **悬停提示**：为截断文本添加 `title` 属性显示完整内容

#### 4. Excel导出增强

**动态字段配置**：根据用户角色智能调整导出字段

```tsx
// 基础字段（所有用户）
const baseData = {
  '隐患编号': h.code || h.id,
  '状态': h.status,
  '风险等级': h.riskLevel,
  '检查类型': h.checkType ? (checkTypeMap[h.checkType] || getCheckTypeNameSync(h.checkType)) : '-',
  '整改方式': h.rectificationType ? rectificationTypeMap[h.rectificationType] : '-',
  '隐患类型': h.type,
  '发现位置': h.location,
  '隐患描述': h.desc,
  '上报人': h.reporterName || '-',
  '上报时间': h.reportTime ? h.reportTime.split('T')[0] : '-',
  '责任部门': h.responsibleDeptName || '-',
  '责任人': h.responsibleName || '-',
  '整改期限': h.deadline ? h.deadline.split('T')[0] : '-',
  '整改描述': h.rectifyDesc || '-',
  '整改时间': h.rectifyTime ? h.rectifyTime.split('T')[0] : '-',
  '整改措施要求': h.rectifyRequirement || '-',
  '验收人': h.verifierName || '-',
  '验收时间': h.verifyTime ? h.verifyTime.split('T')[0] : '-',
  '验收描述': h.verifyDesc || '-',
};

// 管理员额外字段
const adminData = isAdmin ? {
  '是否已作废': h.isVoided ? '是' : '否',
  '作废原因': h.voidReason || '-',
  '作废时间': h.voidedAt ? h.voidedAt.split('T')[0] : '-',
  '作废操作人': parseVoidedBy(h.voidedBy),
} : {};

return { ...baseData, ...adminData };
```

**字段映射功能**：
- 检查类型自动转换为中文（daily → 日常检查）
- 整改方式自动转换为中文（immediate → 立即整改）
- 作废操作人JSON解析（提取name字段）

## 🎨 UI/UX 特性

### 响应式设计
- 表格支持横向滚动（当视口宽度不足时）
- 固定表头（sticky header）保持可见
- 斑马纹样式提高可读性

### 交互体验
- 行悬停高亮效果
- 点击行查看详情
- 删除按钮仅在有权限时显示
- 已作废记录半透明显示 + 删除线

### 视觉层次
- 使用徽章组件展示状态和风险等级
- 字体大小差异化（编号用等宽字体）
- 颜色编码区分不同状态

## 📦 数据类型支持

所有字段都在 `HazardRecord` 接口中定义（`src/types/hidden-danger.d.ts`）：
- 字符串类型：code, status, riskLevel, type, location, desc 等
- 日期类型（ISO字符串）：deadline, rectifyTime
- 可选字段：使用 `?` 标记，未定义时显示 `-`

## ✅ 验证方法

### 前端验证
1. 访问"我的任务"视图
2. 访问"隐患查询"视图
3. 检查表格列数是否为13列
4. 验证每列数据显示正确
5. 测试横向滚动功能
6. 测试Excel导出是否包含所有字段

### 数据完整性验证
```javascript
// 检查字段是否完整
const requiredFields = [
  'code', 'status', 'riskLevel', 'type', 'location', 'desc',
  'responsibleDeptName', 'responsibleName', 'deadline',
  'rectifyDesc', 'rectifyTime', 'rectifyRequirement'
];
```

## 🔄 兼容性说明

### 向后兼容
- 可选字段使用 `||` 运算符提供默认值
- 日期格式统一处理（split('T')[0]）
- 已作废记录保持原有样式逻辑

### 数据库字段映射
确保后端API返回包含以下完整字段：

**基础信息**：
- `code`（隐患编号）
- `status`（状态）
- `riskLevel`（风险等级）
- `checkType`（检查类型）
- `rectificationType`（整改方式）
- `type`（隐患类型）
- `location`（发现位置）
- `desc`（隐患描述）

**上报信息**：
- `reporterName`（上报人姓名）
- `reportTime`（上报时间）

**责任信息**：
- `responsibleDeptName`（责任部门名称）
- `responsibleName`（责任人姓名）
- `deadline`（整改期限）

**整改信息**：
- `rectifyDesc`（整改描述）
- `rectifyTime`（整改时间）
- `rectifyRequirement`（整改措施要求）

**验收信息**：
- `verifierName`（验收人姓名）
- `verifyTime`（验收时间）
- `verifyDesc`（验收描述）

**作废信息**（管理员）：
- `isVoided`（是否已作废）
- `voidReason`（作废原因）
- `voidedAt`（作废时间）
- `voidedBy`（作废操作人，JSON格式）

## 📝 注意事项

1. **性能优化**
   - 表格使用虚拟滚动时需注意性能
   - 大数据量时建议服务端分页
   - Excel导出限制最大条数（BATCH_LIMITS.EXPORT_MAX）

2. **移动端适配**
   - 当前实现优先考虑桌面端
   - 移动端建议使用卡片视图（已有HazardCard组件）

3. **权限控制**
   - 删除操作受权限控制（canDeleteHazard）
   - Excel导出字段根据用户角色动态调整
   - 管理员可查看作废相关敏感信息

4. **数据映射**
   - 检查类型优先使用数据库配置，回退到硬编码映射
   - 整改方式使用预定义映射表
   - 作废操作人信息需要JSON解析处理

5. **字段验证**
   - 所有可选字段使用 `|| '-'` 提供默认值
   - 日期字段统一格式化为 YYYY-MM-DD
   - JSON字段解析需要try-catch保护

## 🚀 后续优化建议

1. **列可见性控制**
   - 添加列显示/隐藏开关
   - 保存用户列偏好设置

2. **高级筛选**
   - 为每列添加筛选功能
   - 支持多条件组合筛选

3. **排序功能**
   - 点击列头排序
   - 支持多列排序

4. **列宽调整**
   - 拖拽调整列宽
   - 保存列宽设置

## 📚 相关文档
- [隐患类型定义](../src/types/hidden-danger.d.ts)
- [隐患服务层](../src/services/hazard.service.ts)
- [权限工具函数](../src/app/hidden-danger/_utils/permissions.ts)

## ✨ 实施总结

### 核心成果
通过本次优化，隐患管理系统的数据展示和导出能力得到全面提升：

1. **表格展示优化**
   - 在一个视图中查看12个核心字段
   - 无需多次点击即可获取关键信息
   - 支持横向滚动查看完整数据

2. **Excel导出增强**
   - 基础用户：导出19个完整字段
   - 管理员用户：额外导出4个作废管理字段
   - 智能字段映射（检查类型、整改方式等）
   - 角色权限控制确保数据安全

3. **用户体验改进**
   - 字段自动翻译为易读的中文
   - 日期格式统一规范
   - 空值处理一致（显示为'-'）
   - 作废记录视觉区分

### 技术亮点
- **动态字段配置**：根据用户角色智能调整导出内容
- **映射函数集成**：使用 `getCheckTypeNameSync` 动态获取检查类型名称
- **JSON解析保护**：安全处理 `voidedBy` 等JSON字段
- **权限分层**：普通用户与管理员看到不同的数据维度

### 数据完整性保障
所有隐患生命周期的关键节点数据均已覆盖：
- ✅ 上报阶段（上报人、时间、描述）
- ✅ 分配阶段（责任部门、责任人、期限）
- ✅ 整改阶段（整改描述、时间、措施）
- ✅ 验收阶段（验收人、时间、评价）
- ✅ 管理阶段（作废原因、时间、操作人）
