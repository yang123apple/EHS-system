# 工作流统一组件 - 直接集成方案

## 📋 当前状态评估

### 现有组件分析

经过代码审查，发现现有组件包含大量特定业务逻辑：

**隐患管理** (`WorkflowStepEditor.tsx` - 600+ 行)：
- ✅ 核心步骤锁定机制（report, rectify不可修改）
- ✅ 步骤移动/排序功能
- ✅ 抄送规则（CCRuleEditor）
- ✅ 复杂的部门/用户选择器集成
- ✅ 3种审批模式（OR/AND/CONDITIONAL）

**作业票管理** (`WorkflowEditorModal.tsx` - 1000+ 行)：
- ✅ Part系统（二级模板字段继承）
- ✅ Excel单元格拾取功能
- ✅ 8种找人策略（含文本匹配、选项匹配）
- ✅ 触发条件配置
- ✅ 模板字段解析集成

### 集成难点

1. **业务逻辑耦合度高**：UI与业务逻辑深度绑定
2. **数据结构差异大**：两个模块使用不同的数据格式
3. **特有功能多**：每个模块都有独特的功能需求
4. **组件体积大**：直接替换风险高

---

## 🎯 推荐方案：渐进式共存

### 方案说明

**不立即替换现有组件**，而是在新功能中优先使用统一组件，逐步过渡。

### 实施步骤

#### 阶段1：新功能使用新组件（当前）

在**新增的工作流配置场景**中使用 `WorkflowStrategySelector`：

```typescript
// 示例：新的事故管理模块
import { WorkflowStrategySelector } from '@/components/workflow';

function IncidentWorkflowConfig() {
  const [strategies, setStrategies] = useState<WorkflowStrategy[]>([]);
  
  return (
    <WorkflowStrategySelector
      mode="simple"
      value={strategies}
      onChange={setStrategies}
      supportedStrategies={['fixed', 'reporter', 'reporter_manager']}
      showApprovalMode={true}
    />
  );
}
```

#### 阶段2：创建适配器层（1-2周后）

为现有组件创建适配器，使其可以逐步迁移：

```typescript
// src/components/workflow/adapters/HazardWorkflowAdapter.tsx
import { WorkflowStrategySelector } from '@/components/workflow';
import { convertHazardConfigToUnified } from '@/components/workflow/converter';

export function HazardWorkflowAdapter({ 
  steps, 
  onChange,
  // ... 其他props
}: HazardWorkflowAdapterProps) {
  // 将旧格式转换为新格式
  const unifiedStrategies = steps.map(step => 
    convertHazardConfigToUnified(step.handlerStrategy)
  );
  
  // 使用新组件
  return (
    <div>
      {steps.map((step, index) => (
        <div key={step.id}>
          <h4>{step.name}</h4>
          <WorkflowStrategySelector
            mode="simple"
            value={unifiedStrategies[index]}
            onChange={(newStrategies) => {
              // 转换回旧格式并更新
              const oldFormat = convertUnifiedToHazardConfig(newStrategies);
              onChange(index, { handlerStrategy: oldFormat });
            }}
          />
        </div>
      ))}
    </div>
  );
}
```

#### 阶段3：逐步替换（按需进行）

当某个模块需要重构时，再考虑完全替换：

```typescript
// 替换前
import { HandlerStrategySelector } from './HandlerStrategySelector';

// 替换后
import { WorkflowStrategySelector } from '@/components/workflow';
```

---

## 📊 集成优先级建议

### 高优先级（建议立即使用）

1. **新模块开发**
   - ✅ 事故管理工作流（如果还未实现）
   - ✅ 培训管理审批流程
   - ✅ 档案管理审批流程

2. **简单场景替换**
   - ✅ 隐患管理的简单OR签模式
   - ✅ 固定人员选择场景

### 中优先级（1-2个月内）

1. **创建适配器层**
   - 为隐患管理创建适配器
   - 为作业票创建适配器

2. **逐步迁移复杂功能**
   - AND签/CONDITIONAL签模式
   - 匹配规则配置

### 低优先级（按需进行）

1. **完全替换旧组件**
   - 删除 `HandlerStrategySelector.tsx`
   - 删除 `ApproverStrategyConfig.tsx`
   - 删除 `AdvancedHandlerConfig.tsx`

---

## 🛠️ 快速开始：在新模块中使用

### 示例1：简单工作流（隐患类型）

```typescript
import { WorkflowStrategySelector } from '@/components/workflow';

function SimpleWorkflowConfig() {
  const [strategies, setStrategies] = useState<WorkflowStrategy[]>([
    {
      id: '1',
      type: 'reporter_manager',
      config: {},
    }
  ]);
  
  return (
    <WorkflowStrategySelector
      mode="simple"
      value={strategies}
      onChange={setStrategies}
      supportedStrategies={[
        'fixed',
        'reporter',
        'reporter_manager',
        'location_match',
        'type_match',
      ]}
    />
  );
}
```

### 示例2：高级工作流（作业票类型）

```typescript
import { WorkflowStrategySelector } from '@/components/workflow';

function AdvancedWorkflowConfig() {
  const [strategies, setStrategies] = useState<WorkflowStrategy[]>([]);
  
  return (
    <WorkflowStrategySelector
      mode="advanced"
      value={strategies}
      onChange={setStrategies}
      showApprovalMode={true}
      showConditions={true}
      supportedStrategies={[
        'fixed',
        'role',
        'dept_manager',
        'form_field_dept_manager',
        'form_condition',
      ]}
    />
  );
}
```

### 示例3：混合审批模式

```typescript
import { WorkflowStrategySelector, ApprovalMode } from '@/components/workflow';

function MixedApprovalWorkflow() {
  const [approvalMode, setApprovalMode] = useState<ApprovalMode>('OR');
  const [strategies, setStrategies] = useState<WorkflowStrategy[]>([]);
  
  return (
    <div>
      {/* 审批模式选择器 */}
      <div className="mb-4">
        <label>审批模式：</label>
        <select value={approvalMode} onChange={e => setApprovalMode(e.target.value as ApprovalMode)}>
          <option value="OR">或签（任一人审批即可）</option>
          <option value="AND">会签（全部人员必须审批）</option>
          <option value="CONDITIONAL">条件签（根据条件选择）</option>
        </select>
      </div>
      
      {/* 策略选择器 */}
      <WorkflowStrategySelector
        mode="advanced"
        value={strategies}
        onChange={setStrategies}
        approvalMode={approvalMode}
        showApprovalMode={true}
        showConditions={approvalMode === 'CONDITIONAL'}
      />
    </div>
  );
}
```

---

## 💡 最佳实践建议

### 1. 保持旧组件稳定

**当前阶段**：
- ✅ 不修改现有的 `WorkflowStepEditor.tsx`
- ✅ 不修改现有的 `WorkflowEditorModal.tsx`
- ✅ 保持现有业务逻辑运行

### 2. 新功能优先使用新组件

**未来开发**：
- ✅ 新的审批流程使用 `WorkflowStrategySelector`
- ✅ 新的策略类型使用统一接口
- ✅ 积累使用经验和反馈

### 3. 收集反馈并优化

**持续改进**：
- 记录使用中的问题
- 根据实际需求调整组件API
- 优化性能和用户体验

### 4. 择机重构

**合适时机**：
- 系统大版本升级
- 现有组件需要重大功能扩展
- 有充足的测试时间和资源

---

## 🔄 数据迁移预案

虽然当前数据库为空，但为未来考虑，保留迁移能力：

### 迁移工具

```bash
# 位置：scripts/migrate-workflow-strategies.ts
npm run migrate:workflow -- --dry-run  # 模拟运行
npm run migrate:workflow                # 执行迁移
```

### 手动转换

```typescript
import { 
  convertHazardConfigToUnified,
  convertWorkPermitConfigToUnified 
} from '@/components/workflow/converter';

// 隐患配置转换
const oldHazardConfig = { type: 'reporter_manager', ... };
const unifiedConfig = convertHazardConfigToUnified(oldHazardConfig);

// 作业票配置转换
const oldPermitConfig = { approverStrategy: 'fixed', ... };
const unifiedConfig = convertWorkPermitConfigToUnified(oldPermitConfig);
```

---

## 📈 成功指标

### 短期目标（1个月）

- ✅ 至少1个新模块使用统一组件
- ✅ 团队熟悉新组件API
- ✅ 收集5+条用户反馈

### 中期目标（3个月）

- ✅ 50%的新功能使用统一组件
- ✅ 创建完整的适配器层
- ✅ 性能和稳定性验证通过

### 长期目标（6个月）

- ✅ 完成核心模块迁移
- ✅ 删除旧组件代码
- ✅ 代码量减少30%+

---

## ⚠️ 风险管理

### 已识别风险

1. **学习曲线**
   - 缓解：提供详细文档和示例
   - 缓解：逐步引入，不强制立即使用

2. **兼容性问题**
   - 缓解：保留旧组件
   - 缓解：提供数据转换工具

3. **性能影响**
   - 缓解：已进行性能优化
   - 缓解：持续监控和改进

### 回退策略

如果新组件出现问题：
1. 继续使用旧组件
2. 不影响现有功能
3. 有充足时间修复

---

## 📞 技术支持

### 文档资源

- **组件文档**：`src/components/workflow/README.md`
- **迁移指南**：`docs/工作流策略迁移指南.md`
- **完整报告**：`docs/工作流策略统一组件完整交付报告.md`

### 问题反馈

通过项目Issue反馈使用中遇到的问题。

---

## ✅ 总结

### 当前建议

1. **保持现状**：现有组件继续运行，不做修改
2. **新功能优先**：新开发的模块使用统一组件
3. **积累经验**：收集使用反馈，优化组件
4. **择机重构**：待时机成熟再全面替换

### 核心优势

- ✅ **风险可控**：不影响现有功能
- ✅ **逐步过渡**：平滑的迁移路径
- ✅ **灵活选择**：可以随时调整策略
- ✅ **持续改进**：根据反馈优化组件

---

**文档版本**：v1.0.0  
**最后更新**：2026-01-20  
**适用场景**：开发阶段，数据库为空  
**推荐策略**：渐进式共存，新功能优先使用新组件
