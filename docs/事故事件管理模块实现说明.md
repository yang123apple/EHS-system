# 事故事件管理模块实现说明

## 一、概述

本文档说明事故事件管理模块的实现，该模块完全复用现有系统的基础设施，遵循统一的代码风格和架构模式。

## 二、数据库 Schema

### 2.1 Incident 模型

**文件**: `prisma/incident_schema_addition.prisma`

主要字段包括：
- **基础信息**: 类型、严重程度、发生时间、地点、描述
- **关联关系**: 上报人、责任部门
- **调查详情**: 直接原因、间接原因、管理原因、根本原因（5Why分析法）
- **整改措施**: 纠正措施、预防措施（CAPA）
- **工作流集成**: 状态、当前步骤、工作流日志
- **附件**: 现场照片、调查报告、其他附件（存储MinIO路径）

### 2.2 集成到现有 Schema

需要将 `prisma/incident_schema_addition.prisma` 中的内容添加到 `prisma/schema.prisma`：

1. 添加 `Incident` 模型
2. 在 `User` 模型中添加关系：
   ```prisma
   reportedIncidents    Incident[] @relation("IncidentReporter")
   ```
3. 在 `Department` 模型中添加关系：
   ```prisma
   incidents           Incident[] @relation("IncidentDepartment")
   ```
4. 更新 `SignatureRecord` 模型以支持 Incident（可选，如果需要事故签字功能）

## 三、服务层实现

### 3.1 IncidentService

**文件**: `src/services/incident.service.ts`

核心方法：

1. **reportIncident**: 上报事故
   - 生成事故编号
   - 创建事故记录
   - 记录系统日志
   - 发送通知

2. **updateIncident**: 更新事故信息
   - 支持部分更新
   - 记录变更日志
   - 自动更新关联字段（如部门名称）

3. **submitInvestigation**: 提交调查报告
   - 验证状态
   - 保存调查信息（5Why分析）
   - 更新状态为"待审批"
   - 发送通知

4. **closeIncident**: 结案事故
   - 验证权限和状态
   - 更新状态为"已结案"
   - 记录结案信息
   - 发送通知

5. **getIncidents**: 获取事故列表（支持筛选和分页）

6. **getIncidentById**: 获取单个事故详情

### 3.2 复用的基础设施

- ✅ **SystemLogService**: 所有操作都记录系统日志
- ✅ **HazardNotificationService**: 复用通知生成逻辑
- ✅ **MinIO存储**: 附件通过MinIO存储（路径存储在JSON字段中）

## 四、Server Actions

### 4.1 actions/incident.ts

**文件**: `src/actions/incident.ts`

所有方法都：
1. 使用 `'use server'` 指令
2. 进行权限验证
3. 数据验证
4. 调用服务层
5. 统一的错误处理

主要方法：
- `reportIncident`: 上报事故
- `updateIncident`: 更新事故
- `submitInvestigation`: 提交调查报告
- `closeIncident`: 结案事故
- `getIncidents`: 获取列表（用于服务端组件）
- `getIncidentById`: 获取详情（用于服务端组件）

## 五、类型定义

### 5.1 src/types/incident.ts

定义了：
- `IncidentType`: 事故类型枚举
- `IncidentSeverity`: 严重程度枚举
- `IncidentStatus`: 状态枚举
- `Incident`: 事故接口
- `CorrectiveAction`: 纠正措施接口
- `PreventiveAction`: 预防措施接口
- 标签映射常量

## 六、工作流集成（待实现）

### 6.1 当前状态

目前工作流集成字段已预留，但具体的流转逻辑需要：

1. **配置工作流定义**
   - 参考 `src/app/hidden-danger/_utils/workflow-config.ts`
   - 定义事故处理流程：上报 -> 调查 -> 审批 -> 结案

2. **集成工作流引擎**
   - 使用 `WorkflowEngine` 或 `HazardDispatchEngine` 的模式
   - 在状态变更时调用工作流引擎

3. **处理人匹配**
   - 参考 `src/app/hidden-danger/_utils/handler-matcher.ts`
   - 根据工作流配置自动匹配处理人

### 6.2 建议实现步骤

1. 创建 `src/app/incident/_utils/workflow-config.ts`
2. 创建 `src/app/incident/_utils/handler-matcher.ts`
3. 在 `IncidentService` 中集成工作流引擎
4. 实现审批、驳回等操作

## 七、文件上传集成

### 7.1 前端组件

使用现有的 `FileUploader` 组件：
```tsx
import FileUploader from '@/components/storage/FileUploader';

<FileUploader
  onUploadComplete={(files) => {
    // files 包含 MinIO 路径
    // 调用 updateIncident 更新 photos 或 attachments
  }}
  accept="image/*,application/pdf"
/>
```

### 7.2 后端处理

在 Server Actions 中接收文件路径数组，存储为JSON字符串：
```typescript
photos: JSON.stringify(uploadedFiles.map(f => f.path))
```

## 八、数字签名集成（待实现）

如果需要调查报告签字功能：

1. **更新 SignatureRecord 模型**
   ```prisma
   incidentId          String?
   incident            Incident? @relation(fields: [incidentId], references: [id])
   ```

2. **使用现有签名组件**
   ```tsx
   import SignatureManager from '@/components/common/SignatureManager';
   ```

3. **在提交调查报告时记录签名**

## 九、下一步开发建议

### 9.1 前端页面

1. **列表页** (`src/app/incident/page.tsx`)
   - 使用 DataTable 展示事故列表
   - 支持筛选（状态、类型、严重程度、时间范围）
   - 支持分页

2. **详情页** (`src/app/incident/[id]/page.tsx`)
   - 显示事故基本信息
   - 根据状态显示不同的操作表单
   - 显示工作流进度
   - 显示附件和照片

3. **上报页** (`src/app/incident/report/page.tsx`)
   - 事故上报表单
   - 文件上传组件
   - 提交后调用 `reportIncident` Server Action

### 9.2 工作流配置

创建事故处理工作流配置文件，定义：
- 步骤：上报 -> 调查 -> 审批 -> 结案
- 每个步骤的处理人匹配规则
- 审批模式（或签/会签）

### 9.3 统计报表

- 事故类型统计
- 严重程度分布
- 部门事故统计
- 时间趋势分析

## 十、代码风格说明

### 10.1 错误处理

所有方法都使用 try-catch，并返回统一的 `ActionResponse` 格式：
```typescript
{
  success: boolean;
  message?: string;
  error?: string;
  data?: T;
}
```

### 10.2 日志记录

所有关键操作都调用 `SystemLogService.createLog`，包含：
- 用户信息快照
- 操作类型和标签
- 目标对象信息
- 变更详情（beforeData/afterData/changes）

### 10.3 通知发送

使用 `HazardNotificationService` 的模式生成通知数据，然后批量创建通知记录。

## 十一、数据库迁移

执行以下命令应用 Schema 变更：

```bash
npx prisma migrate dev --name add_incident_module
npx prisma generate
```

## 十二、测试建议

1. **单元测试**: 测试服务层方法
2. **集成测试**: 测试 Server Actions
3. **E2E测试**: 测试完整流程（上报 -> 调查 -> 审批 -> 结案）

## 十三、注意事项

1. **权限控制**: 所有操作都进行了权限验证
2. **数据验证**: 关键字段都有验证
3. **错误处理**: 统一的错误处理，不泄露敏感信息
4. **日志记录**: 所有操作都有审计日志
5. **通知机制**: 关键节点都会发送通知

