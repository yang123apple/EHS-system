# éšæ‚£å¤„ç†äººç»Ÿä¸€è§£ææ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

ä¸ºç¡®ä¿**æ–°å»ºéšæ‚£æ—¶çš„æµç¨‹é¢„æµ‹**ä¸**å®é™…æµè½¬æ—¶çš„å¤„ç†äººåŒ¹é…**ç»“æœå®Œå…¨ä¸€è‡´ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ç»Ÿä¸€çš„å¤„ç†äººè§£ææœåŠ¡ã€‚

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

**ä¸€ä¸ªå‡½æ•°ï¼Œä¸¤ä¸ªåœºæ™¯ï¼Œå®Œå…¨ä¸€è‡´**

- âœ… å‰ç«¯æ–°å»ºéšæ‚£æ—¶çš„æµç¨‹é¢„è§ˆ
- âœ… åç«¯éšæ‚£æµè½¬æ—¶çš„å®é™…æ‰§è¡Œ
- âœ… ä»»ä½•éœ€è¦è·å–æ­¥éª¤æ‰§è¡Œäººçš„åœºæ™¯

## ğŸ“¦ æ ¸å¿ƒæœåŠ¡

### `HazardHandlerResolverService`

ä½ç½®ï¼š`src/services/hazardHandlerResolver.service.ts`

è¿™æ˜¯ç»Ÿä¸€çš„å¤„ç†äººè§£ææœåŠ¡ï¼Œæä¾›ä»¥ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š

#### 1. `resolveWorkflow()` - è§£ææ•´ä¸ªå·¥ä½œæµ

```typescript
const result = await HazardHandlerResolverService.resolveWorkflow({
  hazard: mockHazard,      // éšæ‚£æ•°æ®ï¼ˆå®é™…æˆ–æ¨¡æ‹Ÿï¼‰
  workflowSteps,           // å·¥ä½œæµé…ç½®
  allUsers,                // æ‰€æœ‰ç”¨æˆ·
  departments,             // éƒ¨é—¨æ•°æ®
  reporter                 // ä¸ŠæŠ¥äººï¼ˆå¯é€‰ï¼‰
});

// è¿”å›ç»“æœ
{
  success: boolean,
  steps: [
    {
      stepIndex: 0,
      stepId: 'report',
      stepName: 'ä¸ŠæŠ¥å¹¶æŒ‡æ´¾',
      success: true,
      handlers: {
        userIds: ['user123'],
        userNames: ['å¼ ä¸‰'],
        matchedBy: 'fixed'
      },
      ccUsers: {
        userIds: ['user456'],
        userNames: ['æå››'],
        details: [...]
      },
      candidateHandlers: [...],
      approvalMode: 'OR'
    },
    // ... å…¶ä»–æ­¥éª¤
  ]
}
```

#### 2. `resolveStepHandlers()` - è§£æå•ä¸ªæ­¥éª¤

```typescript
const stepResult = await HazardHandlerResolverService.resolveStepHandlers({
  hazard,
  step: workflowSteps[0],
  stepIndex: 0,
  allUsers,
  departments,
  reporter
});
```

#### 3. `createMockHazard()` - åˆ›å»ºæ¨¡æ‹Ÿéšæ‚£

```typescript
const mockHazard = HazardHandlerResolverService.createMockHazard(
  formData,      // è¡¨å•æ•°æ®
  currentUser    // å½“å‰ç”¨æˆ·
);
```

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šå‰ç«¯æ–°å»ºéšæ‚£ - æµç¨‹é¢„è§ˆ

**æ–‡ä»¶ï¼š** `src/app/hidden-danger/_components/modals/HazardReportModal.tsx`

```typescript
import { HazardHandlerResolverService } from '@/services/hazardHandlerResolver.service';

// åœ¨ç»„ä»¶ä¸­
const predictWorkflow = async () => {
  if (!workflowConfig || !formData.type || !formData.location) {
    return;
  }

  try {
    // 1. åˆ›å»ºæ¨¡æ‹Ÿéšæ‚£æ•°æ®
    const mockHazard = HazardHandlerResolverService.createMockHazard(
      formData,
      user  // å½“å‰ç”¨æˆ·
    );

    // 2. è§£ææ•´ä¸ªå·¥ä½œæµ
    const result = await HazardHandlerResolverService.resolveWorkflow({
      hazard: mockHazard,
      workflowSteps: workflowConfig.steps || [],
      allUsers: allUsers || [],
      departments: departments || [],
      reporter: user
    });

    // 3. æ˜¾ç¤ºé¢„è§ˆç»“æœ
    if (result.success) {
      setWorkflowPreview({
        steps: result.steps.map(step => ({
          stepName: step.stepName,
          stepKey: step.stepId,
          success: step.success,
          handlers: step.handlers.userNames,
          matchedBy: step.handlers.matchedBy,
          ccUsers: step.ccUsers.userNames,
          ccDetails: step.ccUsers.details,
          error: step.error
        }))
      });
    }
  } catch (error) {
    console.error('æµç¨‹é¢„æµ‹å¤±è´¥:', error);
  }
};
```

### åœºæ™¯2ï¼šåç«¯éšæ‚£æµè½¬ - å®é™…åŒ¹é…

**æ–‡ä»¶ï¼š** `src/services/hazardDispatchEngine.ts`

```typescript
import { HazardHandlerResolverService } from './hazardHandlerResolver.service';

export class HazardDispatchEngine {
  static async dispatch(context: DispatchContext): Promise<DispatchResult> {
    // ... å…¶ä»–é€»è¾‘

    // è·å–ä¸‹ä¸€æ­¥éª¤é…ç½®
    const nextStep = workflowSteps[transition.nextStepIndex];
    
    // ä½¿ç”¨ç»Ÿä¸€æœåŠ¡è§£æè¯¥æ­¥éª¤çš„å¤„ç†äºº
    const stepResult = await HazardHandlerResolverService.resolveStepHandlers({
      hazard: updatedHazard,
      step: nextStep,
      stepIndex: transition.nextStepIndex,
      allUsers,
      departments,
      reporter: allUsers.find(u => u.id === updatedHazard.reporterId)
    });

    // ä½¿ç”¨è§£æç»“æœ
    return {
      success: stepResult.success,
      handlers: stepResult.handlers,
      ccUsers: stepResult.ccUsers,
      candidateHandlers: stepResult.candidateHandlers,
      // ... å…¶ä»–å­—æ®µ
    };
  }
}
```

### åœºæ™¯3ï¼šAPIå±‚è°ƒç”¨

**æ–‡ä»¶ï¼š** `src/app/api/hazards/route.ts`ï¼ˆPOST - åˆ›å»ºéšæ‚£ï¼‰

```typescript
import { HazardHandlerResolverService } from '@/services/hazardHandlerResolver.service';

export const POST = withErrorHandling(
  withPermission('hidden_danger', 'report', async (request, context, user) => {
    const body = await request.json();
    
    // 1. åˆ›å»ºéšæ‚£è®°å½•å‰ï¼Œå…ˆè§£æå·¥ä½œæµ
    const workflowConfig = await getWorkflowConfig();
    
    const mockHazard = HazardHandlerResolverService.createMockHazard(
      body,
      user
    );

    const resolution = await HazardHandlerResolverService.resolveWorkflow({
      hazard: mockHazard,
      workflowSteps: workflowConfig.steps,
      allUsers: await getAllUsers(),
      departments: await getAllDepartments()
    });

    // 2. éªŒè¯æ‰€æœ‰æ­¥éª¤éƒ½èƒ½åŒ¹é…åˆ°å¤„ç†äºº
    if (!resolution.success) {
      return NextResponse.json({
        error: 'å·¥ä½œæµé…ç½®é”™è¯¯ï¼Œéƒ¨åˆ†æ­¥éª¤æ— æ³•åŒ¹é…å¤„ç†äºº',
        details: resolution.steps.filter(s => !s.success)
      }, { status: 400 });
    }

    // 3. ä½¿ç”¨ç¬¬ä¸€æ­¥çš„å¤„ç†äººå’ŒæŠ„é€äºº
    const firstStep = resolution.steps[0];
    
    // 4. åˆ›å»ºéšæ‚£è®°å½•
    const hazard = await prisma.hazardRecord.create({
      data: {
        ...processedData,
        dopersonal_ID: firstStep.handlers.userIds[0],
        dopersonal_Name: firstStep.handlers.userNames[0],
        ccUsers: JSON.stringify(firstStep.ccUsers.userIds),
        candidateHandlers: JSON.stringify(firstStep.candidateHandlers)
      }
    });

    return NextResponse.json(hazard);
  })
);
```

## âœ¨ æ ¸å¿ƒä¼˜åŠ¿

### 1. **é€»è¾‘ç»Ÿä¸€æ€§**
- å‰ç«¯é¢„æµ‹å’Œåç«¯æ‰§è¡Œä½¿ç”¨å®Œå…¨ç›¸åŒçš„é€»è¾‘
- æ¶ˆé™¤äº†é¢„æµ‹ä¸å®é™…ä¸ä¸€è‡´çš„é—®é¢˜

### 2. **å¯ç»´æŠ¤æ€§**
- å¤„ç†äººåŒ¹é…é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªæœåŠ¡ä¸­
- ä¿®æ”¹åŒ¹é…è§„åˆ™æ—¶åªéœ€æ›´æ–°ä¸€å¤„

### 3. **ç±»å‹å®‰å…¨**
- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- ç¼–è¯‘æ—¶å°±èƒ½å‘ç°é—®é¢˜

### 4. **å¯æµ‹è¯•æ€§**
- ç‹¬ç«‹çš„æœåŠ¡å¯ä»¥å•ç‹¬æµ‹è¯•
- æ˜“äºç¼–å†™å•å…ƒæµ‹è¯•

### 5. **å¯æ‰©å±•æ€§**
- è½»æ¾æ·»åŠ æ–°çš„åŒ¹é…ç­–ç•¥
- æ”¯æŒè‡ªå®šä¹‰æ­¥éª¤é…ç½®

## ğŸ” å·¥ä½œåŸç†

### è§£ææµç¨‹

```
1. è¾“å…¥éšæ‚£æ•°æ® + å·¥ä½œæµé…ç½®
         â†“
2. éå†æ¯ä¸ªæ­¥éª¤
         â†“
3. è°ƒç”¨ matchHandler() åŒ¹é…å¤„ç†äºº
         â†“
4. è°ƒç”¨ matchAllCCRules() åŒ¹é…æŠ„é€äºº
         â†“
5. ç»„è£…ç»“æœï¼ˆåŒ…å«å€™é€‰äººã€å®¡æ‰¹æ¨¡å¼ç­‰ï¼‰
         â†“
6. è¿”å›å®Œæ•´è§£æç»“æœ
```

### æ•°æ®æµ

```
å‰ç«¯è¡¨å•æ•°æ®
    â†“
createMockHazard() â†’ æ¨¡æ‹Ÿéšæ‚£å¯¹è±¡
    â†“
resolveWorkflow() â†’ å®Œæ•´å·¥ä½œæµè§£æ
    â†“
å‰ç«¯é¢„è§ˆå±•ç¤º

---åˆ†ç•Œçº¿---

åç«¯æ¥æ”¶è¯·æ±‚
    â†“
resolveWorkflow() â†’ å®Œæ•´å·¥ä½œæµè§£æï¼ˆç›¸åŒé€»è¾‘ï¼‰
    â†“
éªŒè¯ + åˆ›å»ºéšæ‚£è®°å½•
```

## ğŸ“ è¿ç§»æŒ‡å—

### æ­¥éª¤1ï¼šæ›´æ–°å‰ç«¯ä»£ç 

æ›¿æ¢ `HazardReportModal.tsx` ä¸­çš„ `predictWorkflow` å‡½æ•°ï¼š

```typescript
// âŒ æ—§ä»£ç ï¼ˆç›´æ¥è°ƒç”¨ matchHandlerï¼‰
const result = await matchHandler({
  hazard: mockHazard,
  step,
  allUsers,
  departments
});

// âœ… æ–°ä»£ç ï¼ˆä½¿ç”¨ç»Ÿä¸€æœåŠ¡ï¼‰
const result = await HazardHandlerResolverService.resolveWorkflow({
  hazard: mockHazard,
  workflowSteps,
  allUsers,
  departments,
  reporter: user
});
```

### æ­¥éª¤2ï¼šæ›´æ–°åç«¯ä»£ç 

åœ¨ `hazardDispatchEngine.ts` ä¸­ä½¿ç”¨ç»Ÿä¸€æœåŠ¡ï¼š

```typescript
// âœ… å¯¼å…¥ç»Ÿä¸€æœåŠ¡
import { HazardHandlerResolverService } from './hazardHandlerResolver.service';

// âœ… ä½¿ç”¨ç»Ÿä¸€æ–¹æ³•
const stepResult = await HazardHandlerResolverService.resolveStepHandlers({
  hazard: updatedHazard,
  step: nextStep,
  stepIndex: transition.nextStepIndex,
  allUsers,
  departments
});
```

### æ­¥éª¤3ï¼šæµ‹è¯•éªŒè¯

1. **å‰ç«¯æµ‹è¯•**ï¼šæ–°å»ºéšæ‚£ï¼ŒæŸ¥çœ‹æµç¨‹é¢„è§ˆ
2. **åç«¯æµ‹è¯•**ï¼šå®é™…æäº¤éšæ‚£ï¼ŒéªŒè¯æµè½¬
3. **å¯¹æ¯”æµ‹è¯•**ï¼šç¡®ä¿é¢„æµ‹å’Œå®é™…å®Œå…¨ä¸€è‡´

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§

ç¡®ä¿ä¼ å…¥çš„éšæ‚£æ•°æ®ç»“æ„ä¸€è‡´ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šåŒ…å«å¿…éœ€å­—æ®µ
{
  type: string,
  location: string,
  reporterId: string,
  responsibleId: string,
  responsibleDeptId: string,
  assignedDepartmentId: string
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘å…³é”®å­—æ®µ
{
  type: string,
  location: string
  // ç¼ºå°‘å…¶ä»–å­—æ®µä¼šå¯¼è‡´æŸäº›ç­–ç•¥æ— æ³•åŒ¹é…
}
```

### 2. å·¥ä½œæµé…ç½®

ç¡®ä¿å·¥ä½œæµé…ç½®å®Œæ•´ï¼š

```typescript
{
  steps: [
    {
      id: 'report',
      name: 'ä¸ŠæŠ¥å¹¶æŒ‡æ´¾',
      handlerStrategy: {
        type: 'fixed',
        fixedUsers: [...],
        approvalMode: 'OR'  // å¯é€‰
      },
      ccRules: [...]  // å¯é€‰
    }
  ]
}
```

### 3. é”™è¯¯å¤„ç†

```typescript
const result = await HazardHandlerResolverService.resolveWorkflow(context);

if (!result.success) {
  // æ£€æŸ¥å…·ä½“å“ªä¸ªæ­¥éª¤å¤±è´¥
  const failedSteps = result.steps.filter(s => !s.success);
  console.error('å¤±è´¥çš„æ­¥éª¤:', failedSteps);
  
  // å‘ç”¨æˆ·å±•ç¤ºé”™è¯¯
  failedSteps.forEach(step => {
    console.error(`${step.stepName}: ${step.error}`);
  });
}
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```typescript
describe('HazardHandlerResolverService', () => {
  it('åº”è¯¥æ­£ç¡®è§£ææ‰€æœ‰æ­¥éª¤', async () => {
    const result = await HazardHandlerResolverService.resolveWorkflow({
      hazard: mockHazard,
      workflowSteps: testWorkflow,
      allUsers: testUsers,
      departments: testDepts
    });

    expect(result.success).toBe(true);
    expect(result.steps).toHaveLength(testWorkflow.length);
    expect(result.steps[0].handlers.userNames).toContain('å¼ ä¸‰');
  });

  it('åº”è¯¥åœ¨ç¼ºå°‘å¤„ç†äººæ—¶è¿”å›å¤±è´¥', async () => {
    const result = await HazardHandlerResolverService.resolveStepHandlers({
      hazard: invalidHazard,
      step: invalidStep,
      stepIndex: 0,
      allUsers: [],
      departments: []
    });

    expect(result.success).toBe(false);
    expect(result.error).toBeDefined();
  });
});
```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

- âœ… æ‰¹é‡è§£æé¿å…é‡å¤æŸ¥è¯¢
- âœ… ç»“æœå¯ç¼“å­˜ç”¨äºé¢„è§ˆ
- âœ… æ”¯æŒå¢é‡è§£æå•ä¸ªæ­¥éª¤
- âš ï¸ å¤§é‡ç”¨æˆ·/éƒ¨é—¨æ—¶æ³¨æ„æ€§èƒ½

## ğŸ”„ ç‰ˆæœ¬å…¼å®¹

- âœ… å‘åå…¼å®¹ç°æœ‰çš„ `matchHandler` è°ƒç”¨
- âœ… æä¾›ä¾¿æ·æ–¹æ³•å¯¼å‡º
- âœ… æ¸è¿›å¼è¿ç§»æ”¯æŒ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤„ç†äººåŒ¹é…å™¨](../src/app/hidden-danger/_utils/handler-matcher.ts)
- [æŠ„é€äººåŒ¹é…å™¨](../src/app/hidden-danger/_utils/cc-matcher.ts)
- [æ´¾å‘å¼•æ“](../src/services/hazardDispatchEngine.ts)
- [å·¥ä½œæµé…ç½®](../src/app/hidden-danger/_components/views/WorkflowConfig.tsx)

## ğŸ‰ æ€»ç»“

é€šè¿‡ç»Ÿä¸€çš„ `HazardHandlerResolverService`ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **é¢„æµ‹å³å®é™…** - æ–°å»ºæ—¶çœ‹åˆ°çš„å°±æ˜¯æµè½¬æ—¶æ‰§è¡Œçš„
2. **ä¸€å¤„ä¿®æ”¹ï¼Œå¤„å¤„ç”Ÿæ•ˆ** - ç»´æŠ¤æˆæœ¬é™ä½
3. **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶å‘ç°é—®é¢˜
4. **æ˜“äºæµ‹è¯•** - ç‹¬ç«‹æœåŠ¡ä¾¿äºå•å…ƒæµ‹è¯•
5. **å¯æ‰©å±•** - è½»æ¾æ·»åŠ æ–°ç­–ç•¥

**å…³é”®åŸåˆ™ï¼šä¸€ä¸ªå‡½æ•°ï¼Œç»Ÿä¸€é€»è¾‘ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼**
