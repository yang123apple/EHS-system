# å¯†ç å®‰å…¨ä¿®å¤æ–‡æ¡£

## ä¿®å¤æ—¶é—´
2026å¹´1æœˆ11æ—¥

## é—®é¢˜æè¿°
ç³»ç»Ÿå­˜åœ¨ä¸¥é‡çš„å¯†ç å®‰å…¨é—®é¢˜ï¼š
- **æ˜æ–‡å¯†ç å­˜å‚¨**ï¼šæ•°æ®åº“ä¸­çš„ç”¨æˆ·å¯†ç ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨
- **æ˜æ–‡å¯†ç æ¯”å¯¹**ï¼šç™»å½•éªŒè¯æ—¶ç›´æ¥æ¯”å¯¹æ˜æ–‡å¯†ç 
- **æ•°æ®æ³„éœ²é£é™©**ï¼šä¸€æ—¦æ•°æ®åº“æ³„éœ²ï¼Œæ‰€æœ‰ç”¨æˆ·å¯†ç å°†å®Œå…¨æš´éœ²

## ä¿®å¤æ–¹æ¡ˆ
ä½¿ç”¨ `bcryptjs` åº“å¯¹å¯†ç è¿›è¡Œå“ˆå¸ŒåŠ å¯†ï¼ŒåŠ å¯†å¼ºåº¦ä¸º 10 è½®ï¼ˆsalt roundsï¼‰

## å·²ä¿®å¤çš„æ–‡ä»¶

### 1. ç™»å½•éªŒè¯ (`src/app/api/auth/login/route.ts`)
**ä¿®å¤å‰ï¼š**
```typescript
if (user && user.password === password) {
```

**ä¿®å¤åï¼š**
```typescript
import bcrypt from 'bcryptjs';
// ...
const isPasswordValid = user && user.password && await bcrypt.compare(password, user.password);
if (isPasswordValid) {
```

### 2. ç”¨æˆ·åˆ›å»º (`src/app/api/users/route.ts`)
**ä¿®å¤å‰ï¼š**
```typescript
const newUser = await prisma.user.create({
  data: {
    // ...
    password: body.password || '123456', // é»˜è®¤å¯†ç 
  }
});
```

**ä¿®å¤åï¼š**
```typescript
import bcrypt from 'bcryptjs';
// ...
const plainPassword = body.password || '123456';
const salt = await bcrypt.genSalt(10);
const hashedPassword = await bcrypt.hash(plainPassword, salt);

const newUser = await prisma.user.create({
  data: {
    // ...
    password: hashedPassword,
  }
});
```

### 3. å¯†ç é‡ç½® (`src/app/api/users/[id]/reset-password/route.ts`)
**ä¿®å¤å‰ï¼š**
```typescript
const updatedUser = await db.updateUser(id, { 
  password: '123' 
});
```

**ä¿®å¤åï¼š**
```typescript
import bcrypt from 'bcryptjs';
// ...
const salt = await bcrypt.genSalt(10);
const hashedPassword = await bcrypt.hash('123', salt);

const updatedUser = await db.updateUser(id, { 
  password: hashedPassword
});
```

### 4. ç”¨æˆ·ä¿å­˜å‡½æ•° (`src/lib/db.ts`)
**ä¿®å¤å‰ï¼š**
```typescript
const safeData = {
  // ...
  password: user.password,
  // ...
};
```

**ä¿®å¤åï¼š**
```typescript
import bcrypt from 'bcryptjs';
// ...
let hashedPassword = user.password;
if (user.password && !user.password.startsWith('$2a$') && !user.password.startsWith('$2b$')) {
  const salt = await bcrypt.genSalt(10);
  hashedPassword = await bcrypt.hash(user.password, salt);
}

const safeData = {
  // ...
  password: hashedPassword,
  // ...
};
```

### 5. æ•°æ®åº“ç§å­æ–‡ä»¶ (`prisma/seed.ts`)
**ä¿®å¤å‰ï¼š**
```typescript
const admin = await prisma.user.create({
  data: {
    // ...
    password: 'admin', // ç”Ÿäº§ç¯å¢ƒè¯·åŠ å¯†
  }
});
```

**ä¿®å¤åï¼š**
```typescript
import bcrypt from 'bcryptjs';
// ...
const salt = await bcrypt.genSalt(10);
const hashedPassword = await bcrypt.hash('admin', salt);

const admin = await prisma.user.create({
  data: {
    // ...
    password: hashedPassword, // ä½¿ç”¨ bcrypt åŠ å¯†
  }
});
```

### 6. å¯†ç ä¿®æ”¹åŠŸèƒ½ (`src/actions/settings.ts`)
âœ… **å·²ç»æ­£ç¡®å®ç°**ï¼Œä»£ç å·²ç»åŒæ—¶æ”¯æŒæ˜æ–‡å’ŒåŠ å¯†å¯†ç çš„éªŒè¯

## å¯†ç è¿ç§»

### è¿ç§»è„šæœ¬
åˆ›å»ºäº† `scripts/migrate-passwords-to-hash.js` ç”¨äºå°†ç°æœ‰æ˜æ–‡å¯†ç è¿ç§»ä¸ºå“ˆå¸Œå¯†ç ã€‚

### ä½¿ç”¨æ–¹æ³•
```bash
node scripts/migrate-passwords-to-hash.js
```

### è„šæœ¬åŠŸèƒ½
- æ‰«ææ‰€æœ‰ç”¨æˆ·è®°å½•
- è‡ªåŠ¨æ£€æµ‹å¯†ç æ˜¯å¦å·²åŠ å¯†ï¼ˆé€šè¿‡ bcrypt hash å‰ç¼€ `$2a$` æˆ– `$2b$`ï¼‰
- å¯¹æœªåŠ å¯†çš„å¯†ç è¿›è¡ŒåŠ å¯†
- ç”Ÿæˆè¯¦ç»†çš„è¿ç§»æŠ¥å‘Š
- æ˜¾ç¤ºå·²è¿ç§»ç”¨æˆ·çš„åŸå§‹å¯†ç ï¼ˆç”¨äºé€šçŸ¥ç”¨æˆ·ï¼‰

### è¿ç§»æŠ¥å‘Šç¤ºä¾‹
```
ğŸ“‹ è¿ç§»æŠ¥å‘Š
============================================================
æ€»ç”¨æˆ·æ•°:        10
å·²è¿ç§»:          8
å·²åŠ å¯†(è·³è¿‡):    1
æ— å¯†ç (è·³è¿‡):    1
é”™è¯¯æ•°:          0
============================================================
```

## å®‰å…¨æ”¹è¿›

### 1. å¯†ç å“ˆå¸Œ
- ä½¿ç”¨ `bcrypt` ç®—æ³•è¿›è¡Œå•å‘å“ˆå¸Œ
- Salt rounds = 10ï¼ˆè®¡ç®—å¤æ‚åº¦é€‚ä¸­ï¼‰
- æ¯ä¸ªå¯†ç ä½¿ç”¨å”¯ä¸€çš„ salt

### 2. å‘åå…¼å®¹
- `src/actions/settings.ts` ä¸­çš„å¯†ç éªŒè¯åŒæ—¶æ”¯æŒæ˜æ–‡å’ŒåŠ å¯†å¯†ç 
- ä¾¿äºå¹³æ»‘è¿ç§»ï¼Œä¸ä¼šå½±å“ç°æœ‰ç”¨æˆ·ç™»å½•
- è¿ç§»è„šæœ¬ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶è·³è¿‡å·²åŠ å¯†çš„å¯†ç 

### 3. é˜²æ­¢é‡å¤åŠ å¯†
- `db.ts` ä¸­çš„ `saveUser` å‡½æ•°ä¼šæ£€æŸ¥å¯†ç æ˜¯å¦å·²åŠ å¯†
- é¿å…å¯¹å·²åŠ å¯†çš„å¯†ç å†æ¬¡åŠ å¯†

## æ³¨æ„äº‹é¡¹

### å¯¹ç°æœ‰ç³»ç»Ÿçš„å½±å“
1. **å·²ç™»å½•ç”¨æˆ·**ï¼šä¸å—å½±å“
2. **æ–°ç”¨æˆ·**ï¼šå¯†ç è‡ªåŠ¨åŠ å¯†å­˜å‚¨
3. **å¯†ç é‡ç½®**ï¼šé‡ç½®åçš„å¯†ç ä¼šåŠ å¯†å­˜å‚¨
4. **ç°æœ‰æ˜æ–‡å¯†ç **ï¼šéœ€è¦è¿è¡Œè¿ç§»è„šæœ¬

### è¿ç§»æ­¥éª¤ï¼ˆæ¨èï¼‰
1. **å¤‡ä»½æ•°æ®åº“**ï¼š
   ```bash
   # æ ¹æ®ä½ çš„æ•°æ®åº“ç±»å‹å¤‡ä»½
   ```

2. **è¿è¡Œè¿ç§»è„šæœ¬**ï¼š
   ```bash
   node scripts/migrate-passwords-to-hash.js
   ```

3. **éªŒè¯è¿ç§»ç»“æœ**ï¼š
   - æ£€æŸ¥è¿ç§»æŠ¥å‘Š
   - æµ‹è¯•ç”¨æˆ·ç™»å½•
   - æµ‹è¯•å¯†ç é‡ç½®åŠŸèƒ½

4. **é€šçŸ¥ç”¨æˆ·**ï¼ˆå¯é€‰ï¼‰ï¼š
   - å¦‚æœéœ€è¦ï¼Œå¯ä»¥é€šçŸ¥ç”¨æˆ·å¯†ç å·²åŠ å¯†
   - å»ºè®®ç”¨æˆ·ä¿®æ”¹å¯†ç ï¼ˆå¯é€‰ï¼‰

### é»˜è®¤å¯†ç 
- æ–°åˆ›å»ºç”¨æˆ·ï¼š`123456`ï¼ˆä¼šè‡ªåŠ¨åŠ å¯†ï¼‰
- é‡ç½®å¯†ç åï¼š`123`ï¼ˆä¼šè‡ªåŠ¨åŠ å¯†ï¼‰
- ç®¡ç†å‘˜åˆå§‹å¯†ç ï¼š`admin`ï¼ˆä¼šè‡ªåŠ¨åŠ å¯†ï¼‰

## ä¾èµ–é¡¹
- `bcryptjs`: ^3.0.3ï¼ˆå·²åœ¨ package.json ä¸­ï¼‰

## æµ‹è¯•å»ºè®®
1. æµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
2. æµ‹è¯•å¯†ç é‡ç½®åŠŸèƒ½
3. æµ‹è¯•å¯†ç ä¿®æ”¹åŠŸèƒ½
4. éªŒè¯ç°æœ‰ç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•
5. éªŒè¯è¿ç§»è„šæœ¬çš„å¹‚ç­‰æ€§ï¼ˆå¤šæ¬¡è¿è¡Œä¸ä¼šé‡å¤åŠ å¯†ï¼‰

## å®‰å…¨æ€§è¯„ä¼°

### ä¿®å¤å‰
- **é£é™©ç­‰çº§**ï¼šğŸ”´ ä¸¥é‡
- **é—®é¢˜**ï¼šæ˜æ–‡å¯†ç å­˜å‚¨å’Œæ¯”å¯¹
- **å½±å“**ï¼šæ•°æ®åº“æ³„éœ²å°†å¯¼è‡´æ‰€æœ‰ç”¨æˆ·å¯†ç æš´éœ²

### ä¿®å¤å
- **é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½
- **æ”¹è¿›**ï¼š
  - å¯†ç ä½¿ç”¨ bcrypt å“ˆå¸Œå­˜å‚¨
  - å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç›´æ¥è·å–æ˜æ–‡å¯†ç 
  - bcrypt ç®—æ³•å…·æœ‰æŠ—æš´åŠ›ç ´è§£ç‰¹æ€§ï¼ˆè®¡ç®—æˆæœ¬é«˜ï¼‰

## æœªæ¥æ”¹è¿›å»ºè®®
1. è€ƒè™‘å¢åŠ å¯†ç å¤æ‚åº¦è¦æ±‚
2. å®æ–½å¯†ç è¿‡æœŸç­–ç•¥
3. æ·»åŠ å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
4. è®°å½•å¯†ç ä¿®æ”¹å†å²
5. å®æ–½è´¦æˆ·é”å®šæœºåˆ¶ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰
