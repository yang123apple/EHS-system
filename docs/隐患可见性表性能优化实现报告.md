# éšæ‚£å¯è§æ€§è¡¨æ€§èƒ½ä¼˜åŒ–å®ç°æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†éšæ‚£ç®¡ç†ç³»ç»Ÿä¸­åŸºäºå¯è§æ€§è¡¨ï¼ˆHazardVisibilityï¼‰çš„è¡Œçº§å®‰å…¨æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆçš„å®ç°è¿‡ç¨‹ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

- **æ€§èƒ½éœ€æ±‚**ï¼šæ”¯æŒç™¾ä¸‡çº§æ•°æ®é‡çš„é«˜æ•ˆæŸ¥è¯¢
- **æ ¸å¿ƒåœºæ™¯**ï¼š"æˆ‘çš„éšæ‚£"æŸ¥è¯¢ï¼Œé¿å…å¤æ‚çš„å¤šè¡¨JOINå’ŒORæ¡ä»¶
- **ä¼˜åŒ–ç­–ç•¥**ï¼šé¢„è®¡ç®—æƒé™å…³ç³»ï¼Œä½¿ç”¨æ‰å¹³åŒ–æƒé™è¡¨ + å¤åˆç´¢å¼•

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. Prisma Schema æ›´æ–°

åœ¨ `prisma/schema.prisma` ä¸­å·²æ·»åŠ  `HazardVisibility` æ¨¡å‹ï¼š

```prisma
model HazardVisibility {
  id        String       @id @default(cuid())
  hazardId  String       // éšæ‚£ID
  hazard    HazardRecord @relation(fields: [hazardId], references: [id], onDelete: Cascade)
  userId    String       // å¯è§ç”¨æˆ·ID
  role      String       // ç”¨æˆ·è§’è‰²ï¼šcreator, executor, cc, responsible, verifier, candidate
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // ğŸ”¥ æ€§èƒ½å…³é”®ç´¢å¼•
  @@unique([hazardId, userId, role]) // é˜²æ­¢é‡å¤è®°å½•
  @@index([userId, hazardId]) // ğŸš€ æ ¸å¿ƒç´¢å¼•ï¼šæŸ¥è¯¢æŸç”¨æˆ·å¯è§çš„æ‰€æœ‰éšæ‚£
  @@index([hazardId]) // æŸ¥è¯¢æŸéšæ‚£çš„æ‰€æœ‰å¯è§ç”¨æˆ·
  @@index([role]) // æŒ‰è§’è‰²ç­›é€‰
  @@index([userId, role]) // æŸ¥è¯¢æŸç”¨æˆ·ä»¥æŸè§’è‰²å¯è§çš„éšæ‚£
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- `(userId, hazardId)` å¤åˆç´¢å¼•ï¼šè¦†ç›–ç´¢å¼•ï¼Œç›´æ¥æ”¯æŒ"æˆ‘çš„éšæ‚£"æŸ¥è¯¢
- çº§è”åˆ é™¤ï¼šéšæ‚£åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†å¯è§æ€§è®°å½•
- å”¯ä¸€çº¦æŸï¼šé˜²æ­¢é‡å¤æƒé™è®°å½•

### 2. å¯è§æ€§æœåŠ¡å®ç°

å·²åˆ›å»º `src/services/hazardVisibility.service.ts`ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

#### 2.1 å¯è§æ€§è®¡ç®—å‡½æ•°

```typescript
export function calculateVisibilityRoles(hazard: {
  createdBy: string;
  dopersonal_ID?: string | null;
  ccUsers?: Array<{ userId: string }>;
  responsibleUserId?: string | null;
  verifierUserId?: string | null;
  candidateHandlers?: Array<{ userId: string }>;
}): VisibilityRole[]
```

**åŠŸèƒ½**ï¼šæ ¹æ®éšæ‚£å½“å‰çŠ¶æ€è®¡ç®—æ‰€æœ‰å¯è§æ€§è§’è‰²
- åˆ›å»ºäººï¼ˆcreatorï¼‰
- å½“å‰æ‰§è¡Œäººï¼ˆexecutorï¼‰
- æŠ„é€äººï¼ˆccï¼‰
- è´£ä»»äººï¼ˆresponsibleï¼‰
- éªŒæ”¶äººï¼ˆverifierï¼‰
- å€™é€‰å¤„ç†äººï¼ˆcandidateï¼‰

#### 2.2 åŒæ­¥å¯è§æ€§å‡½æ•°

```typescript
export async function syncHazardVisibility(
  hazardId: string,
  tx?: typeof prisma
): Promise<void>
```

**åŠŸèƒ½**ï¼šåŒæ­¥å•ä¸ªéšæ‚£çš„å¯è§æ€§è®°å½•
- æ”¯æŒäº‹åŠ¡æ“ä½œï¼ˆä¸å…¶ä»–æ•°æ®åº“æ“ä½œç»„åˆï¼‰
- åˆ é™¤æ—§è®°å½• + é‡æ–°è®¡ç®— + æ‰¹é‡æ’å…¥æ–°è®°å½•

#### 2.3 æ‰¹é‡åŒæ­¥å‡½æ•°

```typescript
export async function batchSyncVisibility(
  hazardIds: string[],
  batchSize: number = 100
): Promise<{ success: number; failed: number; errors: Array<...> }>
```

**ç”¨é€”**ï¼š
- ç³»ç»Ÿåˆå§‹åŒ–
- æ‰¹é‡æ•°æ®è¿ç§»
- å®šæœŸç»´æŠ¤ä»»åŠ¡

#### 2.4 å…¨é‡é‡å»ºå‡½æ•°

```typescript
export async function rebuildAllVisibility(options?: {
  where?: any;
  batchSize?: number;
  onProgress?: (processed: number, total: number) => void;
}): Promise<{ total: number; success: number; failed: number }>
```

**è­¦å‘Š**ï¼šæ­¤æ“ä½œè€—æ—¶ï¼Œä»…ç”¨äºé¦–æ¬¡å¯ç”¨æˆ–æ•°æ®ä¿®å¤åœºæ™¯

#### 2.5 ä¼˜åŒ–æŸ¥è¯¢å‡½æ•°

```typescript
export async function getMyHazards(
  userId: string,
  options?: {
    skip?: number;
    take?: number;
    orderBy?: any;
    where?: any;
    include?: any;
  }
)
```

**æ€§èƒ½å…³é”®**ï¼š
- åˆ©ç”¨ `HazardVisibility` çš„ `(userId, hazardId)` ç´¢å¼•
- é¿å…å¤æ‚çš„å¤šè¡¨JOINå’ŒORæ¡ä»¶
- æ”¯æŒé«˜æ•ˆåˆ†é¡µ

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```typescript
const hazards = await prisma.hazardRecord.findMany({
  where: {
    ...where,
    deletedAt: null,
    visibilityRecords: {
      some: { userId } // åˆ©ç”¨ç´¢å¼•çš„é«˜æ•ˆæŸ¥è¯¢
    }
  },
  skip,
  take,
  orderBy: orderBy || { createdAt: 'desc' }
});
```

#### 2.6 æƒé™æ£€æŸ¥å‡½æ•°

```typescript
export async function canUserViewHazard(
  userId: string,
  hazardId: string
): Promise<boolean>
```

**é«˜æ€§èƒ½ç‰ˆæœ¬**ï¼šç›´æ¥æŸ¥è¯¢å¯è§æ€§è¡¨ï¼Œé¿å…å¤æ‚çš„æƒé™è®¡ç®—é€»è¾‘

## â³ å¾…å®Œæˆå·¥ä½œ

### 1. æ•°æ®åº“è¿ç§»

éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åº”ç”¨Schemaæ›´æ”¹ï¼š

```bash
# ç”ŸæˆPrisma Client
npx prisma generate

# åˆ›å»ºå¹¶åº”ç”¨è¿ç§»
npx prisma migrate dev --name add_hazard_visibility
```

### 2. é›†æˆåˆ°æ´¾å‘å¼•æ“

éœ€è¦åœ¨ `src/services/hazardDispatchEngine.ts` ä¸­é›†æˆå¯è§æ€§åŒæ­¥ï¼š

```typescript
import { syncHazardVisibility } from './hazardVisibility.service';

// åœ¨éšæ‚£çŠ¶æ€å˜æ›´æ—¶åŒæ­¥å¯è§æ€§
async dispatch(hazard: HazardRecord, action: string) {
  // ... ç°æœ‰é€»è¾‘ ...
  
  // ğŸš€ åŒæ­¥å¯è§æ€§è®°å½•
  await syncHazardVisibility(hazard.id);
}
```

**é›†æˆç‚¹**ï¼š
- éšæ‚£åˆ›å»ºæ—¶
- çŠ¶æ€æµè½¬æ—¶
- å¤„ç†äººå˜æ›´æ—¶
- æŠ„é€äººå˜æ›´æ—¶

### 3. æ›´æ–°APIè·¯ç”±

éœ€è¦åœ¨ `src/app/api/hazards/route.ts` ä¸­ä½¿ç”¨æ–°çš„æŸ¥è¯¢å‡½æ•°ï¼š

```typescript
import { getMyHazards } from '@/services/hazardVisibility.service';

// GET /api/hazards - æŸ¥è¯¢æˆ‘çš„éšæ‚£
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const page = parseInt(searchParams.get('page') || '1');
  const pageSize = parseInt(searchParams.get('pageSize') || '20');
  
  const result = await getMyHazards(currentUserId, {
    skip: (page - 1) * pageSize,
    take: pageSize,
    where: {
      // å…¶ä»–ç­›é€‰æ¡ä»¶
    }
  });
  
  return NextResponse.json(result);
}
```

### 4. åˆå§‹åŒ–ç°æœ‰æ•°æ®

ä¸ºç°æœ‰éšæ‚£æ•°æ®ç”Ÿæˆå¯è§æ€§è®°å½•ï¼š

```typescript
// åˆ›å»ºè„šæœ¬: scripts/init-hazard-visibility.ts
import { rebuildAllVisibility } from '@/services/hazardVisibility.service';

async function main() {
  console.log('å¼€å§‹åˆå§‹åŒ–éšæ‚£å¯è§æ€§è®°å½•...');
  
  const result = await rebuildAllVisibility({
    batchSize: 100,
    onProgress: (processed, total) => {
      console.log(`è¿›åº¦: ${processed}/${total} (${Math.round(processed/total*100)}%)`);
    }
  });
  
  console.log('åˆå§‹åŒ–å®Œæˆ:', result);
}

main();
```

### 5. æ€§èƒ½æµ‹è¯•

éœ€è¦éªŒè¯ä¼˜åŒ–æ•ˆæœï¼š

```typescript
// æµ‹è¯•è„šæœ¬: scripts/test-visibility-performance.ts
import { performance } from 'perf_hooks';

async function testPerformance() {
  // 1. æµ‹è¯•æ—§æ–¹æ³•ï¼ˆå¤æ‚JOINï¼‰
  const start1 = performance.now();
  const oldResult = await getHazardsOldWay(userId);
  const time1 = performance.now() - start1;
  
  // 2. æµ‹è¯•æ–°æ–¹æ³•ï¼ˆå¯è§æ€§è¡¨ï¼‰
  const start2 = performance.now();
  const newResult = await getMyHazards(userId);
  const time2 = performance.now() - start2;
  
  console.log(`æ—§æ–¹æ³•è€—æ—¶: ${time1.toFixed(2)}ms`);
  console.log(`æ–°æ–¹æ³•è€—æ—¶: ${time2.toFixed(2)}ms`);
  console.log(`æ€§èƒ½æå‡: ${((time1/time2 - 1) * 100).toFixed(2)}%`);
}
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ç´¢å¼•ç­–ç•¥

```sql
-- æ ¸å¿ƒè¦†ç›–ç´¢å¼•ï¼šç›´æ¥æ”¯æŒ"æˆ‘çš„éšæ‚£"æŸ¥è¯¢
CREATE INDEX "HazardVisibility_userId_hazardId_idx" 
  ON "HazardVisibility"("userId", "hazardId");

-- åå‘æŸ¥è¯¢ç´¢å¼•ï¼šæŸ¥è¯¢æŸéšæ‚£çš„æ‰€æœ‰å¯è§ç”¨æˆ·
CREATE INDEX "HazardVisibility_hazardId_idx" 
  ON "HazardVisibility"("hazardId");

-- è§’è‰²ç­›é€‰ç´¢å¼•
CREATE INDEX "HazardVisibility_role_idx" 
  ON "HazardVisibility"("role");

-- å¤åˆè§’è‰²ç´¢å¼•ï¼šæŸ¥è¯¢æŸç”¨æˆ·ä»¥æŸè§’è‰²å¯è§çš„éšæ‚£
CREATE INDEX "HazardVisibility_userId_role_idx" 
  ON "HazardVisibility"("userId", "role");
```

### æ•°æ®ä¸€è‡´æ€§ä¿è¯

1. **äº‹åŠ¡æ”¯æŒ**ï¼š`syncHazardVisibility` æ”¯æŒä¼ å…¥äº‹åŠ¡å®¢æˆ·ç«¯
2. **çº§è”åˆ é™¤**ï¼šéšæ‚£åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†å¯è§æ€§è®°å½•
3. **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢é‡å¤æƒé™è®°å½•
4. **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨ `createMany` æé«˜æ’å…¥æ€§èƒ½

### æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

1. **é¿å…N+1æŸ¥è¯¢**ï¼šä½¿ç”¨å•æ¬¡JOINæ›¿ä»£å¤šæ¬¡æŸ¥è¯¢
2. **ç´¢å¼•è¦†ç›–**ï¼š`(userId, hazardId)` ç´¢å¼•åŒ…å«æ‰€æœ‰æŸ¥è¯¢å­—æ®µ
3. **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒæ‰¹é‡åŒæ­¥ï¼Œé¿å…å•æ¡æ“ä½œå¼€é”€
4. **å¼‚æ­¥æ›´æ–°**ï¼šå¯ä»¥åœ¨åå°å¼‚æ­¥åŒæ­¥å¯è§æ€§è®°å½•

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

- **æŸ¥è¯¢å¤æ‚åº¦**ï¼šO(n) â†’ O(log n)
- **æ•°æ®é‡æ”¯æŒ**ï¼šåƒçº§ â†’ ç™¾ä¸‡çº§
- **å“åº”æ—¶é—´**ï¼šé¢„è®¡æå‡ 50-80%ï¼ˆå–å†³äºæ•°æ®é‡ï¼‰

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿éšæ‚£çŠ¶æ€å˜æ›´æ—¶åŠæ—¶åŒæ­¥å¯è§æ€§
2. **åˆå§‹åŒ–æˆæœ¬**ï¼šé¦–æ¬¡å¯ç”¨éœ€è¦å…¨é‡é‡å»ºï¼Œè€—æ—¶è¾ƒé•¿
3. **å­˜å‚¨å¼€é”€**ï¼šå¯è§æ€§è¡¨ä¼šå ç”¨é¢å¤–å­˜å‚¨ç©ºé—´
4. **ç»´æŠ¤æˆæœ¬**ï¼šéœ€è¦å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… æ‰§è¡Œ `npx prisma generate` ç”ŸæˆPrisma Client
2. âœ… æ‰§è¡Œ `npx prisma migrate dev` åº”ç”¨æ•°æ®åº“è¿ç§»
3. â³ åœ¨æ´¾å‘å¼•æ“ä¸­é›†æˆå¯è§æ€§åŒæ­¥
4. â³ æ›´æ–°APIè·¯ç”±ä½¿ç”¨æ–°æŸ¥è¯¢å‡½æ•°
5. â³ æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬ä¸ºç°æœ‰æ•°æ®ç”Ÿæˆå¯è§æ€§è®°å½•
6. â³ è¿›è¡Œæ€§èƒ½æµ‹è¯•éªŒè¯ä¼˜åŒ–æ•ˆæœ

## ğŸ“… æ›´æ–°æ—¥å¿—

- **2026-01-23**ï¼šåˆ›å»ºå¯è§æ€§æœåŠ¡ï¼Œå®ç°æ ¸å¿ƒåŠŸèƒ½
- **2026-01-23**ï¼šæ·»åŠ Prisma Schemaå®šä¹‰
- **å¾…å®š**ï¼šå®Œæˆé›†æˆå’Œæµ‹è¯•

---

**è´Ÿè´£äºº**ï¼šAI Assistant (Claude 4.5)  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2026-01-23
