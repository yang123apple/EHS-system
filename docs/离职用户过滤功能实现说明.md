# 离职用户过滤功能实现说明

## 📋 功能概述

本次修改为 EHS 系统的人员选择功能增加了"过滤离职用户"的能力，确保在新建数据（如隐患、作业票等）时选人时，默认自动过滤掉 `isActive: false` 的离职用户。

## 🎯 修改目标

1. ✅ 后端 API 支持 `activeOnly` 查询参数
2. ✅ 前端组件默认只显示在职人员
3. ✅ 保持向后兼容性，允许在特殊场景下显示所有人员

## 📝 修改文件清单

### 1. 后端 API 修改（3个文件）

#### 1.1 `/api/users/route.ts`
**修改内容：**
- 新增 `activeOnly` 查询参数支持
- 当 `activeOnly=true` 时，在 `whereCondition` 中添加 `isActive: true` 过滤条件

**修改代码：**
```typescript
const activeOnly = searchParams.get('activeOnly') === 'true'; // 🟢 新增

const whereCondition: any = {};
// ... 其他条件

// 🟢 新增：如果 activeOnly 为 true，只返回在职用户
if (activeOnly) {
    whereCondition.isActive = true;
}
```

#### 1.2 `/api/users/by-dept/route.ts`
**修改内容：**
- 新增 `activeOnly` 查询参数支持
- 在 Prisma 查询中添加 `isActive` 过滤条件
- 在返回结果中包含 `isActive` 字段

**修改代码：**
```typescript
const activeOnly = searchParams.get('activeOnly') === 'true'; // 🟢 新增

const whereCondition: any = { departmentId: deptId };

// 🟢 新增：如果 activeOnly 为 true，只返回在职用户
if (activeOnly) {
  whereCondition.isActive = true;
}

const users = await prisma.user.findMany({
  where: whereCondition,
  select: {
      id: true,
      name: true,
      jobTitle: true,
      departmentId: true,
      isActive: true // 🟢 返回在职状态
  }
});
```

#### 1.3 `/api/users/search/route.ts`
**修改内容：**
- 新增 `activeOnly` 查询参数支持
- 使用 `.filter()` 方法过滤掉 `isActive: false` 的用户
- 在返回结果中包含 `isActive` 字段

**修改代码：**
```typescript
const activeOnly = searchParams.get('activeOnly') === 'true'; // 🟢 新增

const users = await PeopleFinder.searchUsers(query, deptId);

// 🟢 新增：如果 activeOnly 为 true，过滤掉离职用户
const filteredUsers = activeOnly 
  ? users.filter(u => u.isActive !== false)
  : users;

return NextResponse.json(filteredUsers.map(u => ({
    id: u.id,
    name: u.name,
    jobTitle: u.jobTitle,
    departmentId: u.departmentId,
    isActive: u.isActive // 🟢 返回在职状态
})));
```

### 2. 前端组件修改（3个文件）

#### 2.1 `PeopleSelector.tsx`

**修改 1：Props 接口**
```typescript
interface Props {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (result: UserLite[] | OrgNode[]) => void;
  mode: SelectorMode;
  multiSelect?: boolean;
  title?: string;
  activeUsersOnly?: boolean; // 🟢 新增：是否只显示在职人员，默认为 true
}
```

**修改 2：组件参数默认值**
```typescript
export default function PeopleSelector({ 
  isOpen, 
  onClose, 
  onConfirm, 
  mode, 
  multiSelect = false, 
  title, 
  activeUsersOnly = true // 🟢 默认为 true
}: Props) {
```

**修改 3：fetchUsers 函数**
```typescript
const fetchUsers = async (deptId: string) => {
  try {
    setIsLoadingUsers(true);
    // 🟢 新增：如果 activeUsersOnly 为 true，追加 activeOnly 查询参数
    const url = activeUsersOnly 
      ? `/api/users/by-dept?deptId=${deptId}&activeOnly=true`
      : `/api/users/by-dept?deptId=${deptId}`;
    const res = await apiFetch(url);
    if (res.ok) setUsers(await res.json());
  } catch (e) {
    console.error(e);
  } finally {
    setIsLoadingUsers(false);
  }
};
```

**修改 4：handleSearch 函数**
```typescript
const handleSearch = async (query: string) => {
  setSearchQuery(query);
  if (query.length < 2) {
      setSearchResults([]);
      return;
  }
  try {
       // 🟢 新增：如果 activeUsersOnly 为 true，追加 activeOnly 查询参数
       const url = activeUsersOnly
         ? `/api/users/search?q=${encodeURIComponent(query)}&activeOnly=true`
         : `/api/users/search?q=${encodeURIComponent(query)}`;
       const res = await apiFetch(url);
       if (res.ok) setSearchResults(await res.json());
  } catch(e) {
      console.error(e);
  }
};
```

## 🚀 使用示例

### 默认行为（只显示在职人员）
```tsx
<PeopleSelector
  isOpen={isOpen}
  onClose={() => setIsOpen(false)}
  onConfirm={handleConfirm}
  mode="user"
  multiSelect={true}
  title="选择处理人"
  // activeUsersOnly 默认为 true，会自动过滤离职用户
/>
```

### 特殊场景（显示所有人员，包括离职）
```tsx
<PeopleSelector
  isOpen={isOpen}
  onClose={() => setIsOpen(false)}
  onConfirm={handleConfirm}
  mode="user"
  multiSelect={true}
  title="查看历史数据"
  activeUsersOnly={false} // 🔴 显式设置为 false，显示所有用户
/>
```

## ✨ 核心特性

### 1. **默认过滤离职用户**
- `PeopleSelector` 组件的 `activeUsersOnly` 默认为 `true`
- 所有新建数据场景无需修改代码即可自动过滤离职用户

### 2. **灵活的配置选项**
- 通过 `activeUsersOnly` prop 可以控制是否过滤
- 适用于管理员查看历史数据等特殊场景

### 3. **完整的过滤覆盖**
- 部门用户列表：通过 `/api/users/by-dept` 过滤
- 全局搜索：通过 `/api/users/search` 过滤
- 保证用户无论通过哪种方式选人，都会被正确过滤

### 4. **向后兼容**
- 所有 API 在不传 `activeOnly` 参数时保持原有行为
- 现有代码无需修改即可继续工作

## 🔍 技术要点

### 1. 后端过滤策略
- **优先使用 Prisma 查询过滤**：在数据库层面过滤，性能最优
- **备选方案使用内存过滤**：对于无法修改查询的场景（如 PeopleFinder），使用 `.filter()` 方法

### 2. 数据一致性
- 所有 API 返回结果都包含 `isActive` 字段
- 便于前端进行二次验证或显示状态标识

### 3. 查询参数规范
- 统一使用 `activeOnly=true` 作为查询参数
- 遵循 RESTful API 设计原则

#### 2.2 `hidden-danger/page.tsx`
**修改内容：**
- 修改 `fetchUsers` 函数，添加 `activeOnly=true` 参数

**修改代码：**
```typescript
const fetchUsers = async () => {
  try {
    // 🟢 新增：添加 activeOnly=true 参数，只获取在职用户
    const res = await apiFetch('/api/users?activeOnly=true');
    const data = await res.json();
    setAllUsers(data);
  } catch (error) {
    console.error('获取用户失败:', error);
  }
};
```

**问题说明：**
隐患管理模块使用 `UserSelectModal` 组件，该组件接收从父组件传递的 `allUsers` 列表。虽然 `PeopleSelector` 已经支持过滤离职用户，但 `UserSelectModal` 直接使用的是预加载的用户列表，因此需要在数据源头进行过滤。

#### 2.3 `work-permit/page.tsx`
**修改内容：**
- 修改 `fetchAllUsers` 函数，直接调用 API 并添加 `activeOnly=true` 参数
- 替换原来的 `UserService.getAll()` 调用

**修改代码：**
```typescript
// 🟢 修改：获取所有人员（仅在职）
const fetchAllUsers = async () => {
  try {
    const res = await apiFetch('/api/users?activeOnly=true');
    const data = await res.json();
    setAllUsers(data);
  } catch (e) {
    console.error("Fetch users failed", e);
  }
};
```

**问题说明：**
作业票模块通过 `UserService.getAll()` 获取所有用户用于流程配置。虽然该模块也使用了 `PeopleSelector` 组件，但在流程编辑器等场景中需要预加载用户列表，因此需要在获取数据时就进行过滤。

## 📊 影响范围

### 受影响的模块
1. ✅ **隐患管理** - 选择处理人/整改人/责任人（已修复）
2. ✅ **作业票管理** - 选择审批人/执行人（已修复）
3. ✅ **事故管理** - 选择相关人员（使用 PeopleSelector，自动生效）
4. ✅ **培训管理** - 选择培训对象（使用 PeopleSelector，自动生效）
5. ✅ **所有使用 `PeopleSelector` 组件的场景**（自动生效）

### 未受影响的功能
- 用户管理界面（管理员需要看到所有用户，包括离职）
- 历史数据查看（可通过 `activeUsersOnly={false}` 显示所有用户）

## 🧪 测试建议

### 1. 功能测试
- [ ] 新建隐患时选择处理人，验证只显示在职人员
- [ ] 新建作业票时选择审批人，验证只显示在职人员
- [ ] 搜索功能验证离职人员不出现在结果中
- [ ] 部门切换验证只显示该部门的在职人员

### 2. 特殊场景测试
- [ ] 管理员查看历史数据时，验证可以看到离职人员参与的记录
- [ ] 验证 `activeUsersOnly={false}` 时能看到所有用户

### 3. 性能测试
- [ ] 大量用户场景下的查询性能
- [ ] 搜索响应时间是否在可接受范围内

## 📌 注意事项

1. **数据库字段依赖**：本功能依赖 User 表的 `isActive` 字段，确保该字段已正确迁移并设置默认值
2. **现有数据处理**：需要确保现有用户的 `isActive` 字段已正确初始化（默认为 `true`）
3. **业务逻辑一致性**：各模块使用人员选择器时应保持一致的过滤策略
4. **UI 提示**：建议在人员选择器中添加"仅显示在职人员"的提示文字

## 🔄 后续优化建议

1. **状态标识**：在用户列表中显示用户的在职状态（如添加状态标签）
2. **统计信息**：显示"共 X 人（在职 Y 人）"等统计信息
3. **快速切换**：在选择器中添加"显示离职人员"的开关按钮
4. **审计日志**：记录选择离职人员的操作，便于后续审计

## 📅 更新日期

2026-01-19

## 👤 实施人员

系统开发团队

---

**修改完成 ✅**
所有相关文件已更新，功能测试通过后即可部署使用。
