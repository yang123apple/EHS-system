# 通知模块初始化步骤

## 当前状态

系统显示"暂无通知模板"，需要完成以下步骤来初始化通知模块。

## 解决方案

### 方法一：使用初始化网页工具（推荐）

1. **执行数据库迁移**（仅需一次）
   
   停止应用，然后运行：
   ```powershell
   # 停止应用（在运行应用的终端按 Ctrl+C）
   
   # 执行迁移
   node node_modules/prisma/build/index.js migrate deploy
   
   # 重启应用
   npm run dev
   ```

2. **使用网页工具创建模板**
   
   应用运行后，访问：
   ```
   http://localhost:3000/init-notification-templates.html
   ```
   
   点击"开始初始化"按钮，等待完成。

3. **验证结果**
   
   访问 `/admin/notifications` 页面，应该能看到 6 个模板。

### 方法二：手动在管理页面创建

如果上述方法有问题，可以手动创建模板：

1. 访问 `/admin/notifications` 页面
2. 点击"新建模板"
3. 按照以下配置创建 6 个模板：

#### 模板 1：培训任务分配
- **名称**: `training_assigned_default`
- **标题**: `新培训任务`
- **内容**: `{{user.name}}分配给您一个新的培训任务：{{training.title}}，请及时完成。`
- **类型**: `training`
- **触发事件**: `training_assigned`
- **状态**: 启用

#### 模板 2：培训任务更新
- **名称**: `training_updated_default`
- **标题**: `培训任务已更新`
- **内容**: `培训任务"{{training.title}}"已更新，请及时查看。`
- **类型**: `training`
- **触发事件**: `training_updated`
- **状态**: 启用

#### 模板 3：待审批作业票
- **名称**: `permit_pending_approval_default`
- **标题**: `待审批作业票`
- **内容**: `【{{permit.templateName}}】{{permit.projectName}} - 等待您审批（第{{permit.stepNumber}}步：{{permit.stepName}}）`
- **类型**: `work_permit`
- **触发事件**: `permit_pending_approval`
- **状态**: 启用

#### 模板 4：作业票审批通过
- **名称**: `permit_approved_default`
- **标题**: `作业票审批通过`
- **内容**: `【已完成】【{{permit.templateName}}】{{permit.projectName}} - {{user.name}}通过了您的申请`
- **类型**: `work_permit`
- **触发事件**: `permit_approved`
- **状态**: 启用

#### 模板 5：作业票被驳回
- **名称**: `permit_rejected_default`
- **标题**: `作业票被驳回`
- **内容**: `【已驳回】【{{permit.templateName}}】{{permit.projectName}} - {{user.name}}驳回了您的申请`
- **类型**: `work_permit`
- **触发事件**: `permit_rejected`
- **状态**: 启用

#### 模板 6：隐患已分配
- **名称**: `hazard_assigned_default`
- **标题**: `隐患已分配`
- **内容**: `{{user.name}}分配给您一个隐患（编号：{{hazard.code}}，位置：{{hazard.location}}），请及时处理。`
- **类型**: `hazard`
- **触发事件**: `hazard_assigned`
- **状态**: 启用

## 验证

创建完成后：

1. 在 `/admin/notifications` 页面的"通知模板"标签查看是否有 6 个模板
2. 切换到"消息记录"标签（初始应该是空的）
3. 创建一个培训任务测试通知功能
4. 提交一个作业票测试审批通知

## 已集成的模块

以下模块已经集成了通知服务：

- ✅ **培训模块** (`training_assigned`, `training_updated`)
- ✅ **作业票模块** (`permit_pending_approval`, `permit_approved`, `permit_rejected`)
- ⏳ **隐患模块** (代码已准备但需要模板)

## 故障排除

### 问题 1: "数据库表不存在"

**解决方案**: 执行数据库迁移
```powershell
node node_modules/prisma/build/index.js migrate deploy
```

### 问题 2: "模板名称已存在"

**解决方案**: 该模板已创建，跳过即可。或在管理页面删除后重新创建。

### 问题 3: 通知没有发送

**可能原因**:
- 模板未创建或已禁用
- 触发事件名称不匹配
- 查看浏览器控制台和服务器日志

**排查步骤**:
1. 检查模板是否存在且已启用
2. 查看服务器日志是否有 "未找到模板" 的提示
3. 确认触发事件名称正确

## 技术细节

### 文件清单
- `src/lib/notificationService.ts` - 通知服务
- `src/app/admin/notifications/page.tsx` - 管理页面
- `src/app/api/admin/notifications/route.ts` - 消息记录 API
- `src/app/api/admin/notification-templates/route.ts` - 模板管理 API
- `public/init-notification-templates.html` - 初始化工具

### 数据库表
- `NotificationTemplate` - 存储通知模板
- `Notification` - 存储用户消息记录
