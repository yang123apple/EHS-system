# 系统日志管理功能说明

## 概述
系统日志管理功能已完成集成，管理员可以在 `系统管理 > Logs` 页面查看所有子系统的操作日志。

## 日志类型

### 1. 登录日志
记录用户的登录和退出操作：
- **登录**: action = `'login'` 或 `'用户登录'`
- **退出**: action = `'logout'` 或 `'用户退出'`
- **目标类型**: `targetType = 'auth'`

### 2. 操作日志
记录各子系统的业务操作：

#### 隐患管理系统 (targetType = 'hazard')
- 上报隐患: `hazard_reported`
- 指派隐患: `hazard_assigned`
- 提交整改: `hazard_rectified`
- 验收通过: `hazard_verified`
- 验收驳回: `hazard_rejected`
- 删除隐患: `hidden_danger.delete`

#### 作业票系统 (targetType = 'permit')
- 创建作业票: `创建作业票`
- 更新作业票: `更新作业票`
- 删除作业票: `删除作业票`

#### 作业票模板系统 (targetType = 'template')
- 创建模板: `创建作业票模板`
- 更新模板: `更新作业票模板`
- 删除模板: `删除作业票模板`

#### 文档管理系统 (targetType = 'document')
- 删除文档历史: `document_history_deleted`
- 其他文档操作: `doc_sys.*`

#### 培训系统 (targetType = 'training')
- 培训相关操作: `training.*`

## 日志数据结构

```typescript
interface SystemLog {
  id: string;
  userId: string | null;      // 操作用户ID
  userName: string | null;    // 操作用户名
  action: string;             // 操作类型
  targetId: string | null;    // 目标对象ID（如隐患ID、作业票ID等）
  targetType: string | null;  // 目标类型（hazard/permit/template/document等）
  details: string | null;     // 操作详情描述
  snapshot: string | null;    // 操作快照（JSON格式）
  ip: string | null;          // 客户端IP地址
  createdAt: DateTime;        // 创建时间
}
```

## 日志记录方式

### 方式1: 使用 SystemLogService（推荐）
```typescript
import { createSystemLog } from '@/services/systemLogService';

await createSystemLog({
  userId: user.id,
  userName: user.name,
  action: '操作名称',
  targetId: '目标ID',
  targetType: 'hazard', // 或 permit/template/document/training
  details: '详细描述',
  ip: clientIP,
});
```

### 方式2: 使用 logger.ts（兼容旧代码）
```typescript
import { createLog } from '@/lib/logger';

await createLog(
  userId,
  userName,
  '操作名称',
  targetId,
  '详细描述',
  'permit' // targetType
);
```

### 方式3: 通过 API（前端调用）
```typescript
await apiFetch('/api/logs', {
  method: 'POST',
  body: {
    userId: user.id,
    userName: user.name,
    action: 'hazard_reported',
    targetType: 'hazard',
    targetId: hazard.id,
    details: '操作描述',
    snapshot: JSON.stringify(snapshotData),
  }
});
```

## 页面功能

### 标签页
1. **登录日志**: 显示所有用户的登录/退出记录
2. **操作日志**: 显示所有业务操作记录
3. **统计分析**: 显示日志统计数据和趋势

### 筛选功能
- 用户ID筛选
- 操作类型筛选
- 目标类型筛选（hazard/permit/template/document等）
- 时间范围筛选

### 显示信息
- **登录日志**: 时间、用户、操作、IP地址、设备信息
- **操作日志**: 时间、用户、操作、目标类型、目标ID、详情

## 已完成的集成

✅ 登录/退出日志记录  
✅ 隐患系统操作日志（通过工作流引擎）  
✅ 作业票系统操作日志  
✅ 作业票模板系统操作日志  
✅ 文档系统操作日志  
✅ 权限系统审计日志（logApiOperation）  
✅ 前端页面显示和筛选功能  

## 注意事项

1. **日志记录不应影响主业务**: 所有日志记录操作都使用 try-catch 包裹，失败不影响主流程
2. **兼容新旧格式**: 系统同时支持英文和中文的 action 命名
3. **targetType 统一**: 所有子系统的日志都应设置正确的 targetType
4. **快照数据**: 复杂操作（如工作流）可以在 snapshot 字段中保存详细的上下文信息

## 后续扩展

如需为新的子系统添加日志记录：
1. 选择合适的 targetType（建议使用英文小写，如 'training', 'exam' 等）
2. 定义清晰的 action 命名规范（建议使用中文或带前缀的英文）
3. 在关键操作点调用日志记录函数
4. 在前端筛选器中添加新的 targetType 选项（可选）
