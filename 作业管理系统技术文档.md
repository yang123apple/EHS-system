# ä½œä¸šç®¡ç†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

## ç›®å½•
1. [è§£ææ¨¡æ¿](#1-è§£ææ¨¡æ¿)
2. [ç­¾ç½²æµç¨‹](#2-ç­¾ç½²æµç¨‹)
3. [ç§»åŠ¨ç«¯å®ç°](#3-ç§»åŠ¨ç«¯å®ç°)
4. [ç¼–è¾‘æ¨¡æ¿](#4-ç¼–è¾‘æ¨¡æ¿)
5. [ä¸€çº§ä¸äºŒçº§è¡¨å•](#5-ä¸€çº§ä¸äºŒçº§è¡¨å•)
   - [5.5 Section å­—æ®µè¯¦ç»†å®ç°](#55-section-å­—æ®µè¯¦ç»†å®ç°)
   - [5.6 Timenow å­—æ®µè¯¦ç»†å®ç°](#56-timenow-å­—æ®µè¯¦ç»†å®ç°)
6. [æ¶æ„é‡æ„](#6-æ¶æ„é‡æ„)

---

## 1. è§£ææ¨¡æ¿

### 1.1 æ¦‚è¿°
æ¨¡æ¿è§£æç³»ç»Ÿè´Ÿè´£ä»Excelæ¨¡æ¿ä¸­è‡ªåŠ¨è¯†åˆ«å’Œæå–å­—æ®µä¿¡æ¯ï¼Œæ”¯æŒå¤šç§å­—æ®µç±»å‹çš„æ™ºèƒ½è¯†åˆ«ï¼Œä¸ºåç»­çš„è¡¨å•å¡«å†™ã€å·¥ä½œæµé…ç½®ç­‰åŠŸèƒ½æä¾›åŸºç¡€æ•°æ®ã€‚

### 1.2 æ ¸å¿ƒå®ç°

#### 1.2.1 è§£æå…¥å£
**æ–‡ä»¶ä½ç½®**: `src/utils/templateParser.ts`

**æ ¸å¿ƒå‡½æ•°**: `parseTemplateFields(structureJson: string): ParsedField[]`

```typescript
export function parseTemplateFields(structureJson: string): ParsedField[] {
  // 1. è§£æJSONç»“æ„ï¼Œæå–äºŒç»´è¡¨æ ¼æ•°æ®
  const structure = JSON.parse(structureJson) as ParsedStructure;
  const data = extractGrid(structure);
  
  // 2. ä¸¤é˜¶æ®µè§£æç­–ç•¥
  // STEP 1: è§£ææœ‰å€¼çš„å•å…ƒæ ¼ï¼ˆæ—¥æœŸã€é€‰é¡¹å­—æ®µï¼‰
  // STEP 2: è§£æç©ºç™½å•å…ƒæ ¼ï¼ˆæ–‡æœ¬ã€ç­¾åç­‰å­—æ®µï¼‰
}
```

#### 1.2.2 æ•°æ®æå–
ç³»ç»Ÿæ”¯æŒå¤šç§Excelæ•°æ®æ ¼å¼ï¼š
- **LuckySheetæ ¼å¼**: `sheets[0].data` æˆ– `sheets[0].celldata`
- **æ ‡å‡†æ ¼å¼**: `grid` æˆ– `data` äºŒç»´æ•°ç»„
- **åˆå¹¶å•å…ƒæ ¼**: è‡ªåŠ¨å¤„ç†åˆå¹¶åŒºåŸŸï¼Œå¡«å……åˆå¹¶å€¼

**å…³é”®å‡½æ•°**:
```typescript
function extractGrid(structure: any): any[][] {
  // ä¼˜å…ˆä½¿ç”¨ sheets[0].data
  if (Array.isArray(structure?.sheets?.[0]?.data)) {
    return structure.sheets[0].data;
  }
  
  // å¤„ç† celldata æ ¼å¼ï¼ˆç¨€ç–çŸ©é˜µï¼‰
  const celldata = structure?.sheets?.[0]?.celldata;
  // æ„å»ºå®Œæ•´äºŒç»´æ•°ç»„ï¼Œå¤„ç†åˆå¹¶å•å…ƒæ ¼
}
```

#### 1.2.3 å­—æ®µç±»å‹è¯†åˆ«

**æ”¯æŒçš„å­—æ®µç±»å‹**:
- `text`: æ–‡æœ¬å­—æ®µï¼ˆé»˜è®¤ï¼‰
- `date`: æ—¥æœŸæ—¶é—´å­—æ®µ
- `department`: éƒ¨é—¨é€‰æ‹©å­—æ®µ
- `personnel`: äººå‘˜å­—æ®µ
- `signature`: ç­¾åå­—æ®µï¼ˆå®¡æ‰¹ç”¨ï¼‰
- `handwritten`: æ‰‹å†™ç­¾åå­—æ®µ
- `option`: é€‰é¡¹å­—æ®µï¼ˆå•é€‰/å¤šé€‰ï¼‰
- `number`: æ•°å­—å­—æ®µ
- `section`: åµŒå¥—è¡¨å•å­—æ®µï¼ˆäºŒçº§è¡¨å•ï¼‰
- `timenow`: è‡ªåŠ¨ç”Ÿæˆæ—¶é—´å­—æ®µ

**è¯†åˆ«è§„åˆ™**:

1. **æ—¥æœŸå­—æ®µè¯†åˆ«**:
   - åŒ¹é…æ¨¡å¼: `å¹´.*æœˆ.*æ—¥`ã€`YYYY-MM-DD`ã€`hh:mm`
   - ä»å·¦ä¾§å•å…ƒæ ¼è¯»å–æ ‡ç­¾ä½œä¸ºå­—æ®µå

2. **é€‰é¡¹å­—æ®µè¯†åˆ«**:
   - æ£€æµ‹é€‰é¡¹æ ‡è®°ç¬¦: `Â£`ã€`â–¡`ã€`â˜‘`ã€`âœ“`ã€`âœ”`
   - æ”¯æŒWingdingså­—ä½“å­—ç¬¦: `R`ã€`P`ã€`O`
   - èšåˆåŒä¸€è¡Œçš„è¿ç»­é€‰é¡¹å•å…ƒæ ¼

3. **ç©ºç™½å•å…ƒæ ¼è¯†åˆ«**:
   - å‘å·¦æŸ¥æ‰¾æ ‡ç­¾ï¼ˆæœ€å¤šè·¨è¶Š5åˆ—ï¼‰
   - å‘ä¸ŠæŸ¥æ‰¾æ ‡ç­¾ï¼ˆæœ€å¤š15è¡Œï¼‰
   - æ ¹æ®æ ‡ç­¾å…³é”®è¯æ¨æ–­å­—æ®µç±»å‹

**å­—æ®µç±»å‹å…³é”®è¯æ˜ å°„**:
```typescript
const FIELD_TYPE_KEYWORDS: Record<string, string[]> = {
  signature: ['ç­¾å', 'ç­¾å­—', 'æ„è§'],
  department: ['éƒ¨é—¨', 'éœ€æ±‚éƒ¨é—¨', 'ç”³è¯·éƒ¨é—¨'],
  personnel: ['äººå‘˜', 'å§“å', 'åå­—', 'æ“ä½œäººå‘˜'],
  date: ['å¹´', 'æœˆ', 'æ—¥', 'æ—¶'],
  number: ['æ•°é‡', 'æ•°å­—', 'ç”µè¯', 'è”ç³»æ–¹å¼', 'èº«ä»½è¯å·'],
  // ...
};
```

#### 1.2.4 å­—æ®µå±æ€§æå–

**ParsedFieldæ¥å£**:
```typescript
interface ParsedField {
  cellKey: string;        // å•å…ƒæ ¼åæ ‡ "R1C1"
  label: string;          // æ ‡ç­¾å†…å®¹
  fieldName: string;      // è§„èŒƒåŒ–å­—æ®µå
  fieldType: FieldType;   // å­—æ®µç±»å‹
  hint: string;           // æç¤ºæ–‡æœ¬
  editableHint?: string;  // ç¼–è¾‘åçš„æç¤º
  options?: string[];     // é€‰é¡¹åˆ—è¡¨
  required?: boolean;      // æ˜¯å¦å¿…å¡«
  boundTemplateId?: string; // sectionç±»å‹ç»‘å®šçš„äºŒçº§æ¨¡æ¿ID
  group?: string;         // å­—æ®µåˆ†ç»„
  isSafetyMeasure?: boolean; // æ˜¯å¦ä¸ºå®‰å…¨æªæ–½é¡¹
  rowIndex?: number;      // åŸå§‹è¡Œç´¢å¼•
  colIndex?: number;      // åŸå§‹åˆ—ç´¢å¼•
}
```

**ç‰¹æ®Šå¤„ç†**:
- **å®‰å…¨æªæ–½è¯†åˆ«**: å‘ä¸ŠæŸ¥æ‰¾15è¡Œï¼Œæ£€æµ‹"å®‰å…¨æªæ–½"æ–‡æœ¬ï¼Œè‡ªåŠ¨æ ‡è®°ä¸ºå®‰å…¨æªæ–½ç»„
- **å­—æ®µåå”¯ä¸€æ€§**: ç›¸åŒå­—æ®µåè‡ªåŠ¨æ·»åŠ è¡Œå·åç¼€ï¼ˆå¦‚ `ç”µè¯_row5`ï¼‰
- **é€‰é¡¹èšåˆ**: åŒä¸€è¡Œçš„å¤šä¸ªé€‰é¡¹å•å…ƒæ ¼åˆå¹¶ä¸ºä¸€ä¸ªå­—æ®µ

#### 1.2.5 APIæ¥å£

**è§£ææ¥å£**: `POST /api/templates/[id]/parse`

```typescript
// è§£ææ¨¡æ¿å­—æ®µ
const parsedFields = parseTemplateFields(template.structureJson);

// ä¿å­˜è§£æç»“æœ
await prisma.workPermitTemplate.update({
  where: { id },
  data: {
    parsedFields: JSON.stringify(parsedFields),
  },
});
```

---

## 2. ç­¾ç½²æµç¨‹

### 2.1 æ¦‚è¿°
ç­¾ç½²æµç¨‹ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„å®¡æ‰¹å·¥ä½œæµï¼Œæ”¯æŒæˆ–ç­¾ã€ä¼šç­¾ã€æ¡ä»¶ç­¾ç­‰å¤šç§å®¡æ‰¹æ¨¡å¼ï¼Œå¹¶æä¾›ç”µå­ç­¾å­—åŠŸèƒ½ã€‚

### 2.2 å·¥ä½œæµå¼•æ“

#### 2.2.1 æ ¸å¿ƒå¼•æ“
**æ–‡ä»¶ä½ç½®**: `src/services/workflowEngine.ts`

**æ ¸å¿ƒç±»**: `WorkflowEngine`

```typescript
export class WorkflowEngine {
  static async transition(
    record: PermitRecord,
    action: WorkflowAction,
    operator: { id: string; name: string },
    comment: string,
    workflowConfig: WorkflowStep[]
  ) {
    // 1. çŠ¶æ€éªŒè¯
    // 2. ç”Ÿæˆæ—¥å¿—æ¡ç›®
    // 3. è®¡ç®—ä¸‹ä¸€çŠ¶æ€
    // 4. è§£æä¸‹ä¸€èŠ‚ç‚¹å®¡æ‰¹äºº
  }
}
```

#### 2.2.2 å®¡æ‰¹æ¨¡å¼

**æ”¯æŒçš„å®¡æ‰¹æ¨¡å¼**:

1. **ORæ¨¡å¼ï¼ˆæˆ–ç­¾ï¼‰**:
   - ä»»æ„ä¸€äººå®¡æ‰¹é€šè¿‡å³å¯è¿›å…¥ä¸‹ä¸€æ­¥
   - å·²æœ‰äººå®¡æ‰¹é€šè¿‡åï¼Œå…¶ä»–äººæ— æ³•é‡å¤å®¡æ‰¹

2. **ANDæ¨¡å¼ï¼ˆä¼šç­¾ï¼‰**:
   - æ‰€æœ‰å®¡æ‰¹äººéƒ½å¿…é¡»å®¡æ‰¹é€šè¿‡
   - æ£€æŸ¥å·²æ‰¹å‡†ç”¨æˆ·é›†åˆï¼Œå…¨éƒ¨é€šè¿‡åè¿›å…¥ä¸‹ä¸€æ­¥

3. **CONDITIONALæ¨¡å¼ï¼ˆæ¡ä»¶ç­¾ï¼‰**:
   - æ ¹æ®è¡¨å•å­—æ®µå€¼åŠ¨æ€å†³å®šå®¡æ‰¹äºº
   - æ”¯æŒæ¡ä»¶åŒ¹é…ï¼šåŒ…å«ã€ç­‰äºã€ä¸ç­‰äºã€å¤§äºã€å°äº

**å®ç°é€»è¾‘**:
```typescript
if (approvalMode === 'AND') {
  // è·å–è¯¥æ­¥éª¤æ‰€æœ‰åº”å®¡æ‰¹äºº
  const requiredApprovers = await resolveApprovers(...);
  
  // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰äººéƒ½å·²æ‰¹å‡†
  const allApproved = requiredApprovers.every(user => 
    approvedUserIds.has(user.id)
  );
  
  if (!allApproved) {
    // ä¼šç­¾æœªå®Œæˆï¼šåœç•™åœ¨å½“å‰æ­¥éª¤
    newStatus = WorkflowStatus.PENDING;
    newStepIndex = record.currentStep;
  } else {
    // ä¼šç­¾å®Œæˆï¼šè¿›å…¥ä¸‹ä¸€æ­¥
    newStepIndex = record.currentStep + 1;
  }
}
```

#### 2.2.3 å®¡æ‰¹äººè§£æ

**æ–‡ä»¶ä½ç½®**: `src/lib/workflowUtils.ts`

**æ ¸å¿ƒå‡½æ•°**: `resolveApprovers()`

**æ”¯æŒçš„å®¡æ‰¹ç­–ç•¥**:

1. **å›ºå®šäººå‘˜** (`fixed`):
   ```typescript
   if (approverStrategy === 'fixed' && approvers?.length) {
     const userIds = approvers.map(a => a.userId);
     return await Promise.all(userIds.map(id => PeopleFinder.findUserById(id)));
   }
   ```

2. **å½“å‰éƒ¨é—¨è´Ÿè´£äºº** (`current_dept_manager`):
   ```typescript
   const dept = await prisma.department.findFirst({
     where: { OR: [{ id: applicantDept }, { name: applicantDept }] }
   });
   const manager = await PeopleFinder.findDeptManager(dept.id);
   ```

3. **æŒ‡å®šéƒ¨é—¨è´Ÿè´£äºº** (`specific_dept_manager`):
   ```typescript
   const manager = await PeopleFinder.findDeptManager(strategyConfig.targetDeptId);
   ```

4. **è§’è‰²åŒ¹é…** (`role`):
   ```typescript
   const users = await prisma.user.findMany({
     where: { role: strategyConfig.roleName }
   });
   ```

5. **æ¨¡æ¿å­—æ®µåŒ¹é…** (`template_field_manager`):
   - ä»è¡¨å•å­—æ®µä¸­è¯»å–éƒ¨é—¨åï¼ŒæŸ¥æ‰¾è¯¥éƒ¨é—¨è´Ÿè´£äºº

6. **æ–‡æœ¬åŒ¹é…** (`template_text_match`):
   - æ ¹æ®æ–‡æœ¬å­—æ®µå†…å®¹ï¼ŒåŒ¹é…åˆ°å¯¹åº”éƒ¨é—¨è´Ÿè´£äºº
   ```typescript
   if (fieldValue.includes(match.containsText)) {
     const manager = await PeopleFinder.findDeptManager(match.targetDeptId);
     return [manager];
   }
   ```

7. **é€‰é¡¹åŒ¹é…** (`template_option_match`):
   - æ ¹æ®é€‰é¡¹å­—æ®µçš„å‹¾é€‰çŠ¶æ€ï¼ŒåŒ¹é…å…·ä½“äººå‘˜æˆ–éƒ¨é—¨è´Ÿè´£äºº
   ```typescript
   if (isChecked) {
     if (match.approverType === 'person') {
       const user = await PeopleFinder.findUserById(match.approverUserId);
     } else if (match.approverType === 'dept_manager') {
       const manager = await PeopleFinder.findDeptManager(match.targetDeptId);
     }
   }
   ```

#### 2.2.4 ç”µå­ç­¾å­—

**æ–‡ä»¶ä½ç½®**: `src/app/api/permits/approve/route.ts`

**ç­¾å­—å†™å…¥é€»è¾‘**:
```typescript
// 1. æŸ¥æ‰¾æ­¥éª¤é…ç½®ä¸­çš„è¾“å‡ºå•å…ƒæ ¼
const currentStepConfig = workflow.find(w => w.step === currentStepIndex);
const { r, c } = currentStepConfig.outputCell;

// 2. å‡†å¤‡ç­¾å­—å†…å®¹
const actionText = action === 'pass' ? 'åŒæ„' : 'é©³å›';
const timeText = new Date().toLocaleString('zh-CN');
const signText = `ã€${actionText}ã€‘ ${userName}  ${timeText}`;

// 3. å†™å…¥Excelæ•°æ®ç»“æ„
const cellPayload = {
  r, c,
  v: {
    v: signText,
    m: signText,
    fc: action === 'reject' ? "#ff0000" : "#000000",
    tb: 1, // è‡ªåŠ¨æ¢è¡Œ
  }
};

// 4. æ›´æ–°celldataæ•°ç»„
targetSheet.celldata.push(cellPayload);
updatedDataJson = JSON.stringify(sheetData);
```

**æ•°æ®ç»“æ„å¤„ç†**:
- æ”¯æŒåŒé‡åºåˆ—åŒ–æ£€æµ‹å’Œä¿®å¤
- å…¼å®¹å¤šç§Excelæ•°æ®æ ¼å¼
- è‡ªåŠ¨åˆå§‹åŒ–ç©ºæ•°æ®ç»“æ„

#### 2.2.5 å®¡æ‰¹æ—¥å¿—

**æ—¥å¿—ç»“æ„**:
```typescript
interface ApprovalLogEntry {
  id: string;
  stepIndex: number;
  stepName: string;
  action: 'pass' | 'reject' | 'read' | 'submit';
  operatorId: string;
  operatorName: string;
  timestamp: string;
  comment: string;
  snapshotVersion: number;
}
```

**æ—¥å¿—è¿½åŠ ç­–ç•¥**:
- ä½¿ç”¨ä¸å¯å˜æ—¥å¿—ï¼ˆImmutable Logï¼‰
- æ¯æ¬¡å®¡æ‰¹è¿½åŠ æ–°æ—¥å¿—ï¼Œä¸è¦†ç›–å†å²è®°å½•
- æ”¯æŒæ—¥å¿—æŸ¥è¯¢å’Œå®¡è®¡

#### 2.2.6 çŠ¶æ€æµè½¬

**çŠ¶æ€å®šä¹‰**:
- `draft`: è‰ç¨¿
- `pending`: å¾…å®¡æ‰¹
- `processing`: å®¡æ‰¹ä¸­
- `approved`: å·²æ‰¹å‡†
- `rejected`: å·²é©³å›

**æµè½¬è§„åˆ™**:
```typescript
if (action === WorkflowAction.SUBMIT) {
  newStatus = WorkflowStatus.PENDING;
  newStepIndex = 0;
} else if (action === WorkflowAction.APPROVE) {
  // æ ¹æ®å®¡æ‰¹æ¨¡å¼å†³å®šæ˜¯å¦è¿›å…¥ä¸‹ä¸€æ­¥
  if (isLastStep) {
    newStatus = WorkflowStatus.APPROVED;
    newStepIndex = -1;
  } else {
    newStatus = WorkflowStatus.PENDING;
    newStepIndex = record.currentStep + 1;
  }
} else if (action === WorkflowAction.REJECT) {
  newStatus = WorkflowStatus.REJECTED;
  newStepIndex = -1;
}
```

#### 2.2.7 é€šçŸ¥ç³»ç»Ÿ

**é€šçŸ¥ç±»å‹**:
1. **å¾…å®¡æ‰¹é€šçŸ¥**: é€šçŸ¥ä¸‹ä¸€æ­¥å®¡æ‰¹äºº
2. **å®¡æ‰¹ç»“æœé€šçŸ¥**: é€šçŸ¥å‘èµ·äººå®¡æ‰¹ç»“æœ
3. **ä¼šç­¾/æˆ–ç­¾è¿›åº¦é€šçŸ¥**: é€šçŸ¥å…¶ä»–å€™é€‰äºº

**é€šçŸ¥åˆ›å»º**:
```typescript
await createPermitNotification(
  'permit_pending_approval',
  approverIds,
  {
    id: recordId,
    templateName: updatedRecord.template.name,
    projectName: updatedRecord.project.name,
    stepName: nextStepConfig.name,
  },
  userName
);
```

---

## 3. ç§»åŠ¨ç«¯å®ç°

### 3.1 æ¦‚è¿°
ç§»åŠ¨ç«¯å®ç°æä¾›äº†å“åº”å¼è¡¨å•æ¸²æŸ“ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡ä¸Šçš„è¡¨å•å¡«å†™å’ŒæŸ¥çœ‹ï¼Œæä¾›ä¼˜åŒ–çš„ç”¨æˆ·ä½“éªŒã€‚

### 3.2 ç§»åŠ¨ç«¯è¡¨å•æ¸²æŸ“å™¨

#### 3.2.1 æ ¸å¿ƒç»„ä»¶
**æ–‡ä»¶ä½ç½®**: `src/components/work-permit/views/MobileFormRenderer.tsx`

**ç»„ä»¶æ¥å£**:
```typescript
interface MobileFormRendererProps {
  config: MobileFormConfigForRenderer | null;  // è¡¨å•é…ç½®
  parsedFields?: ParsedField[];                // è§£æå­—æ®µ
  title?: string;                              // è¡¨å•æ ‡é¢˜
  code?: string;                                // è¡¨å•ç¼–å·
  formData?: Record<string, any>;              // è¡¨å•æ•°æ®
  onDataChange?: (key: string, value: any) => void;
  mode?: 'edit' | 'preview' | 'readonly';      // æ¸²æŸ“æ¨¡å¼
  onSectionClick?: (cellKey: string, fieldName: string) => void;
  onDepartmentClick?: (inputKey: string, label: string) => void;
  departments?: any[];
  allUsers?: any[];
}
```

#### 3.2.2 è¡¨å•é…ç½®

**é…ç½®ç»“æ„**:
```typescript
interface MobileFormConfig {
  enabled: boolean;
  groups: MobileFormGroup[];
  fields?: ParsedField[];
}

interface MobileFormGroup {
  title: string;
  fieldKeys: string[];
}
```

**å­—æ®µåˆ†ç»„**:
- ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®å­—æ®µçš„`group`å±æ€§è¿›è¡Œåˆ†ç»„
- æ”¯æŒæ‰‹åŠ¨é…ç½®åˆ†ç»„å’Œå­—æ®µé¡ºåº
- æ¯ä¸ªåˆ†ç»„æ˜¾ç¤ºç‹¬ç«‹çš„å¡ç‰‡æ ·å¼

#### 3.2.3 å­—æ®µæ¸²æŸ“

**å­—æ®µç±»å‹æ”¯æŒ**:

1. **æ–‡æœ¬å­—æ®µ** (`text`, `number`, `personnel`):
   ```typescript
   <input
     type={fieldType === 'number' ? 'number' : 'text'}
     value={currentValue}
     onChange={(e) => handleFieldChange(field, e.target.value)}
     className="w-full text-right bg-transparent border-b border-dashed"
   />
   ```

2. **æ—¥æœŸå­—æ®µ** (`date`):
   ```typescript
   <input
     type="date"
     value={currentValue}
     onChange={(e) => handleFieldChange(field, e.target.value)}
   />
   ```

3. **é€‰é¡¹å­—æ®µ** (`option`):
   - æ”¯æŒå•é€‰æŒ‰é’®ç»„
   - æ”¯æŒå¼€å…³åˆ‡æ¢ï¼ˆæ˜¯/å¦ç±»å‹ï¼‰
   - æ”¯æŒå¤šé€‰æ ‡ç­¾

4. **éƒ¨é—¨å­—æ®µ** (`department`):
   ```typescript
   <button onClick={() => onDepartmentClick(inputKey, label)}>
     {currentValue || 'ç‚¹å‡»é€‰æ‹©éƒ¨é—¨'}
   </button>
   ```

5. **æ‰‹å†™ç­¾å** (`handwritten`):
   - æ”¯æŒå¤šäººç­¾å
   - æ˜¾ç¤ºç­¾åç¼©ç•¥å›¾
   - ç‚¹å‡»æ·»åŠ æ–°ç­¾å

6. **æ–‡æœ¬åŸŸ** (`textarea`, `signature`):
   ```typescript
   <textarea
     value={currentValue}
     onChange={(e) => handleFieldChange(field, e.target.value)}
     rows={3}
   />
   ```

#### 3.2.4 è¾“å…¥ä¼˜åŒ–

**ç„¦ç‚¹ç®¡ç†**:
```typescript
const handleInputFocus = useCallback((e: React.FocusEvent) => {
  activeInputRef.current = e.target;
  setTimeout(() => {
    if (activeInputRef.current) {
      activeInputRef.current.scrollIntoView({ 
        block: 'center', 
        behavior: 'smooth' 
      });
    }
  }, 300);
}, []);
```

**ä¸­æ–‡è¾“å…¥æ³•å¤„ç†**:
- ä½¿ç”¨`isComposing`çŠ¶æ€é”é˜²æ­¢è¾“å…¥æ³•é—ªçƒ
- é¿å…åœ¨è¾“å…¥è¿‡ç¨‹ä¸­è§¦å‘çŠ¶æ€æ›´æ–°

**æ»šåŠ¨ä¼˜åŒ–**:
- ç›‘å¬ç”¨æˆ·ä¸»åŠ¨æ»šåŠ¨ï¼Œé¿å…è‡ªåŠ¨æ»šåŠ¨å†²çª
- è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°å¯è§†åŒºåŸŸ

#### 3.2.5 å“åº”å¼è®¾è®¡

**å¸ƒå±€ç‰¹ç‚¹**:
- åˆ†ç»„å¡ç‰‡å¼å¸ƒå±€
- å·¦å³åˆ†æ ï¼šæ ‡ç­¾åœ¨å·¦ï¼Œè¾“å…¥åœ¨å³
- å¤§å­—æ®µï¼ˆtextareaã€signatureï¼‰ä½¿ç”¨ä¸Šä¸‹å¸ƒå±€

**æ ·å¼é€‚é…**:
```typescript
// åˆ†ç»„æ ·å¼
<div className={`rounded-xl shadow-sm border ${
  isEven ? 'bg-white' : 'bg-blue-50/30'
}`}>
  <div className={`px-4 py-3 border-b ${
    isEven ? 'bg-slate-50' : 'bg-blue-100/40'
  }`}>
    {/* åˆ†ç»„æ ‡é¢˜ */}
  </div>
</div>
```

#### 3.2.6 ç§»åŠ¨ç«¯è¡¨å•ç¼–è¾‘å™¨

**æ–‡ä»¶ä½ç½®**: `src/components/work-permit/moduls/MobileFormEditor.tsx`

**åŠŸèƒ½**:
- æ‹–æ‹½æ’åºå­—æ®µ
- æ·»åŠ /åˆ é™¤åˆ†ç»„
- å®æ—¶é¢„è§ˆç§»åŠ¨ç«¯æ•ˆæœ
- ä¿å­˜é…ç½®åˆ°æ¨¡æ¿

**ç¼–è¾‘å™¨ç•Œé¢**:
- å·¦ä¾§ï¼šå­—æ®µåˆ—è¡¨ï¼ˆå¯æ‹–æ‹½ï¼‰
- ä¸­é—´ï¼šæ‰‹æœºé¢„è§ˆï¼ˆ375pxå®½åº¦ï¼‰
- å³ä¾§ï¼šåˆ†ç»„é…ç½®

---

## 4. ç¼–è¾‘æ¨¡æ¿

### 4.1 æ¦‚è¿°
æ¨¡æ¿ç¼–è¾‘ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æ¨¡æ¿è®¾è®¡åŠŸèƒ½ï¼Œæ”¯æŒExcelæ ·å¼çš„è¡¨æ ¼ç¼–è¾‘ã€å­—æ®µè§£æé…ç½®ã€å·¥ä½œæµé…ç½®ç­‰ã€‚

### 4.2 æ¨¡æ¿ç¼–è¾‘å™¨

#### 4.2.1 æ ¸å¿ƒç»„ä»¶
**æ–‡ä»¶ä½ç½®**: `src/components/work-permit/moduls/EditTemplateModal.tsx`

**ä¸»è¦åŠŸèƒ½**:
- æ¨¡æ¿åŸºæœ¬ä¿¡æ¯ç¼–è¾‘ï¼ˆåç§°ã€ç±»å‹ï¼‰
- Excelè¡¨æ ¼å¯è§†åŒ–ç¼–è¾‘
- å­—æ®µè§£æç¼–è¾‘
- æ°´å°é…ç½®
- æ¨¡æ¿çº§åˆ«è®¾ç½®ï¼ˆä¸€çº§/äºŒçº§ï¼‰
- Sectionç»‘å®šé…ç½®
- ç§»åŠ¨ç«¯è¡¨å•é…ç½®

#### 4.2.2 Excelæ¸²æŸ“å™¨

**æ–‡ä»¶ä½ç½®**: `src/components/work-permit/ExcelRenderer.tsx`

**æ¸²æŸ“æ¨¡å¼**:

1. **è®¾è®¡æ¨¡å¼** (`mode="design"`):
   - å¯ç¼–è¾‘å•å…ƒæ ¼å†…å®¹
   - è°ƒæ•´åˆ—å®½å’Œè¡Œé«˜
   - è®¾ç½®å•å…ƒæ ¼æ ·å¼ï¼ˆåŠ ç²—ã€å­—å·ï¼‰
   - è§£æç¼–è¾‘æ¨¡å¼

2. **ç¼–è¾‘æ¨¡å¼** (`mode="edit"`):
   - æ ¹æ®å­—æ®µç±»å‹æ˜¾ç¤ºå¯¹åº”è¾“å…¥æ§ä»¶
   - éƒ¨é—¨é€‰æ‹©å¼¹çª—
   - æ—¥æœŸé€‰æ‹©å™¨
   - é€‰é¡¹å•é€‰æ¡†/å¤é€‰æ¡†
   - æ‰‹å†™ç­¾å

3. **æŸ¥çœ‹æ¨¡å¼** (`mode="view"`):
   - åªè¯»æ˜¾ç¤º
   - æ˜¾ç¤ºå®¡æ‰¹æ—¥å¿—
   - æ˜¾ç¤ºç­¾å­—å†…å®¹

#### 4.2.3 å­—æ®µè§£æç¼–è¾‘

**è§£æç¼–è¾‘æ¨¡å¼**:
```typescript
if (parseEditMode) {
  // ç‚¹å‡»å•å…ƒæ ¼é€‰ä¸­
  setSelectedCell({ r: rIndex, c: cIndex });
  
  // æ˜¾ç¤ºè§£æç¼–è¾‘é¢æ¿
  <div className="è§£æç¼–è¾‘é¢æ¿">
    <input placeholder="å­—æ®µå" />
    <select>å­—æ®µç±»å‹</select>
    <input placeholder="æç¤º" />
    <button>ä¿å­˜è§£æ</button>
  </div>
}
```

**å­—æ®µå±æ€§ç¼–è¾‘**:
- å­—æ®µå
- å­—æ®µç±»å‹
- æç¤ºæ–‡æœ¬
- ç¼–è¾‘æç¤ºï¼ˆå¯é€‰ï¼‰
- å¿…å¡«æ ‡è®°

#### 4.2.4 æ°´å°é…ç½®

**æ°´å°è®¾ç½®**:
```typescript
interface WatermarkSettings {
  text: string;           // æ°´å°æ–‡å­—
  enabled: boolean;      // æ˜¯å¦å¯ç”¨
  includeUser?: boolean; // åŒ…å«ç”¨æˆ·åå’ŒID
  includeTime?: boolean;  // åŒ…å«å½“å‰æ—¶é—´
}
```

**åº”ç”¨åœºæ™¯**:
- æ‰“å°æ—¶æ˜¾ç¤ºæ°´å°
- é˜²æ­¢æœªæˆæƒä½¿ç”¨
- å®¡è®¡è¿½è¸ª

#### 4.2.5 æ¨¡æ¿çº§åˆ«

**çº§åˆ«ç±»å‹**:
- `primary`: ä¸€çº§æ¨¡æ¿ï¼ˆä¸»è¡¨å•ï¼‰
- `secondary`: äºŒçº§æ¨¡æ¿ï¼ˆå­è¡¨å•ï¼‰

**çº§åˆ«ç”¨é€”**:
- ä¸€çº§æ¨¡æ¿å¯ä»¥ç»‘å®šäºŒçº§æ¨¡æ¿
- Sectionå­—æ®µå¯ä»¥ç»‘å®šäºŒçº§æ¨¡æ¿
- äºŒçº§æ¨¡æ¿ç”¨äºåµŒå¥—è¡¨å•åœºæ™¯

#### 4.2.6 Sectionç»‘å®š

**ç»‘å®šæµç¨‹**:
1. åœ¨æ¨¡æ¿ä¸­æ ‡è®°Sectionç±»å‹å­—æ®µ
2. ç‚¹å‡»Sectionå•å…ƒæ ¼
3. é€‰æ‹©è¦ç»‘å®šçš„äºŒçº§æ¨¡æ¿
4. ä¿å­˜ç»‘å®šå…³ç³»

**ç»‘å®šå­˜å‚¨**:
```typescript
sectionBindings: Record<string, string>; // cellKey -> templateId
```

#### 4.2.7 çº¸å¼ æ–¹å‘

**æ”¯æŒæ–¹å‘**:
- `portrait`: ç«–å‘ï¼ˆ210mm Ã— 297mmï¼‰
- `landscape`: æ¨ªå‘ï¼ˆ297mm Ã— 210mmï¼‰

**åº”ç”¨**:
- æ¨¡æ¿è®¾è®¡æ—¶è®¾ç½®
- è¡¨å•æ¸²æŸ“æ—¶åº”ç”¨
- æ‰“å°æ—¶ä½¿ç”¨å¯¹åº”å°ºå¯¸

---

## 5. ä¸€çº§ä¸äºŒçº§è¡¨å•

### 5.1 æ¦‚è¿°
ä¸€çº§ä¸äºŒçº§è¡¨å•ç³»ç»Ÿå®ç°äº†åµŒå¥—è¡¨å•åŠŸèƒ½ï¼Œå…è®¸åœ¨ä¸»è¡¨å•ä¸­åµŒå…¥å­è¡¨å•ï¼Œæ”¯æŒæ•°æ®ç»§æ‰¿å’Œç‹¬ç«‹å®¡æ‰¹æµç¨‹ã€‚

### 5.2 è¡¨å•çº§åˆ«

#### 5.2.1 çº§åˆ«å®šä¹‰

**ä¸€çº§è¡¨å•ï¼ˆPrimaryï¼‰**:
- ä¸»è¡¨å•ï¼ŒåŒ…å«å®Œæ•´çš„ä½œä¸šä¿¡æ¯
- å¯ä»¥åŒ…å«Sectionå­—æ®µ
- æ‹¥æœ‰ç‹¬ç«‹çš„å®¡æ‰¹æµç¨‹
- ç”Ÿæˆä¸»è¡¨å•ç¼–å·

**äºŒçº§è¡¨å•ï¼ˆSecondaryï¼‰**:
- å­è¡¨å•ï¼Œä½œä¸ºSectionçš„åµŒå¥—å†…å®¹
- ç»‘å®šåˆ°ä¸€çº§è¡¨å•çš„Sectionå­—æ®µ
- å¯ä»¥ç»§æ‰¿ä¸€çº§è¡¨å•çš„æ•°æ®
- ç”Ÿæˆå­è¡¨å•ç¼–å·ï¼ˆæ ¼å¼ï¼š`ä¸»ç¼–å·-å­—æ®µç®€å†™`ï¼‰

#### 5.2.2 Sectionå­—æ®µ

**å­—æ®µç±»å‹**: `section`

**è¯†åˆ«æ–¹å¼**:
- æ¨¡æ¿è§£ææ—¶è¯†åˆ«ä¸ºsectionç±»å‹
- åœ¨æ¨¡æ¿ç¼–è¾‘å™¨ä¸­æ ‡è®°ä¸ºSectionå­—æ®µ
- ç»‘å®šåˆ°äºŒçº§æ¨¡æ¿

**æ¸²æŸ“è¡¨ç°**:
- è®¾è®¡æ¨¡å¼ï¼šæ˜¾ç¤ºç»‘å®šæŒ‰é’®
- ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤º"å¡«å†™å­è¡¨å•"æŒ‰é’®
- æŸ¥çœ‹æ¨¡å¼ï¼šæ˜¾ç¤º"æŸ¥çœ‹å­è¡¨å•"æŒ‰é’®

### 5.3 äºŒçº§è¡¨å•æ¨¡æ€æ¡†

#### 5.3.1 ç»„ä»¶ç»“æ„
**æ–‡ä»¶ä½ç½®**: `src/components/work-permit/moduls/SectionFormModal.tsx`

**ç»„ä»¶æ¥å£**:
```typescript
interface Props {
  isOpen: boolean;
  onClose: () => void;
  cellKey: string;                    // Sectionå•å…ƒæ ¼åæ ‡
  fieldName: string;                  // å­—æ®µå
  boundTemplate: Template | null;     // ç»‘å®šçš„äºŒçº§æ¨¡æ¿
  parentCode: string;                 // çˆ¶è¡¨å•ç¼–å·
  parentFormData?: Record<string, any>; // çˆ¶è¡¨å•æ•°æ®
  parentParsedFields?: ParsedField[];    // çˆ¶è¡¨å•è§£æå­—æ®µ
  parentApprovalLogs?: any[];           // çˆ¶è¡¨å•å®¡æ‰¹æ—¥å¿—
  parentWorkflowConfig?: any[];         // çˆ¶è¡¨å•æµç¨‹é…ç½®
  existingData?: SectionData;           // å·²æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
  onSave: (data: SectionData) => void;
  readOnly?: boolean;
}
```

#### 5.3.2 æ•°æ®ç»§æ‰¿

**Partå­—æ®µç»§æ‰¿æœºåˆ¶**:

1. **é…ç½®å®šä¹‰**:
   ```typescript
   // åœ¨äºŒçº§æ¨¡æ¿çš„workflowConfigä¸­å®šä¹‰Parté…ç½®
   {
     name: "Partåç§°",
     pickStrategy: "field_match",
     pickConfig: {
       fieldName: "çˆ¶è¡¨å•å­—æ®µå"
     },
     outputCell: "R5C3"  // è¾“å‡ºåˆ°å­è¡¨å•çš„å•å…ƒæ ¼
   }
   ```

2. **ç»§æ‰¿é€»è¾‘**:
   ```typescript
   // ä»çˆ¶è¡¨å•æ•°æ®ä¸­æå–
   const matchedField = parentParsedFields.find(
     f => f.label === targetFieldName || f.fieldName === targetFieldName
   );
   
   if (matchedField) {
     const cellKey = matchedField.cellKey; // "R30C4"
     const [r, c] = cellKey.substring(1).split('C').map(n => parseInt(n) - 1);
     const inputKey = `${r}-${c}`;
     const value = parentFormData[inputKey];
     
     // å†™å…¥å­è¡¨å•
     const [outR, outC] = part.outputCell.substring(1).split('C').map(n => parseInt(n) - 1);
     const outputKey = `${outR}-${outC}`;
     inherited[outputKey] = value;
   }
   ```

3. **å®¡æ‰¹æ—¥å¿—ç»§æ‰¿**:
   - å¦‚æœçˆ¶è¡¨å•å­—æ®µå€¼ä¸ºç©ºï¼Œå°è¯•ä»å®¡æ‰¹æ—¥å¿—ä¸­æå–
   - åŒ¹é…workflowæ­¥éª¤å’Œå•å…ƒæ ¼
   - æ‹¼æ¥å®¡æ ¸ä¿¡æ¯ï¼šæ„è§ + äººå + æ—¥æœŸ

#### 5.3.3 ç¼–å·ç”Ÿæˆ

**ä¸»è¡¨å•ç¼–å·**:
- æ ¼å¼ï¼š`ç±»å‹-æ—¥æœŸ-åºå·`
- ç¤ºä¾‹ï¼š`DH-20250101-001`

**å­è¡¨å•ç¼–å·**:
```typescript
const sectionCode = useMemo(() => {
  if (existingData?.code) return existingData.code;
  const suffix = fieldName.substring(0, 3).toUpperCase();
  return `${parentCode}-${suffix}`;
}, [parentCode, fieldName, existingData]);
```

**ç¤ºä¾‹**: `DH-20250101-001-æ–½å·¥`

#### 5.3.4 æ•°æ®å­˜å‚¨

**Sectionæ•°æ®ç»“æ„**:
```typescript
interface SectionData {
  templateId: string;      // äºŒçº§æ¨¡æ¿ID
  templateName: string;    // äºŒçº§æ¨¡æ¿åç§°
  code: string;            // å­è¡¨å•ç¼–å·
  data: Record<string, any>; // è¡¨å•æ•°æ®
}
```

**å­˜å‚¨æ–¹å¼**:
- å­˜å‚¨åœ¨çˆ¶è¡¨å•çš„`dataJson`ä¸­
- ä½¿ç”¨ç‰¹æ®Šé”®ï¼š`SECTION_${cellKey}`
- æ ¼å¼ï¼š`{ "SECTION_R5C3": { templateId, templateName, code, data } }`

#### 5.3.5 è¡¨å•äº¤äº’

**æ‰“å¼€å­è¡¨å•**:
```typescript
// ç‚¹å‡»Sectionå•å…ƒæ ¼
onSectionClick(cellKey, fieldName);

// æ‰“å¼€SectionFormModal
<SectionFormModal
  cellKey={cellKey}
  fieldName={fieldName}
  boundTemplate={boundTemplate}
  parentCode={parentCode}
  parentFormData={parentFormData}
  existingData={sectionData}
  onSave={handleSectionSave}
/>
```

**ä¿å­˜å­è¡¨å•**:
```typescript
const handleSectionSave = (sectionData: SectionData) => {
  const cellKey = sectionData.cellKey;
  const newFormData = {
    ...formData,
    [`SECTION_${cellKey}`]: sectionData
  };
  setFormData(newFormData);
};
```

#### 5.3.6 æ•°æ®éªŒè¯

**å¿…å¡«å­—æ®µéªŒè¯**:
```typescript
const requiredFields = parsedFields.filter(f => f.required);
const missingFields: string[] = [];

for (const field of requiredFields) {
  const value = formData[`${r}-${c}`];
  if (!value || String(value).trim() === '') {
    missingFields.push(field.label || field.fieldName);
  }
}

if (missingFields.length > 0) {
  alert(`è¯·å¡«å†™ä»¥ä¸‹å¿…å¡«é¡¹ï¼š\n${missingFields.join('\n')}`);
  return;
}
```

### 5.4 ä½¿ç”¨åœºæ™¯

**å…¸å‹åº”ç”¨**:
1. **ä½œä¸šç¥¨ä¸»è¡¨å• + æ–½å·¥æ˜ç»†å­è¡¨å•**
   - ä¸»è¡¨å•ï¼šä½œä¸šåŸºæœ¬ä¿¡æ¯
   - å­è¡¨å•ï¼šæ–½å·¥æ­¥éª¤ã€å®‰å…¨æªæ–½æ¸…å•

2. **å®¡æ‰¹æµç¨‹ + ç°åœºç¡®è®¤**
   - ä¸»è¡¨å•ï¼šå®¡æ‰¹æµç¨‹
   - å­è¡¨å•ï¼šç°åœºç¡®è®¤è®°å½•

3. **æ•°æ®ç»§æ‰¿åœºæ™¯**
   - å­è¡¨å•è‡ªåŠ¨ç»§æ‰¿ä¸»è¡¨å•çš„éƒ¨é—¨ã€äººå‘˜ç­‰ä¿¡æ¯
   - å‡å°‘é‡å¤å¡«å†™

### 5.5 Section å­—æ®µè¯¦ç»†å®ç°

#### 5.5.1 Section å­—æ®µè¯†åˆ«

**æ¨¡æ¿è§£æé˜¶æ®µ**ï¼š

åœ¨ `src/utils/templateParser.ts` ä¸­ï¼ŒSection å­—æ®µé€šè¿‡ä»¥ä¸‹æ–¹å¼è¯†åˆ«ï¼š

1. **å…³é”®è¯åŒ¹é…**ï¼š
   ```typescript
   const SECTION_KEYWORDS = ['å­è¡¨å•', 'åµŒå¥—è¡¨å•', 'äºŒçº§è¡¨å•', 'section'];
   
   // åœ¨è§£æç©ºç™½å•å…ƒæ ¼æ—¶
   if (SECTION_KEYWORDS.some(keyword => label.includes(keyword))) {
     fieldType = 'section';
   }
   ```

2. **æ‰‹åŠ¨æ ‡è®°**ï¼š
   - åœ¨æ¨¡æ¿ç¼–è¾‘å™¨çš„è§£æç¼–è¾‘æ¨¡å¼ä¸‹
   - ç‚¹å‡»å•å…ƒæ ¼ï¼Œé€‰æ‹©å­—æ®µç±»å‹ä¸º `section`
   - ç³»ç»Ÿä¼šå°†è¯¥å­—æ®µæ ‡è®°ä¸º Section ç±»å‹

3. **ç»‘å®šäºŒçº§æ¨¡æ¿**ï¼š
   ```typescript
   // åœ¨æ¨¡æ¿ç¼–è¾‘å™¨ä¸­ï¼Œä¸º Section å­—æ®µç»‘å®šäºŒçº§æ¨¡æ¿
   const sectionBindings = {
     "R5C3": "template-id-xxx",  // cellKey -> templateId
     "R10C3": "template-id-yyy"
   };
   
   // ä¿å­˜åˆ°æ¨¡æ¿çš„ sectionBindings å­—æ®µï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
   await prisma.workPermitTemplate.update({
     where: { id: templateId },
     data: {
       sectionBindings: JSON.stringify(sectionBindings),
     }
   });
   ```

#### 5.5.2 Section å­—æ®µæ¸²æŸ“

**æ–‡ä»¶ä½ç½®**: `src/components/work-permit/ExcelRenderer.tsx`

**æ¸²æŸ“é€»è¾‘**ï¼š

```typescript
// 1. æ£€æµ‹ Section å­—æ®µ
const parsedField = parsedFields.find(f => 
  f.cellKey === `R${r + 1}C${c + 1}`
);

if (parsedField?.fieldType === 'section') {
  // 2. è·å–ç»‘å®šçš„äºŒçº§æ¨¡æ¿
  const sectionBindings = template.sectionBindings 
    ? JSON.parse(template.sectionBindings) 
    : {};
  const boundTemplateId = sectionBindings[parsedField.cellKey];
  const boundTemplate = allTemplates.find(t => t.id === boundTemplateId);
  
  // 3. æ ¹æ®æ¨¡å¼æ¸²æŸ“
  if (mode === 'design') {
    // è®¾è®¡æ¨¡å¼ï¼šæ˜¾ç¤ºç»‘å®šæŒ‰é’®
    return (
      <button onClick={() => handleSectionBind(parsedField.cellKey)}>
        {boundTemplate ? `å·²ç»‘å®š: ${boundTemplate.name}` : 'ç»‘å®šäºŒçº§æ¨¡æ¿'}
      </button>
    );
  } else if (mode === 'edit') {
    // ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤º"å¡«å†™å­è¡¨å•"æŒ‰é’®
    const sectionData = formData[`SECTION_${parsedField.cellKey}`];
    return (
      <button onClick={() => onSectionClick(parsedField.cellKey, parsedField.fieldName)}>
        {sectionData ? 'ç¼–è¾‘å­è¡¨å•' : 'å¡«å†™å­è¡¨å•'}
      </button>
    );
  } else {
    // æŸ¥çœ‹æ¨¡å¼ï¼šæ˜¾ç¤º"æŸ¥çœ‹å­è¡¨å•"æŒ‰é’®
    return (
      <button onClick={() => onSectionClick(parsedField.cellKey, parsedField.fieldName)}>
        æŸ¥çœ‹å­è¡¨å•
      </button>
    );
  }
}
```

#### 5.5.3 Section æ•°æ®å­˜å‚¨æœºåˆ¶

**å­˜å‚¨ä½ç½®**ï¼š

1. **æ—§ç‰ˆå­˜å‚¨æ–¹å¼**ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰ï¼š
   ```typescript
   // å­˜å‚¨åœ¨çˆ¶è¡¨å•çš„ dataJson ä¸­
   {
     "R5C3": "å·²å¡«å†™",  // ç®€å•æ ‡è®°
     "SECTION_R5C3": {   // å®Œæ•´æ•°æ®
       templateId: "xxx",
       templateName: "æ¯æ—¥æ–½å·¥å•",
       code: "DH-001-æ–½å·¥",
       data: {
         "R1C1": "æ–½å·¥å†…å®¹1",
         "R2C1": "æ–½å·¥å†…å®¹2",
         // ...
       }
     }
   }
   ```

2. **æ–°ç‰ˆå­˜å‚¨æ–¹å¼**ï¼ˆæ¶æ„é‡æ„åï¼‰ï¼š
   ```typescript
   // çˆ¶è¡¨å• JSON ä¸­åªä¿ç•™å¼•ç”¨
   {
     "R5C3": {
       "_subPermitId": "sub-permit-id",
       "_display": "[å­è¡¨å•:sub-permit-id]"
     }
   }
   
   // å­è¡¨å•æ•°æ®å­˜å‚¨åœ¨ SubPermit è¡¨ä¸­
   {
     id: "sub-permit-id",
     parentPermitId: "parent-id",
     templateId: "xxx",
     cellKey: "R5C3",
     dataJson: "{ ... }",  // å®Œæ•´çš„å­è¡¨å•æ•°æ®
   }
   ```

#### 5.5.4 Section æ•°æ®ç»§æ‰¿æœºåˆ¶

**Part å­—æ®µç»§æ‰¿é…ç½®**ï¼š

åœ¨äºŒçº§æ¨¡æ¿çš„ `workflowConfig` ä¸­å®šä¹‰ Part é…ç½®ï¼š

```typescript
// äºŒçº§æ¨¡æ¿çš„ workflowConfig
[
  {
    name: "Part1: ç»§æ‰¿éƒ¨é—¨",
    pickStrategy: "field_match",
    pickConfig: {
      fieldName: "ç”³è¯·éƒ¨é—¨"  // ä»çˆ¶è¡¨å•çš„å­—æ®µå
    },
    outputCell: "R5C3"  // è¾“å‡ºåˆ°å­è¡¨å•çš„å•å…ƒæ ¼
  },
  {
    name: "Part2: ç»§æ‰¿å®¡æ‰¹æ„è§",
    pickStrategy: "approval_log",
    pickConfig: {
      stepIndex: 0,  // çˆ¶è¡¨å•çš„å®¡æ‰¹æ­¥éª¤
      outputCell: "R6C3"
    }
  }
]
```

**ç»§æ‰¿é€»è¾‘å®ç°**ï¼š

```typescript
// src/components/work-permit/moduls/SectionFormModal.tsx

const inheritedData = useMemo(() => {
  const inherited: Record<string, any> = {};
  
  // éå†äºŒçº§æ¨¡æ¿çš„ workflowPartsï¼ˆPart é…ç½®ï¼‰
  workflowParts.forEach((part: any) => {
    if (part.pickStrategy === 'field_match') {
      // ç­–ç•¥1ï¼šå­—æ®µåŒ¹é…
      const targetFieldName = part.pickConfig?.fieldName;
      const matchedField = parentParsedFields.find(
        f => f.label === targetFieldName || f.fieldName === targetFieldName
      );
      
      if (matchedField) {
        const cellKey = matchedField.cellKey; // "R30C4"
        const [r, c] = cellKey.substring(1).split('C').map(n => parseInt(n) - 1);
        const inputKey = `${r}-${c}`;
        const value = parentFormData[inputKey];
        
        // å†™å…¥å­è¡¨å•
        const [outR, outC] = part.outputCell.substring(1).split('C').map(n => parseInt(n) - 1);
        const outputKey = `${outR}-${outC}`;
        inherited[outputKey] = value;
      }
    } else if (part.pickStrategy === 'approval_log') {
      // ç­–ç•¥2ï¼šä»å®¡æ‰¹æ—¥å¿—ä¸­æå–
      const stepIndex = part.pickConfig?.stepIndex;
      const log = parentApprovalLogs.find(
        (l: any) => l.stepIndex === stepIndex || l.step === stepIndex
      );
      
      if (log) {
        // åŒ¹é… workflow æ­¥éª¤å’Œå•å…ƒæ ¼
        const stepConfig = parentWorkflowConfig.find(
          (w: any) => w.stepIndex === stepIndex || w.step === stepIndex
        );
        
        if (stepConfig?.outputCell) {
          const [outR, outC] = part.outputCell.substring(1).split('C').map(n => parseInt(n) - 1);
          const outputKey = `${outR}-${outC}`;
          // æ‹¼æ¥å®¡æ ¸ä¿¡æ¯ï¼šæ„è§ + äººå + æ—¥æœŸ
          inherited[outputKey] = `${log.opinion || ''} ${log.approver} ${log.time}`;
        }
      }
    }
  });
  
  return inherited;
}, [parentFormData, parentParsedFields, parentApprovalLogs, parentWorkflowConfig, workflowParts]);
```

#### 5.5.5 Section è¡¨å•äº¤äº’æµç¨‹

**å®Œæ•´äº¤äº’æµç¨‹**ï¼š

1. **ç‚¹å‡» Section å•å…ƒæ ¼**ï¼š
   ```typescript
   // ExcelRenderer.tsx
   const handleSectionClick = (cellKey: string, fieldName: string) => {
     setCurrentSectionCell({ cellKey, fieldName });
     setSectionModalOpen(true);
   };
   ```

2. **æ‰“å¼€ SectionFormModal**ï¼š
   ```typescript
   // è·å–ç»‘å®šçš„äºŒçº§æ¨¡æ¿
   const bindings = template.sectionBindings 
     ? JSON.parse(template.sectionBindings) 
     : {};
   const boundTemplateId = bindings[cellKey];
   const boundTemplate = allTemplates.find(t => t.id === boundTemplateId);
   
   // è·å–å·²æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
   const existingData = formData[`SECTION_${cellKey}`];
   
   // æ‰“å¼€æ¨¡æ€æ¡†
   <SectionFormModal
     isOpen={sectionModalOpen}
     cellKey={currentSectionCell.cellKey}
     fieldName={currentSectionCell.fieldName}
     boundTemplate={boundTemplate}
     parentCode={permitCode}
     parentFormData={formData}
     parentParsedFields={parsedFields}
     existingData={existingData}
     onSave={handleSectionSave}
   />
   ```

3. **å¡«å†™/ç¼–è¾‘å­è¡¨å•**ï¼š
   - å­è¡¨å•ä½¿ç”¨ç‹¬ç«‹çš„ ExcelRenderer æ¸²æŸ“
   - æ”¯æŒæ•°æ®ç»§æ‰¿ï¼ˆè‡ªåŠ¨å¡«å……ç»§æ‰¿å­—æ®µï¼‰
   - æ”¯æŒç‹¬ç«‹çš„å®¡æ‰¹æµç¨‹ï¼ˆå¦‚æœé…ç½®ï¼‰

4. **ä¿å­˜å­è¡¨å•**ï¼š
   ```typescript
   const handleSectionSave = (sectionData: SectionData) => {
     const cellKey = sectionData.cellKey;
     const newFormData = {
       ...formData,
       [`SECTION_${cellKey}`]: sectionData
     };
     setFormData(newFormData);
   };
   ```

#### 5.5.6 Section ç¼–å·ç”Ÿæˆè§„åˆ™

**å­è¡¨å•ç¼–å·æ ¼å¼**ï¼š

```typescript
// æ ¼å¼ï¼šçˆ¶ç¼–å·-å­—æ®µåç®€å†™
const sectionCode = useMemo(() => {
  if (existingData?.code) return existingData.code;
  
  // ç®€åŒ–å­—æ®µåä½œä¸ºåç¼€ï¼ˆå–å‰3ä¸ªå­—ç¬¦å¹¶è½¬å¤§å†™ï¼‰
  const suffix = fieldName.substring(0, 3).toUpperCase();
  return `${parentCode}-${suffix}`;
}, [parentCode, fieldName, existingData]);
```

**ç¤ºä¾‹**ï¼š
- çˆ¶è¡¨å•ç¼–å·ï¼š`DH-20250101-001`
- å­—æ®µåï¼š`æ¯æ—¥æ–½å·¥å•`
- å­è¡¨å•ç¼–å·ï¼š`DH-20250101-001-æ¯æ—¥`

### 5.6 Timenow å­—æ®µè¯¦ç»†å®ç°

#### 5.6.1 Timenow å­—æ®µè¯†åˆ«

**æ¨¡æ¿è§£æé˜¶æ®µ**ï¼š

åœ¨ `src/utils/templateParser.ts` ä¸­ï¼ŒTimenow å­—æ®µé€šè¿‡ä»¥ä¸‹æ–¹å¼è¯†åˆ«ï¼š

1. **å…³é”®è¯åŒ¹é…**ï¼š
   ```typescript
   const TIMENOW_KEYWORDS = ['æ—¶é—´', 'å½“å‰æ—¶é—´', 'ç³»ç»Ÿæ—¶é—´', 'è‡ªåŠ¨æ—¶é—´'];
   
   // åœ¨è§£æç©ºç™½å•å…ƒæ ¼æ—¶
   if (TIMENOW_KEYWORDS.some(keyword => label.includes(keyword))) {
     fieldType = 'timenow';
   }
   ```

2. **æ‰‹åŠ¨æ ‡è®°**ï¼š
   - åœ¨æ¨¡æ¿ç¼–è¾‘å™¨çš„è§£æç¼–è¾‘æ¨¡å¼ä¸‹
   - ç‚¹å‡»å•å…ƒæ ¼ï¼Œé€‰æ‹©å­—æ®µç±»å‹ä¸º `timenow`
   - ç³»ç»Ÿä¼šå°†è¯¥å­—æ®µæ ‡è®°ä¸º Timenow ç±»å‹

**å­—æ®µç±»å‹å®šä¹‰**ï¼š

```typescript
// src/types/work-permit.ts
export interface ParsedField {
  cellKey: string;
  label: string;
  fieldName: string;
  fieldType: 'text' | 'date' | 'timenow' | ...;  // timenow ç±»å‹
  hint: string;
  // ...
}
```

#### 5.6.2 Timenow å­—æ®µæ¸²æŸ“

**æ–‡ä»¶ä½ç½®**: `src/components/work-permit/ExcelRenderer.tsx`

**æ¸²æŸ“é€»è¾‘**ï¼š

```typescript
// æ£€æµ‹ Timenow å­—æ®µ
const parsedField = parsedFields.find(f => 
  f.cellKey === `R${r + 1}C${c + 1}`
);

if (parsedField?.fieldType === 'timenow') {
  // Timenow å­—æ®µï¼šæ˜¾ç¤ºå ä½ç¬¦ï¼Œè‡ªåŠ¨ç”Ÿæˆæ—¶é—´ï¼Œæ— éœ€å¡«å†™
  const currentValue = formData[`R${r + 1}C${c + 1}`];
  
  return (
    <div className="timenow-field">
      {currentValue || 'ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæ—¶é—´'}
    </div>
  );
}
```

**ç§»åŠ¨ç«¯æ¸²æŸ“**ï¼š

```typescript
// src/components/work-permit/views/MobileFormRenderer.tsx

case 'timenow':
  // timenow å­—æ®µï¼šæ˜¾ç¤ºå ä½ç¬¦ï¼Œè‡ªåŠ¨ç”Ÿæˆæ—¶é—´ï¼Œæ— éœ€å¡«å†™
  return (
    <div className="field-value">
      {currentValue || (
        <span className="text-gray-400 italic">
          ç³»ç»Ÿå°†åœ¨æäº¤æ—¶è‡ªåŠ¨å¡«å……å½“å‰æ—¶é—´
        </span>
      )}
    </div>
  );
```

#### 5.6.3 Timenow è‡ªåŠ¨å¡«å……æœºåˆ¶

**åç«¯è‡ªåŠ¨å¡«å……**ï¼š

**æ–‡ä»¶ä½ç½®**: `src/app/api/permits/route.ts`

**åˆ›å»ºä½œä¸šç¥¨æ—¶**ï¼š

```typescript
// POST /api/permits
export const POST = async (req: Request) => {
  // 1. è·å–æ¨¡æ¿çš„ parsedFields
  const template = await prisma.workPermitTemplate.findUnique({
    where: { id: templateId },
    select: { parsedFields: true }
  });
  
  // 2. å¤„ç† timenow å­—æ®µï¼šè‡ªåŠ¨å¡«å……å½“å‰æ—¶é—´
  let processedDataJson = typeof dataJson === 'string' 
    ? JSON.parse(dataJson) 
    : { ...dataJson };
  
  if (template?.parsedFields) {
    const parsedFields = JSON.parse(template.parsedFields);
    const now = new Date();
    
    // æ ¼å¼åŒ–æ—¶é—´å­—ç¬¦ä¸²ï¼ˆä¸­æ–‡æ ¼å¼ï¼‰
    const timeString = now.toLocaleString('zh-CN', { 
      year: 'numeric', 
      month: '2-digit', 
      day: '2-digit', 
      hour: '2-digit', 
      minute: '2-digit', 
      second: '2-digit',
      hour12: false  // 24å°æ—¶åˆ¶
    });
    // è¾“å‡ºæ ¼å¼ï¼š2025/01/29 14:30:25
    
    // 3. éå†æ‰€æœ‰å­—æ®µï¼Œæ‰¾åˆ° timenow ç±»å‹
    parsedFields.forEach((field: any) => {
      if (field.fieldType === 'timenow' && field.cellKey) {
        // å¦‚æœè¯¥å­—æ®µè¿˜æ²¡æœ‰å€¼ï¼Œåˆ™è‡ªåŠ¨å¡«å……å½“å‰æ—¶é—´
        if (!processedDataJson[field.cellKey] || processedDataJson[field.cellKey] === '') {
          processedDataJson[field.cellKey] = timeString;
        }
      }
    });
  }
  
  // 4. ä¿å­˜å¤„ç†åçš„æ•°æ®
  await prisma.workPermitRecord.create({
    data: {
      dataJson: JSON.stringify(processedDataJson),
      // ...
    }
  });
};
```

**æ›´æ–°ä½œä¸šç¥¨æ—¶**ï¼š

```typescript
// PATCH /api/permits
export const PATCH = async (req: Request) => {
  // åŒæ ·çš„é€»è¾‘ï¼Œåœ¨æ›´æ–°æ—¶ä¹Ÿä¼šè‡ªåŠ¨å¡«å…… timenow å­—æ®µ
  if (dataJson !== undefined) {
    let processedDataJson = typeof dataJson === 'string' 
      ? JSON.parse(dataJson) 
      : { ...dataJson };
    
    // è·å–æ¨¡æ¿çš„ parsedFields
    const record = await prisma.workPermitRecord.findUnique({
      where: { id },
      select: { templateId: true, template: { select: { parsedFields: true } } }
    });
    
    if (record?.template?.parsedFields) {
      const parsedFields = JSON.parse(record.template.parsedFields);
      const now = new Date();
      const timeString = now.toLocaleString('zh-CN', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false
      });
      
      parsedFields.forEach((field: any) => {
        if (field.fieldType === 'timenow' && field.cellKey) {
          // å¦‚æœè¯¥å­—æ®µè¿˜æ²¡æœ‰å€¼ï¼Œåˆ™è‡ªåŠ¨å¡«å……å½“å‰æ—¶é—´
          if (!processedDataJson[field.cellKey] || processedDataJson[field.cellKey] === '') {
            processedDataJson[field.cellKey] = timeString;
          }
        }
      });
    }
    
    updateData.dataJson = JSON.stringify(processedDataJson);
  }
};
```

#### 5.6.4 Timenow æ—¶é—´æ ¼å¼

**é»˜è®¤æ ¼å¼**ï¼š

```typescript
// ä¸­æ–‡æ ¼å¼ï¼š2025/01/29 14:30:25
const timeString = new Date().toLocaleString('zh-CN', { 
  year: 'numeric',      // 2025
  month: '2-digit',     // 01
  day: '2-digit',       // 29
  hour: '2-digit',      // 14
  minute: '2-digit',    // 30
  second: '2-digit',    // 25
  hour12: false         // 24å°æ—¶åˆ¶
});
```

**æ ¼å¼è¯´æ˜**ï¼š
- **æ—¥æœŸéƒ¨åˆ†**ï¼š`YYYY/MM/DD`ï¼ˆå¹´/æœˆ/æ—¥ï¼‰
- **æ—¶é—´éƒ¨åˆ†**ï¼š`HH:mm:ss`ï¼ˆæ—¶:åˆ†:ç§’ï¼‰
- **åˆ†éš”ç¬¦**ï¼šæ—¥æœŸå’Œæ—¶é—´ä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”
- **æ—¶åˆ¶**ï¼š24å°æ—¶åˆ¶

**ç¤ºä¾‹è¾“å‡º**ï¼š
- `2025/01/29 14:30:25`
- `2025/12/31 23:59:59`

#### 5.6.5 Timenow ä½¿ç”¨åœºæ™¯

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

1. **åˆ›å»ºæ—¶é—´è®°å½•**ï¼š
   - ä½œä¸šç¥¨åˆ›å»ºæ—¶é—´
   - è¡¨å•æäº¤æ—¶é—´
   - æ•°æ®å½•å…¥æ—¶é—´

2. **å®¡æ‰¹æ—¶é—´æˆ³**ï¼š
   - å®¡æ‰¹é€šè¿‡æ—¶é—´
   - å®¡æ‰¹é©³å›æ—¶é—´
   - å„æ­¥éª¤å®¡æ‰¹æ—¶é—´

3. **æ“ä½œæ—¥å¿—**ï¼š
   - æ“ä½œè®°å½•æ—¶é—´
   - çŠ¶æ€å˜æ›´æ—¶é—´
   - æ•°æ®ä¿®æ”¹æ—¶é—´

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// æ¨¡æ¿ä¸­å®šä¹‰ timenow å­—æ®µ
{
  cellKey: "R10C3",
  label: "åˆ›å»ºæ—¶é—´",
  fieldName: "createTime",
  fieldType: "timenow",
  hint: "ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ"
}

// ç”¨æˆ·æäº¤è¡¨å•æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å¡«å……
// æäº¤å‰ï¼šformData["R10C3"] = ""
// æäº¤åï¼šformData["R10C3"] = "2025/01/29 14:30:25"
```

#### 5.6.6 Timenow å­—æ®µç‰¹æ€§

**æ ¸å¿ƒç‰¹æ€§**ï¼š

1. **è‡ªåŠ¨å¡«å……**ï¼š
   - æ— éœ€ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
   - ç³»ç»Ÿåœ¨æäº¤/æ›´æ–°æ—¶è‡ªåŠ¨å¡«å……
   - ä»…åœ¨å­—æ®µä¸ºç©ºæ—¶å¡«å……ï¼ˆä¸è¦†ç›–å·²æœ‰å€¼ï¼‰

2. **åªè¯»æ˜¾ç¤º**ï¼š
   - å‰ç«¯æ˜¾ç¤ºä¸ºåªè¯»çŠ¶æ€
   - ä¸å…è®¸ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹
   - æ˜¾ç¤ºå ä½ç¬¦æç¤ºç”¨æˆ·

3. **æ—¶é—´ç²¾åº¦**ï¼š
   - ç²¾ç¡®åˆ°ç§’çº§åˆ«
   - ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´ï¼ˆé¿å…å®¢æˆ·ç«¯æ—¶é—´ä¸ä¸€è‡´ï¼‰

4. **æ ¼å¼ç»Ÿä¸€**ï¼š
   - æ‰€æœ‰ timenow å­—æ®µä½¿ç”¨ç›¸åŒæ ¼å¼
   - ä¾¿äºæ•°æ®å±•ç¤ºå’ŒæŸ¥è¯¢

**æ³¨æ„äº‹é¡¹**ï¼š

1. **æ—¶åŒºé—®é¢˜**ï¼š
   - ä½¿ç”¨æœåŠ¡å™¨æ—¶åŒºï¼ˆå»ºè®®ä½¿ç”¨ UTC+8ï¼‰
   - ç¡®ä¿æ‰€æœ‰æ—¶é—´æˆ³ä¸€è‡´

2. **æ›´æ–°ç­–ç•¥**ï¼š
   - ä»…åœ¨å­—æ®µä¸ºç©ºæ—¶å¡«å……
   - å·²å¡«å……çš„æ—¶é—´ä¸ä¼šè¢«è¦†ç›–
   - å¦‚éœ€æ›´æ–°ï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç©ºå­—æ®µ

3. **æ•°æ®éªŒè¯**ï¼š
   - Timenow å­—æ®µé€šå¸¸ä¸æ˜¯å¿…å¡«é¡¹
   - ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€éªŒè¯

---

## 6. æ¶æ„é‡æ„

### 6.1 æ¦‚è¿°

æœ¬æ¬¡æ¶æ„é‡æ„ä¸»è¦è§£å†³ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š
1. **æ•°æ®å­¤å²›ä¸æŠ¥è¡¨ç»Ÿè®¡é—®é¢˜**ï¼šé€šè¿‡æ•°æ®æ˜ å°„å±‚ï¼Œä½¿å…³é”®å­—æ®µå¯ç”¨äº SQL ç»Ÿè®¡æŸ¥è¯¢
2. **ç”µå­ç­¾åæ³•å¾‹æ•ˆåŠ›**ï¼šå®ç°ç¬¦åˆå®¡è®¡è¦æ±‚çš„ç”µå­ç­¾åæ–¹æ¡ˆï¼ŒåŒ…å«é˜²ç¯¡æ”¹æœºåˆ¶
3. **å­è¡¨å•æ¶æ„è§£è€¦**ï¼šå°†äºŒçº§è¡¨å•æ•°æ®ä»çˆ¶è¡¨å• JSON ä¸­åˆ†ç¦»ï¼Œå­˜å‚¨åˆ°ç‹¬ç«‹è¡¨
4. **ç¦»çº¿æ”¯æŒ**ï¼šæä¾›åŸºäº IndexedDB çš„æš‚å­˜å’ŒåŒæ­¥æœºåˆ¶

### 6.2 æ•°æ®æ˜ å°„å±‚ (Data Mapping Layer)

#### 6.2.1 è®¾è®¡ç›®æ ‡

è§£å†³æ‰€æœ‰ä¸šåŠ¡æ•°æ®éƒ½åœ¨ `dataJson` ä¸­ï¼Œæ— æ³•ä½¿ç”¨ SQL è¿›è¡Œç»Ÿè®¡æŸ¥è¯¢çš„é—®é¢˜ã€‚é€šè¿‡æå–å…³é”®å­—æ®µåˆ°ç‹¬ç«‹åˆ—ï¼Œå®ç°é«˜æ•ˆçš„ç»Ÿè®¡æŸ¥è¯¢ã€‚

#### 6.2.2 æ•°æ®åº“è®¾è®¡

åœ¨ `WorkPermitRecord` è¡¨ä¸­æ–°å¢å…³é”®ç´¢å¼•åˆ—ï¼š

```typescript
model WorkPermitRecord {
  // ... åŸæœ‰å­—æ®µ ...
  
  // ğŸŸ¢ æ•°æ®æ˜ å°„å±‚ï¼šå…³é”®ä¸šåŠ¡å­—æ®µ
  riskLevel         String?  // é£é™©ç­‰çº§ï¼šlow, medium, high, critical
  workType          String?  // ä½œä¸šç±»å‹ï¼šåŠ¨ç«ã€é«˜å¤„ã€å—é™ç©ºé—´ç­‰
  location          String?  // ä½œä¸šåœ°ç‚¹
  applicantId       String?  // ç”³è¯·äººID
  applicantName     String?  // ç”³è¯·äººå§“å
  applicantDept     String?  // ç”³è¯·äººéƒ¨é—¨
  workDate          DateTime? // ä½œä¸šæ—¥æœŸ
  workStartTime     DateTime? // ä½œä¸šå¼€å§‹æ—¶é—´
  workEndTime       DateTime? // ä½œä¸šç»“æŸæ—¶é—´
  supervisorId      String?  // ç›‘æŠ¤äººID
  supervisorName    String?  // ç›‘æŠ¤äººå§“å
  
  // ç´¢å¼•ï¼šç”¨äºç»Ÿè®¡æŸ¥è¯¢
  @@index([riskLevel])
  @@index([workType])
  @@index([location])
  @@index([applicantId])
  @@index([applicantDept])
  @@index([workDate])
  @@index([workType, workDate]) // å¤åˆç´¢å¼•
  @@index([applicantDept, workDate]) // å¤åˆç´¢å¼•
}
```

#### 6.2.3 æ ¸å¿ƒå®ç°

**æ–‡ä»¶ä½ç½®**: `src/utils/dataMapper.ts`

**æ ¸å¿ƒå‡½æ•°**: `mapJsonToColumns()`

```typescript
export function mapJsonToColumns(
  dataJson: string | Record<string, any>,
  parsedFields: ParsedField[] = []
): MappedFields {
  // 1. è§£æ dataJsonï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
  // 2. æ„å»ºå­—æ®µæ˜ å°„è¡¨ï¼ˆåŸºäº parsedFieldsï¼‰
  // 3. æå–å…³é”®å­—æ®µï¼ˆé£é™©ç­‰çº§ã€ä½œä¸šç±»å‹ã€åœ°ç‚¹ã€ç”³è¯·äººç­‰ï¼‰
  // 4. è¿”å›æ˜ å°„åçš„å­—æ®µå¯¹è±¡
}
```

**å­—æ®µæå–ç­–ç•¥**ï¼š
- æ”¯æŒå¤šç§å­—æ®µåå˜ä½“ï¼ˆå¦‚ `riskLevel`, `risk_level`, `é£é™©ç­‰çº§`ï¼‰
- è‡ªåŠ¨å¤„ç†æ•°ç»„æ ¼å¼ï¼ˆExcel gridï¼‰å’Œå¯¹è±¡æ ¼å¼
- æ™ºèƒ½æ—¥æœŸæ—¶é—´è§£æ
- ä»æ¨¡æ¿ç±»å‹æ¨æ–­ä½œä¸šç±»å‹ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

#### 6.2.4 ä½¿ç”¨æ–¹å¼

**è‡ªåŠ¨é›†æˆ**ï¼šåœ¨åˆ›å»º/æ›´æ–°ä½œä¸šç¥¨æ—¶è‡ªåŠ¨æå–å…³é”®å­—æ®µ

```typescript
// src/app/api/permits/route.ts
import { mapJsonToColumns, inferWorkTypeFromTemplate } from '@/utils/dataMapper';

// åˆ›å»ºä½œä¸šç¥¨æ—¶
const mappedFields = mapJsonToColumns(finalDataJson, parsedFields);
if (!mappedFields.workType) {
  mappedFields.workType = inferWorkTypeFromTemplate(templateType);
}

await prisma.workPermitRecord.create({
  data: {
    dataJson: JSON.stringify(dataJson),
    ...mappedFields, // è‡ªåŠ¨å¡«å……å…³é”®å­—æ®µ
  }
});
```

#### 6.2.5 ç»Ÿè®¡æŸ¥è¯¢ç¤ºä¾‹

ç°åœ¨å¯ä»¥ä½¿ç”¨ SQL è¿›è¡Œé«˜æ•ˆç»Ÿè®¡æŸ¥è¯¢ï¼š

```typescript
// ç»Ÿè®¡æŸéƒ¨é—¨æœ¬æœˆåŠ¨ç«ä½œä¸šæ¬¡æ•°
const count = await prisma.workPermitRecord.count({
  where: {
    applicantDept: 'ç”Ÿäº§éƒ¨',
    workType: 'åŠ¨ç«ä½œä¸š',
    workDate: {
      gte: new Date(2024, 0, 1),
      lte: new Date(2024, 0, 31),
    },
  },
});

// æŒ‰é£é™©ç­‰çº§åˆ†ç»„ç»Ÿè®¡
const stats = await prisma.workPermitRecord.groupBy({
  by: ['riskLevel'],
  _count: true,
  where: {
    workDate: { gte: new Date(2024, 0, 1) },
  },
});
```

### 6.3 ç”µå­ç­¾åæ³•å¾‹æ•ˆåŠ› (Legal Validity of E-Signatures)

#### 6.3.1 è®¾è®¡ç›®æ ‡

å®ç°ç¬¦åˆå®¡è®¡è¦æ±‚çš„ç”µå­ç­¾åæ–¹æ¡ˆï¼Œç¡®ä¿ç­¾å­—åå†…å®¹æœªè¢«ç¯¡æ”¹ï¼Œæ»¡è¶³æ³•å¾‹åˆè§„è¦æ±‚ã€‚

#### 6.3.2 æ•°æ®åº“è®¾è®¡

**æ–°å¢è¡¨**: `SignatureRecord`

```typescript
model SignatureRecord {
  id                String   @id @default(cuid())
  permitId          String
  permit            WorkPermitRecord @relation(...)
  signerId          String   // ç­¾å­—äººID
  signerName        String   // ç­¾å­—äººå§“å
  action            String   // 'pass' | 'reject' | 'issue' | 'site_confirm'
  comment           String?  // å®¡æ‰¹æ„è§
  stepIndex         Int      // å®¡æ‰¹æ­¥éª¤ç´¢å¼•
  stepName          String?  // å®¡æ‰¹æ­¥éª¤åç§°
  
  // ğŸ” é˜²ç¯¡æ”¹æ ¸å¿ƒå­—æ®µ
  dataSnapshotHash  String   // ç­¾å­—æ—¶åˆ»è¡¨å•æ•°æ®çš„ Hash å€¼ï¼ˆSHA-256ï¼‰
  dataSnapshot      String?  // ç­¾å­—æ—¶åˆ»è¡¨å•æ•°æ®çš„å®Œæ•´å¿«ç…§ï¼ˆå¯é€‰ï¼‰
  
  signedAt          DateTime @default(now())
  clientInfo        String?  // JSONï¼šå®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯
  
  @@index([permitId])
  @@index([signerId])
  @@index([signedAt])
  @@index([permitId, stepIndex])
}
```

#### 6.3.3 æ ¸å¿ƒå®ç°

**æ–‡ä»¶ä½ç½®**: `src/services/signatureService.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

1. **åˆ›å»ºç­¾åè®°å½•**ï¼š
```typescript
export async function createSignature(
  input: SignatureInput,
  dataJson: string,
  saveSnapshot: boolean = false
) {
  // è®¡ç®—æ•°æ®å¿«ç…§ Hashï¼ˆSHA-256ï¼‰
  const dataSnapshotHash = calculateDataHash(dataJson);
  
  // åˆ›å»ºç­¾åè®°å½•
  await prisma.signatureRecord.create({
    data: {
      permitId: input.permitId,
      signerId: input.signerId,
      signerName: input.signerName,
      action: input.action,
      comment: input.comment,
      stepIndex: input.stepIndex,
      stepName: input.stepName,
      dataSnapshotHash, // å…³é”®ï¼šå­˜å‚¨ Hash å€¼
      dataSnapshot: saveSnapshot ? dataJson : null, // å¯é€‰ï¼šå®Œæ•´å¿«ç…§
      clientInfo: JSON.stringify(input.clientInfo),
    },
  });
}
```

2. **éªŒè¯æ•°æ®å®Œæ•´æ€§**ï¼š
```typescript
export async function verifySignature(
  permitId: string,
  currentDataJson: string,
  signatureId?: string
): Promise<SignatureVerificationResult> {
  // è®¡ç®—å½“å‰æ•°æ®çš„ Hash
  const currentHash = calculateDataHash(currentDataJson);
  
  // æŸ¥è¯¢ç­¾åè®°å½•
  const signatures = await prisma.signatureRecord.findMany({...});
  
  // æ£€æŸ¥æ¯ä¸ªç­¾åè®°å½•
  for (const signature of signatures) {
    if (signature.dataSnapshotHash !== currentHash) {
      return {
        isValid: false,
        reason: `ç­¾ååæ•°æ®å·²è¢«ç¯¡æ”¹ã€‚ç­¾åæ—¶é—´: ${signature.signedAt}`,
        currentHash,
        recordedHash: signature.dataSnapshotHash,
      };
    }
  }
  
  return { isValid: true, currentHash };
}
```

#### 6.3.4 é˜²ç¯¡æ”¹æœºåˆ¶

**å·¥ä½œæµç¨‹**ï¼š

1. **ç­¾å­—æ—¶åˆ»**ï¼š
   - è®¡ç®—è¡¨å•æ•°æ®çš„ SHA-256 Hash å€¼
   - å­˜å‚¨ Hash å€¼åˆ° `dataSnapshotHash` å­—æ®µ
   - å¯é€‰ï¼šå­˜å‚¨å®Œæ•´æ•°æ®å¿«ç…§ï¼ˆç”¨äºå®¡è®¡ï¼‰

2. **éªŒè¯æ—¶åˆ»**ï¼š
   - é‡æ–°è®¡ç®—å½“å‰æ•°æ®çš„ Hash å€¼
   - ä¸å­˜å‚¨çš„ Hash å€¼å¯¹æ¯”
   - ä¸ä¸€è‡´åˆ™åˆ¤å®šä¸ºæ•°æ®è¢«ç¯¡æ”¹

3. **å®¡è®¡è¿½æº¯**ï¼š
   - è®°å½•ç­¾å­—äººã€æ—¶é—´ã€æ“ä½œç±»å‹
   - è®°å½•å®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯ï¼ˆIPã€æµè§ˆå™¨ã€è®¾å¤‡ç­‰ï¼‰
   - æ”¯æŒå®Œæ•´çš„å®¡è®¡æ—¥å¿—æŸ¥è¯¢

#### 6.3.5 é›†æˆåˆ°å®¡æ‰¹æµç¨‹

**æ–‡ä»¶ä½ç½®**: `src/app/api/permits/approve/route.ts`

```typescript
// å®¡æ‰¹æ—¶è‡ªåŠ¨åˆ›å»ºç­¾åè®°å½•
await createSignature(
  {
    permitId: recordId,
    signerId: userId,
    signerName: userName,
    action: action === 'pass' ? 'pass' : 'reject',
    comment: opinion,
    stepIndex: currentStepIndex,
    stepName: currentStepConfig?.name,
    clientInfo: extractClientInfo(req),
  },
  updatedDataJson, // ç­¾å­—æ—¶åˆ»çš„æ•°æ®å¿«ç…§
  false // ä¸ä¿å­˜å®Œæ•´å¿«ç…§ï¼Œä»…ä¿å­˜ Hash
);
```

### 6.4 å­è¡¨å•æ¶æ„è§£è€¦ (Decoupling Sub-forms)

#### 6.4.1 è®¾è®¡ç›®æ ‡

å°†äºŒçº§è¡¨å•æ•°æ®ä»çˆ¶è¡¨å• JSON ä¸­åˆ†ç¦»ï¼Œè§£å†³ï¼š
- çˆ¶è¡¨å• JSON è¿‡å¤§é—®é¢˜
- å¹¶å‘å†™å…¥å†²çªé—®é¢˜ï¼ˆOptimistic Locking issuesï¼‰
- å­è¡¨å•æ•°æ®éš¾ä»¥ç‹¬ç«‹ç®¡ç†çš„é—®é¢˜

#### 6.4.2 æ•°æ®åº“è®¾è®¡

**æ–°å¢è¡¨**: `SubPermit`

```typescript
model SubPermit {
  id                String   @id @default(cuid())
  parentPermitId    String
  parentPermit      WorkPermitRecord @relation(...)
  templateId        String   // ç»‘å®šçš„äºŒçº§æ¨¡æ¿ID
  code              String?  // å­è¡¨å•ç¼–å·
  cellKey           String   // çˆ¶è¡¨å•ä¸­ç»‘å®šçš„å•å…ƒæ ¼é”®ï¼ˆå¦‚ï¼šR5C3ï¼‰
  fieldName         String?  // å­—æ®µå
  dataJson          String   // å­è¡¨å•çš„å®Œæ•´æ•°æ®ï¼ˆJSONï¼‰
  
  status            String   @default("draft")
  currentStep       Int      @default(0)
  approvalLogs      String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([parentPermitId])
  @@index([templateId])
  @@index([code])
  @@index([cellKey])
}
```

#### 6.4.3 æ•°æ®å­˜å‚¨ç­–ç•¥

**çˆ¶è¡¨å• JSON æ ¼å¼å˜åŒ–**ï¼š

**é‡æ„å‰**ï¼š
```json
{
  "R5C3": {
    "templateId": "xxx",
    "templateName": "æ¯æ—¥æ–½å·¥å•",
    "code": "DH-001-æ–½å·¥",
    "data": { /* å¤§é‡å­è¡¨å•æ•°æ® */ }
  }
}
```

**é‡æ„å**ï¼š
```json
{
  "R5C3": {
    "_subPermitId": "sub-permit-id",
    "_display": "[å­è¡¨å•:sub-permit-id]"
  }
}
```

**å­è¡¨å•æ•°æ®**ï¼šå­˜å‚¨åœ¨ `SubPermit` è¡¨çš„ `dataJson` å­—æ®µä¸­

#### 6.4.4 æ ¸å¿ƒå®ç°

**æ–‡ä»¶ä½ç½®**: `src/services/subPermitService.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

1. **åˆ›å»ºå­è¡¨å•**ï¼š
```typescript
export async function createSubPermit(input: SubPermitInput) {
  // 1. åˆ›å»ºå­è¡¨å•è®°å½•
  const subPermit = await prisma.subPermit.create({
    data: {
      parentPermitId: input.parentPermitId,
      templateId: input.templateId,
      cellKey: input.cellKey,
      dataJson: JSON.stringify(input.dataJson),
      // ...
    },
  });
  
  // 2. æ›´æ–°çˆ¶è¡¨å• JSONï¼šå°†å­è¡¨å•æ•°æ®æ›¿æ¢ä¸º ID å¼•ç”¨
  await updateParentPermitJson(
    input.parentPermitId,
    input.cellKey,
    subPermit.id
  );
  
  return subPermit;
}
```

2. **è¯»å–å­è¡¨å•**ï¼š
```typescript
// ä»çˆ¶è¡¨å• JSON ä¸­æå–å­è¡¨å• ID
const parentData = JSON.parse(parentPermit.dataJson);
const subPermitId = parentData['R5C3']?._subPermitId;

if (subPermitId) {
  // æŸ¥è¯¢å­è¡¨å•æ•°æ®
  const subPermit = await getSubPermit(subPermitId);
  const subFormData = JSON.parse(subPermit.dataJson);
}
```

3. **æ›´æ–°å­è¡¨å•**ï¼š
```typescript
// ç›´æ¥æ›´æ–°å­è¡¨å•ï¼Œä¸å½±å“çˆ¶è¡¨å•
await updateSubPermit(subPermitId, {
  dataJson: updatedSubFormData,
  status: 'approved',
});
```

#### 6.4.5 API ç«¯ç‚¹

**æ–‡ä»¶ä½ç½®**: `src/app/api/sub-permits/route.ts`

- `GET /api/sub-permits?id=xxx` - è·å–å•ä¸ªå­è¡¨å•
- `GET /api/sub-permits?parentPermitId=xxx` - è·å–çˆ¶è¡¨å•çš„æ‰€æœ‰å­è¡¨å•
- `GET /api/sub-permits?parentPermitId=xxx&cellKey=R5C3` - æ ¹æ®å•å…ƒæ ¼é”®è·å–
- `POST /api/sub-permits` - åˆ›å»ºå­è¡¨å•
- `PATCH /api/sub-permits` - æ›´æ–°å­è¡¨å•
- `DELETE /api/sub-permits?id=xxx` - åˆ é™¤å­è¡¨å•
- `PUT /api/sub-permits` - ä»çˆ¶è¡¨å•æå–å­è¡¨å•ï¼ˆè¿ç§»å·¥å…·ï¼‰

#### 6.4.6 æ•°æ®è¿ç§»

å¯¹äºç°æœ‰çš„åµŒå¥—å­è¡¨å•æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è¿ç§»å·¥å…·ï¼š

```typescript
// ä»çˆ¶è¡¨å• JSON ä¸­æå–æ‰€æœ‰å­è¡¨å•æ•°æ®ï¼Œåˆ›å»ºç‹¬ç«‹çš„ SubPermit è®°å½•
const extracted = await extractSubPermitsFromParent(parentPermitId);
```

### 6.5 ç¦»çº¿æ”¯æŒ (Offline Capabilities)

#### 6.5.1 è®¾è®¡ç›®æ ‡

åœ¨å·¥å‚è½¦é—´ä¿¡å·å·®çš„æƒ…å†µä¸‹ï¼Œå…è®¸ç”¨æˆ·åœ¨æ–­ç½‘æ—¶æš‚å­˜è¡¨å•æ•°æ®ï¼Œç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨åŒæ­¥ã€‚

#### 6.5.2 æŠ€æœ¯æ–¹æ¡ˆ

**åŸºäº IndexedDB çš„ç¦»çº¿å­˜å‚¨**

- ä½¿ç”¨ IndexedDB å­˜å‚¨å¾…åŒæ­¥çš„æ•°æ®
- ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼ˆ`online`/`offline` äº‹ä»¶ï¼‰
- ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨åŒæ­¥

#### 6.5.3 æ ¸å¿ƒå®ç°

**æ–‡ä»¶ä½ç½®**: `src/hooks/useOfflineStorage.ts`

**Hook æ¥å£**ï¼š

```typescript
export function useOfflineStorage() {
  const [isOnline, setIsOnline] = useState(true);
  const [pendingCount, setPendingCount] = useState(0);
  const [isSyncing, setIsSyncing] = useState(false);
  
  // ä¿å­˜åˆ°ç¦»çº¿å­˜å‚¨
  const saveOffline = async (
    type: 'permit' | 'sub_permit' | 'other',
    data: any,
    id?: string
  ) => { /* ... */ };
  
  // åŒæ­¥æ‰€æœ‰å¾…åŒæ­¥é¡¹
  const syncPendingItems = async () => { /* ... */ };
  
  // æ¸…é™¤å·²åŒæ­¥é¡¹
  const clearSyncedItems = async () => { /* ... */ };
  
  return {
    isOnline,
    pendingCount,
    isSyncing,
    saveOffline,
    syncPendingItems,
    clearSyncedItems,
  };
}
```

#### 6.5.4 ä½¿ç”¨æ–¹å¼

```typescript
import { useOfflineStorage } from '@/hooks/useOfflineStorage';

function MyComponent() {
  const { isOnline, pendingCount, saveOffline, syncPendingItems } = useOfflineStorage();
  
  // ä¿å­˜è¡¨å•æ•°æ®
  const handleSave = async () => {
    try {
      await fetch('/api/permits', { method: 'POST', body: JSON.stringify(formData) });
    } catch (error) {
      // ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜åˆ°ç¦»çº¿å­˜å‚¨
      if (!navigator.onLine) {
        await saveOffline('permit', formData);
      }
    }
  };
  
  return (
    <div>
      {!isOnline && (
        <div>ç¦»çº¿æ¨¡å¼ï¼Œå·²ä¿å­˜ {pendingCount} æ¡å¾…åŒæ­¥æ•°æ®</div>
      )}
      {pendingCount > 0 && (
        <button onClick={syncPendingItems}>æ‰‹åŠ¨åŒæ­¥</button>
      )}
    </div>
  );
}
```

#### 6.5.5 è‡ªåŠ¨åŒæ­¥æœºåˆ¶

1. **ç½‘ç»œæ¢å¤æ£€æµ‹**ï¼šç›‘å¬ `online` äº‹ä»¶
2. **è‡ªåŠ¨åŒæ­¥**ï¼šç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨åŒæ­¥æ‰€æœ‰å¾…åŒæ­¥é¡¹
3. **é‡è¯•æœºåˆ¶**ï¼šåŒæ­¥å¤±è´¥æ—¶å¢åŠ é‡è¯•æ¬¡æ•°ï¼Œè¶…è¿‡5æ¬¡åè·³è¿‡
4. **çŠ¶æ€ç®¡ç†**ï¼šè·Ÿè¸ªåŒæ­¥çŠ¶æ€ï¼Œé¿å…é‡å¤åŒæ­¥

**åŒæ­¥æµç¨‹**ï¼š

```typescript
// 1. è·å–æ‰€æœ‰å¾…åŒæ­¥é¡¹
const items = await getPendingSyncItems();

// 2. é€ä¸ªåŒæ­¥
for (const item of items) {
  if (item.syncAttempts >= 5) continue; // è·³è¿‡é‡è¯•æ¬¡æ•°è¿‡å¤šçš„é¡¹
  
  const success = await syncItem(item);
  if (success) {
    await markAsSynced(item.id);
  } else {
    await incrementSyncAttempts(item.id);
  }
}
```

### 6.6 æ•°æ®åº“è¿ç§»

#### 6.6.1 è¿ç§»æ­¥éª¤

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx prisma migrate dev --name add_data_mapping_and_signatures

# 2. ç”Ÿæˆ Prisma Client
npx prisma generate
```

#### 6.6.2 æ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

**è¿ç§»ç°æœ‰æ•°æ®çš„å…³é”®å­—æ®µ**ï¼š

```typescript
// å¯¹ç°æœ‰ä½œä¸šç¥¨è¿è¡Œæ•°æ®æ˜ å°„å‡½æ•°æå–å…³é”®å­—æ®µ
const records = await prisma.workPermitRecord.findMany();
for (const record of records) {
  const parsedFields = JSON.parse(record.template.parsedFields || '[]');
  const mappedFields = mapJsonToColumns(record.dataJson, parsedFields);
  
  await prisma.workPermitRecord.update({
    where: { id: record.id },
    data: mappedFields,
  });
}
```

**è¿ç§»åµŒå¥—å­è¡¨å•**ï¼š

```typescript
// ä½¿ç”¨è¿ç§»å·¥å…·ä»çˆ¶è¡¨å• JSON ä¸­æå–å­è¡¨å•æ•°æ®
const extracted = await extractSubPermitsFromParent(parentPermitId);
```

### 6.7 æ€§èƒ½ä¼˜åŒ–

#### 6.7.1 ç´¢å¼•ä¼˜åŒ–

å·²ä¸ºå…³é”®å­—æ®µæ·»åŠ ç´¢å¼•ï¼š
- **å•åˆ—ç´¢å¼•**ï¼š`riskLevel`, `workType`, `location`, `applicantDept`, `workDate`
- **å¤åˆç´¢å¼•**ï¼š`[workType, workDate]`, `[applicantDept, workDate]`

#### 6.7.2 æŸ¥è¯¢ä¼˜åŒ–

- ç»Ÿè®¡æŸ¥è¯¢ä¼˜å…ˆä½¿ç”¨æ˜ å°„å­—æ®µï¼Œé¿å…å…¨è¡¨æ‰«æ `dataJson`
- å­è¡¨å•æŸ¥è¯¢ä½¿ç”¨ç‹¬ç«‹è¡¨ï¼Œé¿å…è§£æå¤§å‹ JSON
- ç”µå­ç­¾åéªŒè¯ä½¿ç”¨ Hash å¯¹æ¯”ï¼Œæ€§èƒ½é«˜æ•ˆ

#### 6.7.3 å­˜å‚¨ä¼˜åŒ–

- ç”µå­ç­¾åé»˜è®¤ä¸ä¿å­˜å®Œæ•´å¿«ç…§ï¼Œä»…ä¿å­˜ Hashï¼ˆèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
- å­è¡¨å•æ•°æ®ç‹¬ç«‹å­˜å‚¨ï¼Œå‡å°‘çˆ¶è¡¨å• JSON å¤§å°

### 6.8 å…¼å®¹æ€§è¯´æ˜

#### 6.8.1 å‘åå…¼å®¹

- `dataJson` å­—æ®µä»ç„¶ä¿ç•™ï¼Œç°æœ‰åŠŸèƒ½ä¸å—å½±å“
- æ˜ å°„å­—æ®µä¸ºå¯é€‰å­—æ®µï¼ˆ`String?`ï¼‰ï¼Œç°æœ‰æ•°æ®å¯ä»¥é€æ­¥è¿ç§»
- å­è¡¨å•æ”¯æŒæ–°æ—§ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼ˆæ¸è¿›å¼è¿ç§»ï¼‰

#### 6.8.2 æ¸è¿›å¼è¿ç§»

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šæ–°æ•°æ®è‡ªåŠ¨æå–æ˜ å°„å­—æ®µ
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šå¯¹ç°æœ‰æ•°æ®è¿è¡Œè¿ç§»è„šæœ¬
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šé€æ­¥å°†å­è¡¨å•æ•°æ®è¿ç§»åˆ°ç‹¬ç«‹è¡¨

---

## æŠ€æœ¯æ¶æ„æ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **å‰ç«¯æ¡†æ¶**: Next.js + React + TypeScript
- **æ ·å¼æ–¹æ¡ˆ**: Tailwind CSS
- **æ•°æ®åº“**: Prisma + SQLite
- **Excelå¤„ç†**: è‡ªå®šä¹‰è§£æå¼•æ“
- **ç¦»çº¿å­˜å‚¨**: IndexedDB
- **åŠ å¯†ç®—æ³•**: SHA-256 (Node.js crypto)

### å…³é”®è®¾è®¡æ¨¡å¼
1. **è§£æå™¨æ¨¡å¼**: æ¨¡æ¿å­—æ®µè§£æ
2. **çŠ¶æ€æœºæ¨¡å¼**: å·¥ä½œæµçŠ¶æ€æµè½¬
3. **ç­–ç•¥æ¨¡å¼**: å®¡æ‰¹äººè§£æç­–ç•¥
4. **ç»„åˆæ¨¡å¼**: ä¸€çº§äºŒçº§è¡¨å•åµŒå¥—
5. **æ•°æ®æ˜ å°„æ¨¡å¼**: JSON åˆ°æ•°æ®åº“åˆ—çš„æ˜ å°„
6. **é˜²ç¯¡æ”¹æ¨¡å¼**: Hash æ ¡éªŒæœºåˆ¶
7. **ç¦»çº¿ä¼˜å…ˆæ¨¡å¼**: IndexedDB æš‚å­˜å’ŒåŒæ­¥

### æ•°æ®æµ
```
æ¨¡æ¿ä¸Šä¼  â†’ å­—æ®µè§£æ â†’ æ¨¡æ¿ä¿å­˜
    â†“
è¡¨å•åˆ›å»º â†’ æ•°æ®å¡«å†™ â†’ æ•°æ®æ˜ å°„ï¼ˆæå–å…³é”®å­—æ®µï¼‰
    â†“
æäº¤å®¡æ‰¹ â†’ å®¡æ‰¹æµç¨‹ â†’ ç”µå­ç­¾å­—ï¼ˆHash è®¡ç®—ï¼‰
    â†“
æ•°æ®å­˜å‚¨ â†’ æ—¥å¿—è®°å½• â†’ é€šçŸ¥å‘é€
    â†“
å­è¡¨å•è§£è€¦ï¼ˆç‹¬ç«‹å­˜å‚¨ï¼‰â†’ ç¦»çº¿åŒæ­¥ï¼ˆIndexedDBï¼‰
```

### æ¶æ„é‡æ„äº®ç‚¹
1. **æ•°æ®æ˜ å°„å±‚**ï¼šè§£å†³æ•°æ®å­¤å²›é—®é¢˜ï¼Œæ”¯æŒ SQL ç»Ÿè®¡æŸ¥è¯¢
2. **ç”µå­ç­¾å**ï¼šç¬¦åˆå®¡è®¡è¦æ±‚ï¼ŒåŒ…å«é˜²ç¯¡æ”¹æœºåˆ¶ï¼ˆSHA-256 Hashï¼‰
3. **å­è¡¨å•è§£è€¦**ï¼šç‹¬ç«‹å­˜å‚¨ï¼Œè§£å†³å¹¶å‘å’Œæ€§èƒ½é—®é¢˜
4. **ç¦»çº¿æ”¯æŒ**ï¼šåŸºäº IndexedDB çš„æš‚å­˜å’Œè‡ªåŠ¨åŒæ­¥æœºåˆ¶

---

## é™„å½•

### A. å­—æ®µç±»å‹å®Œæ•´åˆ—è¡¨
- `text`: æ–‡æœ¬
- `date`: æ—¥æœŸæ—¶é—´
- `department`: éƒ¨é—¨
- `personnel`: äººå‘˜
- `signature`: ç­¾å
- `handwritten`: æ‰‹å†™ç­¾å
- `option`: é€‰é¡¹
- `number`: æ•°å­—
- `section`: åµŒå¥—è¡¨å•
- `timenow`: è‡ªåŠ¨æ—¶é—´
- `match`: åŒ¹é…
- `other`: å…¶ä»–

### B. å®¡æ‰¹æ¨¡å¼å¯¹æ¯”
| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| OR | ä»»æ„ä¸€äººé€šè¿‡å³å¯ | å¤šå€™é€‰äººé€‰ä¸€ |
| AND | æ‰€æœ‰äººå¿…é¡»é€šè¿‡ | ä¼šç­¾åœºæ™¯ |
| CONDITIONAL | æ¡ä»¶åŒ¹é…å†³å®šå®¡æ‰¹äºº | åŠ¨æ€è·¯ç”± |

### C. ç›¸å…³æ–‡ä»¶æ¸…å•

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `src/utils/templateParser.ts`: æ¨¡æ¿è§£æ
- `src/services/workflowEngine.ts`: å·¥ä½œæµå¼•æ“
- `src/lib/workflowUtils.ts`: å®¡æ‰¹äººè§£æ
- `src/app/api/permits/approve/route.ts`: å®¡æ‰¹æ¥å£
- `src/components/work-permit/ExcelRenderer.tsx`: Excelæ¸²æŸ“å™¨
- `src/components/work-permit/views/MobileFormRenderer.tsx`: ç§»åŠ¨ç«¯æ¸²æŸ“å™¨
- `src/components/work-permit/moduls/EditTemplateModal.tsx`: æ¨¡æ¿ç¼–è¾‘å™¨
- `src/components/work-permit/moduls/SectionFormModal.tsx`: äºŒçº§è¡¨å•æ¨¡æ€æ¡†

**æ¶æ„é‡æ„æ–°å¢**ï¼š
- `src/utils/dataMapper.ts`: æ•°æ®æ˜ å°„å·¥å…·
- `src/services/signatureService.ts`: ç”µå­ç­¾åæœåŠ¡
- `src/services/subPermitService.ts`: å­è¡¨å•æœåŠ¡
- `src/app/api/sub-permits/route.ts`: å­è¡¨å• API
- `src/hooks/useOfflineStorage.ts`: ç¦»çº¿å­˜å‚¨ Hook
- `prisma/schema.prisma`: æ•°æ®åº“ Schemaï¼ˆæ–°å¢ SignatureRecordã€SubPermit è¡¨ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æœ€åæ›´æ–°**: 2025-01-29  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

### æ›´æ–°æ—¥å¿—

**v2.0 (2025-01-29)**
- âœ… æ–°å¢ï¼šæ•°æ®æ˜ å°„å±‚ï¼ˆData Mapping Layerï¼‰
- âœ… æ–°å¢ï¼šç”µå­ç­¾åæ³•å¾‹æ•ˆåŠ›ï¼ˆLegal Validity of E-Signaturesï¼‰
- âœ… æ–°å¢ï¼šå­è¡¨å•æ¶æ„è§£è€¦ï¼ˆDecoupling Sub-formsï¼‰
- âœ… æ–°å¢ï¼šç¦»çº¿æ”¯æŒï¼ˆOffline Capabilitiesï¼‰
- âœ… æ›´æ–°ï¼šæ•°æ®åº“ Schemaï¼ˆæ–°å¢ SignatureRecordã€SubPermit è¡¨ï¼‰
- âœ… æ›´æ–°ï¼šAPI è·¯ç”±ï¼ˆé›†æˆæ•°æ®æ˜ å°„å’Œç­¾åæœåŠ¡ï¼‰

**v1.0 (2025-01-29)**
- åˆå§‹ç‰ˆæœ¬ï¼šåŒ…å«æ¨¡æ¿è§£æã€ç­¾ç½²æµç¨‹ã€ç§»åŠ¨ç«¯å®ç°ã€ç¼–è¾‘æ¨¡æ¿ã€ä¸€çº§äºŒçº§è¡¨å•ç­‰æ ¸å¿ƒåŠŸèƒ½

