<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆå§‹åŒ–é€šçŸ¥æ¨¡æ¿</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .instructions {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-bottom: 20px;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background: #1976d2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .log-item {
      padding: 5px 0;
    }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    .info { color: #2196f3; }
    .warning { color: #ff9800; }
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”” åˆå§‹åŒ–é€šçŸ¥æ¨¡æ¿</h1>
    
    <div class="instructions">
      <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
      <p><strong>âš ï¸ å¦‚æœæç¤º"æ•°æ®åº“è¡¨ä¸å­˜åœ¨"ï¼Œè¯·å…ˆæ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼š</strong></p>
      <ol>
        <li>åœæ­¢åº”ç”¨ï¼ˆCtrl+Cï¼‰</li>
        <li>è¿è¡Œè¿ç§»å‘½ä»¤ï¼š<code>node node_modules/prisma/build/index.js migrate deploy</code></li>
        <li>é‡å¯åº”ç”¨ï¼š<code>npm run dev</code></li>
      </ol>
      <p><strong>ğŸ“ åˆ›å»ºæ¨¡æ¿ï¼š</strong></p>
      <ol>
        <li>ç¡®ä¿æ‚¨å·²ç™»å½•ç®¡ç†å‘˜è´¦å·</li>
        <li>ç‚¹å‡»"å¼€å§‹åˆå§‹åŒ–"æŒ‰é’®</li>
        <li>ç­‰å¾…æ‰€æœ‰æ¨¡æ¿åˆ›å»ºå®Œæˆ</li>
        <li>è®¿é—® <a href="/admin/notifications" target="_blank">/admin/notifications</a> é¡µé¢æŸ¥çœ‹ç»“æœ</li>
      </ol>
      <p style="color: #ff9800;"><strong>ğŸ’¡ æç¤ºï¼š</strong> ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ <a href="/admin/notifications" target="_blank">/admin/notifications</a> é¡µé¢æ‰‹åŠ¨åˆ›å»ºæ¨¡æ¿ã€‚</p>
    </div>

    <div>
      <button id="initBtn" onclick="initTemplates()">å¼€å§‹åˆå§‹åŒ–</button>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="summary" id="summary"></div>
    <div class="log" id="log"></div>
  </div>

  <script>
    const templates = [
      {
        name: 'training_assigned_default',
        title: 'æ–°åŸ¹è®­ä»»åŠ¡',
        content: '{{user.name}}åˆ†é…ç»™æ‚¨ä¸€ä¸ªæ–°çš„åŸ¹è®­ä»»åŠ¡ï¼š{{training.title}}ï¼Œè¯·åŠæ—¶å®Œæˆã€‚',
        type: 'training',
        triggerEvent: 'training_assigned',
        variables: '["user.name","training.title","training.id"]',
        isActive: true,
      },
      {
        name: 'training_updated_default',
        title: 'åŸ¹è®­ä»»åŠ¡å·²æ›´æ–°',
        content: 'åŸ¹è®­ä»»åŠ¡"{{training.title}}"å·²æ›´æ–°ï¼Œè¯·åŠæ—¶æŸ¥çœ‹ã€‚',
        type: 'training',
        triggerEvent: 'training_updated',
        variables: '["training.title","training.id"]',
        isActive: true,
      },
      {
        name: 'permit_pending_approval_default',
        title: 'å¾…å®¡æ‰¹ä½œä¸šç¥¨',
        content: 'ã€{{permit.templateName}}ã€‘{{permit.projectName}} - ç­‰å¾…æ‚¨å®¡æ‰¹ï¼ˆç¬¬{{permit.stepNumber}}æ­¥ï¼š{{permit.stepName}}ï¼‰',
        type: 'work_permit',
        triggerEvent: 'permit_pending_approval',
        variables: '["permit.templateName","permit.projectName","permit.stepNumber","permit.stepName","user.name"]',
        isActive: true,
      },
      {
        name: 'permit_approved_default',
        title: 'ä½œä¸šç¥¨å®¡æ‰¹é€šè¿‡',
        content: 'ã€å·²å®Œæˆã€‘ã€{{permit.templateName}}ã€‘{{permit.projectName}} - {{user.name}}é€šè¿‡äº†æ‚¨çš„ç”³è¯·',
        type: 'work_permit',
        triggerEvent: 'permit_approved',
        variables: '["permit.templateName","permit.projectName","user.name"]',
        isActive: true,
      },
      {
        name: 'permit_rejected_default',
        title: 'ä½œä¸šç¥¨è¢«é©³å›',
        content: 'ã€å·²é©³å›ã€‘ã€{{permit.templateName}}ã€‘{{permit.projectName}} - {{user.name}}é©³å›äº†æ‚¨çš„ç”³è¯·',
        type: 'work_permit',
        triggerEvent: 'permit_rejected',
        variables: '["permit.templateName","permit.projectName","user.name"]',
        isActive: true,
      },
      {
        name: 'hazard_assigned_default',
        title: 'éšæ‚£å·²åˆ†é…',
        content: '{{user.name}}åˆ†é…ç»™æ‚¨ä¸€ä¸ªéšæ‚£ï¼ˆç¼–å·ï¼š{{hazard.code}}ï¼Œä½ç½®ï¼š{{hazard.location}}ï¼‰ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚',
        type: 'hazard',
        triggerEvent: 'hazard_assigned',
        variables: '["user.name","hazard.code","hazard.location","hazard.riskLevel"]',
        isActive: true,
      },
    ];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const item = document.createElement('div');
      item.className = `log-item ${type}`;
      item.textContent = message;
      logDiv.appendChild(item);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
    }

    function showSummary(created, skipped, failed) {
      const summaryDiv = document.getElementById('summary');
      summaryDiv.style.display = 'block';
      summaryDiv.innerHTML = `
        <h3>ğŸ“Š åˆå§‹åŒ–å®Œæˆ</h3>
        <p><strong>âœ… æˆåŠŸåˆ›å»º:</strong> ${created} ä¸ª</p>
        <p><strong>â­ï¸ å·²å­˜åœ¨è·³è¿‡:</strong> ${skipped} ä¸ª</p>
        <p><strong>âŒ å¤±è´¥:</strong> ${failed} ä¸ª</p>
        <p><strong>ğŸ“‹ æ€»è®¡:</strong> ${templates.length} ä¸ª</p>
        ${created > 0 ? '<p style="color: #4caf50;">âœ¨ ç°åœ¨å¯ä»¥è®¿é—® <a href="/admin/notifications" target="_blank">/admin/notifications</a> æŸ¥çœ‹æ¨¡æ¿äº†ï¼</p>' : ''}
      `;
    }

    async function initTemplates() {
      const btn = document.getElementById('initBtn');
      btn.disabled = true;
      btn.textContent = 'åˆå§‹åŒ–ä¸­...';
      clearLog();

      log('ğŸš€ å¼€å§‹åˆå§‹åŒ–é€šçŸ¥æ¨¡æ¿...', 'info');
      log('', 'info');

      let created = 0;
      let skipped = 0;
      let failed = 0;

      for (const template of templates) {
        try {
          log(`â³ æ­£åœ¨åˆ›å»º: ${template.name}`, 'info');
          
          const response = await fetch('/api/admin/notification-templates', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(template),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            log(`âœ… åˆ›å»ºæˆåŠŸ: ${template.name} (${template.triggerEvent})`, 'success');
            created++;
          } else if (result.message?.includes('å·²å­˜åœ¨')) {
            log(`â­ï¸ è·³è¿‡: ${template.name} (å·²å­˜åœ¨)`, 'warning');
            skipped++;
          } else {
            log(`âŒ åˆ›å»ºå¤±è´¥: ${template.name} - ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            failed++;
          }
        } catch (error) {
          log(`âŒ ç½‘ç»œé”™è¯¯: ${template.name} - ${error.message}`, 'error');
          failed++;
        }

        // æ·»åŠ å°å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      log('', 'info');
      log('==============================================', 'info');
      showSummary(created, skipped, failed);
      
      btn.disabled = false;
      btn.textContent = 'é‡æ–°åˆå§‹åŒ–';
    }
  </script>
</body>
</html>
