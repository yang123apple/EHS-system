# éšæ‚£æµç¨‹é…ç½®é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

åœ¨éšæ‚£ç³»ç»Ÿä¸­ï¼Œæµç¨‹é…ç½®åŠŸèƒ½å…è®¸åœ¨4ä¸ªåŸºç¡€æ­¥éª¤ä¸Šé¢å¤–å¢åŠ å…¶ä»–æ­¥éª¤ï¼Œä½†æ˜¯è®¾ç½®å®Œæ–°å¢äº†æ­¥éª¤åï¼Œå¹¶ä¸èƒ½å®é™…è¿ç”¨åˆ°éšæ‚£å®¡æ‰¹æµç¨‹ä¸­ï¼Œè€Œæ˜¯è·³è¿‡è‡ªå·±è®¾ç½®çš„é¢å¤–æ­¥éª¤ã€‚

## é—®é¢˜åŸå› 

### æ ¸å¿ƒé—®é¢˜
`HazardDispatchEngine` ä¸­çš„çŠ¶æ€æµè½¬é€»è¾‘ä½¿ç”¨**ç¡¬ç¼–ç çš„çŠ¶æ€æœº**ï¼ŒåªåŒ…å«4ä¸ªåŸºç¡€æ­¥éª¤ï¼š
- reportï¼ˆä¸ŠæŠ¥å¹¶æŒ‡æ´¾ï¼‰
- assignï¼ˆå¼€å§‹æ•´æ”¹ï¼‰
- rectifyï¼ˆæäº¤æ•´æ”¹ï¼‰
- verifyï¼ˆéªŒæ”¶é—­ç¯ï¼‰

### æŠ€æœ¯ç»†èŠ‚
1. **æ—§é€»è¾‘åŸºäºå›ºå®šçŠ¶æ€**ï¼šæµè½¬é€»è¾‘åŸºäº `HazardStatus`ï¼ˆreported, assigned, rectifying, verifiedï¼‰ï¼Œåªæœ‰4ç§çŠ¶æ€
2. **çŠ¶æ€ä¸æ­¥éª¤ä¸åŒ¹é…**ï¼šå½“é…ç½®ä¸­æœ‰5ä¸ªæ­¥éª¤ï¼ˆreport â†’ assign â†’ EHSç¡®è®¤ â†’ rectify â†’ verifyï¼‰æ—¶ï¼ŒçŠ¶æ€æœºç›´æ¥ä» `assigned` è·³åˆ° `rectifying`ï¼Œå®Œå…¨è·³è¿‡ä¸­é—´çš„è‡ªå®šä¹‰æ­¥éª¤
3. **æ­¥éª¤ç´¢å¼•æœªä½¿ç”¨**ï¼šè™½ç„¶æ•°æ®åº“ä¸­æœ‰ `currentStepIndex` å­—æ®µï¼Œä½†æ´¾å‘å¼•æ“æ²¡æœ‰ä½¿ç”¨å®ƒ

## ä¿®å¤æ–¹æ¡ˆ

### æ”¹è¿›æ€è·¯
å°†çŠ¶æ€æœºä»**åŸºäºå›ºå®šçŠ¶æ€**æ”¹ä¸º**åŸºäºæ­¥éª¤ç´¢å¼•çš„åŠ¨æ€æµè½¬**ã€‚

### ä¿®æ”¹å†…å®¹

#### 1. ä¿®æ”¹ `DispatchContext` æ¥å£ï¼ˆ`hazardDispatchEngine.ts`ï¼‰
```typescript
export interface DispatchContext {
  hazard: HazardRecord;
  action: DispatchAction;
  operator: { id: string; name: string; };
  workflowSteps: HazardWorkflowStep[];
  allUsers: SimpleUser[];
  departments: Department[];
  currentStepIndex?: number; // ğŸ†• æ–°å¢ï¼šå½“å‰æ­¥éª¤ç´¢å¼•
  comment?: string;
  additionalData?: any;
}
```

#### 2. ä¿®æ”¹ `DispatchResult` æ¥å£
```typescript
export interface DispatchResult {
  success: boolean;
  newStatus: HazardStatus;
  currentStep: string;
  nextStepIndex?: number; // ğŸ†• æ–°å¢ï¼šä¸‹ä¸€æ­¥éª¤ç´¢å¼•
  handlers: { /* ... */ };
  ccUsers: { /* ... */ };
  log: HazardLog;
  notifications: NotificationData[];
  error?: string;
}
```

#### 3. é‡å†™ `getTransition` æ–¹æ³•
ä»ï¼š
```typescript
private static getTransition(
  currentStatus: HazardStatus,
  action: DispatchAction
): { success, newStatus, nextStepId, error? }
```

æ”¹ä¸ºï¼š
```typescript
private static getTransition(
  currentStepIndex: number,
  action: DispatchAction,
  workflowSteps: HazardWorkflowStep[],
  currentStatus: HazardStatus
): { success, newStatus, nextStepId, nextStepIndex, error? }
```

**æ ¸å¿ƒé€»è¾‘**ï¼š
- æ­£å¸¸æµè½¬ï¼š`nextStepIndex = currentStepIndex + 1`
- é©³å›æ“ä½œï¼šæ ¹æ®å½“å‰æ­¥éª¤æ™ºèƒ½å›é€€
- è‡ªåŠ¨æ¨æ–­çŠ¶æ€ï¼šæ ¹æ®æ­¥éª¤IDæ¨æ–­å¯¹åº”çš„ `HazardStatus`

#### 4. æ›´æ–° `dispatch` æ–¹æ³•
- æ¥æ”¶ `currentStepIndex` å‚æ•°
- è°ƒç”¨æ–°çš„ `getTransition` æ–¹æ³•
- è¿”å› `nextStepIndex` ä¾›è°ƒç”¨æ–¹ä½¿ç”¨

#### 5. æ›´æ–° `useHazardWorkflow` è°ƒç”¨
åœ¨è°ƒç”¨ `HazardDispatchEngine.dispatch` æ—¶ä¼ å…¥å½“å‰æ­¥éª¤ç´¢å¼•ï¼š
```typescript
const result = await HazardDispatchEngine.dispatch({
  hazard,
  action: dispatchAction,
  operator: { id: user?.id || 'system', name: user?.name || 'ç³»ç»Ÿ' },
  workflowSteps: workflowConfig.steps,
  allUsers,
  departments,
  currentStepIndex: hazard.currentStepIndex ?? 0, // ğŸ†• ä¼ å…¥å½“å‰æ­¥éª¤ç´¢å¼•
  comment: payload?.comment || payload?.rejectReason || payload?.extensionReason,
  additionalData: payload
});
```

å¹¶ä½¿ç”¨è¿”å›çš„ `nextStepIndex`ï¼š
```typescript
const nextStepIndex = result.nextStepIndex ?? (hazard.currentStepIndex ?? 0) + 1;
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
é…ç½®æ­¥éª¤ï¼š
1. reportï¼ˆä¸ŠæŠ¥ï¼‰
2. assignï¼ˆæŒ‡æ´¾ï¼‰
3. EHSç¡®è®¤ â† è¢«è·³è¿‡ï¼
4. rectifyï¼ˆæ•´æ”¹ï¼‰
5. verifyï¼ˆéªŒæ”¶ï¼‰

å®é™…æ‰§è¡Œï¼šreport â†’ assign â†’ rectify â†’ verify
```

### ä¿®å¤å
```
é…ç½®æ­¥éª¤ï¼š
1. reportï¼ˆä¸ŠæŠ¥ï¼‰
2. assignï¼ˆæŒ‡æ´¾ï¼‰
3. EHSç¡®è®¤ â† æ­£å¸¸æ‰§è¡Œï¼
4. rectifyï¼ˆæ•´æ”¹ï¼‰
5. verifyï¼ˆéªŒæ”¶ï¼‰

å®é™…æ‰§è¡Œï¼šreport â†’ assign â†’ EHSç¡®è®¤ â†’ rectify â†’ verify
```

## æµ‹è¯•å»ºè®®

1. **åŸºç¡€æµç¨‹æµ‹è¯•**ï¼šåˆ›å»ºä¸€ä¸ªéšæ‚£ï¼ŒéªŒè¯æ˜¯å¦æŒ‰é…ç½®çš„æ­¥éª¤é¡ºåºæµè½¬
2. **è‡ªå®šä¹‰æ­¥éª¤æµ‹è¯•**ï¼šåœ¨é…ç½®ä¸­æ·»åŠ 1-2ä¸ªè‡ªå®šä¹‰æ­¥éª¤ï¼ŒéªŒè¯æ˜¯å¦éƒ½èƒ½æ­£å¸¸æ‰§è¡Œ
3. **é©³å›æµ‹è¯•**ï¼šä»ä¸­é—´æ­¥éª¤é©³å›ï¼ŒéªŒè¯æ˜¯å¦æ­£ç¡®å›é€€åˆ°ä¸Šä¸€æ­¥
4. **å¤„ç†äººåŒ¹é…æµ‹è¯•**ï¼šéªŒè¯æ¯ä¸ªæ­¥éª¤çš„å¤„ç†äººæ˜¯å¦æŒ‰é…ç½®çš„ç­–ç•¥æ­£ç¡®åŒ¹é…
5. **å¹¶å‘æµ‹è¯•**ï¼šå¤šä¸ªéšæ‚£åŒæ—¶æµè½¬ï¼ŒéªŒè¯æ­¥éª¤ç´¢å¼•æ˜¯å¦æ­£ç¡®ç»´æŠ¤

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å­—æ®µ**ï¼šç¡®ä¿ `HazardRecord` ä¸­çš„ `currentStepIndex` å­—æ®µåœ¨åˆ›å»ºéšæ‚£æ—¶æ­£ç¡®åˆå§‹åŒ–ä¸º `0`
2. **å…¼å®¹æ€§**ï¼šä¿®æ”¹åçš„ä»£ç ä¿æŒäº† `currentStep`ï¼ˆæ­¥éª¤IDï¼‰çš„è¿”å›ï¼Œç¡®ä¿å‘åå…¼å®¹
3. **æ—¥å¿—è¾“å‡º**ï¼šæ–°å¢äº†è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•æµç¨‹æµè½¬é—®é¢˜
4. **çŠ¶æ€æ¨æ–­**ï¼šè‡ªå®šä¹‰æ­¥éª¤çš„çŠ¶æ€é»˜è®¤æ¨æ–­ä¸º `assigned`ï¼Œè¿™åœ¨ UI å±•ç¤ºæ—¶å¯èƒ½éœ€è¦é¢å¤–å¤„ç†

## ç›¸å…³æ–‡ä»¶

- `src/services/hazardDispatchEngine.ts` - æ´¾å‘å¼•æ“æ ¸å¿ƒé€»è¾‘
- `src/app/hidden-danger/_hooks/useHazardWorkflow.ts` - å·¥ä½œæµ Hook
- `data/hazard-workflow.json` - å·¥ä½œæµé…ç½®æ–‡ä»¶
- `src/types/hidden-danger.d.ts` - ç±»å‹å®šä¹‰

## ä¿®å¤æ—¥æœŸ
2026-01-02
