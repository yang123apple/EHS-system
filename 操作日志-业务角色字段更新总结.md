# 操作日志系统 - 业务角色字段更新总结

## 📋 更新内容

### 新增字段: `userRoleInAction`

在所有操作日志中,现在**必须**包含用户在本次操作中的业务角色信息。

## ✅ 已完成的改动

### 1. 数据库层 ✅
- ✅ 在 `SystemLog` 表中添加 `userRoleInAction` 字段
- ✅ 执行数据库迁移: `20260102163456_add_user_role_in_action_to_system_log`
- ✅ 生成 Prisma Client

### 2. 服务层 ✅
- ✅ 更新 `SystemLogData` 接口,添加 `userRoleInAction` 字段
- ✅ 更新 `SystemLogService.createLog()` 方法
- ✅ 更新 `SystemLogService.createBatchLogs()` 方法

### 3. 工具层 ✅
- ✅ 更新 `ActivityLogger.logCreate()` - 添加 `roleInAction` 参数
- ✅ 更新 `ActivityLogger.logUpdate()` - 添加 `roleInAction` 参数
- ✅ 更新 `ActivityLogger.logDelete()` - 添加 `roleInAction` 参数
- ✅ 更新 `ActivityLogger.logApproval()` - 添加 `roleInAction` 参数
- ✅ 更新 `ActivityLogger.logExport()` - 添加 `roleInAction` 参数
- ✅ 更新 `ActivityLogger.logImport()` - 添加 `roleInAction` 参数
- ✅ 更新 `ActivityLogger.logAction()` - 添加 `roleInAction` 参数

### 4. UI层 ✅
- ✅ 更新 `ActivityLogViewer` 组件
  - 日志列表中突出显示业务角色
  - 详情弹窗中显示业务角色信息
  - 区分系统角色和业务角色

### 5. 文档 ✅
- ✅ 创建 `操作日志-用户角色字段使用说明.md` - 详细使用指南
- ✅ 更新 `操作日志系统-README.md` - 添加新字段说明
- ✅ 更新 `操作日志快速开始.md` - 添加使用示例

## 🎯 核心概念

### 字段对比

| 字段 | 含义 | 来源 | 示例 |
|------|------|------|------|
| `userRole` | 系统角色 | 自动获取 | `"admin"`, `"user"`, `"manager"` |
| `userRoleInAction` | 业务角色 | **手动指定** | `"上报人"`, `"整改责任人"`, `"验收人"` |
| `userDepartment` | 用户部门 | 自动获取 | `"生产部"`, `"安全管理部"` |
| `userJobTitle` | 用户职务 | 自动获取 | `"班组长"`, `"安全主管"` |

### 为什么需要 roleInAction?

**问题**: 系统角色(`userRole`)只能表示用户在系统中的权限级别,无法体现用户在具体业务流程中的职责。

**解决**: 通过 `userRoleInAction` 明确记录用户在本次操作中的业务角色:
- 同一个用户可能在不同操作中担任不同角色
- 例如: 一个`"user"`可以是某个隐患的`"上报人"`,同时是另一个隐患的`"整改责任人"`

## 📝 使用示例

### 基础示例

```typescript
import { ActivityLogger, Modules } from '@/utils/activityLogger';

// ❌ 旧写法 - 缺少业务角色
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  data: hazard,
  request,
});

// ✅ 新写法 - 包含业务角色
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  data: hazard,
  roleInAction: '上报人',  // ⭐ 必须指定
  request,
});
```

### 隐患管理完整示例

```typescript
// 1. 上报隐患
await ActivityLogger.logCreate({
  userId: reporter.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  targetLabel: `隐患 ${hazard.code}`,
  data: hazard,
  roleInAction: '上报人',
  request,
});

// 2. 派发隐患
await ActivityLogger.logUpdate({
  userId: dispatcher.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  targetLabel: `隐患 ${hazard.code}`,
  beforeData: oldHazard,
  afterData: updatedHazard,
  roleInAction: '派发人',
  request,
});

// 3. 整改提交
await ActivityLogger.logUpdate({
  userId: rectifier.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  targetLabel: `隐患 ${hazard.code}`,
  beforeData: beforeRectify,
  afterData: afterRectify,
  roleInAction: '整改责任人',
  request,
});

// 4. 验收
await ActivityLogger.logApproval({
  userId: verifier.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,
  targetLabel: `隐患 ${hazard.code}`,
  action: 'APPROVE',
  comment: '整改措施到位,验收通过',
  beforeStatus: 'RECTIFIED',
  afterStatus: 'VERIFIED',
  roleInAction: '验收人',
  request,
});
```

## 🔍 日志查看效果

### 列表视图
```
┌─────────────────────────────────────────────────┐
│ 🟢 新增  hazard  2026-01-03 16:45:23           │
│                                                  │
│ 👤 张三  [上报人]  系统角色:user                │
│    部门:生产部  职位:班组长                     │
│                                                  │
│ 隐患 HZ-2024-001 创建了新隐患                   │
└─────────────────────────────────────────────────┘
```

### 详情视图
```
操作人信息
┌────────────────────────────────────┐
│ 姓名: 张三                          │
│ 操作角色: [上报人]                  │
│ 系统角色: user                      │
│ 部门: 生产部                        │
│ 职位: 班组长                        │
└────────────────────────────────────┘
```

## 📊 常用业务角色清单

### 隐患管理
- `"上报人"` - 发现并上报隐患
- `"派发人"` - 分配整改责任
- `"整改责任人"` - 负责整改
- `"验收人"` - 验收整改结果
- `"复核人"` - 二次验收

### 作业票管理
- `"申请人"` - 申请作业票
- `"审批人"` - 审批作业票
- `"安全审批人"` - 安全专项审批
- `"签发人"` - 签发作业票
- `"监护人"` - 现场监护
- `"作业负责人"` - 作业现场负责人
- `"验收人"` - 作业完成验收

### 培训管理
- `"培训发布人"` - 发布培训任务
- `"学员"` - 参加培训
- `"考核人"` - 培训考核评分

### 文档管理
- `"上传人"` - 上传文档
- `"审核人"` - 审核文档
- `"归档人"` - 文档归档
- `"下载人"` - 下载文档

## ⚠️ 迁移现有代码

### 查找需要更新的代码

```powershell
# 在项目中查找所有调用 ActivityLogger 的地方
grep -r "ActivityLogger\." src/
```

### 更新步骤

1. 找到所有 `ActivityLogger.logXxx()` 的调用
2. 根据业务场景添加 `roleInAction` 参数
3. 参考常用业务角色清单选择合适的角色名称
4. 测试确保日志正确记录

### 向后兼容

- ✅ `roleInAction` 为可选参数,不会破坏现有代码
- ✅ 如果不指定,该字段为 `null`
- ⚠️ 但强烈建议在所有业务操作中指定该字段

## 📚 相关文档

- **[操作日志-用户角色字段使用说明.md](./操作日志-用户角色字段使用说明.md)** - 详细的使用指南和FAQ
- **[操作日志快速开始.md](./操作日志快速开始.md)** - 快速入门示例
- **[操作日志系统使用指南.md](./操作日志系统使用指南.md)** - 完整API文档
- **[操作日志集成示例.md](./操作日志集成示例.md)** - 实战集成案例

## 🎯 检查清单

在记录操作日志时,请确保:

- [x] **用户部门** - ✅ 自动获取
- [x] **用户职务** - ✅ 自动获取
- [x] **系统角色** - ✅ 自动获取
- [x] **业务角色** - ⚠️ **需要手动指定** `roleInAction`
- [x] **操作前后状态** - ✅ 通过 `beforeData`/`afterData` 自动对比

## 🚀 下一步

1. **更新现有代码**: 在所有业务操作日志中添加 `roleInAction` 参数
2. **统一角色命名**: 确保同类操作使用统一的角色名称
3. **审计追溯**: 利用新字段进行更精确的操作审计和追溯

---

**更新日期**: 2026-01-03  
**版本**: v2.0  
**迁移文件**: `20260102163456_add_user_role_in_action_to_system_log`
