# æˆ–ç­¾åŠŸèƒ½é”™è¯¯ä¿®å¤è¯´æ˜

## é”™è¯¯æè¿°
åœ¨æµ‹è¯•æˆ–ç­¾åŠŸèƒ½æ—¶ï¼Œé‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š
```
ApiError: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
at ApiClient.handleResponseError (src/lib/apiClient.ts:111:11)
at async ApiClient.patch (src/lib/apiClient.ts:183:7)
at async processAction
```

## é”™è¯¯åŸå› 
æ–°æ·»åŠ çš„ `candidateHandlers` å­—æ®µï¼ˆç”¨äºå­˜å‚¨æˆ–ç­¾æ¨¡å¼ä¸‹çš„å€™é€‰å¤„ç†äººåˆ—è¡¨ï¼‰åœ¨ä»¥ä¸‹ç¯èŠ‚ç¼ºå°‘å¤„ç†ï¼š

1. **æ•°æ®åº“Schemaç¼ºå¤±**ï¼šPrisma schema ä¸­æ²¡æœ‰å®šä¹‰ `candidateHandlers` å­—æ®µ
2. **APIåºåˆ—åŒ–ç¼ºå¤±**ï¼šPATCH API ä¸­æ²¡æœ‰å¤„ç† `candidateHandlers` æ•°ç»„çš„JSONåºåˆ—åŒ–
3. **APIååºåˆ—åŒ–ç¼ºå¤±**ï¼šmapHazard å‡½æ•°ä¸­æ²¡æœ‰ååºåˆ—åŒ– `candidateHandlers` å­—æ®µ

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ›´æ–°Prisma Schema
åœ¨ `prisma/schema.prisma` ä¸­æ·»åŠ å­—æ®µï¼š
```prisma
model HazardRecord {
  // ... å…¶ä»–å­—æ®µ
  candidateHandlers     String?   // ğŸŸ¢ æˆ–ç­¾æ¨¡å¼ï¼šå€™é€‰å¤„ç†äººåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
  // ...
}
```

### 2. æ›´æ–°API PATCHå¤„ç†
åœ¨ `src/app/api/hazards/route.ts` çš„ PATCH æ–¹æ³•ä¸­ï¼š

#### 2.1 è§£æ„æ—¶æå–å­—æ®µ
```typescript
const { 
  // ... å…¶ä»–å­—æ®µ
  candidateHandlers: candidateHandlersInput, // ğŸŸ¢ æ–°å¢
  ...updates 
} = body;
```

#### 2.2 æ·»åŠ åºåˆ—åŒ–å¤„ç†
```typescript
// ğŸŸ¢ æ–°å¢ï¼šå¤„ç†å€™é€‰å¤„ç†äººåˆ—è¡¨ï¼ˆæˆ–ç­¾æ¨¡å¼ï¼‰
if (candidateHandlersInput !== undefined) {
  if (candidateHandlersInput === null) {
    finalUpdates.candidateHandlers = null;
  } else {
    finalUpdates.candidateHandlers = Array.isArray(candidateHandlersInput) 
      ? JSON.stringify(candidateHandlersInput) 
      : candidateHandlersInput;
  }
}
```

### 3. æ›´æ–°mapHazardååºåˆ—åŒ–
åœ¨ `mapHazard` å‡½æ•°ä¸­æ·»åŠ ï¼š
```typescript
function mapHazard(pHazard: any): HazardRecord {
  try {
    return {
      ...pHazard,
      // ... å…¶ä»–å­—æ®µ
      // ğŸŸ¢ æ–°å¢ï¼šå¤„ç†å€™é€‰å¤„ç†äººåˆ—è¡¨ï¼ˆæˆ–ç­¾æ¨¡å¼ï¼‰
      candidateHandlers: pHazard.candidateHandlers 
        ? (typeof pHazard.candidateHandlers === 'string' 
            ? JSON.parse(pHazard.candidateHandlers) 
            : pHazard.candidateHandlers) 
        : undefined,
      // ...
    };
  } catch (error) {
    // ... é”™è¯¯å¤„ç†
    return {
      ...pHazard,
      candidateHandlers: Array.isArray(pHazard.candidateHandlers) 
        ? pHazard.candidateHandlers 
        : undefined,
    };
  }
}
```

### 4. è¿è¡Œæ•°æ®åº“è¿ç§»
```bash
npx prisma migrate dev --name add_candidate_handlers
```

## ä¿®æ”¹æ–‡ä»¶æ¸…å•
1. âœ… `prisma/schema.prisma` - æ·»åŠ  candidateHandlers å­—æ®µ
2. âœ… `src/app/api/hazards/route.ts` - PATCHæ–¹æ³•åºåˆ—åŒ–å¤„ç†
3. âœ… `src/app/api/hazards/route.ts` - mapHazardååºåˆ—åŒ–å¤„ç†
4. âœ… è¿è¡Œæ•°æ®åº“è¿ç§» - åˆ›å»º migration æ–‡ä»¶

## æ•°æ®ç»“æ„è¯´æ˜

### candidateHandlers å­—æ®µæ ¼å¼
```typescript
candidateHandlers?: Array<{
  userId: string;
  userName: string;
  hasOperated?: boolean; // æ˜¯å¦å·²æ“ä½œ
}>
```

### å­˜å‚¨æ ¼å¼
æ•°æ®åº“ä¸­å­˜å‚¨ä¸ºJSONå­—ç¬¦ä¸²ï¼š
```json
"[{\"userId\":\"user1\",\"userName\":\"å¼ ä¸‰\",\"hasOperated\":false},{\"userId\":\"user2\",\"userName\":\"æå››\",\"hasOperated\":false}]"
```

### ä½¿ç”¨åœºæ™¯
1. **è®¾ç½®å€™é€‰äºº**ï¼šæµç¨‹æ´¾å‘æ—¶ï¼Œå¦‚æœæ˜¯ORæ¨¡å¼ä¸”æœ‰å¤šä¸ªå¤„ç†äººï¼Œè®¾ç½®æ­¤å­—æ®µ
2. **æ ‡è®°æ“ä½œ**ï¼šæŸä¸ªå€™é€‰äººå®Œæˆæ“ä½œåï¼Œå°†å…¶ `hasOperated` æ ‡è®°ä¸º true
3. **æƒé™æ£€æŸ¥**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å€™é€‰äººåˆ—è¡¨ä¸­ï¼Œä¸”æ˜¯å¦è¿˜æœªæœ‰äººæ“ä½œ
4. **æ¸…é™¤å€™é€‰äºº**ï¼šæµç¨‹è¿›å…¥ä¸‹ä¸€æ­¥æ—¶ï¼Œæ¸…é™¤æ­¤å­—æ®µï¼ˆè®¾ä¸º undefined æˆ– nullï¼‰

## æµ‹è¯•éªŒè¯

### 1. åˆ›å»ºæˆ–ç­¾åœºæ™¯
- é…ç½®å·¥ä½œæµæ­¥éª¤ä¸ºORæ¨¡å¼
- æ·»åŠ å¤šä¸ªå¤„ç†äººï¼ˆå¦‚éªŒæ”¶äººï¼šå¼ ä¸‰ã€æå››ã€ç‹äº”ï¼‰
- éšæ‚£æµè½¬åˆ°è¯¥æ­¥éª¤

### 2. éªŒè¯æ•°æ®å­˜å‚¨
æ£€æŸ¥æ•°æ®åº“ä¸­çš„ `candidateHandlers` å­—æ®µï¼š
```sql
SELECT id, code, candidateHandlers FROM HazardRecord WHERE id = 'xxx';
```

åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
```
[{"userId":"user1","userName":"å¼ ä¸‰","hasOperated":false},{"userId":"user2","userName":"æå››","hasOperated":false}]
```

### 3. éªŒè¯æ“ä½œæ ‡è®°
å¼ ä¸‰å®Œæˆæ“ä½œåï¼Œæ£€æŸ¥æ•°æ®ï¼š
```
[{"userId":"user1","userName":"å¼ ä¸‰","hasOperated":true},{"userId":"user2","userName":"æå››","hasOperated":false}]
```

### 4. éªŒè¯æƒé™æ£€æŸ¥
- å¼ ä¸‰æ“ä½œåï¼Œæå››åº”è¯¥æ— æ³•å†æ“ä½œ
- å‰ç«¯åº”æ˜¾ç¤º"å·²æœ‰äººå¤„ç†"æç¤º

## æ³¨æ„äº‹é¡¹

1. **NULL vs undefined**ï¼š
   - æ¸…é™¤å€™é€‰äººåˆ—è¡¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `null` æˆ– `undefined`
   - åºåˆ—åŒ–æ—¶éœ€è¦ç‰¹æ®Šå¤„ç† `null` å€¼

2. **æ•°ç»„éªŒè¯**ï¼š
   - å§‹ç»ˆéªŒè¯ `candidateHandlers` æ˜¯å¦ä¸ºæ•°ç»„
   - å¤„ç†å¯èƒ½çš„ç©ºæ•°ç»„æƒ…å†µ

3. **å‘åå…¼å®¹**ï¼š
   - æ—§æ•°æ®å¯èƒ½æ²¡æœ‰ `candidateHandlers` å­—æ®µ
   - éœ€è¦ä¼˜é›…åœ°å¤„ç† `undefined` æƒ…å†µ

4. **å¹¶å‘æ§åˆ¶**ï¼š
   - å¤šäººåŒæ—¶æ“ä½œæ—¶ï¼Œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
   - ç¬¬ä¸€ä¸ªæˆåŠŸçš„æ“ä½œæ ‡è®° `hasOperated`

## ç›¸å…³æ–‡æ¡£
- `æˆ–ç­¾åŠŸèƒ½ä¿®å¤æ€»ç»“.md` - å®Œæ•´çš„æˆ–ç­¾åŠŸèƒ½å®ç°è¯´æ˜
- `æ“ä½œæ—¥å¿—-æˆ–ç­¾æ¨¡å¼å¤„ç†æŒ‡å—.md` - æˆ–ç­¾æ¨¡å¼çš„è¯¦ç»†æŒ‡å—

## ä¿®å¤æ—¶é—´
2026å¹´1æœˆ2æ—¥

## ä¿®å¤çŠ¶æ€
âœ… å·²å®Œæˆ
- Schemaæ›´æ–°å®Œæˆ
- APIåºåˆ—åŒ–/ååºåˆ—åŒ–å®Œæˆ
- æ•°æ®åº“è¿ç§»å®Œæˆ
- å¯ä»¥æ­£å¸¸ä¿å­˜å’Œè¯»å–candidateHandlersæ•°æ®
