# å¤‡ä»½æ¢å¤æ“ä½œæŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨å¤‡ä»½æ¥æ¢å¤ EHS ç³»ç»Ÿã€‚

## ğŸ“‹ ç›®å½•

1. [å¤‡ä»½ç±»å‹è¯´æ˜](#å¤‡ä»½ç±»å‹è¯´æ˜)
2. [å…¨é‡å¤‡ä»½æ¢å¤](#å…¨é‡å¤‡ä»½æ¢å¤)
3. [æ•°æ®åº“å¢é‡å¤‡ä»½æ¢å¤](#æ•°æ®åº“å¢é‡å¤‡ä»½æ¢å¤)
4. [æ–‡ä»¶å¢é‡å¤‡ä»½æ¢å¤](#æ–‡ä»¶å¢é‡å¤‡ä»½æ¢å¤)
5. [æ—¥å¿—å½’æ¡£æ¢å¤](#æ—¥å¿—å½’æ¡£æ¢å¤)
6. [æ¢å¤å‰å‡†å¤‡](#æ¢å¤å‰å‡†å¤‡)
7. [æ¢å¤åéªŒè¯](#æ¢å¤åéªŒè¯)

---

## å¤‡ä»½ç±»å‹è¯´æ˜

ç³»ç»Ÿæ”¯æŒä»¥ä¸‹å¤‡ä»½ç±»å‹ï¼š

### 1. å…¨é‡å¤‡ä»½ï¼ˆZIPï¼‰
- **ä½ç½®**: `data/backups/full_backup_*.zip`
- **å†…å®¹**: æ•°æ®åº“ + ä¸Šä¼ æ–‡ä»¶ + é…ç½®æ–‡ä»¶
- **ç”¨é€”**: å®Œæ•´ç³»ç»Ÿæ¢å¤

### 2. æ•°æ®åº“å…¨é‡å¤‡ä»½
- **ä½ç½®**: `data/backups/database/full/*.db`
- **å†…å®¹**: å®Œæ•´çš„æ•°æ®åº“æ–‡ä»¶
- **ç”¨é€”**: æ¢å¤æ•´ä¸ªæ•°æ®åº“

### 3. æ•°æ®åº“å¢é‡å¤‡ä»½ï¼ˆWALï¼‰
- **ä½ç½®**: `data/backups/database/incremental/*.db-wal`
- **å†…å®¹**: SQLite WAL æ–‡ä»¶ï¼ˆå¢é‡æ•°æ®ï¼‰
- **ç”¨é€”**: æ¢å¤æ•°æ®åº“çš„å¢é‡æ•°æ®

### 4. æ–‡ä»¶å…¨é‡å¤‡ä»½
- **ä½ç½®**: `data/backups/files/full/*.zip`
- **å†…å®¹**: æ‰€æœ‰ä¸Šä¼ æ–‡ä»¶çš„å‹ç¼©åŒ…
- **ç”¨é€”**: æ¢å¤æ‰€æœ‰ä¸Šä¼ æ–‡ä»¶

### 5. æ–‡ä»¶å¢é‡å¤‡ä»½
- **ä½ç½®**: `data/backups/files/incremental/*.zip`
- **å†…å®¹**: æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶
- **ç”¨é€”**: æ¢å¤æ–°å¢çš„æ–‡ä»¶

### 6. æ—¥å¿—å½’æ¡£
- **ä½ç½®**: `data/backups/logs/archives/*.zip`
- **å†…å®¹**: å½’æ¡£çš„æ—¥å¿—æ–‡ä»¶
- **ç”¨é€”**: æŸ¥çœ‹å†å²æ—¥å¿—

---

## å…¨é‡å¤‡ä»½æ¢å¤

### æ–¹æ³• 1: ä½¿ç”¨æ¢å¤è„šæœ¬ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1: æŸ¥çœ‹å¯ç”¨å¤‡ä»½

```bash
npm run restore:full
```

æˆ–ç›´æ¥è¿è¡Œï¼š

```bash
node scripts/restore-backup.js
```

è¿™ä¼šåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„å…¨é‡å¤‡ä»½æ–‡ä»¶ã€‚

#### æ­¥éª¤ 2: é€‰æ‹©å¹¶æ¢å¤å¤‡ä»½

```bash
npm run restore:full <å¤‡ä»½æ–‡ä»¶å>
```

ç¤ºä¾‹ï¼š

```bash
npm run restore:full full_backup_2026-01-06_14-30-00.zip
```

æˆ–ç›´æ¥è¿è¡Œï¼š

```bash
node scripts/restore-backup.js full_backup_2026-01-06_14-30-00.zip
```

#### æ­¥éª¤ 3: ç¡®è®¤æ¢å¤

è„šæœ¬ä¼šæç¤ºç¡®è®¤ï¼Œè¾“å…¥ `yes` ç»§ç»­ã€‚

#### æ¢å¤å†…å®¹

- âœ… æ•°æ®åº“æ–‡ä»¶ï¼ˆ`prisma/dev.db`ï¼‰
- âœ… ä¸Šä¼ æ–‡ä»¶ï¼ˆ`public/uploads/`ï¼‰
- âš ï¸ é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦æ‰‹åŠ¨æ£€æŸ¥ï¼‰

#### æ³¨æ„äº‹é¡¹

1. **è‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®**: æ¢å¤å‰ä¼šè‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®åº“å’Œä¸Šä¼ æ–‡ä»¶
2. **éœ€è¦é‡å¯åº”ç”¨**: æ¢å¤åéœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ä½¿ç”¨æ¢å¤çš„æ•°æ®
3. **é…ç½®æ–‡ä»¶**: é…ç½®æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨æ¢å¤ï¼Œéœ€è¦æ‰‹åŠ¨æ£€æŸ¥

---

## æ•°æ®åº“å¢é‡å¤‡ä»½æ¢å¤

### æ¢å¤æ­¥éª¤

#### æ­¥éª¤ 1: åœæ­¢åº”ç”¨

```bash
# åœæ­¢æ­£åœ¨è¿è¡Œçš„åº”ç”¨
# æŒ‰ Ctrl+C æˆ–å…³é—­ç»ˆç«¯
```

#### æ­¥éª¤ 2: æ‰¾åˆ°æœ€æ–°çš„æ•°æ®åº“å…¨é‡å¤‡ä»½

```bash
# æŸ¥çœ‹æ•°æ®åº“å…¨é‡å¤‡ä»½
ls -lh data/backups/database/full/
```

#### æ­¥éª¤ 3: æ¢å¤æ•°æ®åº“å…¨é‡å¤‡ä»½

```bash
# å¤‡ä»½å½“å‰æ•°æ®åº“ï¼ˆå¯é€‰ä½†æ¨èï¼‰
cp prisma/dev.db prisma/dev.db.backup

# å¤åˆ¶å…¨é‡å¤‡ä»½åˆ°æ•°æ®åº“ä½ç½®
cp data/backups/database/full/<æœ€æ–°å¤‡ä»½æ–‡ä»¶å> prisma/dev.db

# åˆ é™¤ WAL æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
rm -f prisma/dev.db-wal
rm -f prisma/dev.db-shm
```

**Windows:**

```cmd
copy prisma\dev.db prisma\dev.db.backup
copy data\backups\database\full\<æœ€æ–°å¤‡ä»½æ–‡ä»¶å> prisma\dev.db
del prisma\dev.db-wal
del prisma\dev.db-shm
```

#### æ­¥éª¤ 4: åº”ç”¨å¢é‡å¤‡ä»½ï¼ˆå¯é€‰ï¼‰

å¦‚æœæœ‰å¢é‡å¤‡ä»½ï¼ŒæŒ‰æ—¶é—´é¡ºåºåº”ç”¨ï¼š

```bash
# 1. å¤åˆ¶æœ€æ–°çš„ WAL æ–‡ä»¶
cp data/backups/database/incremental/<æœ€æ–°WALæ–‡ä»¶> prisma/dev.db-wal

# 2. é‡å¯åº”ç”¨ï¼ŒSQLite ä¼šè‡ªåŠ¨åº”ç”¨ WAL æ–‡ä»¶
# 3. åº”ç”¨å®Œæˆåï¼Œæ‰§è¡Œ checkpoint å°† WAL åˆå¹¶åˆ°ä¸»æ•°æ®åº“
```

**æ³¨æ„**: SQLite ä¼šåœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨åº”ç”¨ WAL æ–‡ä»¶ã€‚

#### æ­¥éª¤ 5: æ‰§è¡Œ WAL Checkpointï¼ˆåˆå¹¶å¢é‡æ•°æ®ï¼‰

å¯åŠ¨åº”ç”¨åï¼Œè¿è¡Œï¼š

```bash
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.\$queryRaw\`PRAGMA wal_checkpoint(TRUNCATE)\`.then(() => { console.log('âœ“ WAL checkpoint å®Œæˆ'); process.exit(0); });"
```

æˆ–ä½¿ç”¨æ•°æ®åº“ä¿®å¤å·¥å…·ï¼š

```bash
node db-repair-tool.js checkpoint
```

---

## æ–‡ä»¶å¢é‡å¤‡ä»½æ¢å¤

### æ¢å¤æ­¥éª¤

#### æ­¥éª¤ 1: æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶

```bash
# æŸ¥çœ‹æ–‡ä»¶å¤‡ä»½
ls -lh data/backups/files/full/      # å…¨é‡å¤‡ä»½
ls -lh data/backups/files/incremental/  # å¢é‡å¤‡ä»½
```

#### æ­¥éª¤ 2: æ¢å¤å…¨é‡å¤‡ä»½ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
# å¤‡ä»½å½“å‰ä¸Šä¼ ç›®å½•
mv public/uploads public/uploads.backup

# è§£å‹å…¨é‡å¤‡ä»½
unzip data/backups/files/full/<å…¨é‡å¤‡ä»½æ–‡ä»¶å> -d public/uploads
```

**Windows:**

```cmd
ren public\uploads public\uploads.backup
powershell Expand-Archive -Path data\backups\files\full\<å…¨é‡å¤‡ä»½æ–‡ä»¶å> -DestinationPath public\uploads
```

#### æ­¥éª¤ 3: åº”ç”¨å¢é‡å¤‡ä»½ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰

```bash
# è§£å‹å¢é‡å¤‡ä»½åˆ°ä¸´æ—¶ç›®å½•
unzip data/backups/files/incremental/<å¢é‡å¤‡ä»½æ–‡ä»¶å> -d temp_incremental

# å¤åˆ¶æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•ï¼ˆè¦†ç›–ï¼‰
cp -r temp_incremental/* public/uploads/

# æ¸…ç†ä¸´æ—¶ç›®å½•
rm -rf temp_incremental
```

**Windows:**

```cmd
powershell Expand-Archive -Path data\backups\files\incremental\<å¢é‡å¤‡ä»½æ–‡ä»¶å> -DestinationPath temp_incremental
xcopy /E /Y temp_incremental\* public\uploads\
rmdir /S /Q temp_incremental
```

---

## æ—¥å¿—å½’æ¡£æ¢å¤

æ—¥å¿—å½’æ¡£ä¸»è¦ç”¨äºæŸ¥çœ‹å†å²æ—¥å¿—ï¼Œé€šå¸¸ä¸éœ€è¦æ¢å¤ã€‚

### æŸ¥çœ‹å½’æ¡£æ—¥å¿—

```bash
# è§£å‹å½’æ¡£æ–‡ä»¶
unzip data/backups/logs/archives/<å½’æ¡£æ–‡ä»¶å> -d temp_logs

# æŸ¥çœ‹æ—¥å¿—
cat temp_logs/*.log

# æ¸…ç†ä¸´æ—¶ç›®å½•
rm -rf temp_logs
```

---

## æ¢å¤å‰å‡†å¤‡

### 1. åœæ­¢åº”ç”¨

ç¡®ä¿åº”ç”¨å·²å®Œå…¨åœæ­¢ï¼Œé¿å…æ•°æ®å†²çªã€‚

### 2. å¤‡ä»½å½“å‰æ•°æ®ï¼ˆé‡è¦ï¼ï¼‰

æ¢å¤å‰åŠ¡å¿…å¤‡ä»½å½“å‰æ•°æ®ï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
cp prisma/dev.db prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
cp -r public/uploads public/uploads.backup.$(date +%Y%m%d_%H%M%S)
```

**Windows:**

```cmd
copy prisma\dev.db prisma\dev.db.backup.%date:~0,4%%date:~5,2%%date:~8,2%
xcopy /E /I public\uploads public\uploads.backup.%date:~0,4%%date:~5,2%%date:~8,2%
```

### 3. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶

```bash
# éªŒè¯å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å®Œæ•´
ls -lh data/backups/
```

### 4. ç¡®è®¤æ¢å¤ç‚¹

é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½æ—¶é—´ç‚¹ï¼Œç¡®ä¿è¯¥æ—¶é—´ç‚¹çš„æ•°æ®æ˜¯æ‚¨éœ€è¦çš„ã€‚

---

## æ¢å¤åéªŒè¯

### 1. éªŒè¯æ•°æ®åº“

```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
ls -lh prisma/dev.db

# éªŒè¯æ•°æ®åº“å®Œæ•´æ€§
node db-repair-tool.js check
```

### 2. éªŒè¯ä¸Šä¼ æ–‡ä»¶

```bash
# æ£€æŸ¥ä¸Šä¼ ç›®å½•
ls -lh public/uploads/

# ç»Ÿè®¡æ–‡ä»¶æ•°é‡
find public/uploads -type f | wc -l
```

### 3. å¯åŠ¨åº”ç”¨å¹¶æµ‹è¯•

```bash
npm run dev
```

æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š
- âœ… ç™»å½•åŠŸèƒ½
- âœ… æ•°æ®æŸ¥è¯¢
- âœ… æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½
- âœ… å…³é”®ä¸šåŠ¡æµç¨‹

### 4. æ£€æŸ¥æ—¥å¿—

æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œç¡®è®¤æ²¡æœ‰é”™è¯¯ï¼š

```bash
# æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
# æˆ–æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
cat logs/*.log
```

---

## å¿«é€Ÿæ¢å¤å‘½ä»¤å‚è€ƒ

### å…¨é‡æ¢å¤ï¼ˆæœ€ç®€å•ï¼‰

```bash
# 1. æŸ¥çœ‹å¯ç”¨å¤‡ä»½
npm run restore:full

# 2. æ¢å¤æŒ‡å®šå¤‡ä»½
npm run restore:full <å¤‡ä»½æ–‡ä»¶å>
```

### æ•°æ®åº“æ¢å¤

```bash
# 1. åœæ­¢åº”ç”¨
# 2. æ¢å¤æ•°æ®åº“
cp data/backups/database/full/<æœ€æ–°å¤‡ä»½> prisma/dev.db
rm -f prisma/dev.db-wal prisma/dev.db-shm

# 3. åº”ç”¨å¢é‡å¤‡ä»½ï¼ˆå¦‚æœæœ‰ï¼‰
cp data/backups/database/incremental/<æœ€æ–°WAL> prisma/dev.db-wal

# 4. å¯åŠ¨åº”ç”¨
npm run dev

# 5. æ‰§è¡Œ checkpoint
node db-repair-tool.js checkpoint
```

### æ–‡ä»¶æ¢å¤

```bash
# 1. å¤‡ä»½å½“å‰æ–‡ä»¶
mv public/uploads public/uploads.backup

# 2. æ¢å¤å…¨é‡å¤‡ä»½
unzip data/backups/files/full/<å…¨é‡å¤‡ä»½> -d public/uploads

# 3. åº”ç”¨å¢é‡å¤‡ä»½ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
unzip data/backups/files/incremental/<å¢é‡å¤‡ä»½> -d temp
cp -r temp/* public/uploads/
rm -rf temp
```

---

## å¸¸è§é—®é¢˜

### Q: æ¢å¤åæ•°æ®ä¸å®Œæ•´ï¼Ÿ

**A**: ç¡®ä¿æŒ‰é¡ºåºæ¢å¤ï¼š
1. å…ˆæ¢å¤å…¨é‡å¤‡ä»½
2. å†æŒ‰æ—¶é—´é¡ºåºåº”ç”¨å¢é‡å¤‡ä»½

### Q: æ¢å¤ååº”ç”¨æ— æ³•å¯åŠ¨ï¼Ÿ

**A**: 
1. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
2. éªŒè¯æ•°æ®åº“å®Œæ•´æ€§ï¼š`node db-repair-tool.js check`
3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—é”™è¯¯ä¿¡æ¯

### Q: å¦‚ä½•æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹ï¼Ÿ

**A**: 
1. æ‰¾åˆ°è¯¥æ—¶é—´ç‚¹ä¹‹å‰çš„æœ€æ–°å…¨é‡å¤‡ä»½
2. æ¢å¤å…¨é‡å¤‡ä»½
3. æŒ‰æ—¶é—´é¡ºåºåº”ç”¨è¯¥æ—¶é—´ç‚¹ä¹‹å‰çš„æ‰€æœ‰å¢é‡å¤‡ä»½

### Q: å¢é‡å¤‡ä»½å¦‚ä½•åº”ç”¨ï¼Ÿ

**A**: 
- **æ•°æ®åº“å¢é‡å¤‡ä»½ï¼ˆWALï¼‰**: SQLite ä¼šè‡ªåŠ¨åº”ç”¨ï¼Œåªéœ€å¤åˆ¶ WAL æ–‡ä»¶å¹¶é‡å¯åº”ç”¨
- **æ–‡ä»¶å¢é‡å¤‡ä»½**: éœ€è¦æ‰‹åŠ¨è§£å‹å¹¶å¤åˆ¶åˆ°ç›®æ ‡ç›®å½•

---

## æ¢å¤è„šæœ¬ä½ç½®

- **å…¨é‡æ¢å¤**: `scripts/restore-backup.js`
- **æ•°æ®åº“ä¿®å¤**: `db-repair-tool.js`
- **ä» Git æ¢å¤**: `scripts/restore-from-git.js`

---

## é‡è¦æç¤º

âš ï¸ **æ¢å¤æ“ä½œä¼šè¦†ç›–å½“å‰æ•°æ®ï¼Œè¯·åŠ¡å¿…ï¼š**

1. âœ… æ¢å¤å‰å¤‡ä»½å½“å‰æ•°æ®
2. âœ… ç¡®è®¤æ¢å¤çš„å¤‡ä»½æ–‡ä»¶æ­£ç¡®
3. âœ… åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯æ¢å¤æµç¨‹
4. âœ… æ¢å¤åéªŒè¯æ•°æ®å®Œæ•´æ€§
5. âœ… ä¿ç•™æ¢å¤å‰çš„å¤‡ä»½è‡³å°‘ 7 å¤©

---

## è·å–å¸®åŠ©

å¦‚æœæ¢å¤è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š`logs/` ç›®å½•
2. è¿è¡Œæ•°æ®åº“æ£€æŸ¥ï¼š`node db-repair-tool.js check`
3. æŸ¥çœ‹å¤‡ä»½çŠ¶æ€ï¼šè®¿é—® `/admin/system/backup` é¡µé¢
4. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶ï¼š`data/backups/` ç›®å½•

