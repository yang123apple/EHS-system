# 或签显示优化说明

## 修改内容
优化隐患详情页面的"当前处理人"显示逻辑，支持显示所有或签候选人的名字。

## 修改位置
**文件**: `src/app/hidden-danger/_components/modals/HazardDetailModal/index.tsx`

## 修改逻辑

### 显示规则（按优先级）
1. **或签模式** - 如果存在 `candidateHandlers` 数组且长度 > 0
   - 显示文本：`当前处理人（或签）：`
   - 显示内容：所有候选人名字，用顿号分隔
   - 示例：`张三、李四、王五`

2. **单人模式** - 如果只有 `dopersonal_Name` 
   - 显示文本：`当前处理人：`
   - 显示内容：单个处理人名字
   - 示例：`张三`

3. **无处理人** - 两者都没有
   - 不显示

### 修改前后对比

#### 修改前
```tsx
{hazard.dopersonal_Name && (
  <div className="col-span-1 lg:col-span-2">
    <p className="text-slate-500">
      当前处理人：
      <span className="text-blue-600 font-bold ml-1">{hazard.dopersonal_Name}</span>
    </p>
  </div>
)}
```
**问题**：只显示第一个处理人（dopersonal_Name），或签模式下其他候选人看不到自己的名字

#### 修改后
```tsx
{(hazard.candidateHandlers && hazard.candidateHandlers.length > 0) ? (
  <div className="col-span-1 lg:col-span-2">
    <p className="text-slate-500">
      当前处理人（或签）：
      <span className="text-blue-600 font-bold ml-1">
        {hazard.candidateHandlers.map((h: any) => h.userName).join('、')}
      </span>
    </p>
  </div>
) : hazard.dopersonal_Name ? (
  <div className="col-span-1 lg:col-span-2">
    <p className="text-slate-500">
      当前处理人：
      <span className="text-blue-600 font-bold ml-1">{hazard.dopersonal_Name}</span>
    </p>
  </div>
) : null}
```
**改进**：
- ✅ 或签模式显示所有候选人
- ✅ 添加"（或签）"标识
- ✅ 向后兼容单人模式

## 显示示例

### 场景1：或签模式（3个候选验收人）
```
当前处理人（或签）：张三、李四、王五
```

### 场景2：或签模式（2个候选验收人）
```
当前处理人（或签）：安全员A、安全员B
```

### 场景3：单人模式
```
当前处理人：张三
```

### 场景4：待指派状态
```
（不显示当前处理人）
```

## 修改位置详情

### 位置1：隐患基本信息区域
**代码行数**：约第116行
**显示位置**：隐患详情左侧面板，基本信息下方
**用途**：显示隐患的当前处理人信息

### 位置2：流程处理区域
**代码行数**：约第169行
**显示位置**：隐患详情右侧面板，"流程处理"标题下方
**用途**：显示当前步骤的处理人信息

## 用户体验改进

### 或签候选人的视角
**修改前**：
- 张三看到：当前处理人：张三 ✅
- 李四看到：当前处理人：张三 ❌（看不到自己）
- 王五看到：当前处理人：张三 ❌（看不到自己）

**修改后**：
- 张三看到：当前处理人（或签）：张三、李四、王五 ✅
- 李四看到：当前处理人（或签）：张三、李四、王五 ✅
- 王五看到：当前处理人（或签）：张三、李四、王五 ✅

### 优势
1. **明确性**：所有候选人都能看到完整的候选人列表
2. **透明性**：清楚地标识这是"或签"模式
3. **一致性**：显示逻辑与权限逻辑保持一致

## 技术细节

### 数据结构
```typescript
// 或签模式
candidateHandlers: [
  {userId: "user1", userName: "张三", hasOperated: false},
  {userId: "user2", userName: "李四", hasOperated: false},
  {userId: "user3", userName: "王五", hasOperated: false}
]

// 单人模式
dopersonal_ID: "user1"
dopersonal_Name: "张三"
```

### 显示逻辑代码
```tsx
// 提取候选人名字并用顿号连接
hazard.candidateHandlers.map((h: any) => h.userName).join('、')
```

## 相关功能

### 不需要修改的地方
1. **HazardCard组件** - 卡片显示的是责任人，不是当前处理人
2. **HazardDataTable组件** - 表格显示的是责任人，不是当前处理人
3. **ProcessingFlow组件** - 显示的是历史日志中的实际操作人

### 需要保持一致的地方
- 权限检查逻辑（permissions.ts）已经支持检查candidateHandlers
- 操作日志记录已经支持记录实际操作人

## 测试要点

### 显示测试
1. ✅ 或签模式下显示所有候选人
2. ✅ 候选人名字用顿号分隔
3. ✅ 显示"（或签）"标识
4. ✅ 单人模式显示正常
5. ✅ 无处理人时不显示

### 兼容性测试
1. ✅ 旧数据（只有dopersonal_Name）显示正常
2. ✅ 新数据（有candidateHandlers）显示正常
3. ✅ 流程流转后显示正常

## 修改时间
2026年1月2日

## 修改状态
✅ 已完成并测试通过
