# 操作日志系统 - 使用指南

## 概述

本系统实现了完整的用户活动日志记录功能，支持：

- ✅ 用户身份快照（用户名、角色、部门、职位）
- ✅ 操作时间（精确到秒）
- ✅ 操作类型（新增、修改、删除、导出、审批等）
- ✅ 操作对象（被操作的数据实体）
- ✅ 操作详情（操作前后的数据快照、字段变更对比）
- ✅ IP地址和User-Agent记录

## 1. 数据模型

### SystemLog 表结构

```prisma
model SystemLog {
  id              String   @id @default(cuid())
  
  // 用户身份信息（快照）
  userId          String?
  userName        String?
  userRole        String?
  userDepartment  String?
  userDepartmentId String?
  userJobTitle    String?
  
  // 操作信息
  action          String
  actionLabel     String?
  module          String?
  
  // 操作对象
  targetId        String?
  targetType      String?
  targetLabel     String?
  
  // 操作详情
  details         String?
  beforeData      String?  // JSON
  afterData       String?  // JSON
  changes         String?  // JSON
  snapshot        String?  // JSON
  
  // 其他信息
  ip              String?
  userAgent       String?
  
  createdAt       DateTime @default(now())
}
```

## 2. 基础使用

> **⚠️ 重要提示**：使用业务编号而非数据库ID
> 
> 在记录日志时，`targetId` 字段**必须使用业务系统的编号**（如隐患编号 `HZ-2024-001`），而不是数据库自动生成的ID。
> 
> - ✅ **正确**: `targetId: hazard.code`（业务编号，如 HZ-2024-001）
> - ❌ **错误**: `targetId: hazard.id`（数据库ID，如 clx123...）
> 
> 详细说明请参考：[操作日志-业务编号规范.md](./操作日志-业务编号规范.md)

### 2.1 导入工具类

```typescript
import { ActivityLogger, ActionTypes, Modules } from '@/utils/activityLogger';
import { SystemLogService } from '@/services/systemLog.service';
```

### 2.2 记录创建操作

```typescript
// 方法1：使用ActivityLogger（推荐）
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: newHazard.code,  // 使用业务编号（隐患编号）
  targetLabel: newHazard.desc?.substring(0, 50),  // 隐患描述（可选）
  data: newHazard,
  request, // NextRequest对象，可选
});

// 方法2：直接使用SystemLogService
const userSnapshot = await SystemLogService.getUserSnapshot(user.id);
await SystemLogService.createLog({
  userSnapshot,
  action: ActionTypes.CREATE,
  actionLabel: '新增',
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: newHazard.code,  // 使用业务编号
  targetLabel: newHazard.desc?.substring(0, 50),  // 隐患描述
  details: `创建了隐患 ${newHazard.code}`,
  afterData: newHazard,
});
```

### 2.3 记录更新操作（自动对比变更）

```typescript
// 获取更新前的数据
const beforeData = await prisma.hazardRecord.findUnique({
  where: { id: hazardId }
});

// 执行更新
const afterData = await prisma.hazardRecord.update({
  where: { id: hazardId },
  data: updateData,
});

// 记录日志（自动对比变更）
await ActivityLogger.logUpdate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: afterData.code,  // 使用隐患编号
  targetLabel: afterData.desc?.substring(0, 50),
  beforeData,
  afterData,
  fieldLabels: {
    status: '状态',
    desc: '描述',
    responsibleId: '责任人',
    // ... 其他字段的中文标签
  },
  request,
});
```

### 2.4 记录删除操作

```typescript
// 获取要删除的数据
const dataToDelete = await prisma.hazardRecord.findUnique({
  where: { id: hazardId }
});

// 执行删除
await prisma.hazardRecord.delete({
  where: { id: hazardId }
});

// 记录日志
await ActivityLogger.logDelete({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: dataToDelete.code,  // 使用隐患编号
  targetLabel: dataToDelete.desc?.substring(0, 50),
  data: dataToDelete,
  request,
});
```

### 2.5 记录审批操作

```typescript
await ActivityLogger.logApproval({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.code,  // 使用隐患编号
  targetLabel: hazard.desc?.substring(0, 50),
  action: 'APPROVE', // 或 'REJECT'
  comment: '同意整改',
  beforeStatus: '待审批',
  afterStatus: '已通过',
  request,
});
```

### 2.6 记录导出操作

```typescript
await ActivityLogger.logExport({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  description: '隐患记录列表',
  count: exportData.length,
  request,
});
```

### 2.7 记录用户登录

```typescript
await ActivityLogger.logLogin({
  userId: user.id,
  userName: user.name,
  success: true,
  request,
});
```

## 3. 在API路由中使用

### 示例：隐患记录创建API

```typescript
// src/app/api/hazards/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { ActivityLogger, Modules } from '@/utils/activityLogger';
import { getServerSession } from 'next-auth';

export async function POST(request: NextRequest) {
  try {
    // 获取当前用户
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    // 解析请求数据
    const body = await request.json();

    // 创建隐患记录
    const newHazard = await prisma.hazardRecord.create({
      data: {
        ...body,
        reporterId: user.id,
      },
    });

    // 记录操作日志
    await ActivityLogger.logCreate({
      userId: user.id,
      module: Modules.HAZARD,
      targetType: 'hazard',
      targetId: newHazard.id,
      targetLabel: `隐患 ${newHazard.code}`,
      data: newHazard,
      request,
    });

    return NextResponse.json({
      success: true,
      data: newHazard,
    });
  } catch (error) {
    console.error('创建隐患失败:', error);
    return NextResponse.json(
      { error: '创建失败' },
      { status: 500 }
    );
  }
}
```

### 示例：隐患记录更新API

```typescript
// src/app/api/hazards/[id]/route.ts
export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const session = await getServerSession();
    const user = session?.user;
    
    if (!user) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();
    const hazardId = params.id;

    // 获取更新前的数据
    const beforeData = await prisma.hazardRecord.findUnique({
      where: { id: hazardId },
    });

    if (!beforeData) {
      return NextResponse.json({ error: '记录不存在' }, { status: 404 });
    }

    // 执行更新
    const afterData = await prisma.hazardRecord.update({
      where: { id: hazardId },
      data: body,
    });

    // 记录操作日志（自动对比变更）
    await ActivityLogger.logUpdate({
      userId: user.id,
      module: Modules.HAZARD,
      targetType: 'hazard',
      targetId: hazardId,
      targetLabel: `隐患 ${afterData.code}`,
      beforeData,
      afterData,
      fieldLabels: {
        status: '状态',
        desc: '描述',
        level: '等级',
        responsibleId: '责任人',
        deadline: '截止日期',
      },
      request,
    });

    return NextResponse.json({
      success: true,
      data: afterData,
    });
  } catch (error) {
    console.error('更新隐患失败:', error);
    return NextResponse.json(
      { error: '更新失败' },
      { status: 500 }
    );
  }
}
```

## 4. 字段变更对比

系统会自动对比操作前后的数据，生成字段变更列表：

```typescript
const changes = SystemLogService.compareObjects(
  beforeData,
  afterData,
  {
    status: '状态',
    desc: '描述',
    level: '等级',
    // ... 更多字段标签
  }
);

// 返回格式：
[
  {
    field: 'status',
    fieldLabel: '状态',
    oldValue: '待处理',
    newValue: '处理中',
    changeType: 'modified'
  },
  // ...
]
```

## 5. 查询日志

### 5.1 API查询

```typescript
// GET /api/logs?page=1&limit=20&module=hazard&action=CREATE&userId=xxx&startDate=2024-01-01&endDate=2024-01-31
```

### 5.2 使用ActivityLogViewer组件

```typescript
import ActivityLogViewer from '@/components/ActivityLogViewer';

// 显示所有日志
<ActivityLogViewer />

// 只显示特定模块的日志
<ActivityLogViewer module="hazard" />

// 只显示特定对象的日志
<ActivityLogViewer 
  targetType="hazard" 
  targetId="xxx" 
/>

// 不显示筛选条件
<ActivityLogViewer showFilters={false} />
```

## 6. 操作类型常量

系统预定义了常用的操作类型：

```typescript
export const ActionTypes = {
  // 通用操作
  CREATE: 'CREATE',
  UPDATE: 'UPDATE',
  DELETE: 'DELETE',
  VIEW: 'VIEW',
  EXPORT: 'EXPORT',
  IMPORT: 'IMPORT',
  
  // 审批相关
  SUBMIT: 'SUBMIT',
  APPROVE: 'APPROVE',
  REJECT: 'REJECT',
  REVOKE: 'REVOKE',
  
  // 隐患相关
  REPORT: 'REPORT',
  DISPATCH: 'DISPATCH',
  RECTIFY: 'RECTIFY',
  VERIFY: 'VERIFY',
  CLOSE: 'CLOSE',
  REOPEN: 'REOPEN',
  
  // 用户相关
  LOGIN: 'LOGIN',
  LOGOUT: 'LOGOUT',
  CHANGE_PASSWORD: 'CHANGE_PASSWORD',
  
  // 其他
  DOWNLOAD: 'DOWNLOAD',
  UPLOAD: 'UPLOAD',
  SHARE: 'SHARE',
};

export const ActionLabels = {
  CREATE: '新增',
  UPDATE: '修改',
  DELETE: '删除',
  // ...
};
```

## 7. 模块常量

```typescript
export const Modules = {
  HAZARD: 'hazard',        // 隐患管理
  DOCUMENT: 'document',    // 文档管理
  PERMIT: 'permit',        // 作业许可
  TRAINING: 'training',    // 培训管理
  USER: 'user',           // 用户管理
  ORG: 'org',             // 组织管理
  CONFIG: 'config',       // 配置管理
  SYSTEM: 'system',       // 系统
};
```

## 8. 高级功能

### 8.1 批量操作日志

```typescript
const logs = items.map(item => ({
  userSnapshot: await SystemLogService.getUserSnapshot(user.id),
  action: ActionTypes.CREATE,
  actionLabel: '批量导入',
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: item.id,
  targetLabel: `隐患 ${item.code}`,
  afterData: item,
}));

await SystemLogService.createBatchLogs(logs);
```

### 8.2 自定义操作类型

```typescript
await ActivityLogger.logAction({
  userId: user.id,
  action: 'CUSTOM_ACTION',
  actionLabel: '自定义操作',
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: 'xxx',
  details: '执行了自定义操作',
  request,
});
```

### 8.3 添加额外的快照信息

```typescript
await ActivityLogger.logAction({
  userId: user.id,
  action: ActionTypes.DISPATCH,
  actionLabel: '派发隐患',
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.id,
  targetLabel: `隐患 ${hazard.code}`,
  details: '派发给责任人处理',
  afterData: {
    status: hazard.status,
    responsibleId: hazard.responsibleId,
  },
  // 额外的快照信息
  snapshot: {
    dispatchReason: '紧急处理',
    candidates: ['user1', 'user2'],
    selectedBy: 'auto-engine',
  },
  request,
});
```

## 9. 注意事项

1. **日志失败不影响主流程**：所有日志记录方法都会捕获异常，确保日志失败不会中断业务流程
2. **性能考虑**：对于批量操作，使用 `createBatchLogs` 方法
3. **数据快照**：建议只记录必要的字段，避免存储过大的JSON数据
4. **用户快照**：系统会自动获取用户的当前状态（角色、部门等），确保记录的是操作时的真实状态
5. **字段标签**：在调用 `logUpdate` 时提供 `fieldLabels` 映射，使变更记录更易读

## 10. 数据清理

定期清理旧日志（默认保留90天）：

```typescript
import { SystemLogService } from '@/services/systemLog.service';

// 清理90天前的日志
await SystemLogService.cleanOldLogs(90);

// 清理180天前的日志
await SystemLogService.cleanOldLogs(180);
```

可以设置定时任务自动清理：

```typescript
// scripts/cleanup-logs.ts
import { SystemLogService } from '@/services/systemLog.service';

async function cleanupLogs() {
  const result = await SystemLogService.cleanOldLogs(90);
  console.log(`已清理 ${result.count} 条旧日志`);
}

cleanupLogs();
```

## 11. 迁移现有代码

如果您的系统中已有日志记录代码，可以逐步迁移：

### 旧代码：
```typescript
await createLog(
  user.id,
  user.name,
  'create_hazard',
  hazard.id,
  `创建隐患 ${hazard.code}`,
  'hazard'
);
```

### 新代码：
```typescript
await ActivityLogger.logCreate({
  userId: user.id,
  module: Modules.HAZARD,
  targetType: 'hazard',
  targetId: hazard.id,
  targetLabel: `隐患 ${hazard.code}`,
  data: hazard,
  request,
});
```

## 12. 故障排查

### 日志未记录

1. 检查用户ID是否正确
2. 查看控制台是否有错误信息
3. 确认数据库连接正常

### 变更对比不准确

1. 确保 beforeData 和 afterData 格式一致
2. 检查是否包含不需要对比的字段（如 id, createdAt 等）
3. 提供准确的 fieldLabels 映射

### 性能问题

1. 对批量操作使用 `createBatchLogs`
2. 避免记录过大的数据快照
3. 定期清理旧日志
4. 考虑为高频操作添加采样记录

---

更新日期：2026-01-02
