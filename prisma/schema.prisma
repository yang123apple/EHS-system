generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Project {
  id              String   @id @default(cuid())
  code            String   @unique @default(cuid())
  name            String
  contractNo      String?
  location        String
  startDate       DateTime
  endDate         DateTime
  requestDept     String
  requestHead     String
  requestContact  String
  mgmtDept        String?
  mgmtHead        String?
  mgmtContact     String?
  supplierName    String
  supplierHead    String
  supplierContact String
  attachments     String?
  deletedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  permits         WorkPermitRecord[]
}

model WorkPermitTemplate {
  id            String   @id @default(cuid())
  name          String
  type          String
  structureJson String
  workflowConfig String?
  parsedFields  String?
  level         String   @default("primary")
  sectionBindings String?
  orientation   String   @default("portrait")
  mobileFormConfig String?
  isLocked      Boolean  @default(false)
  createdAt     DateTime @default(now())
  records       WorkPermitRecord[]
}

model WorkPermitRecord {
  id          String   @id @default(cuid())
  code        String?  @unique
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId  String
  template    WorkPermitTemplate @relation(fields: [templateId], references: [id])
  dataJson    String
  status      String   @default("draft") 
  currentStep Int      @default(0)
  approvalLogs String?
  attachments String?
  parsedFieldValues String?
  createdAt   DateTime @default(now())
}

model User {
  id              String   @id @default(cuid())
  username        String   @unique
  name            String
  password        String
  avatar          String   @default("/image/default_avatar.jpg")
  role            String   @default("user")
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])
  jobTitle        String?
  directManagerId String?
  permissions     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  reportedHazards  HazardRecord[] @relation("Reporter")
  assignedHazards  HazardRecord[] @relation("Responsible")
  uploadedMaterials TrainingMaterial[]
  publishedTasks    TrainingTask[] @relation("TaskPublisher")
  trainingAssignments TrainingAssignment[]
  learnedRecords  MaterialLearnedRecord[]
}

model Department {
  id          String   @id @default(cuid())
  name        String
  parentId    String?
  parent      Department? @relation("DeptHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DeptHierarchy")
  managerId   String?
  level       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model HazardRecord {
  id              String   @id @default(cuid())
  code            String?  @unique
  status          String   @default("reported")
  riskLevel       String   @default("low")
  type            String
  location        String
  desc            String
  photos          String?
  reporterId      String
  reporter        User     @relation("Reporter", fields: [reporterId], references: [id])
  reporterName    String
  reportTime      DateTime @default(now())
  responsibleId   String?
  responsible     User?    @relation("Responsible", fields: [responsibleId], references: [id])
  responsibleName String?
  responsibleDept String?
  deadline        DateTime?
  rectifyDesc     String?
  rectifyPhotos   String?
  rectifyTime     DateTime?
  verifierId      String?
  verifierName    String?
  verifyTime      DateTime?
  rectifyRequirement    String?
  requireEmergencyPlan  Boolean  @default(false)
  emergencyPlanDeadline DateTime?
  emergencyPlanContent  String?
  emergencyPlanSubmitTime DateTime?
  ccDepts               String?
  ccUsers               String?
  logs                  String?
  old_personal_ID       String?
  dopersonal_ID         String?   // å½“å‰æ­¥éª¤æ‰§è¡ŒäººIDï¼ˆåŠ¨æ€å­—æ®µï¼Œéšæ­¥éª¤æµè½¬æ›´æ–°ï¼‰
  dopersonal_Name       String?   // å½“å‰æ­¥éª¤æ‰§è¡Œäººå§“åï¼ˆåŠ¨æ€å­—æ®µï¼Œéšæ­¥éª¤æµè½¬æ›´æ–°ï¼‰
  candidateHandlers     String?   // ğŸŸ¢ æˆ–ç­¾/ä¼šç­¾æ¨¡å¼ï¼šå€™é€‰å¤„ç†äººåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
  approvalMode          String?   // ğŸŸ¢ å½“å‰æ­¥éª¤çš„å®¡æ‰¹æ¨¡å¼ï¼ˆOR=æˆ–ç­¾ï¼ŒAND=ä¼šç­¾ï¼‰
  currentStepIndex      Int?      @default(0)  // å½“å‰æ­¥éª¤ç´¢å¼•ï¼ˆç”¨äºè¿½è¸ªå·¥ä½œæµä½ç½®ï¼‰
  currentStepId         String?   // å½“å‰æ­¥éª¤IDï¼ˆç”¨äºè¿½è¸ªå·¥ä½œæµä½ç½®ï¼‰
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model HazardConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id          String   @id @default(cuid())
  name        String
  type        String
  docxPath    String?
  pdfPath     String?
  prefix      String?
  suffix      Int?
  fullNum     String?
  level       Int
  parentId    String?
  parent      Document? @relation("DocHierarchy", fields: [parentId], references: [id])
  children    Document[] @relation("DocHierarchy")
  dept        String?
  uploader    String?
  uploadTime  DateTime @default(now())
  searchText  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  history     DocumentHistory[]
}

model DocumentHistory {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  type        String   // 'docx', 'xlsx', 'pdf'
  name        String
  path        String
  uploader    String?
  uploadTime  DateTime @default(now())
  createdAt   DateTime @default(now())
}

model SystemLog {
  id              String   @id @default(cuid())
  // ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆå¿«ç…§ï¼‰
  userId          String?
  userName        String?
  userRole        String?  // æ“ä½œæ—¶çš„è§’è‰²
  userDepartment  String?  // æ“ä½œæ—¶æ‰€å±éƒ¨é—¨åç§°
  userDepartmentId String? // æ“ä½œæ—¶æ‰€å±éƒ¨é—¨ID
  userJobTitle    String?  // æ“ä½œæ—¶çš„èŒä½
  
  // æ“ä½œä¿¡æ¯
  action          String   // æ“ä½œç±»å‹ï¼šCREATE, UPDATE, DELETE, EXPORT, APPROVE, REJECTç­‰
  actionLabel     String?  // æ“ä½œç±»å‹çš„ä¸­æ–‡æè¿°
  module          String?  // æ‰€å±æ¨¡å—ï¼šhazard, document, permit, training, user, orgç­‰
  
  // æ“ä½œå¯¹è±¡
  targetId        String?  // è¢«æ“ä½œçš„æ•°æ®å®ä½“ID
  targetType      String?  // 'hazard', 'document', 'permit' ç­‰
  targetLabel     String?  // è¢«æ“ä½œå¯¹è±¡çš„æè¿°ï¼ˆå¦‚ï¼šéšæ‚£ç¼–å·ã€æ–‡æ¡£æ ‡é¢˜ï¼‰
  
  // æ“ä½œè¯¦æƒ…
  details         String?  // æ“ä½œçš„ç®€è¦æè¿°
  beforeData      String?  // æ“ä½œå‰çš„æ•°æ®å¿«ç…§ï¼ˆJSONï¼‰
  afterData       String?  // æ“ä½œåçš„æ•°æ®å¿«ç…§ï¼ˆJSONï¼‰
  changes         String?  // å­—æ®µå˜æ›´å¯¹æ¯”ï¼ˆJSONæ•°ç»„ï¼‰
  snapshot        String?  // å…¶ä»–å¿«ç…§ä¿¡æ¯ï¼ˆå¦‚æµç¨‹å¿«ç…§ã€å€™é€‰äººåˆ—è¡¨ç­‰ï¼‰
  
  // å…¶ä»–ä¿¡æ¯
  ip              String?  // IPåœ°å€
  userAgent       String?  // æµè§ˆå™¨UA
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([targetType])
  @@index([module])
  @@index([createdAt])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  content     String
  relatedType String?
  relatedId   String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TrainingMaterial {
  id            String   @id @default(cuid())
  title         String
  description   String?
  type          String   // video, pdf, docx
  category      String?  // å­¦ä¹ ç±»å‹åˆ†ç±»
  url           String
  convertedUrl  String?  // PDF version of docx
  thumbnail     String?  // ç¼©ç•¥å›¾è·¯å¾„
  duration      Int?     // seconds, for video
  isExamRequired Boolean @default(false)
  passingScore  Int?
  isPublic      Boolean  @default(true) // æ˜¯å¦æ”¾å…¥å…¬å…±çŸ¥è¯†åº“
  uploaderId    String
  uploader      User     @relation(fields: [uploaderId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  questions     ExamQuestion[]
  tasks         TrainingTask[]
  learnedRecords MaterialLearnedRecord[]
}

model ExamQuestion {
  id            String   @id @default(cuid())
  materialId    String
  material      TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  type          String   // single, multiple
  question      String
  options       String   // JSON string
  answer        String   // JSON string
  score         Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model TrainingTask {
  id            String   @id @default(cuid())
  title         String
  description   String?
  startDate     DateTime
  endDate       DateTime
  materialId    String
  material      TrainingMaterial @relation(fields: [materialId], references: [id])
  publisherId   String
  publisher     User     @relation("TaskPublisher", fields: [publisherId], references: [id])
  targetType    String   // all, dept, user
  targetConfig  String?  // JSON string
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  assignments   TrainingAssignment[]
}

model TrainingAssignment {
  id            String   @id @default(cuid())
  taskId        String
  task          TrainingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  status        String   // assigned, in-progress, completed, passed, failed
  progress      Int      // 0-100 or seconds watched
  isPassed      Boolean  @default(false)
  examScore     Int?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([taskId, userId])
}

model MaterialLearnedRecord {
  id          String   @id @default(cuid())
  materialId  String
  material    TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  learnedAt   DateTime @default(now())

  @@unique([materialId, userId])
}

// é€šçŸ¥æ¨¡æ¿ç®¡ç†
model NotificationTemplate {
  id            String   @id @default(cuid())
  name          String   @unique
  title         String   // æ”¯æŒå˜é‡å ä½ç¬¦ï¼Œå¦‚ {{user.name}}
  content       String   // æ”¯æŒå˜é‡å ä½ç¬¦
  type          String   // hazard, training, work_permit, system
  triggerEvent  String   // è§¦å‘äº‹ä»¶ï¼šhazard_created, hazard_assigned, etc
  triggerCondition String? // JSONé…ç½®ï¼šæ¡ä»¶è§„åˆ™
  isActive      Boolean  @default(true)
  variables     String?  // JSONæ•°ç»„ï¼šå¯ç”¨å˜é‡åˆ—è¡¨
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// AI API é…ç½®
model AIApiConfig {
  id            String   @id @default(cuid())
  name          String   @unique
  provider      String   // openai, azure, custom
  apiKey        String   // åŠ å¯†å­˜å‚¨
  endpoint      String
  model         String?  // gpt-4, gpt-3.5-turbo, etc
  maxTokens     Int      @default(2000)
  temperature   Float    @default(0.7)
  isActive      Boolean  @default(true)
  rateLimitPerMinute Int @default(1000) // é™æµç­–ç•¥ï¼šæ¯åˆ†é’Ÿæœ€å¤§è°ƒç”¨æ¬¡æ•°
  rateLimitPerDay Int    @default(50000) // æ¯å¤©æœ€å¤§è°ƒç”¨æ¬¡æ•°
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  logs          AIApiLog[]
}

// AI API è°ƒç”¨æ—¥å¿—
model AIApiLog {
  id            String   @id @default(cuid())
  configId      String
  config        AIApiConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  requestBy     String?  // è°ƒç”¨è€…ç”¨æˆ·IDæˆ–ç³»ç»Ÿåç§°
  requestSource String?  // hazard, training, work_permit, custom
  requestPayload String? // JSONï¼šè¯·æ±‚å†…å®¹
  responsePayload String? // JSONï¼šå“åº”å†…å®¹
  tokens        Int?     // æ¶ˆè€—çš„tokenæ•°
  duration      Int?     // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  status        String   // success, error, rate_limited
  errorMessage  String?
  ip            String?
  createdAt     DateTime @default(now())
}
