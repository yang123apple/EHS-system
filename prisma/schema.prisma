generator client {
  provider = "prisma-client-js"
  // âŒ ç»å¯¹ä¸è¦å†™ previewFeatures
  // âŒ ç»å¯¹ä¸è¦å†™ engineType
}

datasource db {
  provider = "sqlite"
  // âœ… å¿…é¡»åŠ å›è¿™ä¸€è¡Œï¼Œå› ä¸º config æ–‡ä»¶æ²¡äº†
  url      = env("DATABASE_URL")
}

// 1. å·¥ç¨‹/é¡¹ç›®è¡¨
model Project {
  id              String   @id @default(cuid())
  // âœ… æ–°å¢ï¼šé¡¹ç›®ç¼–å· (è‡ªåŠ¨ç”Ÿæˆï¼Œå”¯ä¸€)
  code            String   @unique @default(cuid())
  name            String
  contractNo      String?
  location        String
  startDate       DateTime
  endDate         DateTime
  
  requestDept     String
  requestHead     String
  requestContact  String

  mgmtDept        String?
  mgmtHead        String?
  mgmtContact     String?

  supplierName    String
  supplierHead    String
  supplierContact String

  // ğŸŸ¢ æ–°å¢ï¼šé™„ä»¶å’Œè½¯åˆ é™¤æ”¯æŒ
  attachments     String?  // JSON æ ¼å¼å­˜å‚¨é™„ä»¶åˆ—è¡¨
  deletedAt       DateTime? // è½¯åˆ é™¤æ—¶é—´æˆ³

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  permits         WorkPermitRecord[]
}

// 2. ä½œä¸šç¥¨æ¨¡æ¿
model WorkPermitTemplate {
  id            String   @id @default(cuid())
  name          String
  type          String
  structureJson String
  
  // âœ… æ–°å¢ï¼šå­˜å‚¨æµç¨‹å®šä¹‰
  // æ ¼å¼: [{ step: 1, name: "éœ€æ±‚éƒ¨é—¨", rowIndex: 16, role: "user" }, ...]
  workflowConfig String? 

  // ğŸŸ¢ æ–°å¢ï¼šå­˜å‚¨è§£æçš„æ¨¡æ¿å­—æ®µ
  // æ ¼å¼: [{ cellKey: "R1C1", label: "éƒ¨é—¨", fieldName: "department", fieldType: "department", hint: "..." }]
  parsedFields  String?

  // ğŸŸ¢ V3.3 æ¨¡æ¿çº§åˆ«ç³»ç»Ÿ
  level         String   @default("primary")  // primary=ä¸€çº§, secondary=äºŒçº§
  sectionBindings String?                    // JSON: { "R5C3": "templateId", ... } sectionå•å…ƒæ ¼ç»‘å®šçš„äºŒçº§æ¨¡æ¿

  isLocked      Boolean  @default(false)
  createdAt     DateTime @default(now())
  records       WorkPermitRecord[]
}

// 3. ä½œä¸šç¥¨å¡«å†™è®°å½•
model WorkPermitRecord {
  id          String   @id @default(cuid())
  code        String?  @unique  // ğŸŸ¢ æ–°å¢ï¼šä½œä¸šå•ç¼–å·ï¼ˆå¦‚ 251220-001-DH-251222-001ï¼‰
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId  String
  template    WorkPermitTemplate @relation(fields: [templateId], references: [id])
  dataJson    String
  
  // âœ… ä¿®æ”¹ï¼šçŠ¶æ€ä¸å†åªæ˜¯ activeï¼Œè¿˜æœ‰ pending_step_1, approved, rejected ç­‰
  status      String   @default("draft") 
  
  // âœ… æ–°å¢ï¼šå½“å‰è¿›è¡Œåˆ°ç¬¬å‡ æ­¥ (0 è¡¨ç¤ºåˆšæäº¤/ç¬¬ä¸€æ­¥)
  currentStep Int      @default(0)

  // âœ… æ–°å¢ï¼šå­˜å‚¨å®¡æ‰¹å†å²
  // æ ¼å¼: [{ step: 0, approver: "å¼ ä¸‰", opinion: "åŒæ„", time: "2023...", action: "pass" }]
  approvalLogs String? 

  // âœ… æ–°å¢ï¼šé™„ä»¶åˆ—è¡¨ï¼ˆå¯ä¸ºç©ºï¼‰ï¼Œä»¥ JSON å­—ç¬¦ä¸²ä¿å­˜ï¼Œæ ¼å¼ç¤ºä¾‹: [{ name: 'xxx.jpg', url: '/uploads/xxx.jpg' }]
  attachments String?

  // ğŸŸ¢ æ–°å¢ï¼šè§£æåçš„å­—æ®µå€¼ï¼ˆç”¨äºå·¥ä½œæµæ¡ä»¶åŒ¹é…ï¼‰
  // æ ¼å¼: { "constructionDepartment": "Engineering", "startDate": "2024-01-15", ... }
  parsedFieldValues String?

  createdAt   DateTime @default(now())
}

// âœ… æ–°å¢ï¼šç³»ç»Ÿæ“ä½œæ—¥å¿—è¡¨
model SystemLog {
  id        String   @id @default(cuid())
  userId    String?  // æ“ä½œäººID
  userName  String?  // æ“ä½œäººå§“å (å†—ä½™å­˜å‚¨ï¼Œæ–¹ä¾¿å¿«é€Ÿå±•ç¤º)
  action    String   // åŠ¨ä½œç±»å‹ (å¦‚: DELETE_PERMIT, APPROVE_PASS)
  targetId  String?  // æ“ä½œå¯¹è±¡ID (å¦‚ä½œä¸šç¥¨ID)
  details   String?  // è¯¦ç»†æè¿° (JSONå­—ç¬¦ä¸²æˆ–æ–‡æœ¬)
  ip        String?  // æ“ä½œIP (å¯é€‰)
  createdAt DateTime @default(now())
}