generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Project {
  id              String             @id @default(cuid())
  code            String             @unique @default(cuid())
  name            String
  contractNo      String?
  location        String
  startDate       DateTime
  endDate         DateTime
  requestDept     String
  requestHead     String
  requestContact  String
  mgmtDept        String?
  mgmtHead        String?
  mgmtContact     String?
  supplierName    String
  supplierHead    String
  supplierContact String
  attachments     String?
  deletedAt       DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  permits         WorkPermitRecord[]
}

model WorkPermitTemplate {
  id               String             @id @default(cuid())
  name             String
  type             String
  structureJson    String
  workflowConfig   String?
  parsedFields     String?
  level            String             @default("primary")
  sectionBindings  String?
  orientation      String             @default("portrait")
  mobileFormConfig String?
  isLocked         Boolean            @default(false)
  createdAt        DateTime           @default(now())
  records          WorkPermitRecord[]
}

model WorkPermitRecord {
  id                String             @id @default(cuid())
  code              String?            @unique
  projectId         String
  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId        String
  template          WorkPermitTemplate @relation(fields: [templateId], references: [id])
  dataJson          String
  status            String             @default("draft")
  currentStep       Int                @default(0)
  approvalLogs      String?
  attachments       String?
  parsedFieldValues String?
  createdAt         DateTime           @default(now())
}

model User {
  id                  String                  @id @default(cuid())
  username            String                  @unique
  name                String
  password            String
  avatar              String                  @default("/image/default_avatar.jpg")
  role                String                  @default("user")
  departmentId        String?
  department          Department?             @relation(fields: [departmentId], references: [id])
  jobTitle            String?
  directManagerId     String?
  permissions         String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  reportedHazards     HazardRecord[]          @relation("Reporter")
  assignedHazards     HazardRecord[]          @relation("Responsible")
  uploadedMaterials   TrainingMaterial[]
  publishedTasks      TrainingTask[]          @relation("TaskPublisher")
  trainingAssignments TrainingAssignment[]
  learnedRecords      MaterialLearnedRecord[]
  uploadedFiles       FileMetadata[]          @relation("FileUploader")
}

model Department {
  id        String       @id @default(cuid())
  name      String
  parentId  String?
  parent    Department?  @relation("DeptHierarchy", fields: [parentId], references: [id])
  children  Department[] @relation("DeptHierarchy")
  managerId String?
  level     Int          @default(1)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  users     User[]
}

model HazardRecord {
  id                      String    @id @default(cuid())
  code                    String?   @unique
  status                  String    @default("reported")
  riskLevel               String    @default("low")
  type                    String
  location                String
  desc                    String
  photos                  String?
  reporterId              String
  reporter                User      @relation("Reporter", fields: [reporterId], references: [id])
  reporterName            String
  reportTime              DateTime  @default(now())
  responsibleId           String?
  responsible             User?     @relation("Responsible", fields: [responsibleId], references: [id])
  responsibleName         String?
  responsibleDept         String?
  deadline                DateTime?
  rectifyDesc             String?
  rectifyPhotos           String?
  rectifyTime             DateTime?
  verifierId              String?
  verifierName            String?
  verifyTime              DateTime?
  rectifyRequirement      String?
  requireEmergencyPlan    Boolean   @default(false)
  emergencyPlanDeadline   DateTime?
  emergencyPlanContent    String?
  emergencyPlanSubmitTime DateTime?
  ccDepts                 String?
  ccUsers                 String?
  logs                    String?
  old_personal_ID         String?
  dopersonal_ID           String? // å½“å‰æ­¥éª¤æ‰§è¡ŒäººIDï¼ˆåŠ¨æ€å­—æ®µï¼Œéšæ­¥éª¤æµè½¬æ›´æ–°ï¼‰
  dopersonal_Name         String? // å½“å‰æ­¥éª¤æ‰§è¡Œäººå§“åï¼ˆåŠ¨æ€å­—æ®µï¼Œéšæ­¥éª¤æµè½¬æ›´æ–°ï¼‰
  candidateHandlers       String? // ğŸŸ¢ æˆ–ç­¾/ä¼šç­¾æ¨¡å¼ï¼šå€™é€‰å¤„ç†äººåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
  approvalMode            String? // ğŸŸ¢ å½“å‰æ­¥éª¤çš„å®¡æ‰¹æ¨¡å¼ï¼ˆOR=æˆ–ç­¾ï¼ŒAND=ä¼šç­¾ï¼‰
  currentStepIndex        Int?      @default(0) // å½“å‰æ­¥éª¤ç´¢å¼•ï¼ˆç”¨äºè¿½è¸ªå·¥ä½œæµä½ç½®ï¼‰
  currentStepId           String? // å½“å‰æ­¥éª¤IDï¼ˆç”¨äºè¿½è¸ªå·¥ä½œæµä½ç½®ï¼‰
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

model HazardConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id         String            @id @default(cuid())
  name       String
  type       String
  docxPath   String?
  pdfPath    String?
  prefix     String?
  suffix     Int?
  fullNum    String?
  level      Int
  parentId   String?
  parent     Document?         @relation("DocHierarchy", fields: [parentId], references: [id])
  children   Document[]        @relation("DocHierarchy")
  dept       String?
  uploader   String?
  uploadTime DateTime          @default(now())
  searchText String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  history    DocumentHistory[]
}

model DocumentHistory {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  type       String // 'docx', 'xlsx', 'pdf'
  name       String
  path       String
  uploader   String?
  uploadTime DateTime @default(now())
  createdAt  DateTime @default(now())
}

model SystemLog {
  id String @id @default(cuid())

  // ============ æ“ä½œäººèº«ä»½ä¿¡æ¯ï¼ˆå¿«ç…§ï¼‰ ============
  userId           String?
  userName         String?
  userRole         String? // æ“ä½œæ—¶çš„ç³»ç»Ÿè§’è‰²ï¼ˆadmin/user/managerç­‰ï¼‰
  userDepartment   String? // æ“ä½œæ—¶æ‰€å±éƒ¨é—¨åç§°
  userDepartmentId String? // æ“ä½œæ—¶æ‰€å±éƒ¨é—¨ID
  userJobTitle     String? // æ“ä½œæ—¶çš„èŒä½
  userRoleInAction String? // ç”¨æˆ·åœ¨æœ¬æ¬¡æ“ä½œä¸­çš„ä¸šåŠ¡è§’è‰²ï¼ˆä¸ŠæŠ¥äºº/æ•´æ”¹äºº/éªŒæ”¶äºº/å®¡æ‰¹äººç­‰ï¼‰

  // ============ æ“ä½œä¿¡æ¯ ============
  module       String // æ‰€å±æ¨¡å—ï¼šHAZARD, WORK_PERMIT, TRAINING, USER, ORG, SYSTEM ç­‰
  action       String // æ“ä½œç±»å‹ï¼šCREATE, UPDATE, DELETE, APPROVE, REJECT, EXPORT, LOGIN ç­‰
  actionLabel  String? // æ“ä½œç±»å‹çš„ä¸­æ–‡æè¿°ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚ï¼š"åˆ›å»ºéšæ‚£"ã€"å®¡æ‰¹ä½œä¸šç¥¨"ï¼‰
  businessCode String? // æ ‡å‡†ä¸šåŠ¡ç¼–ç ï¼ˆå¦‚ï¼šHD_CRT_001, WP_APV_001ï¼‰ï¼Œéµå¾ªä¸šåŠ¡ç¼–å·è§„èŒƒ

  // ============ æ“ä½œå¯¹è±¡ ============
  targetId    String? // è¢«æ“ä½œçš„ä¸šåŠ¡å®ä½“ç¼–å·ï¼ˆå¦‚ï¼šHZ-2024-001, JOB-2024-001ï¼‰âš ï¸ ä½¿ç”¨ä¸šåŠ¡ç¼–å·ï¼Œéæ•°æ®åº“ID
  targetType  String? // æ“ä½œå¯¹è±¡ç±»å‹ï¼ˆhazard, document, permit, training_task, user ç­‰ï¼‰
  targetLabel String? // è¢«æ“ä½œå¯¹è±¡çš„æè¿°ï¼ˆå¦‚ï¼šéšæ‚£ç®€è¿°å‰50å­—ã€æ–‡æ¡£æ ‡é¢˜ã€ä½œä¸šç±»å‹ï¼‰
  targetLink  String? // ğŸ”— æ“ä½œå¯¹è±¡çš„è¯¦æƒ…é¡µé“¾æ¥ï¼ˆç”¨äºæ—¥å¿—è¿½æº¯è·³è½¬ï¼‰

  // ============ å®¡è®¡ç»†èŠ‚ï¼ˆæ ¸å¿ƒï¼‰ ============
  snapshot   String? // ğŸ“¸ æ“ä½œåçš„å®Œæ•´å¯¹è±¡å¿«ç…§ï¼ˆJSONï¼‰ï¼Œæ¸…æ´—æ•æ„Ÿå­—æ®µåå­˜å‚¨ï¼Œç”¨äºå®Œæ•´è¿˜åŸå½“æ—¶çš„çŠ¶æ€
  diff       String? // ğŸ“Š ä¿®æ”¹å‰åçš„å·®å¼‚å¯¹æ¯”ï¼ˆJSONï¼‰ï¼Œæ ¼å¼ï¼š{ fieldName: { old: value, new: value } }
  changes    String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œä¼˜å…ˆä½¿ç”¨ diff
  beforeData String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿä½¿ç”¨ snapshot å’Œ diff
  afterData  String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿä½¿ç”¨ snapshot å’Œ diff

  // ============ å®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯ ============
  clientInfo String? // ğŸ“± å®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯ï¼ˆJSONï¼‰ï¼ŒåŒ…å«ï¼š{ ip, userAgent, device, browser, os }
  ip         String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿå­˜å…¥ clientInfo
  userAgent  String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿå­˜å…¥ clientInfo

  // ============ å…¶ä»–ä¿¡æ¯ ============
  details String? // æ“ä½œçš„è‡ªç„¶è¯­è¨€æè¿°ï¼ˆå¦‚ï¼š"å¼ ä¸‰ å®¡æ‰¹é€šè¿‡äº† ä½œä¸šç¥¨ [JOB-2024-001]"ï¼‰

  createdAt DateTime @default(now())

  // ============ æ€§èƒ½ä¼˜åŒ–ç´¢å¼• ============
  @@index([userId]) // æŒ‰ç”¨æˆ·æŸ¥è¯¢
  @@index([module]) // æŒ‰æ¨¡å—æŸ¥è¯¢
  @@index([action]) // æŒ‰æ“ä½œç±»å‹æŸ¥è¯¢
  @@index([targetType]) // æŒ‰å¯¹è±¡ç±»å‹æŸ¥è¯¢
  @@index([targetId]) // æŒ‰ä¸šåŠ¡ç¼–å·æŸ¥è¯¢ï¼ˆé«˜é¢‘ï¼‰
  @@index([businessCode]) // æŒ‰ä¸šåŠ¡ç¼–ç æŸ¥è¯¢
  @@index([createdAt]) // æŒ‰æ—¶é—´æ’åº
  @@index([module, targetId]) // å¤åˆæŸ¥è¯¢ï¼šæŸæ¨¡å—ä¸‹çš„æŸä¸ªå¯¹è±¡çš„å…¨ç”Ÿå‘½å‘¨æœŸæ—¥å¿—
  @@index([userId, createdAt]) // å¤åˆæŸ¥è¯¢ï¼šæŸç”¨æˆ·çš„æ“ä½œæ—¶é—´çº¿
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  content     String
  relatedType String?
  relatedId   String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TrainingMaterial {
  id                  String                  @id @default(cuid())
  title               String
  description         String?
  type                String // video, pdf, docx
  category            String? // å­¦ä¹ ç±»å‹åˆ†ç±»
  url                 String
  convertedUrl        String? // PDF version of docx
  thumbnail           String? // ç¼©ç•¥å›¾è·¯å¾„
  duration            Int? // seconds, for video
  isExamRequired      Boolean                 @default(false)
  passingScore        Int?
  examMode            String                  @default("standard") // standard, random
  randomQuestionCount Int? // éšæœºæ¨¡å¼ä¸‹çš„é¢˜ç›®æ•°é‡
  isPublic            Boolean                 @default(true) // æ˜¯å¦æ”¾å…¥å…¬å…±çŸ¥è¯†åº“
  uploaderId          String
  uploader            User                    @relation(fields: [uploaderId], references: [id])
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  questions           ExamQuestion[]
  tasks               TrainingTask[]
  learnedRecords      MaterialLearnedRecord[]
}

model ExamQuestion {
  id         String           @id @default(cuid())
  materialId String
  material   TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  type       String // single, multiple
  question   String
  options    String // JSON string
  answer     String // JSON string
  score      Int
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model TrainingTask {
  id              String               @id @default(cuid())
  title           String
  description     String?
  startDate       DateTime
  endDate         DateTime
  materialId      String
  material        TrainingMaterial     @relation(fields: [materialId], references: [id])
  publisherId     String
  publisher       User                 @relation("TaskPublisher", fields: [publisherId], references: [id])
  targetType      String // all, dept, user
  targetConfig    String? // JSON string
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  assignments     TrainingAssignment[]
  autoAssignRules AutoAssignRule[]
}

// è‡ªåŠ¨æ´¾å‘è§„åˆ™ï¼šç”¨äºæŠŠåŸ¹è®­ä»»åŠ¡ä¸äº‹ä»¶/è§„åˆ™ç»‘å®š
model AutoAssignRule {
  id        String       @id @default(cuid())
  taskId    String
  task      TrainingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  mode      String // 'event' | 'rule'
  eventType String? // ä¾‹å¦‚: 'user_first_login','job_changed','document_updated','exam_finished'
  condition String? // å­˜å‚¨è§¦å‘æ¡ä»¶ä¸ç›®æ ‡é…ç½®çš„ JSON å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ { jobTitle: 'æ“ä½œå·¥' } æˆ– { documentId: '...' }
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model TrainingAssignment {
  id          String       @id @default(cuid())
  taskId      String
  task        TrainingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  status      String // assigned, in-progress, completed, passed, failed
  progress    Int // 0-100 or seconds watched
  isPassed    Boolean      @default(false)
  examScore   Int?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([taskId, userId])
}

model MaterialLearnedRecord {
  id         String           @id @default(cuid())
  materialId String
  material   TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  learnedAt  DateTime         @default(now())

  @@unique([materialId, userId])
}

// é€šçŸ¥æ¨¡æ¿ç®¡ç†
model NotificationTemplate {
  id               String   @id @default(cuid())
  name             String   @unique
  title            String // æ”¯æŒå˜é‡å ä½ç¬¦ï¼Œå¦‚ {{user.name}}
  content          String // æ”¯æŒå˜é‡å ä½ç¬¦
  type             String // hazard, training, work_permit, system
  triggerEvent     String // è§¦å‘äº‹ä»¶ï¼šhazard_created, hazard_assigned, etc
  triggerCondition String? // JSONé…ç½®ï¼šæ¡ä»¶è§„åˆ™
  isActive         Boolean  @default(true)
  variables        String? // JSONæ•°ç»„ï¼šå¯ç”¨å˜é‡åˆ—è¡¨
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// AI API é…ç½®
model AIApiConfig {
  id                 String     @id @default(cuid())
  name               String     @unique
  provider           String // openai, azure, custom
  apiKey             String // åŠ å¯†å­˜å‚¨
  endpoint           String
  model              String? // gpt-4, gpt-3.5-turbo, etc
  maxTokens          Int        @default(2000)
  temperature        Float      @default(0.7)
  isActive           Boolean    @default(true)
  rateLimitPerMinute Int        @default(1000) // é™æµç­–ç•¥ï¼šæ¯åˆ†é’Ÿæœ€å¤§è°ƒç”¨æ¬¡æ•°
  rateLimitPerDay    Int        @default(50000) // æ¯å¤©æœ€å¤§è°ƒç”¨æ¬¡æ•°
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  logs               AIApiLog[]
}

// AI API è°ƒç”¨æ—¥å¿—
model AIApiLog {
  id              String      @id @default(cuid())
  configId        String
  config          AIApiConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  requestBy       String? // è°ƒç”¨è€…ç”¨æˆ·IDæˆ–ç³»ç»Ÿåç§°
  requestSource   String? // hazard, training, work_permit, custom
  requestPayload  String? // JSONï¼šè¯·æ±‚å†…å®¹
  responsePayload String? // JSONï¼šå“åº”å†…å®¹
  tokens          Int? // æ¶ˆè€—çš„tokenæ•°
  duration        Int? // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  status          String // success, error, rate_limited
  errorMessage    String?
  ip              String?
  createdAt       DateTime    @default(now())
}

// AI API ç”¨æˆ·é™æµç­–ç•¥
model AIApiRateLimit {
  id           String   @id @default(cuid())
  userId       String? // ç”¨æˆ·IDï¼Œå¦‚æœä¸ºnullåˆ™åº”ç”¨äºæ‰€æœ‰ç”¨æˆ·
  departmentId String? // éƒ¨é—¨IDï¼Œå¦‚æœä¸ºnullåˆ™åº”ç”¨äºæ‰€æœ‰éƒ¨é—¨
  dailyLimit   Int      @default(100) // æ¯æ—¥APIè°ƒç”¨æ€»æ¬¡æ•°é™åˆ¶
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, departmentId], name: "userId_departmentId") // ç¡®ä¿æ¯ä¸ªç”¨æˆ·/éƒ¨é—¨ç»„åˆåªæœ‰ä¸€ä¸ªé™æµç­–ç•¥
  @@index([userId])
  @@index([departmentId])
}

// æ–‡ä»¶å…ƒæ•°æ®è¡¨ - ç”¨äºæ–‡ä»¶ç´¢å¼•å’Œå¢é‡å¤‡ä»½
model FileMetadata {
  id             String    @id @default(cuid())
  filePath       String    @unique // æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ /uploads/docs/DOCX-xxx.docx
  fileName       String // åŸå§‹æ–‡ä»¶å
  fileType       String // docx, pdf, xlsx, mp4, jpg, pngç­‰
  fileSize       Int // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  md5Hash        String    @unique // MD5å“ˆå¸Œå€¼ï¼Œç”¨äºå»é‡å’Œå¢é‡å¤‡ä»½
  category       String // docs, training, avatar, thumbnail, other
  uploaderId     String?
  uploader       User?     @relation("FileUploader", fields: [uploaderId], references: [id])
  uploadedAt     DateTime  @default(now())
  lastAccessedAt DateTime? // æœ€åè®¿é—®æ—¶é—´ï¼Œç”¨äºå½’æ¡£ç­–ç•¥
  isArchived     Boolean   @default(false) // æ˜¯å¦å·²å½’æ¡£åˆ°å†·å­˜å‚¨
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([md5Hash])
  @@index([category])
  @@index([uploadedAt])
  @@index([lastAccessedAt])
  @@index([isArchived])
}
