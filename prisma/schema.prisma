generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Project {
  id              String   @id @default(cuid())
  code            String   @unique @default(cuid())
  name            String
  contractNo      String?
  location        String
  startDate       DateTime
  endDate         DateTime
  requestDept     String
  requestHead     String
  requestContact  String
  mgmtDept        String?
  mgmtHead        String?
  mgmtContact     String?
  supplierName    String
  supplierHead    String
  supplierContact String
  attachments     String?
  deletedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  permits         WorkPermitRecord[]
}

model WorkPermitTemplate {
  id            String   @id @default(cuid())
  name          String
  type          String
  structureJson String
  workflowConfig String?
  parsedFields  String?
  level         String   @default("primary")
  sectionBindings String?
  orientation   String   @default("portrait")
  mobileFormConfig String?
  isLocked      Boolean  @default(false)
  createdAt     DateTime @default(now())
  records       WorkPermitRecord[]
}

model WorkPermitRecord {
  id          String   @id @default(cuid())
  code        String?  @unique
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId  String
  template    WorkPermitTemplate @relation(fields: [templateId], references: [id])
  dataJson    String
  status      String   @default("draft") 
  currentStep Int      @default(0)
  approvalLogs String?
  attachments String?
  parsedFieldValues String?
  createdAt   DateTime @default(now())
}

model User {
  id              String   @id @default(cuid())
  username        String   @unique
  name            String
  password        String
  avatar          String   @default("/image/default_avatar.jpg")
  role            String   @default("user")
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])
  jobTitle        String?
  directManagerId String?
  permissions     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  reportedHazards  HazardRecord[] @relation("Reporter")
  assignedHazards  HazardRecord[] @relation("Responsible")
}

model Department {
  id          String   @id @default(cuid())
  name        String
  parentId    String?
  parent      Department? @relation("DeptHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DeptHierarchy")
  managerId   String?
  level       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model HazardRecord {
  id              String   @id @default(cuid())
  code            String?  @unique
  status          String   @default("reported")
  riskLevel       String   @default("low")
  type            String
  location        String
  desc            String
  photos          String?
  reporterId      String
  reporter        User     @relation("Reporter", fields: [reporterId], references: [id])
  reporterName    String
  reportTime      DateTime @default(now())
  responsibleId   String?
  responsible     User?    @relation("Responsible", fields: [responsibleId], references: [id])
  responsibleName String?
  responsibleDept String?
  deadline        DateTime?
  rectifyDesc     String?
  rectifyPhotos   String?
  rectifyTime     DateTime?
  verifierId      String?
  verifierName    String?
  verifyTime      DateTime?
  rectifyRequirement    String?
  requireEmergencyPlan  Boolean  @default(false)
  emergencyPlanDeadline DateTime?
  emergencyPlanContent  String?
  emergencyPlanSubmitTime DateTime?
  ccDepts               String?
  ccUsers               String?
  logs                  String?
  old_personal_ID       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model HazardConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id          String   @id @default(cuid())
  name        String
  type        String
  docxPath    String?
  pdfPath     String?
  prefix      String?
  suffix      Int?
  fullNum     String?
  level       Int
  parentId    String?
  parent      Document? @relation("DocHierarchy", fields: [parentId], references: [id])
  children    Document[] @relation("DocHierarchy")
  dept        String?
  uploader    String?
  uploadTime  DateTime @default(now())
  searchText  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SystemLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String
  targetId  String?
  details   String?
  ip        String?
  createdAt DateTime @default(now())
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  content     String
  relatedType String?
  relatedId   String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
