generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Project {
  id              String             @id @default(cuid())
  code            String             @unique @default(cuid())
  name            String
  contractNo      String?
  location        String
  startDate       DateTime
  endDate         DateTime
  requestDept     String
  requestHead     String
  requestContact  String
  mgmtDept        String?
  mgmtHead        String?
  mgmtContact     String?
  supplierName    String
  supplierHead    String
  supplierContact String
  attachments     String?
  deletedAt       DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  permits         WorkPermitRecord[]
}

model WorkPermitTemplate {
  id               String             @id @default(cuid())
  name             String
  type             String
  structureJson    String
  workflowConfig   String?
  parsedFields     String?
  level            String             @default("primary")
  sectionBindings  String?
  orientation      String             @default("portrait")
  mobileFormConfig String?
  isLocked         Boolean            @default(false)
  // ğŸŸ¢ åŠ¨æ€è®°å½•å‹æ¨¡æ¿ï¼ˆå¦‚ï¼šæ°”ä½“æ£€æµ‹ã€å·¡æ£€è®°å½•ï¼‰
  // å…è®¸åœ¨çˆ¶è¡¨å•å®¡æ‰¹é€šè¿‡åï¼Œä»¥â€œè¿½åŠ è®°å½•â€çš„æ–¹å¼æŒç»­å†™å…¥
  isDynamicLog     Boolean            @default(false)
  createdAt        DateTime           @default(now())
  records          WorkPermitRecord[]
}

model WorkPermitRecord {
  id                String             @id @default(cuid())
  code              String?            @unique
  projectId         String
  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId        String
  template          WorkPermitTemplate @relation(fields: [templateId], references: [id])
  dataJson          String
  status            String             @default("draft")
  currentStep       Int                @default(0)
  approvalLogs      String?
  attachments       String?
  parsedFieldValues String?
  candidateHandlers String? // ğŸŸ¢ æˆ–ç­¾/ä¼šç­¾æ¨¡å¼ï¼šå€™é€‰å®¡æ‰¹äººåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
  approvalMode      String? // ğŸŸ¢ å½“å‰æ­¥éª¤çš„å®¡æ‰¹æ¨¡å¼ï¼ˆOR=æˆ–ç­¾ï¼ŒAND=ä¼šç­¾ï¼‰
  createdAt         DateTime           @default(now())

  // ğŸŸ¢ æ•°æ®æ˜ å°„å±‚ï¼šå…³é”®ä¸šåŠ¡å­—æ®µï¼ˆä» dataJson ä¸­æå–ï¼Œç”¨äº SQL ç»Ÿè®¡æŸ¥è¯¢ï¼‰
  riskLevel      String? // é£é™©ç­‰çº§ï¼šlow, medium, high, critical
  workType       String? // ä½œä¸šç±»å‹ï¼šåŠ¨ç«ã€é«˜å¤„ã€å—é™ç©ºé—´ç­‰
  location       String? // ä½œä¸šåœ°ç‚¹
  applicantId    String? // ç”³è¯·äººID
  applicantName  String? // ç”³è¯·äººå§“å
  applicantDept  String? // ç”³è¯·äººéƒ¨é—¨
  workDate       DateTime? // ä½œä¸šæ—¥æœŸ
  workStartTime  DateTime? // ä½œä¸šå¼€å§‹æ—¶é—´
  workEndTime    DateTime? // ä½œä¸šç»“æŸæ—¶é—´
  supervisorId   String? // ç›‘æŠ¤äººID
  supervisorName String? // ç›‘æŠ¤äººå§“å

  // å…³è”å…³ç³»
  signatures SignatureRecord[]
  subPermits SubPermit[]

  // ç´¢å¼•ï¼šç”¨äºç»Ÿè®¡æŸ¥è¯¢
  @@index([riskLevel])
  @@index([workType])
  @@index([location])
  @@index([applicantId])
  @@index([applicantDept])
  @@index([workDate])
  @@index([status])
  @@index([createdAt])
  @@index([workType, workDate]) // å¤åˆç´¢å¼•ï¼šæŒ‰ç±»å‹å’Œæ—¥æœŸç»Ÿè®¡
  @@index([applicantDept, workDate]) // å¤åˆç´¢å¼•ï¼šæŒ‰éƒ¨é—¨å’Œæ—¥æœŸç»Ÿè®¡
}

model User {
  id                  String                  @id @default(cuid())
  username            String                  @unique
  name                String
  password            String
  avatar              String                  @default("/image/default_avatar.jpg")
  role                String                  @default("user")
  departmentId        String?
  department          Department?             @relation(fields: [departmentId], references: [id])
  jobTitle            String?
  directManagerId     String?
  permissions         String?
  isActive            Boolean                 @default(true) // åœ¨èŒçŠ¶æ€ï¼štrue=åœ¨èŒï¼Œfalse=ç¦»èŒ
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  reportedHazards     HazardRecord[]          @relation("Reporter")
  assignedHazards     HazardRecord[]          @relation("Responsible")
  uploadedMaterials   TrainingMaterial[]
  publishedTasks      TrainingTask[]          @relation("TaskPublisher")
  trainingAssignments TrainingAssignment[]
  learnedRecords      MaterialLearnedRecord[]
  uploadedFiles       FileMetadata[]          @relation("FileUploader")
  reportedIncidents   Incident[]              @relation("IncidentReporter")
}

model Department {
  id        String       @id @default(cuid())
  name      String
  parentId  String?
  parent    Department?  @relation("DeptHierarchy", fields: [parentId], references: [id])
  children  Department[] @relation("DeptHierarchy")
  managerId String?
  level     Int          @default(1)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  users     User[]
  incidents Incident[]   @relation("IncidentDepartment")
}

model HazardRecord {
  id                      String    @id @default(cuid())
  code                    String?   @unique
  status                  String    @default("reported")
  riskLevel               String    @default("low")
  type                    String
  location                String
  desc                    String
  photos                  String?
  reporterId              String
  reporter                User      @relation("Reporter", fields: [reporterId], references: [id])
  reporterName            String
  reportTime              DateTime  @default(now())
  responsibleId           String?
  responsible             User?     @relation("Responsible", fields: [responsibleId], references: [id])
  responsibleName         String?
  responsibleDept         String?
  deadline                DateTime?
  rectifyDesc             String?
  rectifyPhotos           String?
  rectifyTime             DateTime?
  verifierId              String?
  verifierName            String?
  verifyTime              DateTime?
  verifyPhotos            String? // éªŒæ”¶æ—¶çš„ç°åœºç…§ç‰‡è·¯å¾„ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  verifyDesc              String? // éªŒæ”¶æ—¶çš„æè¿°/è¯„ä»·
  rectifyRequirement      String?
  requireEmergencyPlan    Boolean   @default(false)
  emergencyPlanDeadline   DateTime?
  emergencyPlanContent    String?
  emergencyPlanSubmitTime DateTime?
  rootCause               String? // æ ¹æœ¬åŸå› åˆ†æåˆ†ç±»ï¼ˆå¦‚ï¼šäººçš„ä¸å®‰å…¨è¡Œä¸ºã€ç‰©çš„ä¸å®‰å…¨çŠ¶æ€ã€ç®¡ç†ç¼ºé™·ç­‰ï¼‰
  ccDepts                 String?
  ccUsers                 String?
  logs                    String?
  old_personal_ID         String?
  dopersonal_ID           String? // å½“å‰æ­¥éª¤æ‰§è¡ŒäººIDï¼ˆåŠ¨æ€å­—æ®µï¼Œéšæ­¥éª¤æµè½¬æ›´æ–°ï¼‰
  dopersonal_Name         String? // å½“å‰æ­¥éª¤æ‰§è¡Œäººå§“åï¼ˆåŠ¨æ€å­—æ®µï¼Œéšæ­¥éª¤æµè½¬æ›´æ–°ï¼‰
  candidateHandlers       String? // ğŸŸ¢ æˆ–ç­¾/ä¼šç­¾æ¨¡å¼ï¼šå€™é€‰å¤„ç†äººåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
  approvalMode            String? // ğŸŸ¢ å½“å‰æ­¥éª¤çš„å®¡æ‰¹æ¨¡å¼ï¼ˆOR=æˆ–ç­¾ï¼ŒAND=ä¼šç­¾ï¼‰
  currentStepIndex        Int?      @default(0) // å½“å‰æ­¥éª¤ç´¢å¼•ï¼ˆç”¨äºè¿½è¸ªå·¥ä½œæµä½ç½®ï¼‰
  currentStepId           String? // å½“å‰æ­¥éª¤IDï¼ˆç”¨äºè¿½è¸ªå·¥ä½œæµä½ç½®ï¼‰
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // å…³è”å…³ç³»
  signatures SignatureRecord[]
  extensions HazardExtension[]
}

// éšæ‚£æ•´æ”¹å»¶æœŸå†å²è®°å½•
model HazardExtension {
  id          String       @id @default(cuid())
  hazardId    String
  hazard      HazardRecord @relation(fields: [hazardId], references: [id], onDelete: Cascade)
  oldDeadline DateTime // åŸå®šæˆªæ­¢æ—¥æœŸ
  newDeadline DateTime // ç”³è¯·çš„æ–°æˆªæ­¢æ—¥æœŸ
  reason      String // å»¶æœŸåŸå› 
  applicantId String // ç”³è¯·äººID
  approverId  String? // æ‰¹å‡†äººIDï¼ˆNullableï¼‰
  status      String       @default("pending") // çŠ¶æ€ï¼špending(å¾…å®¡æ‰¹), approved(å·²æ‰¹å‡†), rejected(å·²é©³å›)
  createdAt   DateTime     @default(now())

  // ç´¢å¼•
  @@index([hazardId])
  @@index([applicantId])
  @@index([approverId])
  @@index([status])
  @@index([createdAt])
}

model HazardConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============ äº‹æ•…äº‹ä»¶ç®¡ç†æ¨¡å— ============
model Incident {
  id   String  @id @default(cuid())
  code String? @unique // äº‹æ•…ç¼–å·ï¼Œå¦‚ï¼šINC-2024-001

  // ============ åŸºç¡€ä¿¡æ¯ ============
  type        String // äº‹æ•…ç±»å‹ï¼šinjury(ä¼¤å®³äº‹æ•…), near_miss(æœªé‚äº‹æ•…), property_damage(è´¢äº§æŸå¤±), environmental(ç¯å¢ƒäº‹æ•…)
  severity    String // ä¸¥é‡ç¨‹åº¦ï¼šminor(è½»å¾®), moderate(ä¸­ç­‰), serious(ä¸¥é‡), critical(é‡å¤§)
  occurredAt  DateTime // äº‹æ•…å‘ç”Ÿæ—¶é—´
  location    String // å‘ç”Ÿåœ°ç‚¹
  description String // äº‹æ•…æè¿°

  // ============ å…³è”å…³ç³» ============
  reporterId   String // ä¸ŠæŠ¥äººID
  reporter     User     @relation("IncidentReporter", fields: [reporterId], references: [id])
  reporterName String // ä¸ŠæŠ¥äººå§“åï¼ˆå¿«ç…§ï¼‰
  reporterDept String? // ä¸ŠæŠ¥äººéƒ¨é—¨ï¼ˆå¿«ç…§ï¼‰
  reportTime   DateTime @default(now()) // ä¸ŠæŠ¥æ—¶é—´

  departmentId   String? // è´£ä»»éƒ¨é—¨ID
  department     Department? @relation("IncidentDepartment", fields: [departmentId], references: [id])
  departmentName String? // è´£ä»»éƒ¨é—¨åç§°ï¼ˆå¿«ç…§ï¼‰

  // ============ è°ƒæŸ¥è¯¦æƒ…ï¼ˆ5Whyåˆ†ææ³•ï¼‰ ============
  // ç›´æ¥åŸå› 
  directCause String? // ç›´æ¥åŸå› æè¿°

  // é—´æ¥åŸå› 
  indirectCause String? // é—´æ¥åŸå› æè¿°

  // ç®¡ç†åŸå› 
  managementCause String? // ç®¡ç†åŸå› æè¿°

  // æ ¹æœ¬åŸå› ï¼ˆç»¼åˆï¼‰
  rootCause String? // æ ¹æœ¬åŸå› åˆ†æ

  // ============ æ•´æ”¹æªæ–½ (CAPA) ============
  correctiveActions     String? // çº æ­£æªæ–½ï¼ˆJSONæ ¼å¼ï¼Œæ”¯æŒå¤šæ¡ï¼‰
  preventiveActions     String? // é¢„é˜²æªæ–½ï¼ˆJSONæ ¼å¼ï¼Œæ”¯æŒå¤šæ¡ï¼‰
  actionDeadline        DateTime? // æ•´æ”¹æªæ–½å®ŒæˆæœŸé™
  actionResponsibleId   String? // æ•´æ”¹æªæ–½è´Ÿè´£äººID
  actionResponsibleName String? // æ•´æ”¹æªæ–½è´Ÿè´£äººå§“å

  // ============ é™„ä»¶ä¸è¯æ® ============
  photos              String? // ç°åœºç…§ç‰‡ï¼ˆJSONæ•°ç»„ï¼Œå­˜å‚¨MinIOè·¯å¾„ï¼‰
  attachments         String? // å…¶ä»–é™„ä»¶ï¼ˆJSONæ•°ç»„ï¼Œå­˜å‚¨MinIOè·¯å¾„ï¼‰
  investigationReport String? // è°ƒæŸ¥æŠ¥å‘Šï¼ˆMinIOè·¯å¾„ï¼‰

  // ============ å·¥ä½œæµé›†æˆ ============
  status           String  @default("reported") // çŠ¶æ€ï¼šreported(å·²ä¸ŠæŠ¥), investigating(è°ƒæŸ¥ä¸­), reviewed(å¾…å®¡æ‰¹), closed(å·²ç»“æ¡ˆ), rejected(å·²é©³å›)
  currentStepIndex Int?    @default(0) // å½“å‰å·¥ä½œæµæ­¥éª¤ç´¢å¼•
  currentStepId    String? // å½“å‰å·¥ä½œæµæ­¥éª¤ID
  flowId           String? // å…³è”çš„å·¥ä½œæµå®šä¹‰ID
  workflowLogs     String? // å·¥ä½œæµå®¡æ‰¹æ—¥å¿—ï¼ˆJSONæ ¼å¼ï¼‰

  // å½“å‰å¤„ç†äººï¼ˆåŠ¨æ€å­—æ®µï¼Œéšå·¥ä½œæµæµè½¬æ›´æ–°ï¼‰
  currentHandlerId   String?
  currentHandlerName String?
  candidateHandlers  String? // å€™é€‰å¤„ç†äººåˆ—è¡¨ï¼ˆJSONæ ¼å¼ï¼Œç”¨äºæˆ–ç­¾/ä¼šç­¾ï¼‰
  approvalMode       String? // å½“å‰æ­¥éª¤çš„å®¡æ‰¹æ¨¡å¼ï¼ˆOR=æˆ–ç­¾ï¼ŒAND=ä¼šç­¾ï¼‰

  // ============ å®¡æ‰¹ä¸ç»“æ¡ˆ ============
  reviewerId    String? // å®¡æ‰¹äººID
  reviewerName  String? // å®¡æ‰¹äººå§“å
  reviewTime    DateTime? // å®¡æ‰¹æ—¶é—´
  reviewComment String? // å®¡æ‰¹æ„è§

  closerId    String? // ç»“æ¡ˆäººID
  closerName  String? // ç»“æ¡ˆäººå§“å
  closeTime   DateTime? // ç»“æ¡ˆæ—¶é—´
  closeReason String? // ç»“æ¡ˆåŸå› 

  // ============ æ•°å­—ç­¾å ============
  signatures SignatureRecord[] // å…³è”çš„ç­¾åè®°å½•ï¼ˆè°ƒæŸ¥æŠ¥å‘Šç­¾å­—ã€ç»“æ¡ˆç­¾å­—ç­‰ï¼‰

  // ============ é€šçŸ¥ä¸æŠ„é€ ============
  ccDepts String? // æŠ„é€éƒ¨é—¨ï¼ˆJSONæ•°ç»„ï¼‰
  ccUsers String? // æŠ„é€ç”¨æˆ·ï¼ˆJSONæ•°ç»„ï¼‰

  // ============ æ—¶é—´æˆ³ ============
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============ ç´¢å¼•ä¼˜åŒ– ============
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([reporterId])
  @@index([departmentId])
  @@index([occurredAt])
  @@index([createdAt])
  @@index([status, occurredAt]) // å¤åˆç´¢å¼•ï¼šæŒ‰çŠ¶æ€å’Œæ—¶é—´æŸ¥è¯¢
  @@index([departmentId, occurredAt]) // å¤åˆç´¢å¼•ï¼šæŒ‰éƒ¨é—¨å’Œæ—¶é—´ç»Ÿè®¡
}

model Document {
  id         String     @id @default(cuid())
  name       String
  type       String
  docxPath   String?
  pdfPath    String?
  prefix     String?
  suffix     Int?
  fullNum    String?
  level      Int
  parentId   String?
  parent     Document?  @relation("DocHierarchy", fields: [parentId], references: [id])
  children   Document[] @relation("DocHierarchy")
  dept       String?
  uploader   String?
  uploadTime DateTime   @default(now())
  searchText String?

  // ğŸŸ¢ EHS Archive Fields
  archiveCategory String? // 'enterprise', 'equipment', 'personnel'
  expiryDate      DateTime? // License/Certificate expiration date
  warningDays     Int       @default(30) // Days before expiry to warn
  entityId        String? // Link to User.id or Equipment ID

  tags Tag[] @relation("DocumentTags")

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  history   DocumentHistory[]
}

model Tag {
  id        String     @id @default(cuid())
  name      String     @unique
  color     String     @default("#blue") // UI display color
  documents Document[] @relation("DocumentTags")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model DocumentHistory {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  type       String // 'docx', 'xlsx', 'pdf'
  name       String
  path       String
  uploader   String?
  uploadTime DateTime @default(now())
  createdAt  DateTime @default(now())
}

model SystemLog {
  id String @id @default(cuid())

  // ============ æ“ä½œäººèº«ä»½ä¿¡æ¯ï¼ˆå¿«ç…§ï¼‰ ============
  userId           String?
  userName         String?
  userRole         String? // æ“ä½œæ—¶çš„ç³»ç»Ÿè§’è‰²ï¼ˆadmin/user/managerç­‰ï¼‰
  userDepartment   String? // æ“ä½œæ—¶æ‰€å±éƒ¨é—¨åç§°
  userDepartmentId String? // æ“ä½œæ—¶æ‰€å±éƒ¨é—¨ID
  userJobTitle     String? // æ“ä½œæ—¶çš„èŒä½
  userRoleInAction String? // ç”¨æˆ·åœ¨æœ¬æ¬¡æ“ä½œä¸­çš„ä¸šåŠ¡è§’è‰²ï¼ˆä¸ŠæŠ¥äºº/æ•´æ”¹äºº/éªŒæ”¶äºº/å®¡æ‰¹äººç­‰ï¼‰

  // ============ æ“ä½œä¿¡æ¯ ============
  module       String // æ‰€å±æ¨¡å—ï¼šHAZARD, WORK_PERMIT, TRAINING, USER, ORG, SYSTEM ç­‰
  action       String // æ“ä½œç±»å‹ï¼šCREATE, UPDATE, DELETE, APPROVE, REJECT, EXPORT, LOGIN ç­‰
  actionLabel  String? // æ“ä½œç±»å‹çš„ä¸­æ–‡æè¿°ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚ï¼š"åˆ›å»ºéšæ‚£"ã€"å®¡æ‰¹ä½œä¸šç¥¨"ï¼‰
  businessCode String? // æ ‡å‡†ä¸šåŠ¡ç¼–ç ï¼ˆå¦‚ï¼šHD_CRT_001, WP_APV_001ï¼‰ï¼Œéµå¾ªä¸šåŠ¡ç¼–å·è§„èŒƒ

  // ============ æ“ä½œå¯¹è±¡ ============
  targetId    String? // è¢«æ“ä½œçš„ä¸šåŠ¡å®ä½“ç¼–å·ï¼ˆå¦‚ï¼šHZ-2024-001, JOB-2024-001ï¼‰âš ï¸ ä½¿ç”¨ä¸šåŠ¡ç¼–å·ï¼Œéæ•°æ®åº“ID
  targetType  String? // æ“ä½œå¯¹è±¡ç±»å‹ï¼ˆhazard, document, permit, training_task, user ç­‰ï¼‰
  targetLabel String? // è¢«æ“ä½œå¯¹è±¡çš„æè¿°ï¼ˆå¦‚ï¼šéšæ‚£ç®€è¿°å‰50å­—ã€æ–‡æ¡£æ ‡é¢˜ã€ä½œä¸šç±»å‹ï¼‰
  targetLink  String? // ğŸ”— æ“ä½œå¯¹è±¡çš„è¯¦æƒ…é¡µé“¾æ¥ï¼ˆç”¨äºæ—¥å¿—è¿½æº¯è·³è½¬ï¼‰

  // ============ å®¡è®¡ç»†èŠ‚ï¼ˆæ ¸å¿ƒï¼‰ ============
  snapshot   String? // ğŸ“¸ æ“ä½œåçš„å®Œæ•´å¯¹è±¡å¿«ç…§ï¼ˆJSONï¼‰ï¼Œæ¸…æ´—æ•æ„Ÿå­—æ®µåå­˜å‚¨ï¼Œç”¨äºå®Œæ•´è¿˜åŸå½“æ—¶çš„çŠ¶æ€
  diff       String? // ğŸ“Š ä¿®æ”¹å‰åçš„å·®å¼‚å¯¹æ¯”ï¼ˆJSONï¼‰ï¼Œæ ¼å¼ï¼š{ fieldName: { old: value, new: value } }
  changes    String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œä¼˜å…ˆä½¿ç”¨ diff
  beforeData String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿä½¿ç”¨ snapshot å’Œ diff
  afterData  String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿä½¿ç”¨ snapshot å’Œ diff

  // ============ å®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯ ============
  clientInfo String? // ğŸ“± å®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯ï¼ˆJSONï¼‰ï¼ŒåŒ…å«ï¼š{ ip, userAgent, device, browser, os }
  ip         String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿå­˜å…¥ clientInfo
  userAgent  String? // âš ï¸ ä¿ç•™å­—æ®µï¼Œå‘ä¸‹å…¼å®¹ï¼Œæ–°ç³»ç»Ÿå­˜å…¥ clientInfo

  // ============ å…¶ä»–ä¿¡æ¯ ============
  details String? // æ“ä½œçš„è‡ªç„¶è¯­è¨€æè¿°ï¼ˆå¦‚ï¼š"å¼ ä¸‰ å®¡æ‰¹é€šè¿‡äº† ä½œä¸šç¥¨ [JOB-2024-001]"ï¼‰

  createdAt DateTime @default(now())

  // ============ æ€§èƒ½ä¼˜åŒ–ç´¢å¼• ============
  @@index([userId]) // æŒ‰ç”¨æˆ·æŸ¥è¯¢
  @@index([module]) // æŒ‰æ¨¡å—æŸ¥è¯¢
  @@index([action]) // æŒ‰æ“ä½œç±»å‹æŸ¥è¯¢
  @@index([targetType]) // æŒ‰å¯¹è±¡ç±»å‹æŸ¥è¯¢
  @@index([targetId]) // æŒ‰ä¸šåŠ¡ç¼–å·æŸ¥è¯¢ï¼ˆé«˜é¢‘ï¼‰
  @@index([businessCode]) // æŒ‰ä¸šåŠ¡ç¼–ç æŸ¥è¯¢
  @@index([createdAt]) // æŒ‰æ—¶é—´æ’åº
  @@index([module, targetId]) // å¤åˆæŸ¥è¯¢ï¼šæŸæ¨¡å—ä¸‹çš„æŸä¸ªå¯¹è±¡çš„å…¨ç”Ÿå‘½å‘¨æœŸæ—¥å¿—
  @@index([userId, createdAt]) // å¤åˆæŸ¥è¯¢ï¼šæŸç”¨æˆ·çš„æ“ä½œæ—¶é—´çº¿
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  content     String
  relatedType String?
  relatedId   String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TrainingMaterial {
  id                  String                  @id @default(cuid())
  title               String
  description         String?
  type                String // video, pdf, docx
  category            String? // å­¦ä¹ ç±»å‹åˆ†ç±»
  url                 String
  convertedUrl        String? // PDF version of docx
  thumbnail           String? // ç¼©ç•¥å›¾è·¯å¾„
  duration            Int? // seconds, for video
  isExamRequired      Boolean                 @default(false)
  passingScore        Int?
  examMode            String                  @default("standard") // standard, random
  randomQuestionCount Int? // éšæœºæ¨¡å¼ä¸‹çš„é¢˜ç›®æ•°é‡
  isPublic            Boolean                 @default(true) // æ˜¯å¦æ”¾å…¥å…¬å…±çŸ¥è¯†åº“
  uploaderId          String
  uploader            User                    @relation(fields: [uploaderId], references: [id])
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  questions           ExamQuestion[]
  tasks               TrainingTask[]
  learnedRecords      MaterialLearnedRecord[]
}

model ExamQuestion {
  id         String           @id @default(cuid())
  materialId String
  material   TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  type       String // single, multiple
  question   String
  options    String // JSON string
  answer     String // JSON string
  score      Int
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model TrainingTask {
  id              String               @id @default(cuid())
  title           String
  description     String?
  startDate       DateTime
  endDate         DateTime
  materialId      String
  material        TrainingMaterial     @relation(fields: [materialId], references: [id])
  publisherId     String
  publisher       User                 @relation("TaskPublisher", fields: [publisherId], references: [id])
  targetType      String // all, dept, user
  targetConfig    String? // JSON string
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  assignments     TrainingAssignment[]
  autoAssignRules AutoAssignRule[]
}

// è‡ªåŠ¨æ´¾å‘è§„åˆ™ï¼šç”¨äºæŠŠåŸ¹è®­ä»»åŠ¡ä¸äº‹ä»¶/è§„åˆ™ç»‘å®š
model AutoAssignRule {
  id        String       @id @default(cuid())
  taskId    String
  task      TrainingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  mode      String // 'event' | 'rule'
  eventType String? // ä¾‹å¦‚: 'user_first_login','job_changed','document_updated','exam_finished'
  condition String? // å­˜å‚¨è§¦å‘æ¡ä»¶ä¸ç›®æ ‡é…ç½®çš„ JSON å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ { jobTitle: 'æ“ä½œå·¥' } æˆ– { documentId: '...' }
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model TrainingAssignment {
  id          String       @id @default(cuid())
  taskId      String
  task        TrainingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  status      String // assigned, in-progress, completed, passed, failed
  progress    Int // 0-100 or seconds watched
  isPassed    Boolean      @default(false)
  examScore   Int?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([taskId, userId])
}

model MaterialLearnedRecord {
  id         String           @id @default(cuid())
  materialId String
  material   TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  learnedAt  DateTime         @default(now())

  @@unique([materialId, userId])
}

// é€šçŸ¥æ¨¡æ¿ç®¡ç†
model NotificationTemplate {
  id               String   @id @default(cuid())
  name             String   @unique
  title            String // æ”¯æŒå˜é‡å ä½ç¬¦ï¼Œå¦‚ {{user.name}}
  content          String // æ”¯æŒå˜é‡å ä½ç¬¦
  type             String // hazard, training, work_permit, system
  triggerEvent     String // è§¦å‘äº‹ä»¶ï¼šhazard_created, hazard_assigned, etc
  triggerCondition String? // JSONé…ç½®ï¼šæ¡ä»¶è§„åˆ™
  isActive         Boolean  @default(true)
  variables        String? // JSONæ•°ç»„ï¼šå¯ç”¨å˜é‡åˆ—è¡¨
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// AI API é…ç½®
model AIApiConfig {
  id                 String     @id @default(cuid())
  name               String     @unique
  provider           String // openai, azure, custom
  apiKey             String // åŠ å¯†å­˜å‚¨
  endpoint           String
  model              String? // gpt-4, gpt-3.5-turbo, etc
  maxTokens          Int        @default(2000)
  temperature        Float      @default(0.7)
  isActive           Boolean    @default(true)
  rateLimitPerMinute Int        @default(1000) // é™æµç­–ç•¥ï¼šæ¯åˆ†é’Ÿæœ€å¤§è°ƒç”¨æ¬¡æ•°
  rateLimitPerDay    Int        @default(50000) // æ¯å¤©æœ€å¤§è°ƒç”¨æ¬¡æ•°
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  logs               AIApiLog[]
}

// AI API è°ƒç”¨æ—¥å¿—
model AIApiLog {
  id              String      @id @default(cuid())
  configId        String
  config          AIApiConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  requestBy       String? // è°ƒç”¨è€…ç”¨æˆ·IDæˆ–ç³»ç»Ÿåç§°
  requestSource   String? // hazard, training, work_permit, custom
  requestPayload  String? // JSONï¼šè¯·æ±‚å†…å®¹
  responsePayload String? // JSONï¼šå“åº”å†…å®¹
  tokens          Int? // æ¶ˆè€—çš„tokenæ•°
  duration        Int? // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  status          String // success, error, rate_limited
  errorMessage    String?
  ip              String?
  createdAt       DateTime    @default(now())
}

// AI API ç”¨æˆ·é™æµç­–ç•¥
model AIApiRateLimit {
  id           String   @id @default(cuid())
  userId       String? // ç”¨æˆ·IDï¼Œå¦‚æœä¸ºnullåˆ™åº”ç”¨äºæ‰€æœ‰ç”¨æˆ·
  departmentId String? // éƒ¨é—¨IDï¼Œå¦‚æœä¸ºnullåˆ™åº”ç”¨äºæ‰€æœ‰éƒ¨é—¨
  dailyLimit   Int      @default(100) // æ¯æ—¥APIè°ƒç”¨æ€»æ¬¡æ•°é™åˆ¶
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, departmentId], name: "userId_departmentId") // ç¡®ä¿æ¯ä¸ªç”¨æˆ·/éƒ¨é—¨ç»„åˆåªæœ‰ä¸€ä¸ªé™æµç­–ç•¥
  @@index([userId])
  @@index([departmentId])
}

// æ–‡ä»¶å…ƒæ•°æ®è¡¨ - ç”¨äºæ–‡ä»¶ç´¢å¼•å’Œå¢é‡å¤‡ä»½
model FileMetadata {
  id             String    @id @default(cuid())
  filePath       String    @unique // æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ /uploads/docs/DOCX-xxx.docx
  fileName       String // åŸå§‹æ–‡ä»¶å
  fileType       String // docx, pdf, xlsx, mp4, jpg, pngç­‰
  fileSize       Int // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  md5Hash        String    @unique // MD5å“ˆå¸Œå€¼ï¼Œç”¨äºå»é‡å’Œå¢é‡å¤‡ä»½
  category       String // docs, training, avatar, thumbnail, other
  uploaderId     String?
  uploader       User?     @relation("FileUploader", fields: [uploaderId], references: [id])
  uploadedAt     DateTime  @default(now())
  lastAccessedAt DateTime? // æœ€åè®¿é—®æ—¶é—´ï¼Œç”¨äºå½’æ¡£ç­–ç•¥
  isArchived     Boolean   @default(false) // æ˜¯å¦å·²å½’æ¡£åˆ°å†·å­˜å‚¨
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([md5Hash])
  @@index([category])
  @@index([uploadedAt])
  @@index([lastAccessedAt])
  @@index([isArchived])
}

// ğŸŸ¢ ç”µå­ç­¾åè®°å½•è¡¨ï¼ˆç¬¦åˆå®¡è®¡è¦æ±‚çš„ç”µå­ç­¾åæ–¹æ¡ˆï¼‰
model SignatureRecord {
  id         String            @id @default(cuid())
  permitId   String?
  permit     WorkPermitRecord? @relation(fields: [permitId], references: [id], onDelete: Cascade)
  incidentId String?
  incident   Incident?         @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  hazardId   String?
  hazard     HazardRecord?     @relation(fields: [hazardId], references: [id], onDelete: Cascade)
  signerId   String // ç­¾å­—äººID
  signerName String // ç­¾å­—äººå§“å
  action     String // 'pass' | 'reject' | 'issue' | 'site_confirm' | 'investigate' | 'close'
  comment    String? // å®¡æ‰¹æ„è§
  stepIndex  Int // å®¡æ‰¹æ­¥éª¤ç´¢å¼•
  stepName   String? // å®¡æ‰¹æ­¥éª¤åç§°

  // ğŸ” é˜²ç¯¡æ”¹æ ¸å¿ƒå­—æ®µ
  dataSnapshotHash String // ç­¾å­—æ—¶åˆ»è¡¨å•æ•°æ®çš„ Hash å€¼ï¼ˆSHA-256ï¼‰
  dataSnapshot     String? // ç­¾å­—æ—¶åˆ»è¡¨å•æ•°æ®çš„å®Œæ•´å¿«ç…§ï¼ˆJSONï¼Œå¯é€‰ï¼Œç”¨äºå®¡è®¡ï¼‰

  // æ—¶é—´æˆ³
  signedAt DateTime @default(now())

  // å®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯ï¼ˆç”¨äºå®¡è®¡ï¼‰
  clientInfo String? // JSONï¼š{ ip, userAgent, device, browser, os }

  // ç´¢å¼•
  @@index([permitId])
  @@index([incidentId])
  @@index([hazardId])
  @@index([signerId])
  @@index([signedAt])
  @@index([action])
  @@index([permitId, stepIndex]) // å¤åˆç´¢å¼•ï¼šæŸ¥è¯¢æŸä¸ªä½œä¸šç¥¨çš„æŸä¸ªæ­¥éª¤çš„æ‰€æœ‰ç­¾å
  @@index([incidentId, stepIndex]) // å¤åˆç´¢å¼•ï¼šæŸ¥è¯¢æŸä¸ªäº‹æ•…çš„æŸä¸ªæ­¥éª¤çš„æ‰€æœ‰ç­¾å
  @@index([hazardId, stepIndex]) // å¤åˆç´¢å¼•ï¼šæŸ¥è¯¢æŸä¸ªéšæ‚£çš„æŸä¸ªæ­¥éª¤çš„æ‰€æœ‰ç­¾å
}

// ğŸŸ¢ å­è¡¨å•è¡¨ï¼ˆè§£è€¦äºŒçº§è¡¨å•æ•°æ®ï¼‰
model SubPermit {
  id             String           @id @default(cuid())
  parentPermitId String
  parentPermit   WorkPermitRecord @relation(fields: [parentPermitId], references: [id], onDelete: Cascade)
  templateId     String // ç»‘å®šçš„äºŒçº§æ¨¡æ¿ID
  code           String? // å­è¡¨å•ç¼–å·ï¼ˆå¦‚ï¼šçˆ¶ç¼–å·-å­—æ®µåç®€å†™ï¼‰
  cellKey        String // çˆ¶è¡¨å•ä¸­ç»‘å®šçš„å•å…ƒæ ¼é”®ï¼ˆå¦‚ï¼šR5C3ï¼‰
  fieldName      String? // å­—æ®µåï¼ˆç”¨äºç”Ÿæˆç¼–å·ï¼‰
  dataJson       String // å­è¡¨å•çš„å®Œæ•´æ•°æ®ï¼ˆJSONï¼‰

  // çŠ¶æ€ï¼ˆå¯é€‰ï¼Œç”¨äºå­è¡¨å•çš„ç‹¬ç«‹å®¡æ‰¹æµç¨‹ï¼‰
  status       String  @default("draft")
  currentStep  Int     @default(0)
  approvalLogs String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ç´¢å¼•
  @@index([parentPermitId])
  @@index([templateId])
  @@index([code])
  @@index([cellKey])
  @@index([status])
  @@index([createdAt])
}

// ============ EHS æ¡£æ¡ˆåº“ç³»ç»Ÿ ============

// è®¾å¤‡æ¡£æ¡ˆ
model Equipment {
  id              String        @id @default(cuid())
  name            String // è®¾å¤‡åç§°
  code            String        @unique // è®¾å¤‡ç¼–å·
  description     String? // è®¾å¤‡æè¿°
  startDate       DateTime // å¯ç”¨æ—¥æœŸ
  expectedEndDate DateTime? // é¢„è®¡æŠ¥åºŸæ—¥æœŸ
  isSpecialEquip  Boolean       @default(false) // æ˜¯å¦ç‰¹ç§è®¾å¤‡
  inspectionCycle Int? // å®šæ£€å‘¨æœŸï¼ˆæœˆï¼‰
  lastInspection  DateTime? // ä¸Šæ¬¡å®šæ£€æ—¥æœŸ
  nextInspection  DateTime? // ä¸‹æ¬¡å®šæ£€æ—¥æœŸ
  status          String        @default("active") // active, disposed, under_maintenance
  files           ArchiveFile[] @relation("EquipmentFiles")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([isSpecialEquip])
  @@index([nextInspection])
}

// æ¡£æ¡ˆæ–‡ä»¶ï¼ˆé€šç”¨ï¼‰
model ArchiveFile {
  id           String  @id @default(cuid())
  name         String // æ˜¾ç¤ºåç§°
  fileType     String // æ–‡ä»¶ç±»å‹åˆ†ç±»ï¼ˆä»é…ç½®åº“é€‰æ‹©ï¼‰
  isDynamic    Boolean @default(false) // é™æ€/åŠ¨æ€èµ„æ–™
  description  String? // æ–‡ä»¶æè¿°
  filePath     String // MinIO å­˜å‚¨è·¯å¾„ï¼ˆæ ¼å¼ï¼šbucket:keyï¼‰
  originalName String // åŸå§‹æ–‡ä»¶å
  mimeType     String // MIME ç±»å‹
  fileSize     Int // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰

  // å…³è”åˆ†ç±»ï¼ˆå››é€‰ä¸€ï¼‰
  category    String // 'enterprise' | 'equipment' | 'personnel' | 'msds'
  equipmentId String?
  equipment   Equipment? @relation("EquipmentFiles", fields: [equipmentId], references: [id], onDelete: Cascade)
  userId      String? // å…³è” User.idï¼ˆä¸€äººä¸€æ¡£ï¼‰

  uploaderId   String? // ä¸Šä¼ è€…ID
  uploaderName String? // ä¸Šä¼ è€…å§“å
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([equipmentId])
  @@index([userId])
  @@index([fileType])
  @@index([createdAt])
}

// æ¡£æ¡ˆç³»ç»Ÿé…ç½®
model ArchiveConfig {
  id        String   @id @default(cuid())
  key       String   @unique // watermark, enterprise_types, equipment_types, personnel_types
  value     String // JSON æ ¼å¼å­˜å‚¨
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
