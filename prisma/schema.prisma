generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Project {
  id              String   @id @default(cuid())
  code            String   @unique @default(cuid())
  name            String
  contractNo      String?
  location        String
  startDate       DateTime
  endDate         DateTime
  requestDept     String
  requestHead     String
  requestContact  String
  mgmtDept        String?
  mgmtHead        String?
  mgmtContact     String?
  supplierName    String
  supplierHead    String
  supplierContact String
  attachments     String?
  deletedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  permits         WorkPermitRecord[]
}

model WorkPermitTemplate {
  id            String   @id @default(cuid())
  name          String
  type          String
  structureJson String
  workflowConfig String?
  parsedFields  String?
  level         String   @default("primary")
  sectionBindings String?
  orientation   String   @default("portrait")
  mobileFormConfig String?
  isLocked      Boolean  @default(false)
  createdAt     DateTime @default(now())
  records       WorkPermitRecord[]
}

model WorkPermitRecord {
  id          String   @id @default(cuid())
  code        String?  @unique
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId  String
  template    WorkPermitTemplate @relation(fields: [templateId], references: [id])
  dataJson    String
  status      String   @default("draft") 
  currentStep Int      @default(0)
  approvalLogs String?
  attachments String?
  parsedFieldValues String?
  createdAt   DateTime @default(now())
}

model User {
  id              String   @id @default(cuid())
  username        String   @unique
  name            String
  password        String
  avatar          String   @default("/image/default_avatar.jpg")
  role            String   @default("user")
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])
  jobTitle        String?
  directManagerId String?
  permissions     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  reportedHazards  HazardRecord[] @relation("Reporter")
  assignedHazards  HazardRecord[] @relation("Responsible")
  uploadedMaterials TrainingMaterial[]
  publishedTasks    TrainingTask[] @relation("TaskPublisher")
  trainingAssignments TrainingAssignment[]
  learnedRecords  MaterialLearnedRecord[]
}

model Department {
  id          String   @id @default(cuid())
  name        String
  parentId    String?
  parent      Department? @relation("DeptHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DeptHierarchy")
  managerId   String?
  level       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model HazardRecord {
  id              String   @id @default(cuid())
  code            String?  @unique
  status          String   @default("reported")
  riskLevel       String   @default("low")
  type            String
  location        String
  desc            String
  photos          String?
  reporterId      String
  reporter        User     @relation("Reporter", fields: [reporterId], references: [id])
  reporterName    String
  reportTime      DateTime @default(now())
  responsibleId   String?
  responsible     User?    @relation("Responsible", fields: [responsibleId], references: [id])
  responsibleName String?
  responsibleDept String?
  deadline        DateTime?
  rectifyDesc     String?
  rectifyPhotos   String?
  rectifyTime     DateTime?
  verifierId      String?
  verifierName    String?
  verifyTime      DateTime?
  rectifyRequirement    String?
  requireEmergencyPlan  Boolean  @default(false)
  emergencyPlanDeadline DateTime?
  emergencyPlanContent  String?
  emergencyPlanSubmitTime DateTime?
  ccDepts               String?
  ccUsers               String?
  logs                  String?
  old_personal_ID       String?
  currentStepIndex      Int?      @default(0)  // 当前步骤索引（用于追踪工作流位置）
  currentStepId         String?   // 当前步骤ID（用于追踪工作流位置）
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model HazardConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id          String   @id @default(cuid())
  name        String
  type        String
  docxPath    String?
  pdfPath     String?
  prefix      String?
  suffix      Int?
  fullNum     String?
  level       Int
  parentId    String?
  parent      Document? @relation("DocHierarchy", fields: [parentId], references: [id])
  children    Document[] @relation("DocHierarchy")
  dept        String?
  uploader    String?
  uploadTime  DateTime @default(now())
  searchText  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  history     DocumentHistory[]
}

model DocumentHistory {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  type        String   // 'docx', 'xlsx', 'pdf'
  name        String
  path        String
  uploader    String?
  uploadTime  DateTime @default(now())
  createdAt   DateTime @default(now())
}

model SystemLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String
  targetId  String?
  targetType String? // 'hazard', 'document', 'permit' 等
  details   String?
  snapshot  String?  // JSON string: 记录流程快照（引擎解析结果、候选人列表等）
  ip        String?
  createdAt DateTime @default(now())
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  content     String
  relatedType String?
  relatedId   String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TrainingMaterial {
  id            String   @id @default(cuid())
  title         String
  description   String?
  type          String   // video, pdf, docx
  category      String?  // 学习类型分类
  url           String
  convertedUrl  String?  // PDF version of docx
  thumbnail     String?  // 缩略图路径
  duration      Int?     // seconds, for video
  isExamRequired Boolean @default(false)
  passingScore  Int?
  isPublic      Boolean  @default(true) // 是否放入公共知识库
  uploaderId    String
  uploader      User     @relation(fields: [uploaderId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  questions     ExamQuestion[]
  tasks         TrainingTask[]
  learnedRecords MaterialLearnedRecord[]
}

model ExamQuestion {
  id            String   @id @default(cuid())
  materialId    String
  material      TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  type          String   // single, multiple
  question      String
  options       String   // JSON string
  answer        String   // JSON string
  score         Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model TrainingTask {
  id            String   @id @default(cuid())
  title         String
  description   String?
  startDate     DateTime
  endDate       DateTime
  materialId    String
  material      TrainingMaterial @relation(fields: [materialId], references: [id])
  publisherId   String
  publisher     User     @relation("TaskPublisher", fields: [publisherId], references: [id])
  targetType    String   // all, dept, user
  targetConfig  String?  // JSON string
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  assignments   TrainingAssignment[]
}

model TrainingAssignment {
  id            String   @id @default(cuid())
  taskId        String
  task          TrainingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  status        String   // assigned, in-progress, completed, passed, failed
  progress      Int      // 0-100 or seconds watched
  isPassed      Boolean  @default(false)
  examScore     Int?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([taskId, userId])
}

model MaterialLearnedRecord {
  id          String   @id @default(cuid())
  materialId  String
  material    TrainingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  learnedAt   DateTime @default(now())

  @@unique([materialId, userId])
}
