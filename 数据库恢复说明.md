# 数据库恢复说明

## 问题诊断

您的数据库文件已损坏（"database disk image is malformed"），需要重新创建。

## 恢复步骤

### 方法 1: 使用批处理脚本（推荐）

1. **关闭所有正在运行的应用程序**
   - 关闭 Next.js 开发服务器（如果正在运行）
   - 关闭任何可能使用数据库的程序
   - 确保没有进程占用 `prisma/dev.db` 文件

2. **运行恢复脚本**
   ```bash
   restore-database.bat
   ```

3. **按照提示操作**
   - 脚本会自动清理损坏的数据库
   - 重新创建数据库表结构
   - 从 JSON 备份文件导入数据

### 方法 2: 手动恢复

如果批处理脚本无法运行，请按以下步骤操作：

#### 步骤 1: 关闭应用程序

确保所有使用数据库的程序都已关闭。

#### 步骤 2: 删除损坏的数据库

```powershell
# 备份损坏的数据库（可选）
Copy-Item "prisma\dev.db" "prisma\dev.db.corrupted.backup"

# 删除损坏的数据库文件
Remove-Item "prisma\dev.db" -Force
Remove-Item "prisma\dev.db-wal" -Force -ErrorAction SilentlyContinue
Remove-Item "prisma\dev.db-shm" -Force -ErrorAction SilentlyContinue
Remove-Item "prisma\dev.db-journal" -Force -ErrorAction SilentlyContinue
```

#### 步骤 3: 重新创建数据库结构

```bash
npx prisma migrate deploy
npx prisma generate
```

#### 步骤 4: 导入数据

```bash
npm run db:import
```

选择 "y" 清空现有数据后导入。

### 方法 3: 使用 Node.js 脚本

如果数据库文件未被锁定，可以运行：

```bash
node scripts/recreate-db-from-json.js
```

## 验证恢复结果

恢复完成后，运行以下命令验证：

```bash
node scripts/check-db-status.js
```

应该看到：
- 用户数 > 0
- 部门数 > 0

## 备份文件位置

- **组织架构备份**: `data/org.json`
- **用户数据备份**: `data/users.json`
- **数据库备份**: `data/backups/database/full/`

## 常见问题

### Q: 提示 "database is locked"

**A:** 有程序正在使用数据库文件。请：
1. 关闭所有 Next.js 进程
2. 关闭所有可能使用数据库的程序
3. 检查任务管理器，确保没有 Node.js 进程在运行

### Q: 恢复后数据仍然为空

**A:** 请检查：
1. `data/org.json` 和 `data/users.json` 文件是否存在
2. 文件内容是否完整
3. 导入过程中是否有错误信息

### Q: 如何从其他备份恢复？

**A:** 可以使用以下命令：
```bash
# 从全量备份恢复
node scripts/restore-database-incremental.js
# 选择选项 1: 恢复全量备份

# 从 ZIP 备份恢复
node scripts/restore-backup.js <备份文件名>
```

## 预防措施

建议定期备份数据库：
```bash
# 导出核心数据到 JSON
npm run db:export

# 创建全量备份
npm run backup:full
```

