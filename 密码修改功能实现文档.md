# å¯†ç ä¿®æ”¹åŠŸèƒ½å®ç°æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

å·²ä¸ºæ‚¨çš„ Next.js åº”ç”¨å®ç°äº†å®Œæ•´çš„å®‰å…¨å¯†ç ä¿®æ”¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **Zod éªŒè¯æ¨¡å¼** (`src/schemas/index.ts`)
2. **Server Action** (`src/actions/settings.ts`)
3. **å®¢æˆ·ç«¯è¡¨å•ç»„ä»¶** (`src/components/auth/change-password-form.tsx`)

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. ä¸¥æ ¼çš„éªŒè¯è§„åˆ™
- âœ… æ–°å¯†ç è‡³å°‘ 8 ä¸ªå­—ç¬¦
- âœ… æ–°å¯†ç å¿…é¡»ä¸ç¡®è®¤å¯†ç ä¸€è‡´
- âœ… æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ
- âœ… ä½¿ç”¨ Zod è¿›è¡Œç±»å‹å®‰å…¨éªŒè¯

### 2. æœåŠ¡ç«¯å®‰å…¨
- âœ… ä»æœåŠ¡ç«¯ headers è·å–ç”¨æˆ·IDï¼ˆä¸ä¿¡ä»»å®¢æˆ·ç«¯ä¼ å€¼ï¼‰
- âœ… ä½¿ç”¨ bcrypt è¿›è¡Œå¯†ç åŠ å¯†ï¼ˆå¼ºåº¦ä¸º 10ï¼‰
- âœ… éªŒè¯å½“å‰å¯†ç æ­£ç¡®æ€§
- âœ… æ£€æµ‹ OAuth ç”¨æˆ·ï¼ˆæ— å¯†ç å­—æ®µï¼‰
- âœ… ä¸åœ¨é”™è¯¯æ¶ˆæ¯ä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯
- âœ… å…¼å®¹æ˜æ–‡å¯†ç è¿‡æ¸¡æœŸï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰

### 3. ç”¨æˆ·ä½“éªŒ
- âœ… ä½¿ç”¨ `useTransition` ç®¡ç†åŠ è½½çŠ¶æ€
- âœ… å®æ—¶è¡¨å•éªŒè¯ä¸é”™è¯¯æç¤º
- âœ… å¯†ç å¯è§æ€§åˆ‡æ¢
- âœ… æˆåŠŸåè‡ªåŠ¨æ¸…ç©ºè¡¨å•
- âœ… Toast æ¶ˆæ¯é€šçŸ¥

## ğŸ“¦ å·²å®‰è£…çš„ä¾èµ–

```json
{
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "zod": "^3.23.x",
    "react-hook-form": "^7.x",
    "@hookform/resolvers": "^3.x"
  },
  "devDependencies": {
    "@types/bcryptjs": "^2.4.x"
  }
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ index.ts                          # Zod éªŒè¯æ¨¡å¼
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ settings.ts                       # Server Actions
â””â”€â”€ components/
    â””â”€â”€ auth/
        â””â”€â”€ change-password-form.tsx      # è¡¨å•ç»„ä»¶
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åœ¨é¡µé¢ä¸­ä½¿ç”¨

åˆ›å»ºä¸€ä¸ªæ–°é¡µé¢æˆ–åœ¨ç°æœ‰é¡µé¢ä¸­å¼•å…¥ç»„ä»¶ï¼š

```tsx
// app/settings/password/page.tsx
import { ChangePasswordForm } from '@/components/auth/change-password-form';

export default function ChangePasswordPage() {
  return (
    <div className="container mx-auto py-8">
      <ChangePasswordForm />
    </div>
  );
}
```

### åœ¨è®¾ç½®é¡µé¢ä¸­åµŒå…¥

```tsx
// app/settings/page.tsx
import { ChangePasswordForm } from '@/components/auth/change-password-form';

export default function SettingsPage() {
  return (
    <div className="space-y-6">
      <section>
        <h1 className="text-2xl font-bold mb-4">è´¦æˆ·è®¾ç½®</h1>
        <ChangePasswordForm />
      </section>
    </div>
  );
}
```

### åœ¨æ¨¡æ€æ¡†ä¸­ä½¿ç”¨

```tsx
// components/modals/ChangePasswordModal.tsx
'use client';

import { Dialog } from '@/components/ui/dialog';
import { ChangePasswordForm } from '@/components/auth/change-password-form';

export function ChangePasswordModal({ isOpen, onClose }) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <ChangePasswordForm />
    </Dialog>
  );
}
```

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹å¯†ç å¼ºåº¦è¦æ±‚

ç¼–è¾‘ `src/schemas/index.ts`ï¼š

```typescript
export const ChangePasswordSchema = z.object({
  currentPassword: z.string().min(1, 'è¯·è¾“å…¥å½“å‰å¯†ç '),
  newPassword: z
    .string()
    .min(12, 'æ–°å¯†ç è‡³å°‘éœ€è¦12ä¸ªå­—ç¬¦')  // ä¿®æ”¹æœ€å°é•¿åº¦
    .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, 'å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—'),
  confirmPassword: z.string().min(1, 'è¯·ç¡®è®¤æ–°å¯†ç ')
})
```

### ä¿®æ”¹ bcrypt å¼ºåº¦

ç¼–è¾‘ `src/actions/settings.ts`ï¼š

```typescript
// ä» 10 æ”¹ä¸º 12ï¼ˆæ›´å®‰å…¨ä½†æ›´æ…¢ï¼‰
const salt = await bcrypt.genSalt(12);
```

### è‡ªå®šä¹‰æ ·å¼

ç»„ä»¶ä½¿ç”¨ Tailwind CSSï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ç±»åï¼š

```tsx
// ä¿®æ”¹è¡¨å•å®¹å™¨æ ·å¼
<div className="max-w-lg w-full mx-auto bg-gray-50 p-8 rounded-xl">
  {/* ... */}
</div>
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•åœºæ™¯

```typescript
// æµ‹è¯•åœºæ™¯åˆ—è¡¨
const testCases = [
  {
    name: 'æ­£å¸¸ä¿®æ”¹å¯†ç ',
    currentPassword: '123456',
    newPassword: 'NewPass123!',
    confirmPassword: 'NewPass123!',
    expected: 'success'
  },
  {
    name: 'å½“å‰å¯†ç é”™è¯¯',
    currentPassword: 'wrongpass',
    newPassword: 'NewPass123!',
    confirmPassword: 'NewPass123!',
    expected: 'error: å½“å‰å¯†ç ä¸æ­£ç¡®'
  },
  {
    name: 'æ–°å¯†ç å¤ªçŸ­',
    currentPassword: '123456',
    newPassword: 'short',
    confirmPassword: 'short',
    expected: 'error: æ–°å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦'
  },
  {
    name: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´',
    currentPassword: '123456',
    newPassword: 'NewPass123!',
    confirmPassword: 'NewPass456!',
    expected: 'error: ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'
  },
  {
    name: 'æ–°å¯†ç ä¸å½“å‰å¯†ç ç›¸åŒ',
    currentPassword: '123456',
    newPassword: '123456',
    confirmPassword: '123456',
    expected: 'error: æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ'
  }
];
```

### 2. æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

1. **æ­£å¸¸æµç¨‹æµ‹è¯•**
   ```
   1. æ‰“å¼€å¯†ç ä¿®æ”¹é¡µé¢
   2. è¾“å…¥æ­£ç¡®çš„å½“å‰å¯†ç 
   3. è¾“å…¥ç¬¦åˆè¦æ±‚çš„æ–°å¯†ç 
   4. ç¡®è®¤æ–°å¯†ç 
   5. ç‚¹å‡»æäº¤
   6. éªŒè¯æˆåŠŸæ¶ˆæ¯
   7. ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•
   ```

2. **é”™è¯¯å¤„ç†æµ‹è¯•**
   ```
   - è¾“å…¥é”™è¯¯çš„å½“å‰å¯†ç  â†’ æ˜¾ç¤º"å½“å‰å¯†ç ä¸æ­£ç¡®"
   - æ–°å¯†ç å°‘äº8å­—ç¬¦ â†’ æ˜¾ç¤º"æ–°å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦"
   - ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´ â†’ æ˜¾ç¤º"ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´"
   - æ–°æ—§å¯†ç ç›¸åŒ â†’ æ˜¾ç¤º"æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ"
   ```

3. **UI/UX æµ‹è¯•**
   ```
   - ç‚¹å‡»çœ¼ç›å›¾æ ‡ â†’ å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
   - æäº¤æ—¶ â†’ æŒ‰é’®æ˜¾ç¤º"æäº¤ä¸­..."ä¸”ç¦ç”¨
   - æˆåŠŸå â†’ è¡¨å•è‡ªåŠ¨æ¸…ç©º
   - é”™è¯¯æ—¶ â†’ æ˜¾ç¤ºçº¢è‰²é”™è¯¯æç¤º
   ```

## ğŸ”„ æ•°æ®åº“å¯†ç è¿ç§»

å¦‚æœæ‚¨çš„æ•°æ®åº“ä¸­ç°æœ‰ç”¨æˆ·ä½¿ç”¨æ˜æ–‡å¯†ç ï¼Œéœ€è¦è¿›è¡Œè¿ç§»ï¼š

### è¿ç§»è„šæœ¬

åˆ›å»º `scripts/migrate-passwords.ts`ï¼š

```typescript
import { prisma } from '@/lib/prisma';
import bcrypt from 'bcryptjs';

async function migratePasswords() {
  console.log('å¼€å§‹è¿ç§»å¯†ç ...');
  
  const users = await prisma.user.findMany({
    select: { id: true, username: true, password: true }
  });

  let migrated = 0;
  
  for (const user of users) {
    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ bcrypt å“ˆå¸Œ
    if (user.password.startsWith('$2a$') || user.password.startsWith('$2b$')) {
      console.log(`è·³è¿‡ ${user.username}ï¼ˆå·²åŠ å¯†ï¼‰`);
      continue;
    }

    // åŠ å¯†æ˜æ–‡å¯†ç 
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(user.password, salt);

    await prisma.user.update({
      where: { id: user.id },
      data: { password: hashedPassword }
    });

    console.log(`âœ“ å·²è¿ç§» ${user.username}`);
    migrated++;
  }

  console.log(`\nè¿ç§»å®Œæˆï¼å…±è¿ç§» ${migrated} ä¸ªç”¨æˆ·ã€‚`);
}

migratePasswords()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

è¿è¡Œè¿ç§»ï¼š

```powershell
npx tsx scripts/migrate-passwords.ts
```

## âš ï¸ é‡è¦æç¤º

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] ç¡®ä¿æ‰€æœ‰å¯†ç å·²ä½¿ç”¨ bcrypt åŠ å¯†
- [ ] åˆ é™¤æˆ–æ³¨é‡Š Server Action ä¸­çš„æ˜æ–‡å¯†ç å…¼å®¹ä»£ç 
- [ ] é…ç½®é€‚å½“çš„é€Ÿç‡é™åˆ¶ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰
- [ ] å¯ç”¨ HTTPSï¼ˆé˜²æ­¢å¯†ç åœ¨ä¼ è¾“ä¸­è¢«æˆªè·ï¼‰
- [ ] å®ç°ç™»å½•å°è¯•é™åˆ¶
- [ ] è€ƒè™‘æ·»åŠ ä¸¤æ­¥éªŒè¯

### å®‰å…¨å»ºè®®

```typescript
// åœ¨ Server Action ä¸­æ·»åŠ é€Ÿç‡é™åˆ¶
import { ratelimit } from '@/lib/ratelimit';

export async function changePassword(values: ChangePasswordInput) {
  const userId = await getCurrentUserId();
  
  // é€Ÿç‡é™åˆ¶ï¼šæ¯ç”¨æˆ·æ¯å°æ—¶æœ€å¤š5æ¬¡å°è¯•
  const { success } = await ratelimit.limit(`change-password:${userId}`);
  if (!success) {
    return { success: false, error: 'æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' };
  }
  
  // ... å…¶ä½™ä»£ç 
}
```

## ğŸ› æ•…éšœæ’é™¤

### 1. "æœªæˆæƒï¼šè¯·å…ˆç™»å½•"
- æ£€æŸ¥ `x-user-id` header æ˜¯å¦æ­£ç¡®è®¾ç½®
- ç¡®è®¤ `localStorage` ä¸­æœ‰ç”¨æˆ·ä¿¡æ¯
- æŸ¥çœ‹ `src/lib/apiClient.ts` ä¸­çš„ `apiFetch` å®ç°

### 2. "å½“å‰å¯†ç ä¸æ­£ç¡®"ï¼ˆä½†å¯†ç ç¡®å®æ­£ç¡®ï¼‰
- æ£€æŸ¥æ•°æ®åº“ä¸­å¯†ç æ ¼å¼ï¼ˆæ˜æ–‡ vs bcryptï¼‰
- æŸ¥çœ‹ Server Action ä¸­çš„å¯†ç éªŒè¯é€»è¾‘
- ç¡®è®¤ bcrypt ç‰ˆæœ¬å…¼å®¹æ€§

### 3. è¡¨å•æäº¤æ— ååº”
- æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯
- æ£€æŸ¥ Server Action æ˜¯å¦æ­£ç¡®å¯¼å…¥
- ç¡®è®¤ `'use server'` æŒ‡ä»¤å­˜åœ¨

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Next.js Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations)
- [React Hook Form](https://react-hook-form.com/)
- [Zod](https://zod.dev/)
- [bcryptjs](https://github.com/dcodeIO/bcrypt.js)

## ğŸ‰ å®Œæˆï¼

å¯†ç ä¿®æ”¹åŠŸèƒ½å·²ç»å®Œå…¨å®ç°ã€‚æ‚¨å¯ä»¥ï¼š

1. ç›´æ¥åœ¨é¡µé¢ä¸­ä½¿ç”¨ `<ChangePasswordForm />`
2. æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰æ ·å¼å’ŒéªŒè¯è§„åˆ™
3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£å¯†ç ä¿®æ”¹è¿‡ç¨‹
4. è¿›è¡Œå®Œæ•´çš„æµ‹è¯•

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–å‚è€ƒæœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†ã€‚
