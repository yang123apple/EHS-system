# 或签显示问题修复说明

## 🐛 问题描述

**现象**：当或签模式中有一人完成操作后，流程已经流转到下一步，但是"当前处理人"显示的仍然是或签步骤的候选人，而不是下一步的处理人。

**原因分析**：
1. 或签模式下，第一人完成操作后，派发引擎正确计算了下一步并匹配了下一步的处理人
2. `dispatchedHandlers` 对象正确设置了下一步的 `dopersonal_ID`、`dopersonal_Name` 和 `candidateHandlers`（如果下一步也是多人模式）
3. 但是在构建 `updates` 对象时，代码检查到旧的 `hazard.candidateHandlers` 存在，就直接保留并更新了它的 `hasOperated` 状态
4. 这导致旧的 `candidateHandlers` 覆盖了 `dispatchedHandlers` 中设置的新值
5. 最终数据库保存的是旧的候选人信息，UI显示错误

## 🔧 解决方案

### 修改文件
`src/app/hidden-danger/_hooks/useHazardWorkflow.ts`

### 核心逻辑修改

**修改前**：
```typescript
// 无论是否流转，都更新旧的candidateHandlers
if (hazard.candidateHandlers && hazard.candidateHandlers.length > 0) {
  updates.candidateHandlers = hazard.candidateHandlers.map(candidate => ({
    ...candidate,
    hasOperated: candidate.userId === user?.id ? true : candidate.hasOperated
  }));
}
```

**修改后**：
```typescript
if (hazard.candidateHandlers && hazard.candidateHandlers.length > 0) {
  if (shouldStayAtCurrentStep) {
    // ✅ 会签模式未完成：更新candidateHandlers的hasOperated状态
    updates.candidateHandlers = hazard.candidateHandlers.map(candidate => ({
      ...candidate,
      hasOperated: candidate.userId === user?.id ? true : candidate.hasOperated
    }));
  } else if (hazard.approvalMode === 'OR') {
    // ✅ OR模式已完成流转：不更新旧的candidateHandlers
    // dispatchedHandlers已经设置了下一步的处理人信息
    console.log('✅ 或签已完成，流转到下一步，candidateHandlers由dispatchedHandlers控制');
  }
}
```

### 关键改进

1. **条件判断**：只有在 `shouldStayAtCurrentStep=true`（会签未完成）时，才更新旧的 `candidateHandlers`
2. **或签流转**：当或签完成流转时（`shouldStayAtCurrentStep=false` 且 `approvalMode='OR'`），不处理旧的 `candidateHandlers`，让 `dispatchedHandlers` 中的新值生效
3. **通知优化**：只有在停留在当前步骤时才发送会签/或签进度通知，避免已流转的情况下发送无意义的通知

## 📊 数据流转过程

### 或签模式完成流转

1. **第一人操作**：
   ```
   当前步骤: 验收 (或签: 张三、李四、王五)
   张三点击"通过"
   ```

2. **派发引擎处理**：
   ```typescript
   shouldStayAtCurrentStep = false  // OR模式，一人完成即可流转
   nextStepIndex = currentStepIndex + 1
   ```

3. **设置下一步处理人**：
   ```typescript
   dispatchedHandlers.dopersonal_ID = "下一步处理人ID"
   dispatchedHandlers.dopersonal_Name = "下一步处理人姓名"
   dispatchedHandlers.candidateHandlers = undefined  // 清除候选人列表
   ```

4. **构建更新数据**（修复后）：
   ```typescript
   updates = {
     ...payload,
     ...dispatchedHandlers,  // ✅ 覆盖下一步处理人
     // ❌ 不再添加: candidateHandlers: 旧的候选人列表
   }
   ```

5. **最终结果**：
   ```
   dopersonal_ID: 下一步处理人ID
   dopersonal_Name: 下一步处理人姓名
   candidateHandlers: null/undefined
   ```

### 会签模式未完成

1. **第一人操作**：
   ```
   当前步骤: 审批 (会签: 张三、李四、王五)
   张三点击"通过"
   ```

2. **派发引擎处理**：
   ```typescript
   shouldStayAtCurrentStep = true  // AND模式，需要所有人完成
   nextStepIndex = currentStepIndex  // 停留在当前步骤
   ```

3. **保持当前处理人**：
   ```typescript
   dispatchedHandlers.dopersonal_ID = hazard.dopersonal_ID
   dispatchedHandlers.dopersonal_Name = hazard.dopersonal_Name
   dispatchedHandlers.candidateHandlers = hazard.candidateHandlers  // 保持不变
   ```

4. **更新候选人状态**：
   ```typescript
   updates.candidateHandlers = hazard.candidateHandlers.map(c => ({
     ...c,
     hasOperated: c.userId === user.id ? true : c.hasOperated
   }))
   // 结果: [{张三, hasOperated: true}, {李四, hasOperated: false}, {王五, hasOperated: false}]
   ```

5. **发送进度通知**：
   ```
   通知李四和王五：张三已完成签核，会签进度：1/3人已处理
   ```

## ✅ 验证测试

### 测试场景1：或签完成流转

1. 配置步骤1为或签（张三、李四、王五）
2. 配置步骤2为单人（赵六）
3. 张三登录并完成或签步骤
4. **预期结果**：
   - ✅ 流程流转到步骤2
   - ✅ 当前处理人显示：赵六
   - ✅ 不显示"或签"标识
   - ✅ candidateHandlers 字段为空

### 测试场景2：或签流转到下一个或签

1. 配置步骤1为或签（张三、李四）
2. 配置步骤2为或签（王五、赵六）
3. 张三完成步骤1
4. **预期结果**：
   - ✅ 流程流转到步骤2
   - ✅ 当前处理人显示：王五、赵六（或签）
   - ✅ candidateHandlers 包含王五和赵六的信息

### 测试场景3：会签未完成

1. 配置步骤为会签（张三、李四、王五）
2. 张三完成会签
3. **预期结果**：
   - ✅ 流程停留在当前步骤
   - ✅ 当前处理人显示：张三、李四、王五（会签）
   - ✅ candidateHandlers 中张三的 hasOperated=true
   - ✅ 李四和王五收到进度通知

### 测试场景4：会签完成流转

1. 配置步骤1为会签（张三、李四）
2. 配置步骤2为单人（王五）
3. 张三完成会签
4. 李四完成会签
5. **预期结果**：
   - ✅ 流程流转到步骤2
   - ✅ 当前处理人显示：王五
   - ✅ 不显示"会签"标识

## 📝 代码审查要点

1. **数据优先级**：`dispatchedHandlers` 应该始终优先于旧数据
2. **条件清晰**：明确区分"停留当前步骤"和"流转到下一步"两种情况
3. **通知准确**：只在需要时发送进度通知，避免已流转的情况下发送

## 🚀 后续优化建议

1. **单元测试**：为或签和会签的各种场景编写单元测试
2. **日志增强**：添加更多日志来跟踪 candidateHandlers 的变化
3. **性能优化**：考虑缓存派发引擎的结果，避免重复计算

---

**修复时间**: 2026-01-03  
**影响范围**: 隐患管理系统的或签和会签功能  
**修复文件**: `src/app/hidden-danger/_hooks/useHazardWorkflow.ts`
