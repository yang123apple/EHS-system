# A4 列宽计算 - 快速参考卡

## 🚀 一分钟快速开始

```typescript
import { calculateA4ColumnWidths } from '@/utils/a4-column-width';

// 1. 准备数据
const data = [
  ['姓名', '部门', 'Email'],
  ['张三', '技术部', 'zhang@example.com']
];

// 2. 计算列宽
const widths = calculateA4ColumnWidths(data);

// 3. 应用到表格
// 返回示例: [80, 120, 300]
```

---

## 📋 核心 API

| 函数 | 用途 | 示例 |
|------|------|------|
| `calculateA4ColumnWidths(data)` | 计算列宽 | `[100, 200, 150]` |
| `calculateStringWidth(text)` | 测量文字宽度 | `51` (px) |
| `validateA4Fit(widths)` | 验证是否适配 | `{ fits: true }` |
| `formatWidthsForCSS(widths)` | 转换CSS格式 | `['100px', '200px']` |
| `getTotalTableWidth(widths)` | 计算总宽度 | `450` (px) |

---

## 🎯 关键常量

| 常量 | 值 | 说明 |
|------|-----|------|
| **A4 宽度** | 794px | 纸张总宽度 (96 DPI) |
| **边距** | 50px | 左右边距总和 |
| **可打印区** | 744px | 794 - 50 |
| **目标宽度** | 700px | 安全使用区域 |
| **最小列宽** | 40px | 防止崩溃 |
| **最大列宽** | 300px | 防止独占 |
| **CJK 字符** | 14px | 中文/日文/韩文 |
| **ASCII 字符** | 7px | 英文/数字 |
| **单元格内边距** | 16px | 左右内边距总和 |

---

## 🧮 算法速览

```
1️⃣ 计算每列权重 (基于最长内容)
   CJK字符 × 14px + ASCII字符 × 7px + 16px padding

2️⃣ 求总权重
   sum(所有列权重)

3️⃣ 按比例分配 700px
   每列 = (列权重 / 总权重) × 700px

4️⃣ 应用约束
   min: 40px, max: 300px

5️⃣ 重新分配剩余空间
   给未触及约束的列
```

---

## 📐 字符宽度速算

| 文本 | 计算 | 宽度 |
|------|------|------|
| `'你好'` | 2 CJK × 14px + 16px | 44px |
| `'Hello'` | 5 ASCII × 7px + 16px | 51px |
| `'Hello世界'` | 5 ASCII×7 + 2 CJK×14 + 16px | 79px |
| `'张三123'` | 2 CJK×14 + 3 ASCII×7 + 16px | 65px |

---

## 🔧 常见集成

### React 组件

```tsx
import { useMemo } from 'react';
import { calculateA4ColumnWidths } from '@/utils/a4-column-width';

function Table({ data }) {
  const widths = useMemo(() => 
    calculateA4ColumnWidths(data), [data]
  );
  
  return (
    <table style={{ width: '794px' }}>
      <thead>
        <tr>
          {data[0].map((h, i) => (
            <th key={i} style={{ width: widths[i] }}>{h}</th>
          ))}
        </tr>
      </thead>
    </table>
  );
}
```

### LuckySheet

```typescript
luckysheet.create({
  data: [{
    config: {
      columnlen: Object.fromEntries(
        widths.map((w, i) => [i, w])
      )
    }
  }]
});
```

### 打印样式

```css
@media print {
  @page { size: A4; margin: 10mm; }
  table { width: 794px; }
}
```

---

## 🐛 快速诊断

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 表格溢出 | 列太多 | 减小 `TARGET_USABLE_WIDTH` 或分页 |
| 列太窄 | 约束太严 | 增加 `MIN_COLUMN_WIDTH` |
| 列太宽 | 约束太松 | 减小 `MAX_COLUMN_WIDTH` |
| 中文宽度不准 | 字体差异 | 调整 `CJK_CHAR_WIDTH` |

---

## 📊 性能参考

| 数据量 | 耗时 | 优化建议 |
|--------|------|----------|
| 10×5 | <1ms | ✅ 直接使用 |
| 100×10 | ~2ms | ✅ 使用 useMemo |
| 1000×20 | ~10ms | ⚠️ 防抖处理 |
| 10000×50 | ~100ms | ❌ 分页或虚拟滚动 |

---

## 🎨 实用代码片段

### 验证并提示

```typescript
const widths = calculateA4ColumnWidths(data);
const validation = validateA4Fit(widths);

if (!validation.fits) {
  alert(`表格超出 ${validation.overflow}px，建议横向打印`);
}
```

### 自适应调整

```typescript
function smartCalculate(data: any[][]) {
  let widths = calculateA4ColumnWidths(data);
  let validation = validateA4Fit(widths);
  
  if (!validation.fits) {
    // 尝试减小目标宽度
    const TARGET_USABLE_WIDTH = 680;
    widths = calculateA4ColumnWidths(data); // 重新计算
  }
  
  return widths;
}
```

### 分页处理

```typescript
const maxColumns = 8;
const pages = [];

for (let i = 0; i < data[0].length; i += maxColumns) {
  const pageData = data.map(row => 
    row.slice(i, i + maxColumns)
  );
  pages.push({
    data: pageData,
    widths: calculateA4ColumnWidths(pageData)
  });
}
```

---

## 🔄 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2026-01-03 | 1.0.0 | 初始版本发布 |

---

## 📚 完整文档

- **集成指南**: `A4列宽计算-集成指南.md`
- **算法可视化**: `A4列宽计算-算法可视化.md`
- **源代码**: `src/utils/a4-column-width.ts`
- **测试文件**: `src/utils/a4-column-width.test.ts`

---

## 💡 专业提示

✅ **DO**:
- 使用 `useMemo` 缓存结果
- 清理 null/undefined 值
- 预处理超长文本
- 添加打印媒体查询

❌ **DON'T**:
- 在 render 中重复计算
- 传入未处理的原始数据
- 忽略验证结果
- 硬编码列宽

---

## 🆘 获取帮助

如需支持,请查阅:
1. 集成指南中的"故障排除"章节
2. 测试文件中的使用示例
3. 算法可视化文档理解原理

---

**快速参考卡 v1.0** | EHS 系统 | 2026-01-03
