# æ“ä½œæ—¥å¿—ç³»ç»Ÿ - æ–‡ä»¶ç´¢å¼•

## ğŸ“‚ æ ¸å¿ƒæ–‡ä»¶

### æ•°æ®åº“ç›¸å…³
- **`prisma/schema.prisma`**
  - SystemLog æ•°æ®æ¨¡å‹ï¼ˆå·²å¢å¼ºï¼‰
  - åŒ…å«ç”¨æˆ·å¿«ç…§ã€å­—æ®µå˜æ›´ç­‰å­—æ®µ

- **`prisma/migrations/20260102151949_enhance_system_log_with_user_snapshot_and_changes/`**
  - æ•°æ®åº“è¿ç§»æ–‡ä»¶
  - å·²æ‰§è¡Œ âœ…

### æœåŠ¡å±‚
- **`src/services/systemLog.service.ts`** â­ æ ¸å¿ƒæœåŠ¡
  - `SystemLogService.createLog()` - åˆ›å»ºæ—¥å¿—
  - `SystemLogService.getUserSnapshot()` - è·å–ç”¨æˆ·å¿«ç…§
  - `SystemLogService.compareObjects()` - å¯¹æ¯”æ•°æ®å˜æ›´
  - `SystemLogService.createBatchLogs()` - æ‰¹é‡åˆ›å»º
  - `SystemLogService.getLogs()` - æŸ¥è¯¢æ—¥å¿—
  - `SystemLogService.cleanOldLogs()` - æ¸…ç†æ—§æ—¥å¿—

### å·¥å…·ç±»
- **`src/utils/activityLogger.ts`** â­ ä¾¿æ·å·¥å…·
  - `ActivityLogger.logCreate()` - è®°å½•åˆ›å»º
  - `ActivityLogger.logUpdate()` - è®°å½•æ›´æ–°ï¼ˆè‡ªåŠ¨å¯¹æ¯”ï¼‰
  - `ActivityLogger.logDelete()` - è®°å½•åˆ é™¤
  - `ActivityLogger.logApproval()` - è®°å½•å®¡æ‰¹
  - `ActivityLogger.logExport()` - è®°å½•å¯¼å‡º
  - `ActivityLogger.logImport()` - è®°å½•å¯¼å…¥
  - `ActivityLogger.logLogin()` - è®°å½•ç™»å½•
  - `ActivityLogger.logAction()` - é€šç”¨è®°å½•
  - å¸¸é‡å®šä¹‰ï¼š`ActionTypes`, `ActionLabels`, `Modules`

- **`src/utils/logMiddleware.ts`** - æ—¥å¿—ä¸­é—´ä»¶
  - `withActivityLog()` - æ—¥å¿—è£…é¥°å™¨
  - `LogCreate`, `LogUpdate`, `LogDelete` - ç®€åŒ–è£…é¥°å™¨

### APIè·¯ç”±
- **`src/app/api/logs/route.ts`** â­ æ—¥å¿—API
  - `GET /api/logs` - æŸ¥è¯¢æ—¥å¿—ï¼ˆæ”¯æŒç­›é€‰ã€åˆ†é¡µï¼‰
  - `POST /api/logs` - åˆ›å»ºæ—¥å¿—

### UIç»„ä»¶
- **`src/components/ActivityLogViewer.tsx`** â­ æ—¥å¿—æŸ¥çœ‹å™¨
  - æ—¥å¿—åˆ—è¡¨å±•ç¤º
  - å­—æ®µå˜æ›´å¯¹æ¯”
  - æ•°æ®å¿«ç…§æŸ¥çœ‹
  - ç­›é€‰ã€åˆ†é¡µã€å¯¼å‡º

## ğŸ“„ æ–‡æ¡£æ–‡ä»¶

### ä½¿ç”¨æ–‡æ¡£
- **`æ“ä½œæ—¥å¿—å¿«é€Ÿå¼€å§‹.md`** â­ å¿«é€Ÿå…¥é—¨
  - 5åˆ†é’Ÿå¿«é€Ÿé›†æˆæŒ‡å—
  - æœ€ç®€ä½¿ç”¨ç¤ºä¾‹

- **`æ“ä½œæ—¥å¿—-ä¸šåŠ¡ç¼–å·è§„èŒƒ.md`** âš ï¸ é‡è¦è§„èŒƒ
  - **å¿…è¯»**ï¼šä¸ºä»€ä¹ˆä½¿ç”¨ä¸šåŠ¡ç¼–å·
  - å„ç³»ç»Ÿç¼–å·è§„èŒƒè¯´æ˜
  - æ­£ç¡®ä¸é”™è¯¯ç¤ºä¾‹å¯¹æ¯”

- **`æ“ä½œæ—¥å¿—-æˆ–ç­¾æ¨¡å¼å¤„ç†æŒ‡å—.md`** â­ å·¥ä½œæµè§„èŒƒ
  - æˆ–ç­¾ï¼ˆORç­¾ç½²ï¼‰æ¨¡å¼æ¦‚å¿µè¯´æ˜
  - å€™é€‰äººè®°å½•å’Œå®é™…æ“ä½œäººè®°å½•
  - å®Œæ•´çš„éšæ‚£éªŒæ”¶æˆ–ç­¾ç¤ºä¾‹ä»£ç 
  - UIå±•ç¤ºå’Œæ•°æ®åº“è®¾è®¡å»ºè®®

- **`æ“ä½œæ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`** â­ å®Œæ•´æ–‡æ¡£
  - è¯¦ç»†çš„APIæ–‡æ¡£
  - æ‰€æœ‰åŠŸèƒ½è¯´æ˜
  - æœ€ä½³å®è·µ

- **`æ“ä½œæ—¥å¿—é›†æˆç¤ºä¾‹.md`** â­ å®æˆ˜ç¤ºä¾‹
  - éšæ‚£ç®¡ç†æ¨¡å—å®Œæ•´é›†æˆç¤ºä¾‹
  - æ¶µç›–å„ç§æ“ä½œåœºæ™¯

- **`æ“ä½œæ—¥å¿—ç³»ç»Ÿä¼˜åŒ–æ€»ç»“.md`** - é¡¹ç›®æ€»ç»“
  - ä¼˜åŒ–å†…å®¹
  - æ–‡ä»¶æ¸…å•
  - éªŒè¯æ¸…å•

### ç´¢å¼•æ–‡ä»¶
- **`æ“ä½œæ—¥å¿—ç³»ç»Ÿ-æ–‡ä»¶ç´¢å¼•.md`** - æœ¬æ–‡ä»¶

## ğŸ”§ ç±»å‹å®šä¹‰

### SystemLogData æ¥å£
```typescript
interface SystemLogData {
  // ç”¨æˆ·èº«ä»½ä¿¡æ¯
  userId?: string;
  userName?: string;
  userRole?: string;
  userDepartment?: string;
  userDepartmentId?: string;
  userJobTitle?: string;
  userSnapshot?: UserSnapshot;
  
  // æ“ä½œä¿¡æ¯
  action: string;
  actionLabel?: string;
  module?: string;
  
  // æ“ä½œå¯¹è±¡
  targetId?: string;
  targetType?: string;
  targetLabel?: string;
  
  // æ“ä½œè¯¦æƒ…
  details?: string;
  beforeData?: any;
  afterData?: any;
  changes?: FieldChange[];
  snapshot?: any;
  
  // å…¶ä»–ä¿¡æ¯
  ip?: string;
  userAgent?: string;
}
```

### FieldChange æ¥å£
```typescript
interface FieldChange {
  field: string;
  fieldLabel?: string;
  oldValue: any;
  newValue: any;
  changeType: 'added' | 'modified' | 'deleted';
}
```

### UserSnapshot æ¥å£
```typescript
interface UserSnapshot {
  id: string;
  username: string;
  name: string;
  role: string;
  roleLabel?: string;
  departmentId?: string;
  departmentName?: string;
  jobTitle?: string;
}
```

## ğŸ¯ å¸¸ç”¨å¯¼å…¥è¯­å¥

```typescript
// å·¥å…·ç±»
import { ActivityLogger, ActionTypes, Modules } from '@/utils/activityLogger';
import { SystemLogService } from '@/services/systemLog.service';

// ç»„ä»¶
import ActivityLogViewer from '@/components/ActivityLogViewer';

// ç±»å‹
import type { SystemLogData, FieldChange, UserSnapshot } from '@/services/systemLog.service';
```

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

```sql
-- SystemLog è¡¨
CREATE TABLE SystemLog (
  id TEXT PRIMARY KEY,
  
  -- ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆå¿«ç…§ï¼‰
  userId TEXT,
  userName TEXT,
  userRole TEXT,
  userDepartment TEXT,
  userDepartmentId TEXT,
  userJobTitle TEXT,
  
  -- æ“ä½œä¿¡æ¯
  action TEXT NOT NULL,
  actionLabel TEXT,
  module TEXT,
  
  -- æ“ä½œå¯¹è±¡
  targetId TEXT,
  targetType TEXT,
  targetLabel TEXT,
  
  -- æ“ä½œè¯¦æƒ…
  details TEXT,
  beforeData TEXT,  -- JSON
  afterData TEXT,   -- JSON
  changes TEXT,     -- JSON
  snapshot TEXT,    -- JSON
  
  -- å…¶ä»–ä¿¡æ¯
  ip TEXT,
  userAgent TEXT,
  
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_userId (userId),
  INDEX idx_action (action),
  INDEX idx_targetType (targetType),
  INDEX idx_module (module),
  INDEX idx_createdAt (createdAt)
);
```

## ğŸš€ å¿«é€ŸæŸ¥æ‰¾

éœ€è¦... | æŸ¥çœ‹æ–‡ä»¶
--- | ---
å¿«é€Ÿå¼€å§‹ | `æ“ä½œæ—¥å¿—å¿«é€Ÿå¼€å§‹.md`
å®Œæ•´APIæ–‡æ¡£ | `æ“ä½œæ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`
é›†æˆç¤ºä¾‹ | `æ“ä½œæ—¥å¿—é›†æˆç¤ºä¾‹.md`
è®°å½•æ—¥å¿— | `src/utils/activityLogger.ts`
æŸ¥çœ‹æ—¥å¿— | `src/components/ActivityLogViewer.tsx`
APIæ¥å£ | `src/app/api/logs/route.ts`
æ•°æ®æ¨¡å‹ | `prisma/schema.prisma`

## ğŸ“± ä½¿ç”¨æµç¨‹

```
1. ç”¨æˆ·æ“ä½œ
   â†“
2. APIè·¯ç”±å¤„ç†
   â†“
3. è°ƒç”¨ ActivityLogger
   â†“
4. è‡ªåŠ¨è·å–ç”¨æˆ·å¿«ç…§
   â†“
5. è‡ªåŠ¨å¯¹æ¯”æ•°æ®å˜æ›´ï¼ˆå¦‚æœæ˜¯æ›´æ–°æ“ä½œï¼‰
   â†“
6. è®°å½•åˆ°æ•°æ®åº“
   â†“
7. åœ¨UIä¸­æŸ¥çœ‹ï¼ˆActivityLogViewerï¼‰
```

## ğŸ¨ UIå±•ç¤º

- **æ—¥å¿—åˆ—è¡¨**
  - æ“ä½œç±»å‹æ ‡ç­¾ï¼ˆå¸¦é¢œè‰²ï¼‰
  - ç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åã€è§’è‰²ã€éƒ¨é—¨ã€èŒä½ï¼‰
  - æ“ä½œè¯¦æƒ…
  - å˜æ›´å­—æ®µæ•°é‡æç¤º

- **è¯¦æƒ…å¼¹çª—**
  - æ“ä½œäººä¿¡æ¯å¡ç‰‡
  - å­—æ®µå˜æ›´å¯¹æ¯”ï¼ˆæ—§å€¼ vs æ–°å€¼ï¼‰
  - å®Œæ•´æ•°æ®å¿«ç…§
  - å…¶ä»–ä¿¡æ¯

## âœ… åŠŸèƒ½æ¸…å•

- [x] ç”¨æˆ·èº«ä»½å¿«ç…§è®°å½•
- [x] æ“ä½œæ—¶é—´ç²¾ç¡®åˆ°ç§’
- [x] å¤šç§æ“ä½œç±»å‹æ”¯æŒ
- [x] æ“ä½œå¯¹è±¡è®°å½•
- [x] æ•°æ®å¿«ç…§ï¼ˆæ“ä½œå‰åï¼‰
- [x] å­—æ®µå˜æ›´è‡ªåŠ¨å¯¹æ¯”
- [x] IPåœ°å€è®°å½•
- [x] User-Agentè®°å½•
- [x] æ‰¹é‡æ“ä½œæ”¯æŒ
- [x] æ—¥å¿—æŸ¥è¯¢å’Œç­›é€‰
- [x] æ—¥å¿—å¯¼å‡º
- [x] æ•°æ®æ¸…ç†åŠŸèƒ½
- [x] UIæŸ¥çœ‹ç»„ä»¶
- [x] å®Œæ•´æ–‡æ¡£

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼š
1. æŸ¥çœ‹ `æ“ä½œæ—¥å¿—å¿«é€Ÿå¼€å§‹.md`
2. å‚è€ƒ `æ“ä½œæ—¥å¿—é›†æˆç¤ºä¾‹.md`
3. é˜…è¯» `æ“ä½œæ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`

---
æ›´æ–°æ—¶é—´ï¼š2026-01-02
ç‰ˆæœ¬ï¼šv1.0
