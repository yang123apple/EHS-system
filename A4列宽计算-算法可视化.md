# A4 列宽计算算法 - 可视化说明

## 算法流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    输入: 2D 数据数组                              │
│   [ ['姓名', '部门', 'Email'],                                    │
│     ['张三', '技术部门', 'zhang@example.com'] ]                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 1: 为每列计算权重(基于最长内容)                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐          │
│  │  '姓名'   │  │ '技术部门' │  │'zhang@example.com'  │          │
│  │  CJK×2   │  │  CJK×4    │  │     ASCII×21        │          │
│  │  = 44px  │  │  = 72px   │  │     = 163px         │          │
│  └──────────┘  └──────────┘  └──────────────────────┘          │
│     权重1          权重2             权重3                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 2: 计算总权重                                               │
│                                                                   │
│  总权重 = 44 + 72 + 163 = 279                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 3: 按比例分配 700px 目标宽度                                │
│                                                                   │
│  列1: (44/279) × 700 = 110px                                     │
│  列2: (72/279) × 700 = 180px                                     │
│  列3: (163/279) × 700 = 409px  ← 超过最大宽度!                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 4: 应用约束                                                 │
│                                                                   │
│  列1: 110px  ✓ (在 40-300 范围内)                                │
│  列2: 180px  ✓ (在 40-300 范围内)                                │
│  列3: 409px → 限制为 300px  (触及上限)                           │
│                                                                   │
│  当前总宽度: 110 + 180 + 300 = 590px                             │
│  剩余空间: 700 - 590 = 110px                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 5: 重新分配剩余空间给未约束的列                             │
│                                                                   │
│  未约束列: 列1(权重44) 和 列2(权重72)                            │
│  剩余权重: 44 + 72 = 116                                         │
│                                                                   │
│  列1: 110 + (44/116) × 110 = 152px                               │
│  列2: 180 + (72/116) × 110 = 248px                               │
│  列3: 300px (已约束)                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 6: 最终调整并四舍五入                                       │
│                                                                   │
│  最终宽度: [152, 248, 300]                                       │
│  总宽度: 700px  ✓                                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌────────────────┐
                    │  输出: [152,   │
                    │         248,   │
                    │         300]   │
                    └────────────────┘
```

---

## 字符宽度计算示例

### CJK vs ASCII 比较

```
┌─────────────────────────────────────────────────────────────────┐
│  文本: "Hello"  (5个ASCII字符)                                   │
│                                                                   │
│  H    e    l    l    o                                           │
│  ├─┤  ├─┤  ├─┤  ├─┤  ├─┤                                         │
│  7px  7px  7px  7px  7px                                         │
│                                                                   │
│  总宽度: 5 × 7px = 35px + 16px padding = 51px                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  文本: "你好"  (2个CJK字符)                                       │
│                                                                   │
│  你      好                                                       │
│  ├───┤  ├───┤                                                    │
│  14px   14px                                                     │
│                                                                   │
│  总宽度: 2 × 14px = 28px + 16px padding = 44px                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  文本: "Hello世界"  (5个ASCII + 2个CJK)                          │
│                                                                   │
│  H  e  l  l  o   世     界                                       │
│  ├┤ ├┤ ├┤ ├┤ ├┤  ├───┤ ├───┤                                    │
│                                                                   │
│  总宽度: (5×7px) + (2×14px) + 16px = 79px                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## A4 纸张布局

```
┌────────────────────────────────────────────────────────────────┐
│                          A4 纸张                                │
│                      794px × 1123px                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │← 25px →                                        ← 25px →  │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │                                                     │  │  │
│  │  │            可打印区域 (744px)                       │  │  │
│  │  │                                                     │  │  │
│  │  │  ┌──────────────────────────────────────────────┐  │  │  │
│  │  │  │                                               │  │  │  │
│  │  │  │      目标使用区域 (700px)                     │  │  │  │
│  │  │  │                                               │  │  │  │
│  │  │  │  ┌─────┬──────────┬───────────┬──────────┐   │  │  │  │
│  │  │  │  │     │          │           │          │   │  │  │  │
│  │  │  │  │ 列1 │   列2    │    列3    │   列4    │   │  │  │  │
│  │  │  │  │     │          │           │          │   │  │  │  │
│  │  │  │  │ 80  │   150    │    250    │   220    │   │  │  │  │
│  │  │  │  │ px  │    px    │     px    │    px    │   │  │  │  │
│  │  │  │  │     │          │           │          │   │  │  │  │
│  │  │  │  └─────┴──────────┴───────────┴──────────┘   │  │  │  │
│  │  │  │                                               │  │  │  │
│  │  │  │  总宽度: 80+150+250+220 = 700px  ✓            │  │  │  │
│  │  │  │                                               │  │  │  │
│  │  │  └──────────────────────────────────────────────┘  │  │  │
│  │  │                                                     │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## 约束条件示例

### 最小宽度约束 (40px)

```
场景: 10个窄列

原始计算: [30, 32, 35, 28, 25, 33, 31, 29, 27, 30]
         ↓   ↓   ↓   ↓   ↓   ↓   ↓   ↓   ↓   ↓
应用约束: [40, 40, 40, 40, 40, 40, 40, 40, 40, 40]
         
问题: 40×10 = 400px < 700px (剩余300px)
解决: 将300px按权重重新分配

最终结果: [60, 65, 72, 55, 48, 68, 62, 58, 52, 60]
```

### 最大宽度约束 (300px)

```
场景: 1个极长列 + 2个普通列

原始计算: [450, 125, 125]
          ↓
应用约束: [300, 125, 125]  (列1被限制为300px)
         
问题: 300+125+125 = 550px < 700px (剩余150px)
解决: 将150px分配给列2和列3

最终结果: [300, 200, 200]
```

---

## 实际案例演示

### 案例 1: 员工信息表

```
数据:
┌────────┬────────────────┬─────────────────────────┬────────┐
│  姓名  │      部门      │          Email          │  状态  │
├────────┼────────────────┼─────────────────────────┼────────┤
│  张三  │   技术部门     │ zhangsan@example.com    │  在职  │
│  李四  │     行政部     │ lisi@example.com        │  离职  │
│  王五  │ 销售与市场营销 │ wangwu@example.com      │  在职  │
└────────┴────────────────┴─────────────────────────┴────────┘

权重计算:
列1 '姓名': 2个CJK → 44px
列2 '销售与市场营销': 7个CJK → 114px
列3 'zhangsan@example.com': 21个ASCII → 163px
列4 '状态': 2个CJK → 44px

总权重: 365px

比例分配 (700px):
列1: (44/365) × 700 = 84px
列2: (114/365) × 700 = 218px
列3: (163/365) × 700 = 312px → 限制为 300px
列4: (44/365) × 700 = 84px

重新分配:
剩余: 700 - (84+218+300+84) = 14px
未约束列: 1, 2, 4 (权重: 44+114+44=202)

列1: 84 + (44/202)×14 = 87px
列2: 218 + (114/202)×14 = 226px
列3: 300px (已约束)
列4: 84 + (44/202)×14 = 87px

最终宽度: [87, 226, 300, 87]
```

---

## 性能特征

```
时间复杂度: O(r × c)
  r = 行数
  c = 列数

空间复杂度: O(c)
  需要存储列权重和列宽数组

典型性能:
┌──────────────┬──────────┬────────────┐
│   数据规模   │ 计算时间 │   说明     │
├──────────────┼──────────┼────────────┤
│  10行×5列    │  <1ms   │ 即时计算   │
│  100行×10列  │  ~2ms   │ 快速计算   │
│  1000行×20列 │  ~10ms  │ 可接受     │
│  10000行×50列│  ~100ms │ 需优化     │
└──────────────┴──────────┴────────────┘
```

---

## 边界情况处理

### 1. 空数据

```typescript
输入: []
输出: []
```

### 2. 单个单元格

```typescript
输入: [['Test']]
权重: 35px
分配: 700px (单列获得全部宽度)
约束: 限制为 300px
输出: [300]
```

### 3. 全部 null 值

```typescript
输入: [[null, null, null]]
权重: [16, 16, 16] (仅padding)
输出: [233, 233, 234] (平均分配)
```

### 4. 极端长文本

```typescript
输入: [['Short', 'A'.repeat(1000)]]
      
注意: 超过50字符的文本被截断计算
权重: [51px, 366px (截断为50字符)]
输出: [100, 300] (长列被限制)
```

---

## 调优建议

### 调整目标宽度

```typescript
// 更保守(适合复杂表格)
const TARGET_USABLE_WIDTH = 680;

// 更激进(适合简单表格)
const TARGET_USABLE_WIDTH = 720;
```

### 调整字符宽度

```typescript
// 针对不同字体
const CJK_CHAR_WIDTH = 12;  // 窄字体(如微软雅黑)
const CJK_CHAR_WIDTH = 16;  // 宽字体(如宋体)

const ASCII_CHAR_WIDTH = 6;  // 窄字体
const ASCII_CHAR_WIDTH = 8;  // 宽字体
```

### 调整约束范围

```typescript
// 允许更窄的列
const MIN_COLUMN_WIDTH = 30;

// 允许更宽的列
const MAX_COLUMN_WIDTH = 350;
```

---

## 总结

✅ **核心优势**:
- 纯计算逻辑,无环境依赖
- 智能处理 CJK 字符
- 自动约束保护
- 空间最优化利用

✅ **适用场景**:
- Excel 导出打印
- PDF 生成
- 报表系统
- 数据展示

✅ **扩展性**:
- 易于调整参数
- 支持自定义约束
- 可集成任何表格组件
