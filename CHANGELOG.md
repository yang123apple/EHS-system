# EHS 系统 - V3.0 版本更新日志

## 发布日期
2025年12月21日

## 版本概述
本版本聚焦于 **模板解析精度优化** 和 **运行时错误修复**，完成了中文表单字段识别、选项聚合、以及合并单元格处理的全面升级。

---

## 🎯 核心改进

### 1. 模板字段解析深度优化

#### ✅ 智能日期占位符识别
- **支持中文日期占位**: "年 月 日" 、"月 日"、"月 日 时" 等格式精确识别
- **支持英文占位**: YYYY-MM-DD、yyyy-mm-dd、HH:MM、hh:mm 等国际格式
- **智能左标签查找**: 日期格独立使用"智能向左查找"，可跨越最多 5 个空白格子，遇到已识别输入框停止
- **示例**: 如"申请日期"右侧的"年 月 日"黄色区域现可正确识别为"申请日期"字段（日期类型）

#### ✅ 选项行聚合与标准化
- **行级聚合**: "作业方式"行的"□焊接/□切割/□打磨/□钻孔/□其他"现聚合为单一字段，包含所有选项列表
- **持证列聚合**: 多行的"持证 是/否"自动按行生成独立字段（带 `_rowX` 后缀以区分）
- **优先本格内容**: 选项标记（£/□/☑）优先提取本格内容（如"£钻孔"→字段名"钻孔"），无内容时才向左/上查找
- **收益**: 消除工作流文本匹配下拉菜单中的重复项，提升用户体验

#### ✅ 标签过滤与黑名单机制
- **选项词黑名单**: 自动过滤"是/否/是否/有/无/有无/Yes/No/N/A"等选项值，防止其被误当作字段名
- **大标题黑名单**: 过滤末尾包含"单/表/书"且包含"申请/审批/作业/记录"的表头，避免"审批表/申请单"成为字段名
- **保留有效标签**: "其他"作为常见有效选项值被保留，可作为字段标签

### 2. 合并单元格处理规范化

#### ✅ 仅处理起始单元格
- **原理**: 对于合并区域，仅在左上角（起始格）处理内容
- **防止重复**: 普通循环自动跳过被合并覆盖的单元格
- **正确识别**: 黄色合并区（如日期区）、红色合并区（如风险辨识）均能正确识别

#### ✅ 合并信息兼容性增强
- **支持 LuckySheet 格式**: sheets[0].merges 中的 r/c + rs/cs 或 rowspan/colspan
- **支持 XLSX 格式**: 直接的 { s: { r, c }, e: { r, c } } 标准格式
- **自动规范化**: 统一转换为内部标准的 { s, e } 表示

### 3. 字段名推断与唯一性

#### ✅ 精确映射表
新增针对选项行短标签的精确映射：
- "钻孔" → "钻孔"（避免被"地点/位置"关键词误匹配）
- "其他" → "其他"
- "焊接" → "焊接"、"切割" → "切割"、"打磨" → "打磨"
- "持证" → "持证"

#### ✅ 唯一字段名生成
- **重复自动后缀**: 相同标签的字段自动添加 `_rowX` 后缀，如"负责人_row4"、"电话_row5"
- **首次保留原名**: 同一标签首次出现不带后缀，第二次及以后才添加
- **收益**: 完全消除字段名冲突，支持同一表单多行相同输入

### 4. 列宽读取与渲染优化

#### ✅ 原生 Excel 列宽支持
- **直接读取**: 从 templateData.cols 读取原生 Excel 列宽（单位：像素）
- **三轮智能计算**: 
  1. 非合并单元格建立列宽骨架
  2. 合并单元格按需补偿宽度
  3. 应用最大值约束（500px）
- **中英文区分**: 中文字符按 14px 计算，英文按 7.2px，确保宽度准确

#### ✅ UI 文本换行处理
- **自动检测**: 识别含有 \n 的合并单元格
- **可选换行**: 对应单元格在渲染时自动应用换行，改善用户体验

---

## 🔧 技术细节

### 文件修改
- **src/utils/templateParser.ts** (822 行)
  - 新增顶层函数: `isIgnorableLabel()` - 标签有效性判断
  - 新增顶层函数: `findSmartLeftLabel()` - 智能向左查找标签
  - 优化: `extractMerges()` - 支持多种合并格式
  - 重构: STEP 1 选项行处理 - 行级聚合与本格优先逻辑
  - 增强: nameMap - 新增短标签精确映射

- **src/components/work-permit/ExcelRenderer.tsx** (1050 行)
  - 修复: initialData JSON 字符串处理 - 兼容 typeof string 的输入
  - 改进: formData 初始化逻辑 - 错误处理与降级方案

### 新增字段类型支持
- `date` - 日期/时间选择
- `option` - 下拉选择（包括聚合选项）
- `personnel` - 人员输入
- `department` - 部门选择
- `signature` - 签名区域
- `number` - 数值/电话/身份证号
- `text` - 通用文本（默认）

### 性能优化
- 减少冗余 dedup 逻辑，改用唯一字段名生成
- 合并单元格处理一次性完成，避免重复循环
- 智能左查找带停止条件，避免过度扫描

---

## 🐛 Bug 修复

### ExcelRenderer 运行时错误
**问题**: 尝试对字符串对象设置属性，导致 TypeError
```
Cannot create property '30-1' on string '{"2-2":"电极生产运营部",...}'
```

**原因**: initialData 作为 JSON 字符串传入（而非对象），深拷贝后仍为字符串

**方案**: 添加类型检查与双重解析
```typescript
if (typeof initialData === 'string') {
  mergedData = JSON.parse(JSON.stringify(JSON.parse(initialData)));
} else {
  mergedData = JSON.parse(JSON.stringify(initialData));
}
```

---

## 📊 测试覆盖

### 验证场景（基于"动火作业申请单"模板）
- ✅ 黄色区域（日期占位"年 月 日"）正确解析为日期字段
- ✅ 红色区域（作业方式选项行）聚合为单一字段 + 完整选项列表
- ✅ 持证列多行正确生成"持证_row9"、"持证_row10"等唯一字段
- ✅ 风险辨识合并区正确识别为单一文本字段
- ✅ 工作流下拉菜单中无重复的文本匹配字段

### 解析统计
- **总字段数**: ~70+ 字段（含行级唯一字段）
- **文本/匹配字段**: 4 个（用于工作流）
- **选项字段**: ~20 个（聚合后）
- **日期字段**: ~8 个
- **签名字段**: ~4 个

---

## 🚀 升级建议

1. **清空浏览器 localStorage** - 移除旧的 ehs_user 缓存，避免混乱
2. **重新上传模板** - 重新解析以获得新的字段映射结构
3. **测试工作流** - 确认文本匹配下拉菜单显示正确的去重字段
4. **验证数据输入** - 确认多行相同字段（如多个"负责人"）可独立填写

---

## ⚠️ 已知限制

1. **智能左查找深度**: 最多扫描 5 个空白格子，过多排版空白可能识别失败
2. **大标题识别**: 仅对末尾为"单/表/书"的标题有效，其他形式需手动调整
3. **合并单元格嵌套**: 不支持嵌套合并（Excel 本身也不推荐）

---

## 📝 下一步计划

- [ ] 支持自定义字段类型映射（通过模板设置）
- [ ] 提供字段验证规则配置
- [ ] 增强大标题识别的正则表达式
- [ ] 添加字段映射调试工具

---

## 贡献者
- 开发: EHS 系统团队
- 测试: QA 团队
- 日期: 2025-12-21

